<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SGMRP</title>
    <meta name="description" content="An√°lise gr√°fica e dashboard de consumo de refei√ß√µes">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        .chart-placeholder {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,.1) 10px,
                rgba(255,255,255,.1) 20px
            );
        }
        
        .chart-content {
            position: relative;
            z-index: 1;
            text-align: center;
            padding: 2rem;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--gray-200);
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }
        
        .metric-subtitle {
            font-size: 0.75rem;
            color: var(--gray-500);
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .btn-projection {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-projection:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            margin: 3rem 0;
            opacity: 0.3;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-600);
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }
        
        .tab-btn:hover {
            color: var(--primary-color);
            background: var(--gray-50);
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .projection-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        /* Notifica√ß√µes customizadas */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            animation: slideInRight 0.4s ease-out;
            max-width: 400px;
        }

        .notification-content {
            background: white;
            color: #1f2937;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            border-left: 4px solid #3b82f6;
        }

        .notification-content.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .notification-content.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .notification-content.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .notification-content.info {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .notification-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        .notification-body {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            color: #111827;
        }

        .notification-message {
            font-size: 0.875rem;
            line-height: 1.5;
            color: #6b7280;
            white-space: pre-line;
        }

        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
            color: #6b7280;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .custom-notification.closing {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        @media (max-width: 480px) {
            .custom-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Estilos do Modal de Exporta√ß√£o */
        .export-option:hover {
            background: #f1f5f9 !important;
            border-color: var(--primary-color) !important;
        }

        .export-option input:checked + span {
            color: var(--primary-color) !important;
            font-weight: 600;
        }

        input[type="radio"]:checked {
            accent-color: var(--primary-color);
        }

        label:has(input[type="radio"]:checked) {
            border-color: var(--primary-color) !important;
            background: #f5f3ff !important;
        }

        /* For√ßar cursor pointer em bot√µes bloqueados para permitir clicks */
        .btn-agrupamento.bloqueado {
            cursor: pointer !important;
            pointer-events: auto !important;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('home') }}" class="logo">SGMRP</a>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('home') }}">P√°gina Inicial</a></li>
                        <li><a href="{{ url_for('lotes') }}">Lotes</a></li>
                        <li><a href="{{ url_for('dashboard') }}" class="active">Dashboard</a></li>
                        <li><a href="#configuracoes">Configura√ß√µes</a></li>
                        <li><a href="#" id="logoutLink" style="color: #fed7d7;">Sair</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Breadcrumb -->
            <nav aria-label="Navega√ß√£o" style="margin-bottom: 2.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 0.75rem 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="display: flex; gap: 0.5rem; font-size: 0.95rem; color: var(--gray-500); align-items: center;">
                    <span><a href="{{ url_for('home') }}" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">P√°gina Inicial</a></span>
                    <span aria-hidden="true" style="font-size: 1.1em; opacity: 0.7;">/</span>
                    <span aria-current="page" style="color: var(--primary-color); font-weight: 600;">Dashboard</span>
                </div>
            </nav>

            <!-- Header da P√°gina -->
            <section style="margin-bottom: 2.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 2rem;">
                    <div>
                        <h1 style="margin-bottom: 0.5rem; color: var(--primary-color); font-size: 2.1rem; font-weight: 700; letter-spacing: -1px;">
                            üìä Dashboard e An√°lises
                        </h1>
                        <p style="color: var(--gray-600); margin: 0; font-size: 1.05rem;">Visualiza√ß√£o gr√°fica e estat√≠sticas de consumo de refei√ß√µes</p>
                    </div>
                </div>
            </section>

            <!-- Filtros -->
            <section class="fade-in" style="margin-bottom: 2rem;">
                <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.125rem;">üîç</span>
                            <span style="font-weight: 600; color: var(--gray-700);">Filtros:</span>
                        </div>
                        
                        <!-- Filtro de Lotes (Popup) -->
                        <div style="position: relative;">
                            <label style="display: block; font-weight: 500; color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">üì¶ Lotes:</label>
                            <div id="lotes-display" style="padding: 0.75rem 1rem; font-size: 0.875rem; cursor: pointer; border: 2px solid var(--gray-300); border-radius: 8px; background: white; min-width: 250px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;">
                                <span id="lotes-text" style="color: var(--gray-600);">Selecione os lotes</span>
                                <span style="color: var(--gray-400);">‚ñº</span>
                            </div>
                        </div>
                        
                        <!-- Filtro de Unidades (Popup) -->
                        <div style="position: relative;">
                            <label style="display: block; font-weight: 500; color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">üè¢ Unidades:</label>
                            <div id="unidades-display" style="padding: 0.75rem 1rem; font-size: 0.875rem; cursor: not-allowed; border: 2px solid var(--gray-300); border-radius: 8px; background: var(--gray-100); min-width: 250px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; opacity: 0.6;">
                                <span id="unidades-text" style="color: var(--gray-500);">Selecione um lote primeiro</span>
                                <span style="color: var(--gray-400);">‚ñº</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tipo de Gr√°fico -->
            <section class="fade-in" style="margin-bottom: 2rem;">
                <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.125rem;">üìä</span>
                            <span style="font-weight: 600; color: var(--gray-700);">Tipo de Gr√°fico:</span>
                        </div>
                        
                        <!-- Sele√ß√£o Normal vs Acumulada -->
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Visualiza√ß√£o:</span>
                            <div style="display: flex; gap: 0.5rem; background: var(--gray-100); padding: 0.4rem; border-radius: 10px;">
                                <button id="tipo-normal" class="btn-tipo active" data-tipo="normal" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; background: var(--primary-color); color: white; transition: all 0.3s; box-shadow: 0 2px 4px rgba(59,130,246,0.3);">
                                    üìä Normal
                                </button>
                                <button id="tipo-acumulada" class="btn-tipo" data-tipo="acumulada" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; background: transparent; color: var(--gray-600); transition: all 0.3s;">
                                    üìà Acumulada
                                </button>
                            </div>
                        </div>
                        
                        <!-- Sele√ß√£o Total vs Por Lote vs Por Unidade -->
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Agrupamento:</span>
                            <div style="display: flex; gap: 0.5rem; background: var(--gray-100); padding: 0.4rem; border-radius: 10px;">
                                <button id="agrupamento-total" class="btn-agrupamento active" data-agrupamento="total" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; background: var(--primary-color); color: white; transition: all 0.3s; box-shadow: 0 2px 4px rgba(59,130,246,0.3);">
                                    üìä Total
                                </button>
                                <button id="agrupamento-por-lote" class="btn-agrupamento" data-agrupamento="por-lote" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; background: transparent; color: var(--gray-600); transition: all 0.3s;">
                                    üì¶ Por Lote
                                </button>
                                <button id="agrupamento-por-unidade" class="btn-agrupamento bloqueado" data-agrupamento="por-unidade" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; background: transparent; color: var(--gray-500); transition: all 0.3s; opacity: 0.5;">
                                    üè¢ Por Unidade
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gr√°ficos de Visualiza√ß√£o -->
            <!-- Gr√°fico 1: Refei√ß√µes -->
            <section class="card fade-in" style="margin-bottom: 2rem;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">üìà Gr√°fico de Evolu√ß√£o - Refei√ß√µes por Per√≠odo</h3>
                    <button id="btn-previsao-refeicoes" class="btn-previsao" style="background-color: #8b5cf6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 600; display: none; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#7c3aed'" onmouseout="this.style.backgroundColor='#8b5cf6'">
                        üîÆ Previs√£o
                    </button>
                </div>
                <div class="card-body">
                    <div id="grafico-refeicoes-container" style="position: relative; height: 600px;">
                        <canvas id="grafico-refeicoes" style="height: 600px; display: none;"></canvas>
                        <div class="chart-placeholder" id="placeholder-refeicoes" style="height: 600px;">
                            <div class="chart-content">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
                                <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Gr√°fico de S√©rie Temporal</h3>
                                <p style="color: var(--gray-600); max-width: 500px; margin: 0 auto;">
                                    Selecione os lotes e clique em "Aplicar" para visualizar o gr√°fico.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gr√°fico 2: Gastos -->
            <section class="card fade-in" style="margin-bottom: 2rem;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">üí∞ Gr√°fico de Evolu√ß√£o - Gastos por Per√≠odo</h3>
                    <button id="btn-previsao-gastos" class="btn-previsao" style="background-color: #8b5cf6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 600; display: none; transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#7c3aed'" onmouseout="this.style.backgroundColor='#8b5cf6'">
                        üîÆ Previs√£o
                    </button>
                </div>
                <div class="card-body">
                    <div id="grafico-gastos-container" style="position: relative; height: 600px;">
                        <canvas id="grafico-gastos" style="height: 600px; display: none;"></canvas>
                        <div class="chart-placeholder" id="placeholder-gastos" style="height: 600px;">
                            <div class="chart-content">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üíµ</div>
                                <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Gr√°fico de S√©rie Temporal</h3>
                                <p style="color: var(--gray-600); max-width: 500px; margin: 0 auto;">
                                    Selecione os lotes e clique em "Aplicar" para visualizar o gr√°fico.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- Modal de Confirma√ß√£o de Logout -->
    <!-- Modal de Exporta√ß√£o -->
    <div id="modal-exportacao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 11000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">üìä</div>
                <h3 style="margin-bottom: 0.5rem; color: var(--primary-color);">Exportar Relat√≥rios</h3>
                <p style="margin: 0; color: var(--gray-600); font-size: 0.95rem;">Selecione os gr√°ficos e o formato de exporta√ß√£o</p>
            </div>
            
            <!-- Sele√ß√£o de Gr√°ficos -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: var(--gray-700); font-size: 1rem; font-weight: 600;">üìà Gr√°ficos para Exportar</h4>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-refeicoes-total" value="refeicoes-total" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Refei√ß√µes - Total Geral</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-refeicoes-unidade" value="refeicoes-unidade" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Refei√ß√µes - Por Unidade</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-gastos-total" value="gastos-total" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Gastos - Total Geral</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-gastos-unidade" value="gastos-unidade" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Gastos - Por Unidade</span>
                    </label>
                </div>
            </div>
            
            <!-- Tipo de Visualiza√ß√£o (Normal/Acumulada) -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: var(--gray-700); font-size: 1rem; font-weight: 600;">üìä Tipo de Visualiza√ß√£o</h4>
                <div style="display: flex; gap: 0.75rem;">
                    <label style="flex: 1; display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="export-tipo" value="normal" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: var(--gray-700); font-weight: 500;">Normal</span>
                    </label>
                    
                    <label style="flex: 1; display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="export-tipo" value="acumulada" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: var(--gray-700); font-weight: 500;">Acumulada</span>
                    </label>
                </div>
            </div>
            
            <!-- Formato de Exporta√ß√£o -->
            <div style="margin-bottom: 2rem;">
                <h4 style="margin-bottom: 1rem; color: var(--gray-700); font-size: 1rem; font-weight: 600;">üíæ Formato de Exporta√ß√£o</h4>
                <div style="display: flex; gap: 0.75rem;">
                    <label style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1.25rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="export-formato" value="imagens" checked style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="font-size: 2rem;">üñºÔ∏è</div>
                        <span style="color: var(--gray-700); font-weight: 600; text-align: center;">Imagens PNG<br><small style="font-weight: 400; color: var(--gray-500);">(arquivo ZIP)</small></span>
                    </label>
                    
                    <label style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1.25rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="export-formato" value="pdf" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="font-size: 2rem;">üìÑ</div>
                        <span style="color: var(--gray-700); font-weight: 600; text-align: center;">PDF<br><small style="font-weight: 400; color: var(--gray-500);">(paisagem)</small></span>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="btn-cancelar-exportacao" style="min-width: 120px;">Cancelar</button>
                <button class="btn" id="btn-confirmar-exportacao" style="min-width: 160px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none;">
                    üì• Exportar
                </button>
            </div>
        </div>
    </div>

    <div id="modal-confirmacao-logout" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 11000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">üëã</div>
                <h3 style="margin-bottom: 1rem; color: #f59e0b;">Sair do Sistema</h3>
                <p style="margin: 0; color: var(--gray-700); line-height: 1.5; font-size: 1rem;">
                    Tem certeza que deseja sair do sistema?
                </p>
            </div>
            
            <div style="padding: 1rem; background-color: #fffbeb; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 2rem;">
                <p style="font-size: 0.875rem; margin: 0; color: #92400e;">
                    <strong>‚ÑπÔ∏è Informa√ß√£o:</strong> Voc√™ precisar√° fazer login novamente para acessar o sistema.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="btn-cancelar-logout" style="min-width: 120px;">Cancelar</button>
                <button class="btn" id="btn-confirmar-logout" style="min-width: 120px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;">Sair</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p style="margin: 0; color: var(--gray-400); font-size: 0.875rem;">
                ¬© 2025 SGMRP - Sistema de Gerenciamento de Mapas de Refei√ß√µes Penitenci√°rio
            </p>
        </div>
    </footer>

    <script>
        // Mapeamento de lotes para unidades (do backend)
        const lotesUnidadesMap = {{ lotes_unidades|tojson }};
        
        // Vari√°vel global para o gr√°fico
        let chartInstance = null;
        let modoVisualizacao = 'acumulado'; // 'acumulado', 'unidade', 'lote'
        let tipoVisualizacao = 'normal'; // 'normal', 'acumulada'
        let tipoAgrupamento = 'total'; // 'total', 'por-lote'
        
        // Vari√°veis para gr√°fico de gastos
        let chartInstanceGastos = null;
        let projecaoAtivaGastos = false;
        
        // Vari√°vel para armazenar inst√¢ncia do gr√°fico de refei√ß√µes
        let chartRefeicoesInstance = null;
        
        // Fun√ß√£o para carregar o gr√°fico de refei√ß√µes
        async function carregarGraficoRefeicoes() {
            try {
                // Resetar estado de previs√£o se estiver ativo
                if (previsaoAtivaRefeicoes) {
                    previsaoAtivaRefeicoes = false;
                    dadosOriginaisRefeicoes = null;
                    const btnPrevisao = document.getElementById('btn-previsao-refeicoes');
                    if (btnPrevisao) btnPrevisao.textContent = 'üîÆ Previs√£o';
                }
                
                // Obter lotes selecionados
                const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                const lotesSelecionados = Array.from(checkboxes).map(cb => cb.value);
                
                if (lotesSelecionados.length === 0) {
                    return;
                }
                
                // Obter tipo de visualiza√ß√£o e agrupamento
                const tipo = tipoVisualizacao;
                const agrupamento = tipoAgrupamento;
                
                // Enviar unidades se houver apenas 1 lote selecionado (aplica filtro em todos os modos)
                let unidadesSelecionadas = [];
                if (lotesSelecionados.length === 1) {
                    const unidadesCheckboxes = document.querySelectorAll('.filtro-unidade-checkbox:checked');
                    unidadesSelecionadas = Array.from(unidadesCheckboxes).map(cb => parseInt(cb.value));
                }
                
                // Fazer requisi√ß√£o √† API
                const response = await fetch('/api/dashboard/grafico-refeicoes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lotes: lotesSelecionados,
                        unidades: unidadesSelecionadas,
                        tipo: tipo,
                        agrupamento: agrupamento
                    })
                });
                
                const data = await response.json();
                
                // Verificar se houve erro (status HTTP 4xx ou 5xx, ou success: false)
                if (!response.ok || !data.success) {
                    mostrarNotificacao('Erro', data.error || 'Erro ao carregar dados do gr√°fico', 'error');
                    return;
                }
                
                // Renderizar gr√°fico
                renderizarGraficoRefeicoes(data);
                
            } catch (error) {
                mostrarNotificacao('Erro', 'Erro ao carregar o gr√°fico', 'error');
            }
        }
        
        // Fun√ß√£o para renderizar o gr√°fico de refei√ß√µes
        function renderizarGraficoRefeicoes(dados) {
            const canvas = document.getElementById('grafico-refeicoes');
            const placeholder = document.getElementById('placeholder-refeicoes');
            
            // Ocultar placeholder e mostrar canvas
            placeholder.style.display = 'none';
            canvas.style.display = 'block';
            
            // Destruir gr√°fico anterior se existir
            if (chartRefeicoesInstance) {
                chartRefeicoesInstance.destroy();
            }
            
            // Formatar labels (YYYY-MM -> M√™s/Ano)
            const labelsFormatados = dados.labels.map(label => {
                const [ano, mes] = label.split('-');
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                return `${meses[parseInt(mes) - 1]}/${ano}`;
            });
            
            // Preparar datasets com cores
            const cores = [
                { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },      // Azul
                { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },      // Verde
                { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },      // Laranja
                { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },       // Vermelho
                { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },      // Roxo
                { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' },      // Rosa
                { border: '#14b8a6', bg: 'rgba(20, 184, 166, 0.1)' },      // Turquesa
                { border: '#f97316', bg: 'rgba(249, 115, 22, 0.1)' },      // Laranja escuro
                { border: '#06b6d4', bg: 'rgba(6, 182, 212, 0.1)' },       // Ciano
                { border: '#84cc16', bg: 'rgba(132, 204, 22, 0.1)' },      // Lima
                { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' },      // √çndigo
                { border: '#d946ef', bg: 'rgba(217, 70, 239, 0.1)' },      // F√∫csia
                { border: '#eab308', bg: 'rgba(234, 179, 8, 0.1)' },       // Amarelo
                { border: '#22c55e', bg: 'rgba(34, 197, 94, 0.1)' },       // Verde claro
                { border: '#a855f7', bg: 'rgba(168, 85, 247, 0.1)' },      // Roxo claro
                { border: '#0ea5e9', bg: 'rgba(14, 165, 233, 0.1)' },      // Azul claro
                { border: '#f43f5e', bg: 'rgba(244, 63, 94, 0.1)' },       // Rosa escuro
                { border: '#64748b', bg: 'rgba(100, 116, 139, 0.1)' },     // Cinza azulado
                { border: '#fb923c', bg: 'rgba(251, 146, 60, 0.1)' },      // Laranja m√©dio
                { border: '#2dd4bf', bg: 'rgba(45, 212, 191, 0.1)' }       // Turquesa claro
            ];
            
            const datasets = dados.datasets.map((dataset, index) => {
                const cor = cores[index % cores.length];
                return {
                    label: dataset.label,
                    data: dataset.data,
                    borderColor: cor.border,
                    backgroundColor: cor.bg,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: (dados.agrupamento === 'por-lote' || dados.agrupamento === 'por-unidade') ? false : true,
                    pointRadius: 6,
                    pointHoverRadius: 10,
                    pointBackgroundColor: cor.border,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointHoverBorderWidth: 3,
                    pointHoverBackgroundColor: cor.border,
                    pointHoverBorderColor: '#ffffff'
                };
            });
            
            // Criar gr√°fico
            const ctx = canvas.getContext('2d');
            chartRefeicoesInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labelsFormatados,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 13,
                                    weight: '600'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            mode: 'point',
                            intersect: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.85)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            displayColors: true,
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += new Intl.NumberFormat('pt-BR').format(context.parsed.y);
                                    label += ' refei√ß√µes';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grace: '15%',
                            grid: {
                                color: 'rgba(0, 0, 0, 0.08)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '500'
                                },
                                callback: function(value) {
                                    return new Intl.NumberFormat('pt-BR').format(value);
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'point',
                        intersect: true
                    }
                }
            });
        }

        // ===== Gr√°fico de Gastos =====
        let chartGastos = null;

        async function carregarGraficoGastos() {
            try {
                // Resetar estado de previs√£o se estiver ativo
                if (previsaoAtivaGastos) {
                    previsaoAtivaGastos = false;
                    dadosOriginaisGastos = null;
                    const btnPrevisao = document.getElementById('btn-previsao-gastos');
                    if (btnPrevisao) btnPrevisao.textContent = 'üîÆ Previs√£o';
                }
                
                const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                const lotesSelecionados = Array.from(checkboxes).map(cb => cb.value);
                if (lotesSelecionados.length === 0) return;

                const tipo = tipoVisualizacao;
                const agrupamento = tipoAgrupamento;

                let unidadesSelecionadas = [];
                if (lotesSelecionados.length === 1) {
                    const unidadesCheckboxes = document.querySelectorAll('.filtro-unidade-checkbox:checked');
                    unidadesSelecionadas = Array.from(unidadesCheckboxes).map(cb => parseInt(cb.value));
                }

                const response = await fetch('/api/dashboard/grafico-gastos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lotes: lotesSelecionados,
                        unidades: unidadesSelecionadas,
                        tipo: tipo,
                        agrupamento: agrupamento
                    })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    mostrarNotificacao('Erro', data.error || 'Erro ao carregar dados do gr√°fico de gastos', 'error');
                    return;
                }
                renderizarGraficoGastos(data);
            } catch (e) {
                mostrarNotificacao('Erro', 'Erro inesperado ao carregar gr√°fico de gastos', 'error');
            }
        }

        function renderizarGraficoGastos(dados) {
            const canvas = document.getElementById('grafico-gastos');
            const placeholder = document.getElementById('placeholder-gastos');
            if (!canvas) return;
            canvas.style.display = 'block';
            if (placeholder) placeholder.style.display = 'none';

            if (chartGastos) chartGastos.destroy();

            const labelsFormatados = (dados.labels || dados.periodos).map(periodo => {
                const [ano, mes] = periodo.split('-');
                const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
                return `${meses[parseInt(mes) - 1]}/${ano}`;
            });

            // Paleta e estilo iguais ao gr√°fico de refei√ß√µes
            const cores = [
                { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },      // Azul
                { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },      // Verde
                { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },      // Laranja
                { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },       // Vermelho
                { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },      // Roxo
                { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' },      // Rosa
                { border: '#14b8a6', bg: 'rgba(20, 184, 166, 0.1)' },      // Turquesa
                { border: '#f97316', bg: 'rgba(249, 115, 22, 0.1)' },      // Laranja escuro
                { border: '#06b6d4', bg: 'rgba(6, 182, 212, 0.1)' },       // Ciano
                { border: '#84cc16', bg: 'rgba(132, 204, 22, 0.1)' },      // Lima
                { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' },      // √çndigo
                { border: '#d946ef', bg: 'rgba(217, 70, 239, 0.1)' },      // F√∫csia
                { border: '#eab308', bg: 'rgba(234, 179, 8, 0.1)' },       // Amarelo
                { border: '#22c55e', bg: 'rgba(34, 197, 94, 0.1)' },       // Verde claro
                { border: '#a855f7', bg: 'rgba(168, 85, 247, 0.1)' },      // Roxo claro
                { border: '#0ea5e9', bg: 'rgba(14, 165, 233, 0.1)' },      // Azul claro
                { border: '#f43f5e', bg: 'rgba(244, 63, 94, 0.1)' },       // Rosa escuro
                { border: '#64748b', bg: 'rgba(100, 116, 139, 0.1)' },     // Cinza azulado
                { border: '#fb923c', bg: 'rgba(251, 146, 60, 0.1)' },      // Laranja m√©dio
                { border: '#2dd4bf', bg: 'rgba(45, 212, 191, 0.1)' }       // Turquesa claro
            ];

            const datasets = dados.datasets.map((dataset, index) => {
                const cor = cores[index % cores.length];
                return {
                    label: dataset.label,
                    data: dataset.data,
                    borderColor: cor.border,
                    backgroundColor: cor.bg,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: (dados.agrupamento === 'por-lote' || dados.agrupamento === 'por-unidade') ? false : true,
                    pointRadius: 6,
                    pointHoverRadius: 10,
                    pointBackgroundColor: cor.border,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointHoverBorderWidth: 3,
                    pointHoverBackgroundColor: cor.border,
                    pointHoverBorderColor: '#ffffff'
                };
            });

            chartGastos = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: { labels: labelsFormatados, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            right: 20,
                            bottom: 10,
                            left: 10
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 13,
                                    weight: '600'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            mode: 'point',
                            intersect: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.85)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            displayColors: true,
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grace: '15%',
                            grid: {
                                color: 'rgba(0, 0, 0, 0.08)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '500'
                                },
                                callback: function(value) {
                                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
                                }
                            }
                        }
                    },
                    interaction: { mode: 'point', intersect: true }
                }
            });
        }
        
        // Fun√ß√£o para mostrar notifica√ß√£o customizada
        function mostrarNotificacao(titulo, mensagem, tipo = 'info', duracao = 5000) {
            // Criar elemento de notifica√ß√£o
            const notification = document.createElement('div');
            notification.className = 'custom-notification';
            
            // √çcones por tipo
            const icones = {
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå',
                'success': '‚úÖ',
                'info': '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div class="notification-content ${tipo}">
                    <div class="notification-icon">${icones[tipo] || icones['info']}</div>
                    <div class="notification-body">
                        <div class="notification-title">${titulo}</div>
                        <div class="notification-message">${mensagem}</div>
                    </div>
                    <button class="notification-close" onclick="this.closest('.custom-notification').remove()">‚úï</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remover ap√≥s dura√ß√£o
            setTimeout(() => {
                notification.classList.add('closing');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, duracao);
        }

        // ===== Fun√ß√µes de Previs√£o =====
        
        // Vari√°veis para armazenar dados da previs√£o
        let previsaoAtivaRefeicoes = false;
        let previsaoAtivaGastos = false;
        let dadosOriginaisRefeicoes = null;
        let dadosOriginaisGastos = null;
        
        // Fun√ß√£o para calcular regress√£o linear
        function calcularRegressaoLinear(dados) {
            const n = dados.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            
            dados.forEach((y, x) => {
                sumX += x;
                sumY += y;
                sumXY += x * y;
                sumX2 += x * x;
            });
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            return { slope, intercept };
        }
        
        // Fun√ß√£o para gerar meses futuros
        function gerarMesesFuturos(ultimaData, dataFim) {
            const meses = [];
            const [anoUltimo, mesUltimo] = ultimaData.split('-').map(Number);
            const [anoFim, mesFim] = dataFim.split('-').map(Number);
            
            let ano = anoUltimo;
            let mes = mesUltimo + 1;
            
            while (ano < anoFim || (ano === anoFim && mes <= mesFim)) {
                if (mes > 12) {
                    mes = 1;
                    ano++;
                }
                meses.push(`${ano}-${String(mes).padStart(2, '0')}`);
                mes++;
            }
            
            return meses;
        }
        
        // Fun√ß√£o para adicionar previs√£o ao gr√°fico de refei√ß√µes
        async function adicionarPrevisaoRefeicoes() {
            try {
                if (previsaoAtivaRefeicoes) {
                    // Remover previs√£o
                    previsaoAtivaRefeicoes = false;
                    if (dadosOriginaisRefeicoes) {
                        renderizarGraficoRefeicoes(dadosOriginaisRefeicoes);
                    }
                    document.getElementById('btn-previsao-refeicoes').textContent = 'üîÆ Previs√£o';
                    return;
                }
                
                // Obter lote selecionado
                const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                if (checkboxes.length !== 1) {
                    mostrarNotificacao('Erro', 'Selecione apenas um lote para fazer previs√£o', 'error');
                    return;
                }
                
                const loteId = checkboxes[0].value;
                
                // Buscar dados do lote
                const loteResponse = await fetch(`/api/lote/${loteId}`);
                if (!loteResponse.ok) throw new Error('Erro ao buscar dados do lote');
                const lote = await loteResponse.json();
                
                if (!lote.data_fim) {
                    mostrarNotificacao('Erro', 'Lote n√£o possui data de fim definida', 'error');
                    return;
                }
                
                // Obter dados atuais do gr√°fico
                if (!chartRefeicoesInstance || !chartRefeicoesInstance.data) {
                    mostrarNotificacao('Erro', 'Nenhum gr√°fico para fazer previs√£o', 'error');
                    return;
                }
                
                // Salvar dados originais
                dadosOriginaisRefeicoes = {
                    labels: [...chartRefeicoesInstance.data.labels],
                    datasets: chartRefeicoesInstance.data.datasets.map(ds => ({
                        ...ds,
                        data: [...ds.data]
                    }))
                };
                
                // Buscar dados desagregados por tipo de refei√ß√£o
                const unidadesCheckboxes = document.querySelectorAll('.filtro-unidade-checkbox:checked');
                const unidadesSelecionadas = Array.from(unidadesCheckboxes).map(cb => parseInt(cb.value));
                
                const response = await fetch('/api/dashboard/grafico-refeicoes-desagregado', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lotes: [loteId],
                        unidades: unidadesSelecionadas,
                        agrupamento: tipoAgrupamento
                    })
                });
                
                if (!response.ok) throw new Error('Erro ao buscar dados desagregados');
                const dadosDesagregados = await response.json();
                
                console.log('üìä Dados desagregados recebidos:', dadosDesagregados);
                
                const periodos = dadosDesagregados.labels;
                const tiposRefeicao = Object.keys(dadosDesagregados.dados_por_tipo);
                
                // Para cada dataset atual, calcular previs√£o baseada em previs√µes por tipo
                const novosDatasets = [];
                chartRefeicoesInstance.data.datasets.forEach((dataset, idx) => {
                    // Adicionar dataset original
                    novosDatasets.push({...dataset});
                    
                    // Determinar grupo_key baseado no tipo de agrupamento
                    let grupo_key;
                    if (tipoAgrupamento === 'total') {
                        grupo_key = parseInt(loteId);
                    } else {  // por-unidade
                        // Encontrar unidade_id correspondente ao dataset atual
                        // Assumindo que datasets t√™m uma propriedade 'unidade_id' ou podemos inferir do √≠ndice
                        grupo_key = unidadesSelecionadas[idx];
                        if (!grupo_key) {
                            console.log('N√£o foi poss√≠vel determinar grupo_key para dataset:', dataset.label);
                            return;
                        }
                    }
                    
                    console.log(`üîç Calculando previs√£o para ${dataset.label} (grupo_key: ${grupo_key})`);
                    
                    // Para cada tipo de refei√ß√£o, calcular previs√£o separada
                    const previsoesPorTipo = {};
                    
                    for (const tipoRefeicao of tiposRefeicao) {
                        // Extrair s√©rie temporal deste tipo para este grupo
                        const serieTemporalTipo = [];
                        for (const periodo of periodos) {
                            const valor = dadosDesagregados.dados_por_tipo[tipoRefeicao][periodo][grupo_key] || 0;
                            serieTemporalTipo.push(valor);
                        }
                        
                        console.log(`  üìà ${tipoRefeicao}: ${serieTemporalTipo.length} pontos`);
                        
                        // Remover primeiro m√™s (outlier)
                        const dadosSemOutlier = serieTemporalTipo.slice(1);
                        
                        if (dadosSemOutlier.length < 2) {
                            console.log(`  ‚ö†Ô∏è ${tipoRefeicao}: dados insuficientes`);
                            previsoesPorTipo[tipoRefeicao] = [];
                            continue;
                        }
                        
                        // Calcular regress√£o linear
                        const { slope, intercept } = calcularRegressaoLinear(dadosSemOutlier);
                        console.log(`  üî¢ ${tipoRefeicao}: slope=${slope.toFixed(2)}, intercept=${intercept.toFixed(2)}`);
                        
                        // Gerar meses futuros
                        const ultimaData = periodos[periodos.length - 1];
                        const mesesFuturos = gerarMesesFuturos(ultimaData, lote.data_fim);
                        
                        // Calcular previs√µes para este tipo
                        const previsoesTipo = [];
                        const baseIndex = serieTemporalTipo.length;
                        mesesFuturos.forEach((mes, idx) => {
                            const x = baseIndex + idx;
                            const previsao = Math.max(0, slope * x + intercept);
                            previsoesTipo.push(Math.round(previsao));
                        });
                        
                        previsoesPorTipo[tipoRefeicao] = previsoesTipo;
                        console.log(`  ‚úÖ ${tipoRefeicao}: ${previsoesTipo.length} previs√µes geradas`);
                    }
                    
                    // Somar previs√µes de todos os tipos para cada m√™s futuro
                    const numMesesFuturos = Math.max(...Object.values(previsoesPorTipo).map(arr => arr.length));
                    const previsoesMensaisSomadas = [];
                    
                    for (let i = 0; i < numMesesFuturos; i++) {
                        let somaPrevisoes = 0;
                        for (const tipoRefeicao of tiposRefeicao) {
                            somaPrevisoes += previsoesPorTipo[tipoRefeicao][i] || 0;
                        }
                        previsoesMensaisSomadas.push(somaPrevisoes);
                    }
                    
                    console.log(`  üéØ Previs√µes mensais somadas: ${previsoesMensaisSomadas}`);
                    
                    // Se modo acumulado, acumular as previs√µes
                    let previsoesFinais = previsoesMensaisSomadas;
                    if (tipoVisualizacao === 'acumulada') {
                        const ultimoValorReal = dataset.data[dataset.data.length - 1];
                        previsoesFinais = [];
                        let acumulado = ultimoValorReal;
                        previsoesMensaisSomadas.forEach(valorMensal => {
                            acumulado += valorMensal;
                            previsoesFinais.push(acumulado);
                        });
                        console.log(`  üìä Previs√µes acumuladas: ${previsoesFinais.slice(0, 3)}...`);
                    }
                    
                    // Criar dataset de previs√£o
                    if (previsoesFinais.length > 0) {
                        const dataPrevisao = [...new Array(dataset.data.length).fill(null), ...previsoesFinais];
                        dataPrevisao[dataset.data.length - 1] = dataset.data[dataset.data.length - 1];
                        
                        // Determinar cor baseado no tipo de agrupamento
                        let corPrevisao, corFundoPrevisao, corPontoPrevisao;
                        if (tipoAgrupamento === 'total') {
                            corPrevisao = '#8b5cf6';
                            corFundoPrevisao = 'rgba(139, 92, 246, 0.1)';
                            corPontoPrevisao = '#8b5cf6';
                        } else {
                            const corOriginal = dataset.borderColor;
                            if (corOriginal.startsWith('#')) {
                                const r = parseInt(corOriginal.substr(1, 2), 16);
                                const g = parseInt(corOriginal.substr(3, 2), 16);
                                const b = parseInt(corOriginal.substr(5, 2), 16);
                                const lighten = (val) => Math.min(255, val + (255 - val) * 0.3);
                                corPrevisao = `rgb(${lighten(r)}, ${lighten(g)}, ${lighten(b)})`;
                                corFundoPrevisao = `rgba(${lighten(r)}, ${lighten(g)}, ${lighten(b)}, 0.1)`;
                                corPontoPrevisao = corPrevisao;
                            } else {
                                corPrevisao = corOriginal;
                                corFundoPrevisao = dataset.backgroundColor;
                                corPontoPrevisao = corOriginal;
                            }
                        }
                        
                        novosDatasets.push({
                            label: `${dataset.label} (Previs√£o)`,
                            data: dataPrevisao,
                            borderColor: corPrevisao,
                            backgroundColor: corFundoPrevisao,
                            borderWidth: 3,
                            borderDash: [10, 5],
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 8,
                            pointBackgroundColor: corPontoPrevisao,
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointHoverBorderWidth: 3,
                            fill: tipoAgrupamento === 'total'
                        });
                    }
                });
                
                // Atualizar labels
                const ultimaData = chartRefeicoesInstance.data.labels[chartRefeicoesInstance.data.labels.length - 1];
                const [mesUltimo, anoUltimo] = ultimaData.split('/');
                const mesIdx = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].indexOf(mesUltimo);
                const ano = anoUltimo.length === 2 ? '20' + anoUltimo : anoUltimo;
                
                const mesesFuturos = gerarMesesFuturos(
                    `${ano}-${String(mesIdx + 1).padStart(2, '0')}`,
                    lote.data_fim
                );
                
                const labelsFormatados = mesesFuturos.map(data => {
                    const [ano, mes] = data.split('-');
                    const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
                    return `${meses[parseInt(mes) - 1]}/${ano}`;
                });
                
                const novosLabels = [...chartRefeicoesInstance.data.labels, ...labelsFormatados];
                
                // Atualizar gr√°fico
                chartRefeicoesInstance.data.labels = novosLabels;
                chartRefeicoesInstance.data.datasets = novosDatasets;
                chartRefeicoesInstance.update();
                
                console.log('‚úÖ Gr√°fico atualizado com previs√µes por tipo de refei√ß√£o!');
                
                previsaoAtivaRefeicoes = true;
                document.getElementById('btn-previsao-refeicoes').textContent = '‚ùå Remover Previs√£o';
                mostrarNotificacao('Sucesso', 'Previs√£o adicionada ao gr√°fico', 'success', 3000);
                
            } catch (error) {
                console.error('Erro ao gerar previs√£o:', error);
                mostrarNotificacao('Erro', 'Erro ao gerar previs√£o', 'error');
            }
        }
        
        // Fun√ß√£o para adicionar previs√£o ao gr√°fico de gastos
        async function adicionarPrevisaoGastos() {
            try {
                if (previsaoAtivaGastos) {
                    // Remover previs√£o
                    previsaoAtivaGastos = false;
                    if (dadosOriginaisGastos) {
                        renderizarGraficoGastos(dadosOriginaisGastos);
                    }
                    document.getElementById('btn-previsao-gastos').textContent = 'üîÆ Previs√£o';
                    return;
                }
                
                // Obter lote selecionado
                const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                if (checkboxes.length !== 1) {
                    mostrarNotificacao('Erro', 'Selecione apenas um lote para fazer previs√£o', 'error');
                    return;
                }
                
                const loteId = checkboxes[0].value;
                
                // Buscar dados do lote
                const loteResponse = await fetch(`/api/lote/${loteId}`);
                if (!loteResponse.ok) throw new Error('Erro ao buscar dados do lote');
                const lote = await loteResponse.json();
                
                if (!lote.data_fim) {
                    mostrarNotificacao('Erro', 'Lote n√£o possui data de fim definida', 'error');
                    return;
                }
                
                // Obter dados atuais do gr√°fico
                if (!chartGastos || !chartGastos.data) {
                    mostrarNotificacao('Erro', 'Nenhum gr√°fico para fazer previs√£o', 'error');
                    return;
                }
                
                // Salvar dados originais
                dadosOriginaisGastos = {
                    labels: [...chartGastos.data.labels],
                    datasets: chartGastos.data.datasets.map(ds => ({
                        ...ds,
                        data: [...ds.data]
                    }))
                };
                
                // Buscar dados desagregados por tipo de refei√ß√£o
                const unidadesCheckboxes = document.querySelectorAll('.filtro-unidade-checkbox:checked');
                const unidadesSelecionadas = Array.from(unidadesCheckboxes).map(cb => parseInt(cb.value));
                
                const response = await fetch('/api/dashboard/grafico-gastos-desagregado', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lotes: [loteId],
                        unidades: unidadesSelecionadas,
                        agrupamento: tipoAgrupamento
                    })
                });
                
                if (!response.ok) throw new Error('Erro ao buscar dados desagregados');
                const dadosDesagregados = await response.json();
                
                console.log('üí∞ Dados de gastos desagregados recebidos:', dadosDesagregados);
                
                const periodos = dadosDesagregados.labels;
                const tiposRefeicao = Object.keys(dadosDesagregados.dados_por_tipo);
                
                // Para cada dataset atual, calcular previs√£o baseada em previs√µes por tipo
                const novosDatasets = [];
                chartGastos.data.datasets.forEach((dataset, idx) => {
                    // Adicionar dataset original
                    novosDatasets.push({...dataset});
                    
                    // Determinar grupo_key baseado no tipo de agrupamento
                    let grupo_key;
                    if (tipoAgrupamento === 'total') {
                        grupo_key = parseInt(loteId);
                    } else {  // por-unidade
                        grupo_key = unidadesSelecionadas[idx];
                        if (!grupo_key) {
                            console.log('N√£o foi poss√≠vel determinar grupo_key para dataset:', dataset.label);
                            return;
                        }
                    }
                    
                    console.log(`üí∞ Calculando previs√£o de gastos para ${dataset.label} (grupo_key: ${grupo_key})`);
                    
                    // Para cada tipo de refei√ß√£o, calcular previs√£o separada
                    const previsoesPorTipo = {};
                    
                    for (const tipoRefeicao of tiposRefeicao) {
                        // Extrair s√©rie temporal deste tipo para este grupo
                        const serieTemporalTipo = [];
                        for (const periodo of periodos) {
                            const valor = dadosDesagregados.dados_por_tipo[tipoRefeicao][periodo][grupo_key] || 0;
                            serieTemporalTipo.push(valor);
                        }
                        
                        console.log(`  üí∏ ${tipoRefeicao}: ${serieTemporalTipo.length} pontos`);
                        
                        // Remover primeiro m√™s (outlier)
                        const dadosSemOutlier = serieTemporalTipo.slice(1);
                        
                        if (dadosSemOutlier.length < 2) {
                            console.log(`  ‚ö†Ô∏è ${tipoRefeicao}: dados insuficientes`);
                            previsoesPorTipo[tipoRefeicao] = [];
                            continue;
                        }
                        
                        // Calcular regress√£o linear
                        const { slope, intercept } = calcularRegressaoLinear(dadosSemOutlier);
                        console.log(`  üî¢ ${tipoRefeicao}: slope=${slope.toFixed(2)}, intercept=${intercept.toFixed(2)}`);
                        
                        // Gerar meses futuros
                        const ultimaData = periodos[periodos.length - 1];
                        const mesesFuturos = gerarMesesFuturos(ultimaData, lote.data_fim);
                        
                        // Calcular previs√µes para este tipo
                        const previsoesTipo = [];
                        const baseIndex = serieTemporalTipo.length;
                        mesesFuturos.forEach((mes, idx) => {
                            const x = baseIndex + idx;
                            const previsao = Math.max(0, slope * x + intercept);
                            previsoesTipo.push(previsao);
                        });
                        
                        previsoesPorTipo[tipoRefeicao] = previsoesTipo;
                        console.log(`  ‚úÖ ${tipoRefeicao}: ${previsoesTipo.length} previs√µes geradas`);
                    }
                    
                    // Somar previs√µes de todos os tipos para cada m√™s futuro
                    const numMesesFuturos = Math.max(...Object.values(previsoesPorTipo).map(arr => arr.length));
                    const previsoesMensaisSomadas = [];
                    
                    for (let i = 0; i < numMesesFuturos; i++) {
                        let somaPrevisoes = 0;
                        for (const tipoRefeicao of tiposRefeicao) {
                            somaPrevisoes += previsoesPorTipo[tipoRefeicao][i] || 0;
                        }
                        previsoesMensaisSomadas.push(somaPrevisoes);
                    }
                    
                    console.log(`  üéØ Previs√µes mensais de gastos somadas: [${previsoesMensaisSomadas.slice(0, 3).map(v => v.toFixed(2)).join(', ')}...]`);
                    
                    // Se modo acumulado, acumular as previs√µes
                    let previsoesFinais = previsoesMensaisSomadas;
                    if (tipoVisualizacao === 'acumulada') {
                        const ultimoValorReal = dataset.data[dataset.data.length - 1];
                        previsoesFinais = [];
                        let acumulado = ultimoValorReal;
                        previsoesMensaisSomadas.forEach(valorMensal => {
                            acumulado += valorMensal;
                            previsoesFinais.push(acumulado);
                        });
                        console.log(`  üìä Previs√µes de gastos acumuladas: [${previsoesFinais.slice(0, 3).map(v => v.toFixed(2)).join(', ')}...]`);
                    }
                    
                    // Criar dataset de previs√£o
                    if (previsoesFinais.length > 0) {
                        const dataPrevisao = [...new Array(dataset.data.length).fill(null), ...previsoesFinais];
                        dataPrevisao[dataset.data.length - 1] = dataset.data[dataset.data.length - 1];
                        
                        // Determinar cor baseado no tipo de agrupamento
                        let corPrevisao, corFundoPrevisao, corPontoPrevisao;
                        if (tipoAgrupamento === 'total') {
                            corPrevisao = '#8b5cf6';
                            corFundoPrevisao = 'rgba(139, 92, 246, 0.1)';
                            corPontoPrevisao = '#8b5cf6';
                        } else {
                            const corOriginal = dataset.borderColor;
                            if (corOriginal.startsWith('#')) {
                                const r = parseInt(corOriginal.substr(1, 2), 16);
                                const g = parseInt(corOriginal.substr(3, 2), 16);
                                const b = parseInt(corOriginal.substr(5, 2), 16);
                                const lighten = (val) => Math.min(255, val + (255 - val) * 0.3);
                                corPrevisao = `rgb(${lighten(r)}, ${lighten(g)}, ${lighten(b)})`;
                                corFundoPrevisao = `rgba(${lighten(r)}, ${lighten(g)}, ${lighten(b)}, 0.1)`;
                                corPontoPrevisao = corPrevisao;
                            } else {
                                corPrevisao = corOriginal;
                                corFundoPrevisao = dataset.backgroundColor;
                                corPontoPrevisao = corOriginal;
                            }
                        }
                        
                        novosDatasets.push({
                            label: `${dataset.label} (Previs√£o)`,
                            data: dataPrevisao,
                            borderColor: corPrevisao,
                            backgroundColor: corFundoPrevisao,
                            borderWidth: 3,
                            borderDash: [10, 5],
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 8,
                            pointBackgroundColor: corPontoPrevisao,
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointHoverBorderWidth: 3,
                            fill: tipoAgrupamento === 'total'
                        });
                    }
                });
                
                // Atualizar labels
                const ultimaData = chartGastos.data.labels[chartGastos.data.labels.length - 1];
                const [mesUltimo, anoUltimo] = ultimaData.split('/');
                const mesIdx = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'].indexOf(mesUltimo);
                const ano = anoUltimo.length === 2 ? '20' + anoUltimo : anoUltimo;
                
                const mesesFuturos = gerarMesesFuturos(
                    `${ano}-${String(mesIdx + 1).padStart(2, '0')}`,
                    lote.data_fim
                );
                
                const labelsFormatados = mesesFuturos.map(data => {
                    const [ano, mes] = data.split('-');
                    const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
                    return `${meses[parseInt(mes) - 1]}/${ano}`;
                });
                
                const novosLabels = [...chartGastos.data.labels, ...labelsFormatados];
                
                // Se modo Total E Acumulado, adicionar linha do valor contratual
                if (tipoAgrupamento === 'total' && tipoVisualizacao === 'acumulada' && lote.valor_contratual) {
                    const valorContratual = lote.valor_contratual;
                    const tamanhoTotal = novosLabels.length;
                    const dadosValorContratual = new Array(tamanhoTotal).fill(valorContratual);
                    
                    // Formatar valor para exibir no gr√°fico
                    const valorFormatado = new Intl.NumberFormat('pt-BR', { 
                        style: 'currency', 
                        currency: 'BRL', 
                        minimumFractionDigits: 0, 
                        maximumFractionDigits: 0 
                    }).format(valorContratual);
                    
                    novosDatasets.push({
                        label: 'Valor Contratual',
                        data: dadosValorContratual,
                        borderColor: '#ef4444',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        fill: false,
                        datalabels: {
                            display: true,
                            align: 'end',
                            anchor: 'end',
                            formatter: () => valorFormatado,
                            color: '#ef4444',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            borderRadius: 4,
                            padding: 6
                        }
                    });
                }
                
                // Plugin customizado para desenhar texto do valor contratual na linha
                const pluginValorContratual = {
                    id: 'valorContratualLabel',
                    afterDatasetsDraw(chart) {
                        const ctx = chart.ctx;
                        const datasets = chart.data.datasets;
                        
                        datasets.forEach((dataset, datasetIndex) => {
                            if (dataset.label === 'Valor Contratual' && dataset.datalabels) {
                                const meta = chart.getDatasetMeta(datasetIndex);
                                const middleIndex = Math.floor(meta.data.length / 2);
                                const point = meta.data[middleIndex];
                                
                                if (point) {
                                    const valor = dataset.datalabels.formatter();
                                    
                                    ctx.save();
                                    ctx.font = 'bold 11px Arial';
                                    ctx.fillStyle = '#ef4444';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    
                                    const textMetrics = ctx.measureText(valor);
                                    const textWidth = textMetrics.width;
                                    const textHeight = 18;
                                    const padding = 5;
                                    const x = point.x;
                                    const y = point.y - 8; // Acima da linha
                                    
                                    // Fundo branco com borda
                                    ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
                                    ctx.fillRect(x - textWidth/2 - padding, y - textHeight, textWidth + padding * 2, textHeight);
                                    ctx.strokeStyle = '#ef4444';
                                    ctx.lineWidth = 1;
                                    ctx.strokeRect(x - textWidth/2 - padding, y - textHeight, textWidth + padding * 2, textHeight);
                                    
                                    // Texto
                                    ctx.fillStyle = '#ef4444';
                                    ctx.fillText(valor, x, y - 3);
                                    ctx.restore();
                                }
                            }
                        });
                    }
                };
                
                // Registrar o plugin globalmente se ainda n√£o estiver registrado
                if (!Chart.registry.plugins.get('valorContratualLabel')) {
                    Chart.register(pluginValorContratual);
                }
                
                // Atualizar gr√°fico
                chartGastos.data.labels = novosLabels;
                chartGastos.data.datasets = novosDatasets;
                chartGastos.update();
                
                console.log('‚úÖ Gr√°fico de gastos atualizado com previs√µes por tipo de refei√ß√£o!');
                
                previsaoAtivaGastos = true;
                document.getElementById('btn-previsao-gastos').textContent = '‚ùå Remover Previs√£o';
                mostrarNotificacao('Sucesso', 'Previs√£o adicionada ao gr√°fico', 'success', 3000);
                
            } catch (error) {
                console.error('Erro ao gerar previs√£o:', error);
                mostrarNotificacao('Erro', 'Erro ao gerar previs√£o', 'error');
            }
        }

        // Vari√°vel global para guardar o scroll handler do overlay
        let overlayScrollHandler = null;

        // Fun√ß√£o para bloquear bot√µes de tipo e agrupamento
        function bloquearBotoesGrafico() {
            // Bot√µes de tipo de visualiza√ß√£o
            document.querySelectorAll('.btn-tipo').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            // Bot√µes de agrupamento
            document.querySelectorAll('.btn-agrupamento').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
        }
        
        // Fun√ß√£o para desbloquear bot√µes de tipo e agrupamento
        function desbloquearBotoesGrafico(lotesCount = 1) {
            // Bot√µes de tipo de visualiza√ß√£o
            document.querySelectorAll('.btn-tipo').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
            
            // Bot√µes de agrupamento
            document.querySelectorAll('.btn-agrupamento').forEach(btn => {
                // "Por Unidade" s√≥ funciona com 1 lote
                // "Por Lote" s√≥ funciona com 2+ lotes
                if (btn.id === 'agrupamento-por-unidade' && lotesCount !== 1) {
                    btn.classList.add('bloqueado');
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'pointer';
                    btn.style.pointerEvents = 'auto';
                    btn.removeAttribute('disabled');
                    
                    // Se estava selecionado "Por Unidade", mudar para "Total"
                    if (tipoAgrupamento === 'por-unidade') {
                        tipoAgrupamento = 'total';
                        
                        // Remover estilos ativos de todos os bot√µes de agrupamento
                        document.querySelectorAll('.btn-agrupamento').forEach(b => {
                            b.classList.remove('active');
                            b.style.background = 'transparent';
                            b.style.color = 'var(--gray-600)';
                            b.style.boxShadow = 'none';
                        });
                        
                        // Ativar bot√£o "Total"
                        const btnTotal = document.getElementById('agrupamento-total');
                        btnTotal.classList.add('active');
                        btnTotal.style.background = 'var(--primary-color)';
                        btnTotal.style.color = 'white';
                        btnTotal.style.boxShadow = '0 2px 4px rgba(59,130,246,0.3)';
                        
                        // Recarregar gr√°ficos com o novo agrupamento
                        carregarGraficoRefeicoes();
                        carregarGraficoGastos();
                    }
                    
                    // WORKAROUND: Criar overlay transparente para capturar clicks
                    setTimeout(() => {
                        const btnTest = document.getElementById('agrupamento-por-unidade');
                        if (btnTest) {
                            // Fun√ß√£o para posicionar o overlay
                            const posicionarOverlay = () => {
                                const rect = btnTest.getBoundingClientRect();
                                const overlay = document.getElementById('btn-unidade-overlay');
                                if (overlay) {
                                    overlay.style.top = rect.top + 'px';
                                    overlay.style.left = rect.left + 'px';
                                    overlay.style.width = rect.width + 'px';
                                    overlay.style.height = rect.height + 'px';
                                }
                            };
                            
                            const existingOverlay = document.getElementById('btn-unidade-overlay');
                            if (existingOverlay) existingOverlay.remove();
                            
                            const overlay = document.createElement('div');
                            overlay.id = 'btn-unidade-overlay';
                            overlay.style.position = 'fixed';
                            overlay.style.cursor = 'pointer';
                            overlay.style.zIndex = '99999';
                            overlay.style.background = 'transparent';
                            
                            overlay.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                mostrarNotificacao(
                                    'Modo bloqueado', 
                                    'O modo "Por Unidade" s√≥ est√° dispon√≠vel quando exatamente 1 lote √© selecionado. Selecione apenas um lote para usar este modo.', 
                                    'warning',
                                    5000
                                );
                            }, true);
                            
                            document.body.appendChild(overlay);
                            posicionarOverlay(); // Posicionar inicialmente
                            
                            // Atualizar posi√ß√£o quando a p√°gina rolar
                            overlayScrollHandler = () => posicionarOverlay();
                            window.addEventListener('scroll', overlayScrollHandler, true);
                        }
                    }, 100);
                } else if (btn.id === 'agrupamento-por-lote' && lotesCount === 1) {
                    btn.classList.add('bloqueado');
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'pointer';
                    btn.style.pointerEvents = 'auto';
                    btn.removeAttribute('disabled');
                    
                    // Se estava selecionado "Por Lote", mudar para "Total"
                    if (tipoAgrupamento === 'por-lote') {
                        tipoAgrupamento = 'total';
                        
                        // Remover estilos ativos de todos os bot√µes de agrupamento
                        document.querySelectorAll('.btn-agrupamento').forEach(b => {
                            b.classList.remove('active');
                            b.style.background = 'transparent';
                            b.style.color = 'var(--gray-600)';
                            b.style.boxShadow = 'none';
                        });
                        
                        // Ativar bot√£o "Total"
                        const btnTotal = document.getElementById('agrupamento-total');
                        btnTotal.classList.add('active');
                        btnTotal.style.background = 'var(--primary-color)';
                        btnTotal.style.color = 'white';
                        btnTotal.style.boxShadow = '0 2px 4px rgba(59,130,246,0.3)';
                        
                        // Recarregar gr√°ficos com o novo agrupamento
                        carregarGraficoRefeicoes();
                        carregarGraficoGastos();
                    }
                } else {
                    btn.classList.remove('bloqueado');
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    btn.style.pointerEvents = 'auto';
                    btn.removeAttribute('disabled');
                    
                    // Remover overlay se existir
                    if (btn.id === 'agrupamento-por-unidade') {
                        const overlay = document.getElementById('btn-unidade-overlay');
                        if (overlay) {
                            overlay.remove();
                            // Remover scroll listener
                            if (overlayScrollHandler) {
                                window.removeEventListener('scroll', overlayScrollHandler, true);
                                overlayScrollHandler = null;
                            }
                        }
                    }
                }
            });
        }
        
        // Fun√ß√£o para bloquear filtro de unidades
        function bloquearFiltroUnidades() {
            const unidadesDisplay = document.getElementById('unidades-display');
            const unidadesText = document.getElementById('unidades-text');
            const btnPorUnidade = document.getElementById('agrupamento-por-unidade');
            
            unidadesDisplay.style.cursor = 'not-allowed';
            unidadesDisplay.style.background = 'var(--gray-100)';
            unidadesDisplay.style.opacity = '0.6';
            unidadesText.textContent = 'Selecione um lote primeiro';
            unidadesText.style.color = 'var(--gray-500)';
            
            // Bloquear bot√£o "Por Unidade"
            btnPorUnidade.disabled = true;
            btnPorUnidade.style.opacity = '0.5';
            btnPorUnidade.style.cursor = 'not-allowed';
            btnPorUnidade.style.color = 'var(--gray-500)';
            
            // Se estava ativo, voltar para "Total"
            if (btnPorUnidade.classList.contains('active')) {
                btnPorUnidade.classList.remove('active');
                btnPorUnidade.style.background = 'transparent';
                btnPorUnidade.style.boxShadow = 'none';
                
                // Ativar "Total"
                const btnTotal = document.getElementById('agrupamento-total');
                btnTotal.classList.add('active');
                btnTotal.style.background = 'var(--primary-color)';
                btnTotal.style.color = 'white';
                btnTotal.style.boxShadow = '0 2px 4px rgba(59,130,246,0.3)';
                tipoAgrupamento = 'total';
            }
        }
        
        // Fun√ß√£o para desbloquear filtro de unidades
        function desbloquearFiltroUnidades() {
            const unidadesDisplay = document.getElementById('unidades-display');
            const unidadesText = document.getElementById('unidades-text');
            const btnPorUnidade = document.getElementById('agrupamento-por-unidade');
            
            unidadesDisplay.style.cursor = 'pointer';
            unidadesDisplay.style.background = 'white';
            unidadesDisplay.style.opacity = '1';
            unidadesText.textContent = 'Selecione as unidades';
            unidadesText.style.color = 'var(--gray-600)';
            
            // Desbloquear bot√£o "Por Unidade"
            btnPorUnidade.disabled = false;
            btnPorUnidade.style.opacity = '1';
            btnPorUnidade.style.cursor = 'pointer';
            btnPorUnidade.style.color = 'var(--gray-600)';
        }
        
        // Fun√ß√£o para carregar unidades do lote
        async function carregarUnidadesDoLote(loteId) {
            try {
                const response = await fetch(`/api/lote/${loteId}/unidades`);
                const data = await response.json();
                
                if (data.success && data.unidades) {
                    const unidadesList = document.getElementById('unidades-list');
                    unidadesList.innerHTML = '';
                    
                    data.unidades.forEach(unidade => {
                        const label = document.createElement('label');
                        label.className = 'unidade-checkbox-label';
                        label.style.cssText = 'display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 6px; cursor: pointer; transition: background 0.2s; margin-bottom: 0.25rem;';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'filtro-unidade-checkbox';
                        checkbox.value = unidade.id;
                        checkbox.checked = true;  // Marcar todas por padr√£o
                        checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
                        
                        const span = document.createElement('span');
                        span.style.cssText = 'color: var(--gray-700); font-size: 0.875rem; flex: 1;';
                        
                        // Adicionar nome e contagem de subunidades se houver
                        if (unidade.subunidades_count > 0) {
                            span.innerHTML = `${unidade.nome} <span style="color: var(--gray-500); font-size: 0.75rem; margin-left: 0.5rem;">(+${unidade.subunidades_count} sub)</span>`;
                        } else {
                            span.textContent = unidade.nome;
                        }
                        
                        label.appendChild(checkbox);
                        label.appendChild(span);
                        unidadesList.appendChild(label);
                        
                        // Hover
                        label.addEventListener('mouseenter', () => label.style.background = 'var(--gray-100)');
                        label.addEventListener('mouseleave', () => label.style.background = 'transparent');
                        
                        // Atualizar contagem
                        checkbox.addEventListener('change', atualizarContagemUnidades);
                    });
                    
                    // Atualizar texto do display
                    const unidadesText = document.getElementById('unidades-text');
                    unidadesText.textContent = `Todas as unidades (${data.unidades.length})`;
                    unidadesText.style.color = 'var(--gray-900)';
                }
            } catch (error) {
            }
        }
        
        // Fun√ß√£o para atualizar contagem de unidades
        function atualizarContagemUnidades() {
            const count = document.querySelectorAll('.filtro-unidade-checkbox:checked').length;
            document.getElementById('unidades-count').textContent = `${count} unidade(s) selecionada(s)`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Vari√°vel para armazenar sele√ß√£o tempor√°ria
            let lotesSelecionadosTemp = [];
            
            // Event listeners para bot√µes de previs√£o
            document.getElementById('btn-previsao-refeicoes').addEventListener('click', adicionarPrevisaoRefeicoes);
            document.getElementById('btn-previsao-gastos').addEventListener('click', adicionarPrevisaoGastos);
            
            // Verificar se existe lote pr√©-selecionado no localStorage
            const loteIdSelecionado = localStorage.getItem('lote_id_selecionado');
            if (loteIdSelecionado) {
                // Aguardar um pouco para garantir que os checkboxes foram renderizados
                setTimeout(() => {
                    // Procurar pelo checkbox com value igual ao lote_id
                    const checkboxes = document.querySelectorAll('.filtro-lote-checkbox');
                    checkboxes.forEach(checkbox => {
                        if (checkbox.value === loteIdSelecionado) {
                            checkbox.checked = true;
                        }
                    });
                    // Simular clique no bot√£o aplicar para carregar os dados do lote
                    document.getElementById('btn-aplicar-lotes').click();
                    // Limpar o localStorage
                    localStorage.removeItem('lote_id_selecionado');
                }, 100);
            }
            
            // Bloquear bot√µes no carregamento inicial (sem lotes selecionados)
            bloquearBotoesGrafico();
            
            // Abrir popup de lotes
            document.getElementById('lotes-display').addEventListener('click', function() {
                document.getElementById('lotes-popup').style.display = 'block';
                document.getElementById('lotes-overlay').style.display = 'block';
                atualizarContagemLotes();
            });
            
            // Fechar popup - Overlay
            document.getElementById('lotes-overlay').addEventListener('click', function() {
                document.getElementById('lotes-popup').style.display = 'none';
                document.getElementById('lotes-overlay').style.display = 'none';
            });
            
            // Fechar popup - Bot√£o Cancelar
            document.getElementById('btn-cancelar-lotes').addEventListener('click', function() {
                document.getElementById('lotes-popup').style.display = 'none';
                document.getElementById('lotes-overlay').style.display = 'none';
            });
            
            // Aplicar sele√ß√£o de lotes
            document.getElementById('btn-aplicar-lotes').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                const lotesSelecionados = Array.from(checkboxes);
                const count = lotesSelecionados.length;
                
                // Atualizar texto do display
                const lotesText = document.getElementById('lotes-text');
                if (count === 0) {
                    lotesText.textContent = 'Selecione os lotes';
                    lotesText.style.color = 'var(--gray-600)';
                    
                    // Mostrar placeholder e ocultar gr√°ficos
                    document.getElementById('placeholder-refeicoes').style.display = 'flex';
                    document.getElementById('grafico-refeicoes').style.display = 'none';
                    document.getElementById('placeholder-gastos').style.display = 'flex';
                    document.getElementById('grafico-gastos').style.display = 'none';
                    
                    // Ocultar bot√µes de previs√£o
                    const btnPrevisaoRefeicoes = document.getElementById('btn-previsao-refeicoes');
                    const btnPrevisaoGastos = document.getElementById('btn-previsao-gastos');
                    if (btnPrevisaoRefeicoes) btnPrevisaoRefeicoes.style.display = 'none';
                    if (btnPrevisaoGastos) btnPrevisaoGastos.style.display = 'none';
                    
                    // Bloquear bot√µes de tipo e agrupamento
                    bloquearBotoesGrafico();
                    
                    // Bloquear filtro de unidades
                    bloquearFiltroUnidades();
                } else if (count === 1) {
                    const loteId = lotesSelecionados[0].value;
                    lotesText.textContent = lotesSelecionados[0].nextElementSibling.textContent.trim();
                    lotesText.style.color = 'var(--gray-900)';
                    
                    // Resetar previs√µes ao mudar de lote
                    if (previsaoAtivaRefeicoes) {
                        previsaoAtivaRefeicoes = false;
                        dadosOriginaisRefeicoes = null;
                        document.getElementById('btn-previsao-refeicoes').textContent = 'üîÆ Previs√£o';
                    }
                    if (previsaoAtivaGastos) {
                        previsaoAtivaGastos = false;
                        dadosOriginaisGastos = null;
                        document.getElementById('btn-previsao-gastos').textContent = 'üîÆ Previs√£o';
                    }
                    
                    // Desbloquear filtro de unidades e carregar unidades PRIMEIRO
                    desbloquearFiltroUnidades();
                    
                    // Carregar unidades e depois carregar gr√°ficos
                    carregarUnidadesDoLote(loteId).then(() => {
                        // Desbloquear bot√µes e carregar gr√°fico (1 lote) - DEPOIS de carregar unidades
                        desbloquearBotoesGrafico(1);
                        carregarGraficoRefeicoes();
                        carregarGraficoGastos();
                    });
                    
                    // Mostrar bot√µes de previs√£o (apenas com 1 lote)
                    const btnPrevisaoRefeicoes = document.getElementById('btn-previsao-refeicoes');
                    const btnPrevisaoGastos = document.getElementById('btn-previsao-gastos');
                    if (btnPrevisaoRefeicoes) btnPrevisaoRefeicoes.style.display = 'block';
                    if (btnPrevisaoGastos) btnPrevisaoGastos.style.display = 'block';
                } else {
                    lotesText.textContent = `${count} lotes selecionados`;
                    lotesText.style.color = 'var(--gray-900)';
                    
                    // Resetar previs√µes ao selecionar m√∫ltiplos lotes
                    if (previsaoAtivaRefeicoes) {
                        previsaoAtivaRefeicoes = false;
                        dadosOriginaisRefeicoes = null;
                    }
                    if (previsaoAtivaGastos) {
                        previsaoAtivaGastos = false;
                        dadosOriginaisGastos = null;
                    }
                    
                    // Desbloquear bot√µes e carregar gr√°fico (m√∫ltiplos lotes)
                    desbloquearBotoesGrafico(count);
                    carregarGraficoRefeicoes();
                    carregarGraficoGastos();
                    
                    // Ocultar bot√µes de previs√£o (m√∫ltiplos lotes)
                    const btnPrevisaoRefeicoes = document.getElementById('btn-previsao-refeicoes');
                    const btnPrevisaoGastos = document.getElementById('btn-previsao-gastos');
                    if (btnPrevisaoRefeicoes) btnPrevisaoRefeicoes.style.display = 'none';
                    if (btnPrevisaoGastos) btnPrevisaoGastos.style.display = 'none';
                    
                    // Bloquear filtro de unidades (m√∫ltiplos lotes)
                    bloquearFiltroUnidades();
                }
                
                // Fechar popup
                document.getElementById('lotes-popup').style.display = 'none';
                document.getElementById('lotes-overlay').style.display = 'none';
            });
            
            // Selecionar todos os lotes
            document.getElementById('btn-selecionar-todos-lotes').addEventListener('click', function() {
                document.querySelectorAll('.filtro-lote-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
                atualizarContagemLotes();
            });
            
            // Limpar todos os lotes
            document.getElementById('btn-limpar-lotes').addEventListener('click', function() {
                document.querySelectorAll('.filtro-lote-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                atualizarContagemLotes();
            });
            
            // Atualizar contagem ao clicar em checkbox
            document.querySelectorAll('.filtro-lote-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', atualizarContagemLotes);
            });
            
            // Fun√ß√£o para atualizar contagem
            function atualizarContagemLotes() {
                const count = document.querySelectorAll('.filtro-lote-checkbox:checked').length;
                document.getElementById('lotes-count').textContent = `${count} lote(s) selecionado(s)`;
            }
            
            // === EVENT LISTENERS PARA POPUP DE UNIDADES ===
            
            // Abrir popup de unidades (s√≥ funciona se habilitado)
            document.getElementById('unidades-display').addEventListener('click', function() {
                if (this.style.cursor === 'pointer') {
                    document.getElementById('unidades-popup').style.display = 'block';
                    document.getElementById('unidades-overlay').style.display = 'block';
                    atualizarContagemUnidades();
                }
            });
            
            // Fechar popup - Overlay
            document.getElementById('unidades-overlay').addEventListener('click', function() {
                document.getElementById('unidades-popup').style.display = 'none';
                document.getElementById('unidades-overlay').style.display = 'none';
            });
            
            // Fechar popup - Bot√£o Cancelar
            document.getElementById('btn-cancelar-unidades').addEventListener('click', function() {
                document.getElementById('unidades-popup').style.display = 'none';
                document.getElementById('unidades-overlay').style.display = 'none';
            });
            
            // Aplicar sele√ß√£o de unidades
            document.getElementById('btn-aplicar-unidades').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.filtro-unidade-checkbox:checked');
                const unidadesSelecionadas = Array.from(checkboxes);
                const count = unidadesSelecionadas.length;
                
                // Atualizar texto do display
                const unidadesText = document.getElementById('unidades-text');
                if (count === 0) {
                    unidadesText.textContent = 'Selecione as unidades';
                    unidadesText.style.color = 'var(--gray-600)';
                } else if (count === 1) {
                    unidadesText.textContent = unidadesSelecionadas[0].nextElementSibling.textContent.trim();
                    unidadesText.style.color = 'var(--gray-900)';
                } else {
                    unidadesText.textContent = `${count} unidades selecionadas`;
                    unidadesText.style.color = 'var(--gray-900)';
                }
                
                // Fechar popup
                document.getElementById('unidades-popup').style.display = 'none';
                document.getElementById('unidades-overlay').style.display = 'none';
                
                // Recarregar gr√°fico sempre que unidades s√£o alteradas (se houver 1 lote selecionado)
                const lotesCheckboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                if (lotesCheckboxes.length === 1) {
                    // Resetar previs√µes ao mudar filtro de unidades
                    if (previsaoAtivaRefeicoes) {
                        previsaoAtivaRefeicoes = false;
                        dadosOriginaisRefeicoes = null;
                        document.getElementById('btn-previsao-refeicoes').textContent = 'üîÆ Previs√£o';
                    }
                    if (previsaoAtivaGastos) {
                        previsaoAtivaGastos = false;
                        dadosOriginaisGastos = null;
                        document.getElementById('btn-previsao-gastos').textContent = 'üîÆ Previs√£o';
                    }
                    
                    carregarGraficoRefeicoes();
                    carregarGraficoGastos();
                }
            });
            
            // Selecionar todas as unidades
            document.getElementById('btn-selecionar-todas-unidades').addEventListener('click', function() {
                document.querySelectorAll('.filtro-unidade-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
                atualizarContagemUnidades();
            });
            
            // Limpar todas as unidades
            document.getElementById('btn-limpar-unidades').addEventListener('click', function() {
                document.querySelectorAll('.filtro-unidade-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                atualizarContagemUnidades();
            });
            
            // Hover nos checkboxes de lotes
            document.querySelectorAll('.lote-checkbox-label').forEach(label => {
                label.addEventListener('mouseenter', function() {
                    this.style.background = 'var(--gray-100)';
                });
                label.addEventListener('mouseleave', function() {
                    this.style.background = 'transparent';
                });
            });
            
            // Hover nos bot√µes
            document.getElementById('btn-selecionar-todos-lotes').addEventListener('mouseenter', function() {
                this.style.background = '#2563eb';
            });
            document.getElementById('btn-selecionar-todos-lotes').addEventListener('mouseleave', function() {
                this.style.background = 'var(--primary-color)';
            });
            
            document.getElementById('btn-limpar-lotes').addEventListener('mouseenter', function() {
                this.style.background = '#d1d5db';
            });
            document.getElementById('btn-limpar-lotes').addEventListener('mouseleave', function() {
                this.style.background = 'var(--gray-200)';
            });
            
            // Controlar bot√µes de TIPO de visualiza√ß√£o (Normal vs Acumulada)
            document.querySelectorAll('.btn-tipo').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    
                    // Remover active de todos
                    document.querySelectorAll('.btn-tipo').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'transparent';
                        b.style.color = 'var(--gray-600)';
                        b.style.boxShadow = 'none';
                    });
                    
                    // Adicionar active ao clicado
                    this.classList.add('active');
                    this.style.background = 'var(--primary-color)';
                    this.style.color = 'white';
                    this.style.boxShadow = '0 2px 4px rgba(59,130,246,0.3)';
                    
                    tipoVisualizacao = this.dataset.tipo;
                    
                    // Resetar previs√µes ao mudar tipo
                    if (previsaoAtivaRefeicoes) {
                        previsaoAtivaRefeicoes = false;
                        document.getElementById('btn-previsao-refeicoes').textContent = 'üîÆ Previs√£o';
                    }
                    if (previsaoAtivaGastos) {
                        previsaoAtivaGastos = false;
                        document.getElementById('btn-previsao-gastos').textContent = 'üîÆ Previs√£o';
                    }
                    
                    // Recarregar gr√°fico se houver lotes selecionados
                    const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                    if (checkboxes.length > 0) {
                        carregarGraficoRefeicoes();
                        carregarGraficoGastos();
                    }
                });
            });
            
            // Controlar bot√µes de AGRUPAMENTO (Total vs Por Lote)
            document.querySelectorAll('.btn-agrupamento').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    // Verificar se est√° bloqueado e mostrar notifica√ß√£o
                    if (this.classList.contains('bloqueado')) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        if (this.id === 'agrupamento-por-lote') {
                            mostrarNotificacao(
                                'Modo bloqueado', 
                                'O modo "Por Lote" s√≥ est√° dispon√≠vel quando 2 ou mais lotes s√£o selecionados. Selecione m√∫ltiplos lotes para usar este modo.', 
                                'warning',
                                5000
                            );
                        } else if (this.id === 'agrupamento-por-unidade') {
                            mostrarNotificacao(
                                'Modo bloqueado', 
                                'O modo "Por Unidade" s√≥ est√° dispon√≠vel quando exatamente 1 lote √© selecionado. Selecione apenas um lote para usar este modo.', 
                                'warning',
                                5000
                            );
                        }
                        return false;
                    }
                    
                    // Remover active de todos
                    document.querySelectorAll('.btn-agrupamento').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'transparent';
                        b.style.color = 'var(--gray-600)';
                        b.style.boxShadow = 'none';
                    });
                    
                    // Adicionar active ao clicado
                    this.classList.add('active');
                    this.style.background = 'var(--primary-color)';
                    this.style.color = 'white';
                    this.style.boxShadow = '0 2px 4px rgba(59,130,246,0.3)';
                    
                    tipoAgrupamento = this.dataset.agrupamento;
                    
                    // Resetar previs√µes ao mudar agrupamento
                    if (previsaoAtivaRefeicoes) {
                        previsaoAtivaRefeicoes = false;
                        document.getElementById('btn-previsao-refeicoes').textContent = 'üîÆ Previs√£o';
                    }
                    if (previsaoAtivaGastos) {
                        previsaoAtivaGastos = false;
                        document.getElementById('btn-previsao-gastos').textContent = 'üîÆ Previs√£o';
                    }
                    
                    // Recarregar gr√°fico se houver lotes selecionados
                    const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                    if (checkboxes.length > 0) {
                        carregarGraficoRefeicoes();
                        carregarGraficoGastos();
                    }
                });
            });

            // Anima√ß√µes
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            });

            document.querySelectorAll('.fade-in').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(30px)';
                el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(el);
            });
            
            // N√£o carregar gr√°fico automaticamente - aguardar sele√ß√£o de lote
            // Exibir placeholder inicial
            document.getElementById('placeholder-refeicoes').style.display = 'flex';
        });
    </script>
    
    <!-- Overlay e Popup de Lotes (fora do contexto de empilhamento) -->
    <div id="lotes-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9998;"></div>
    
    <div id="lotes-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 2px solid var(--gray-300); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); min-width: 400px; max-width: 500px; z-index: 9999;">
        <div style="padding: 1.25rem; border-bottom: 1px solid var(--gray-200);">
            <h4 style="margin: 0; color: var(--primary-color); font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">üì¶ Selecionar Lotes Ativos</h4>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.813rem; color: var(--gray-600);">Escolha um ou mais lotes para filtrar os dados</p>
        </div>
        
        <div style="padding: 1.25rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                <button id="btn-selecionar-todos-lotes" style="flex: 1; padding: 0.65rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">‚úÖ Selecionar Todos</button>
                <button id="btn-limpar-lotes" style="flex: 1; padding: 0.65rem; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">‚ùå Limpar Todos</button>
            </div>
            
            <div id="lotes-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                {% for lote in lotes %}
                <label class="lote-checkbox-label" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 6px; cursor: pointer; transition: background 0.2s; margin-bottom: 0.25rem;">
                    <input type="checkbox" class="filtro-lote-checkbox" value="{{ lote.id }}" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="color: var(--gray-700); font-size: 0.875rem; flex: 1;">{{ lote.nome }}{% if lote.empresa %} <span style="color: var(--gray-500);">- {{ lote.empresa }}</span>{% endif %}</span>
                </label>
                {% endfor %}
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                <span id="lotes-count" style="font-size: 0.875rem; color: var(--gray-600); font-weight: 500;">0 lote(s) selecionado(s)</span>
                <div style="display: flex; gap: 0.75rem;">
                    <button id="btn-cancelar-lotes" style="padding: 0.65rem 1.25rem; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Cancelar</button>
                    <button id="btn-aplicar-lotes" style="padding: 0.65rem 1.25rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Aplicar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Overlay e Popup de Unidades -->
    <div id="unidades-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9998;"></div>
    
    <div id="unidades-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 2px solid var(--gray-300); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); min-width: 400px; max-width: 500px; z-index: 9999;">
        <div style="padding: 1.25rem; border-bottom: 1px solid var(--gray-200);">
            <h4 style="margin: 0; color: var(--primary-color); font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">üè¢ Selecionar Unidades</h4>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.813rem; color: var(--gray-600);">Escolha uma ou mais unidades para filtrar os dados</p>
        </div>
        
        <div style="padding: 1.25rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                <button id="btn-selecionar-todas-unidades" style="flex: 1; padding: 0.65rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">‚úÖ Selecionar Todas</button>
                <button id="btn-limpar-unidades" style="flex: 1; padding: 0.65rem; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">‚ùå Limpar Todas</button>
            </div>
            
            <div id="unidades-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                <!-- Unidades ser√£o carregadas dinamicamente -->
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                <span id="unidades-count" style="font-size: 0.875rem; color: var(--gray-600); font-weight: 500;">0 unidade(s) selecionada(s)</span>
                <div style="display: flex; gap: 0.75rem;">
                    <button id="btn-cancelar-unidades" style="padding: 0.65rem 1.25rem; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Cancelar</button>
                    <button id="btn-aplicar-unidades" style="padding: 0.65rem 1.25rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Aplicar</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>