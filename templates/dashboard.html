<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SGMRP</title>
    <meta name="description" content="An√°lise gr√°fica e dashboard de consumo de refei√ß√µes">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        .chart-placeholder {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,.1) 10px,
                rgba(255,255,255,.1) 20px
            );
        }
        
        .chart-content {
            position: relative;
            z-index: 1;
            text-align: center;
            padding: 2rem;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--gray-200);
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }
        
        .metric-subtitle {
            font-size: 0.75rem;
            color: var(--gray-500);
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .btn-projection {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-projection:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            margin: 3rem 0;
            opacity: 0.3;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-600);
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }
        
        .tab-btn:hover {
            color: var(--primary-color);
            background: var(--gray-50);
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .projection-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        /* Notifica√ß√µes customizadas */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            animation: slideInRight 0.4s ease-out;
            max-width: 400px;
        }

        .notification-content {
            background: white;
            color: #1f2937;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            border-left: 4px solid #3b82f6;
        }

        .notification-content.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .notification-content.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .notification-content.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .notification-content.info {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .notification-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        .notification-body {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            color: #111827;
        }

        .notification-message {
            font-size: 0.875rem;
            line-height: 1.5;
            color: #6b7280;
            white-space: pre-line;
        }

        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
            color: #6b7280;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .custom-notification.closing {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        @media (max-width: 480px) {
            .custom-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Estilos do Modal de Exporta√ß√£o */
        .export-option:hover {
            background: #f1f5f9 !important;
            border-color: var(--primary-color) !important;
        }

        .export-option input:checked + span {
            color: var(--primary-color) !important;
            font-weight: 600;
        }

        input[type="radio"]:checked {
            accent-color: var(--primary-color);
        }

        label:has(input[type="radio"]:checked) {
            border-color: var(--primary-color) !important;
            background: #f5f3ff !important;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('home') }}" class="logo">SGMRP</a>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('home') }}">P√°gina Inicial</a></li>
                        <li><a href="{{ url_for('lotes') }}">Lotes</a></li>
                        <li><a href="{{ url_for('dashboard') }}" class="active">Dashboard</a></li>
                        <li><a href="#configuracoes">Configura√ß√µes</a></li>
                        <li><a href="#" id="logoutLink" style="color: #fed7d7;">Sair</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Breadcrumb -->
            <nav aria-label="Navega√ß√£o" style="margin-bottom: 2.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 0.75rem 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="display: flex; gap: 0.5rem; font-size: 0.95rem; color: var(--gray-500); align-items: center;">
                    <span><a href="{{ url_for('home') }}" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">P√°gina Inicial</a></span>
                    <span aria-hidden="true" style="font-size: 1.1em; opacity: 0.7;">/</span>
                    <span aria-current="page" style="color: var(--primary-color); font-weight: 600;">Dashboard</span>
                </div>
            </nav>

            <!-- Header da P√°gina -->
            <section style="margin-bottom: 2.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 2rem;">
                    <div>
                        <h1 style="margin-bottom: 0.5rem; color: var(--primary-color); font-size: 2.1rem; font-weight: 700; letter-spacing: -1px;">
                            üìä Dashboard e An√°lises
                        </h1>
                        <p style="color: var(--gray-600); margin: 0; font-size: 1.05rem;">Visualiza√ß√£o gr√°fica e estat√≠sticas de consumo de refei√ß√µes</p>
                    </div>
                </div>
            </section>

            <!-- Filtros -->
            <section class="fade-in" style="margin-bottom: 2rem;">
                <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.125rem;">üîç</span>
                            <span style="font-weight: 600; color: var(--gray-700);">Filtros:</span>
                        </div>
                        
                        <!-- Filtro de Lotes (Popup) -->
                        <div style="position: relative;">
                            <label style="display: block; font-weight: 500; color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">üì¶ Lotes:</label>
                            <div id="lotes-display" style="padding: 0.75rem 1rem; font-size: 0.875rem; cursor: pointer; border: 2px solid var(--gray-300); border-radius: 8px; background: white; min-width: 250px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;">
                                <span id="lotes-text" style="color: var(--gray-600);">Selecione os lotes</span>
                                <span style="color: var(--gray-400);">‚ñº</span>
                            </div>
                        </div>
                        
                        <!-- Filtro de Unidades (Popup) -->
                        <div style="position: relative;">
                            <label style="display: block; font-weight: 500; color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">üè¢ Unidades:</label>
                            <div id="unidades-display" style="padding: 0.75rem 1rem; font-size: 0.875rem; cursor: not-allowed; border: 2px solid var(--gray-300); border-radius: 8px; background: var(--gray-100); min-width: 250px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; opacity: 0.6;">
                                <span id="unidades-text" style="color: var(--gray-500);">Selecione um lote primeiro</span>
                                <span style="color: var(--gray-400);">‚ñº</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tipo de Gr√°fico -->
            <section class="fade-in" style="margin-bottom: 2rem;">
                <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.125rem;">üìä</span>
                            <span style="font-weight: 600; color: var(--gray-700);">Tipo de Gr√°fico:</span>
                        </div>
                        
                        <!-- Sele√ß√£o Normal vs Acumulada -->
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Visualiza√ß√£o:</span>
                            <div style="display: flex; gap: 0.5rem; background: var(--gray-100); padding: 0.4rem; border-radius: 10px;">
                                <button id="tipo-normal" class="btn-tipo active" data-tipo="normal" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; background: var(--primary-color); color: white; transition: all 0.3s; box-shadow: 0 2px 4px rgba(59,130,246,0.3);">
                                    üìä Normal
                                </button>
                                <button id="tipo-acumulada" class="btn-tipo" data-tipo="acumulada" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; background: transparent; color: var(--gray-600); transition: all 0.3s;">
                                    üìà Acumulada
                                </button>
                            </div>
                        </div>
                        
                        <!-- Sele√ß√£o Total vs Por Lote vs Por Unidade -->
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Agrupamento:</span>
                            <div style="display: flex; gap: 0.5rem; background: var(--gray-100); padding: 0.4rem; border-radius: 10px;">
                                <button id="agrupamento-total" class="btn-agrupamento active" data-agrupamento="total" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; background: var(--primary-color); color: white; transition: all 0.3s; box-shadow: 0 2px 4px rgba(59,130,246,0.3);">
                                    üìä Total
                                </button>
                                <button id="agrupamento-por-lote" class="btn-agrupamento" data-agrupamento="por-lote" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; background: transparent; color: var(--gray-600); transition: all 0.3s;">
                                    üì¶ Por Lote
                                </button>
                                <button id="agrupamento-por-unidade" class="btn-agrupamento" data-agrupamento="por-unidade" style="padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: not-allowed; background: transparent; color: var(--gray-500); transition: all 0.3s; opacity: 0.5;" disabled>
                                    üè¢ Por Unidade
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gr√°ficos de Visualiza√ß√£o -->
            <!-- Gr√°fico 1: Refei√ß√µes -->
            <section class="card fade-in" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 style="margin: 0;">üìà Gr√°fico de Evolu√ß√£o - Refei√ß√µes por Per√≠odo</h3>
                </div>
                <div class="card-body">
                    <div id="grafico-refeicoes-container" style="position: relative; height: 600px;">
                        <canvas id="grafico-refeicoes" style="height: 600px; display: none;"></canvas>
                        <div class="chart-placeholder" id="placeholder-refeicoes" style="height: 600px;">
                            <div class="chart-content">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
                                <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Gr√°fico de S√©rie Temporal</h3>
                                <p style="color: var(--gray-600); max-width: 500px; margin: 0 auto;">
                                    Selecione os lotes e clique em "Aplicar" para visualizar o gr√°fico.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gr√°fico 2: Gastos -->
            <section class="card fade-in" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3 style="margin: 0;">üí∞ Gr√°fico de Evolu√ß√£o - Gastos por Per√≠odo</h3>
                </div>
                <div class="card-body">
                    <div id="grafico-gastos-container" style="position: relative; height: 600px;">
                        <canvas id="grafico-gastos" style="height: 600px; display: none;"></canvas>
                        <div class="chart-placeholder" id="placeholder-gastos" style="height: 600px;">
                            <div class="chart-content">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üíµ</div>
                                <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Gr√°fico de S√©rie Temporal</h3>
                                <p style="color: var(--gray-600); max-width: 500px; margin: 0 auto;">
                                    Selecione os lotes e clique em "Aplicar" para visualizar o gr√°fico.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- Modal de Confirma√ß√£o de Logout -->
    <!-- Modal de Exporta√ß√£o -->
    <div id="modal-exportacao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 11000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">üìä</div>
                <h3 style="margin-bottom: 0.5rem; color: var(--primary-color);">Exportar Relat√≥rios</h3>
                <p style="margin: 0; color: var(--gray-600); font-size: 0.95rem;">Selecione os gr√°ficos e o formato de exporta√ß√£o</p>
            </div>
            
            <!-- Sele√ß√£o de Gr√°ficos -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: var(--gray-700); font-size: 1rem; font-weight: 600;">üìà Gr√°ficos para Exportar</h4>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-refeicoes-total" value="refeicoes-total" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Refei√ß√µes - Total Geral</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-refeicoes-unidade" value="refeicoes-unidade" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Refei√ß√µes - Por Unidade</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-gastos-total" value="gastos-total" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Gastos - Total Geral</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-gastos-unidade" value="gastos-unidade" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Gastos - Por Unidade</span>
                    </label>
                </div>
            </div>
            
            <!-- Tipo de Visualiza√ß√£o (Normal/Acumulada) -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: var(--gray-700); font-size: 1rem; font-weight: 600;">üìä Tipo de Visualiza√ß√£o</h4>
                <div style="display: flex; gap: 0.75rem;">
                    <label style="flex: 1; display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="export-tipo" value="normal" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: var(--gray-700); font-weight: 500;">Normal</span>
                    </label>
                    
                    <label style="flex: 1; display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="export-tipo" value="acumulada" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: var(--gray-700); font-weight: 500;">Acumulada</span>
                    </label>
                </div>
            </div>
            
            <!-- Formato de Exporta√ß√£o -->
            <div style="margin-bottom: 2rem;">
                <h4 style="margin-bottom: 1rem; color: var(--gray-700); font-size: 1rem; font-weight: 600;">üíæ Formato de Exporta√ß√£o</h4>
                <div style="display: flex; gap: 0.75rem;">
                    <label style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1.25rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="export-formato" value="imagens" checked style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="font-size: 2rem;">üñºÔ∏è</div>
                        <span style="color: var(--gray-700); font-weight: 600; text-align: center;">Imagens PNG<br><small style="font-weight: 400; color: var(--gray-500);">(arquivo ZIP)</small></span>
                    </label>
                    
                    <label style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1.25rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="export-formato" value="pdf" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="font-size: 2rem;">üìÑ</div>
                        <span style="color: var(--gray-700); font-weight: 600; text-align: center;">PDF<br><small style="font-weight: 400; color: var(--gray-500);">(paisagem)</small></span>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="btn-cancelar-exportacao" style="min-width: 120px;">Cancelar</button>
                <button class="btn" id="btn-confirmar-exportacao" style="min-width: 160px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none;">
                    üì• Exportar
                </button>
            </div>
        </div>
    </div>

    <div id="modal-confirmacao-logout" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 11000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">üëã</div>
                <h3 style="margin-bottom: 1rem; color: #f59e0b;">Sair do Sistema</h3>
                <p style="margin: 0; color: var(--gray-700); line-height: 1.5; font-size: 1rem;">
                    Tem certeza que deseja sair do sistema?
                </p>
            </div>
            
            <div style="padding: 1rem; background-color: #fffbeb; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 2rem;">
                <p style="font-size: 0.875rem; margin: 0; color: #92400e;">
                    <strong>‚ÑπÔ∏è Informa√ß√£o:</strong> Voc√™ precisar√° fazer login novamente para acessar o sistema.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="btn-cancelar-logout" style="min-width: 120px;">Cancelar</button>
                <button class="btn" id="btn-confirmar-logout" style="min-width: 120px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;">Sair</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p style="margin: 0; color: var(--gray-400); font-size: 0.875rem;">
                ¬© 2025 SGMRP - Sistema de Gerenciamento de Mapas de Refei√ß√µes Penitenci√°rio
            </p>
        </div>
    </footer>

    <script>
        // Mapeamento de lotes para unidades (do backend)
        const lotesUnidadesMap = {{ lotes_unidades|tojson }};
        
        // Vari√°vel global para o gr√°fico
        let chartInstance = null;
        let modoVisualizacao = 'acumulado'; // 'acumulado', 'unidade', 'lote'
        let tipoVisualizacao = 'normal'; // 'normal', 'acumulada'
        let tipoAgrupamento = 'total'; // 'total', 'por-lote'
        
        // Vari√°veis para gr√°fico de gastos
        let chartInstanceGastos = null;
        let projecaoAtivaGastos = false;
        
        // Vari√°vel para armazenar inst√¢ncia do gr√°fico de refei√ß√µes
        let chartRefeicoesInstance = null;
        
        // Fun√ß√£o para carregar o gr√°fico de refei√ß√µes
        async function carregarGraficoRefeicoes() {
            try {
                // Obter lotes selecionados
                const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                const lotesSelecionados = Array.from(checkboxes).map(cb => cb.value);
                
                if (lotesSelecionados.length === 0) {
                    return;
                }
                
                // Obter tipo de visualiza√ß√£o e agrupamento
                const tipo = tipoVisualizacao;
                const agrupamento = tipoAgrupamento;
                
                // Enviar unidades se houver apenas 1 lote selecionado (aplica filtro em todos os modos)
                let unidadesSelecionadas = [];
                if (lotesSelecionados.length === 1) {
                    const unidadesCheckboxes = document.querySelectorAll('.filtro-unidade-checkbox:checked');
                    unidadesSelecionadas = Array.from(unidadesCheckboxes).map(cb => parseInt(cb.value));
                }
                
                // Fazer requisi√ß√£o √† API
                const response = await fetch('/api/dashboard/grafico-refeicoes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lotes: lotesSelecionados,
                        unidades: unidadesSelecionadas,
                        tipo: tipo,
                        agrupamento: agrupamento
                    })
                });
                
                const data = await response.json();
                
                // Verificar se houve erro (status HTTP 4xx ou 5xx, ou success: false)
                if (!response.ok || !data.success) {
                    mostrarNotificacao('Erro', data.error || 'Erro ao carregar dados do gr√°fico', 'error');
                    return;
                }
                
                // Renderizar gr√°fico
                renderizarGraficoRefeicoes(data);
                
            } catch (error) {
                mostrarNotificacao('Erro', 'Erro ao carregar o gr√°fico', 'error');
            }
        }
        
        // Fun√ß√£o para renderizar o gr√°fico de refei√ß√µes
        function renderizarGraficoRefeicoes(dados) {
            const canvas = document.getElementById('grafico-refeicoes');
            const placeholder = document.getElementById('placeholder-refeicoes');
            
            // Ocultar placeholder e mostrar canvas
            placeholder.style.display = 'none';
            canvas.style.display = 'block';
            
            // Destruir gr√°fico anterior se existir
            if (chartRefeicoesInstance) {
                chartRefeicoesInstance.destroy();
            }
            
            // Formatar labels (YYYY-MM -> M√™s/Ano)
            const labelsFormatados = dados.labels.map(label => {
                const [ano, mes] = label.split('-');
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                return `${meses[parseInt(mes) - 1]}/${ano}`;
            });
            
            // Preparar datasets com cores
            const cores = [
                { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
                { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
                { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
                { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
                { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' }
            ];
            
            const datasets = dados.datasets.map((dataset, index) => {
                const cor = cores[index % cores.length];
                return {
                    label: dataset.label,
                    data: dataset.data,
                    borderColor: cor.border,
                    backgroundColor: cor.bg,
                    borderWidth: 2,
                    tension: 0.3,
                    fill: (dados.agrupamento === 'por-lote' || dados.agrupamento === 'por-unidade') ? false : true,  // Sem sombreamento nos modos "Por Lote" e "Por Unidade"
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });
            
            // Criar gr√°fico
            const ctx = canvas.getContext('2d');
            chartRefeicoesInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labelsFormatados,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += new Intl.NumberFormat('pt-BR').format(context.parsed.y);
                                    label += ' refei√ß√µes';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('pt-BR').format(value);
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // ===== Gr√°fico de Gastos =====
        let chartGastos = null;

        async function carregarGraficoGastos() {
            try {
                const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                const lotesSelecionados = Array.from(checkboxes).map(cb => cb.value);
                if (lotesSelecionados.length === 0) return;

                const tipo = tipoVisualizacao;
                const agrupamento = tipoAgrupamento;

                let unidadesSelecionadas = [];
                if (lotesSelecionados.length === 1) {
                    const unidadesCheckboxes = document.querySelectorAll('.filtro-unidade-checkbox:checked');
                    unidadesSelecionadas = Array.from(unidadesCheckboxes).map(cb => parseInt(cb.value));
                }

                const response = await fetch('/api/dashboard/grafico-gastos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lotes: lotesSelecionados,
                        unidades: unidadesSelecionadas,
                        tipo: tipo,
                        agrupamento: agrupamento
                    })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    mostrarNotificacao('Erro', data.error || 'Erro ao carregar dados do gr√°fico de gastos', 'error');
                    return;
                }
                renderizarGraficoGastos(data);
            } catch (e) {
                mostrarNotificacao('Erro', 'Erro inesperado ao carregar gr√°fico de gastos', 'error');
            }
        }

        function renderizarGraficoGastos(dados) {
            const canvas = document.getElementById('grafico-gastos');
            const placeholder = document.getElementById('placeholder-gastos');
            if (!canvas) return;
            canvas.style.display = 'block';
            if (placeholder) placeholder.style.display = 'none';

            if (chartGastos) chartGastos.destroy();

            const labelsFormatados = (dados.labels || dados.periodos).map(periodo => {
                const [ano, mes] = periodo.split('-');
                const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
                return `${meses[parseInt(mes) - 1]}/${ano}`;
            });

            // Paleta e estilo iguais ao gr√°fico de refei√ß√µes
            const cores = [
                { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
                { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
                { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
                { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
                { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' }
            ];

            const datasets = dados.datasets.map((dataset, index) => {
                const cor = cores[index % cores.length];
                return {
                    label: dataset.label,
                    data: dataset.data,
                    borderColor: cor.border,
                    backgroundColor: cor.bg,
                    borderWidth: 2,
                    tension: 0.3,
                    fill: (dados.agrupamento === 'por-lote' || dados.agrupamento === 'por-unidade') ? false : true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });

            chartGastos = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: { labels: labelsFormatados, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            mode: 'index', intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
                                }
                            }
                        }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });
        }
        
        // Fun√ß√£o para mostrar notifica√ß√£o customizada
        function mostrarNotificacao(titulo, mensagem, tipo = 'info', duracao = 5000) {
            // Criar elemento de notifica√ß√£o
            const notification = document.createElement('div');
            notification.className = 'custom-notification';
            
            // √çcones por tipo
            const icones = {
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå',
                'success': '‚úÖ',
                'info': '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div class="notification-content ${tipo}">
                    <div class="notification-icon">${icones[tipo] || icones['info']}</div>
                    <div class="notification-body">
                        <div class="notification-title">${titulo}</div>
                        <div class="notification-message">${mensagem}</div>
                    </div>
                    <button class="notification-close" onclick="this.closest('.custom-notification').remove()">‚úï</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remover ap√≥s dura√ß√£o
            setTimeout(() => {
                notification.classList.add('closing');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, duracao);
        }

        // Fun√ß√£o para bloquear bot√µes de tipo e agrupamento
        function bloquearBotoesGrafico() {
            // Bot√µes de tipo de visualiza√ß√£o
            document.querySelectorAll('.btn-tipo').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
            
            // Bot√µes de agrupamento
            document.querySelectorAll('.btn-agrupamento').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
        }
        
        // Fun√ß√£o para desbloquear bot√µes de tipo e agrupamento
        function desbloquearBotoesGrafico(lotesCount = 1) {
            // Bot√µes de tipo de visualiza√ß√£o
            document.querySelectorAll('.btn-tipo').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
            
            // Bot√µes de agrupamento
            document.querySelectorAll('.btn-agrupamento').forEach(btn => {
                // "Por Unidade" s√≥ funciona com 1 lote
                // "Por Lote" s√≥ funciona com 2+ lotes
                if (btn.id === 'agrupamento-por-unidade' && lotesCount !== 1) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                } else if (btn.id === 'agrupamento-por-lote' && lotesCount === 1) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    
                    // Se estava selecionado "Por Lote", mudar para "Total"
                    if (tipoAgrupamento === 'por-lote') {
                        tipoAgrupamento = 'total';
                        document.querySelectorAll('.btn-agrupamento').forEach(b => b.classList.remove('ativo'));
                        document.getElementById('agrupamento-total').classList.add('ativo');
                    }
                } else {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
        }
        
        // Fun√ß√£o para bloquear filtro de unidades
        function bloquearFiltroUnidades() {
            const unidadesDisplay = document.getElementById('unidades-display');
            const unidadesText = document.getElementById('unidades-text');
            const btnPorUnidade = document.getElementById('agrupamento-por-unidade');
            
            unidadesDisplay.style.cursor = 'not-allowed';
            unidadesDisplay.style.background = 'var(--gray-100)';
            unidadesDisplay.style.opacity = '0.6';
            unidadesText.textContent = 'Selecione um lote primeiro';
            unidadesText.style.color = 'var(--gray-500)';
            
            // Bloquear bot√£o "Por Unidade"
            btnPorUnidade.disabled = true;
            btnPorUnidade.style.opacity = '0.5';
            btnPorUnidade.style.cursor = 'not-allowed';
            btnPorUnidade.style.color = 'var(--gray-500)';
            
            // Se estava ativo, voltar para "Total"
            if (btnPorUnidade.classList.contains('active')) {
                btnPorUnidade.classList.remove('active');
                btnPorUnidade.style.background = 'transparent';
                btnPorUnidade.style.boxShadow = 'none';
                
                // Ativar "Total"
                const btnTotal = document.getElementById('agrupamento-total');
                btnTotal.classList.add('active');
                btnTotal.style.background = 'var(--primary-color)';
                btnTotal.style.color = 'white';
                btnTotal.style.boxShadow = '0 2px 4px rgba(59,130,246,0.3)';
                tipoAgrupamento = 'total';
            }
        }
        
        // Fun√ß√£o para desbloquear filtro de unidades
        function desbloquearFiltroUnidades() {
            const unidadesDisplay = document.getElementById('unidades-display');
            const unidadesText = document.getElementById('unidades-text');
            const btnPorUnidade = document.getElementById('agrupamento-por-unidade');
            
            unidadesDisplay.style.cursor = 'pointer';
            unidadesDisplay.style.background = 'white';
            unidadesDisplay.style.opacity = '1';
            unidadesText.textContent = 'Selecione as unidades';
            unidadesText.style.color = 'var(--gray-600)';
            
            // Desbloquear bot√£o "Por Unidade"
            btnPorUnidade.disabled = false;
            btnPorUnidade.style.opacity = '1';
            btnPorUnidade.style.cursor = 'pointer';
            btnPorUnidade.style.color = 'var(--gray-600)';
        }
        
        // Fun√ß√£o para carregar unidades do lote
        async function carregarUnidadesDoLote(loteId) {
            try {
                const response = await fetch(`/api/lote/${loteId}/unidades`);
                const data = await response.json();
                
                if (data.success && data.unidades) {
                    const unidadesList = document.getElementById('unidades-list');
                    unidadesList.innerHTML = '';
                    
                    data.unidades.forEach(unidade => {
                        const label = document.createElement('label');
                        label.className = 'unidade-checkbox-label';
                        label.style.cssText = 'display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 6px; cursor: pointer; transition: background 0.2s; margin-bottom: 0.25rem;';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'filtro-unidade-checkbox';
                        checkbox.value = unidade.id;
                        checkbox.checked = true;  // Marcar todas por padr√£o
                        checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
                        
                        const span = document.createElement('span');
                        span.style.cssText = 'color: var(--gray-700); font-size: 0.875rem; flex: 1;';
                        
                        // Adicionar nome e contagem de subunidades se houver
                        if (unidade.subunidades_count > 0) {
                            span.innerHTML = `${unidade.nome} <span style="color: var(--gray-500); font-size: 0.75rem; margin-left: 0.5rem;">(+${unidade.subunidades_count} sub)</span>`;
                        } else {
                            span.textContent = unidade.nome;
                        }
                        
                        label.appendChild(checkbox);
                        label.appendChild(span);
                        unidadesList.appendChild(label);
                        
                        // Hover
                        label.addEventListener('mouseenter', () => label.style.background = 'var(--gray-100)');
                        label.addEventListener('mouseleave', () => label.style.background = 'transparent');
                        
                        // Atualizar contagem
                        checkbox.addEventListener('change', atualizarContagemUnidades);
                    });
                    
                    // Atualizar texto do display
                    const unidadesText = document.getElementById('unidades-text');
                    unidadesText.textContent = `Todas as unidades (${data.unidades.length})`;
                    unidadesText.style.color = 'var(--gray-900)';
                }
            } catch (error) {
            }
        }
        
        // Fun√ß√£o para atualizar contagem de unidades
        function atualizarContagemUnidades() {
            const count = document.querySelectorAll('.filtro-unidade-checkbox:checked').length;
            document.getElementById('unidades-count').textContent = `${count} unidade(s) selecionada(s)`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Vari√°vel para armazenar sele√ß√£o tempor√°ria
            let lotesSelecionadosTemp = [];
            
            // Verificar se existe lote pr√©-selecionado no localStorage
            const loteIdSelecionado = localStorage.getItem('lote_id_selecionado');
            if (loteIdSelecionado) {
                // Aguardar um pouco para garantir que os checkboxes foram renderizados
                setTimeout(() => {
                    // Procurar pelo checkbox com value igual ao lote_id
                    const checkboxes = document.querySelectorAll('.filtro-lote-checkbox');
                    checkboxes.forEach(checkbox => {
                        if (checkbox.value === loteIdSelecionado) {
                            checkbox.checked = true;
                        }
                    });
                    // Simular clique no bot√£o aplicar para carregar os dados do lote
                    document.getElementById('btn-aplicar-lotes').click();
                    // Limpar o localStorage
                    localStorage.removeItem('lote_id_selecionado');
                }, 100);
            }
            
            // Bloquear bot√µes no carregamento inicial (sem lotes selecionados)
            bloquearBotoesGrafico();
            
            // Abrir popup de lotes
            document.getElementById('lotes-display').addEventListener('click', function() {
                document.getElementById('lotes-popup').style.display = 'block';
                document.getElementById('lotes-overlay').style.display = 'block';
                atualizarContagemLotes();
            });
            
            // Fechar popup - Overlay
            document.getElementById('lotes-overlay').addEventListener('click', function() {
                document.getElementById('lotes-popup').style.display = 'none';
                document.getElementById('lotes-overlay').style.display = 'none';
            });
            
            // Fechar popup - Bot√£o Cancelar
            document.getElementById('btn-cancelar-lotes').addEventListener('click', function() {
                document.getElementById('lotes-popup').style.display = 'none';
                document.getElementById('lotes-overlay').style.display = 'none';
            });
            
            // Aplicar sele√ß√£o de lotes
            document.getElementById('btn-aplicar-lotes').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                const lotesSelecionados = Array.from(checkboxes);
                const count = lotesSelecionados.length;
                
                // Atualizar texto do display
                const lotesText = document.getElementById('lotes-text');
                if (count === 0) {
                    lotesText.textContent = 'Selecione os lotes';
                    lotesText.style.color = 'var(--gray-600)';
                    
                    // Mostrar placeholder e ocultar gr√°fico
                    document.getElementById('placeholder-refeicoes').style.display = 'flex';
                    document.getElementById('grafico-refeicoes').style.display = 'none';
                    
                    // Bloquear bot√µes de tipo e agrupamento
                    bloquearBotoesGrafico();
                    
                    // Bloquear filtro de unidades
                    bloquearFiltroUnidades();
                } else if (count === 1) {
                    const loteId = lotesSelecionados[0].value;
                    lotesText.textContent = lotesSelecionados[0].nextElementSibling.textContent.trim();
                    lotesText.style.color = 'var(--gray-900)';
                    
                    // Desbloquear bot√µes e carregar gr√°fico (1 lote)
                    desbloquearBotoesGrafico(1);
                    carregarGraficoRefeicoes();
                    carregarGraficoGastos();
                    
                    // Desbloquear filtro de unidades e carregar unidades
                    desbloquearFiltroUnidades();
                    carregarUnidadesDoLote(loteId);
                } else {
                    lotesText.textContent = `${count} lotes selecionados`;
                    lotesText.style.color = 'var(--gray-900)';
                    
                    // Desbloquear bot√µes e carregar gr√°fico (m√∫ltiplos lotes)
                    desbloquearBotoesGrafico(count);
                    carregarGraficoRefeicoes();
                    carregarGraficoGastos();
                    
                    // Bloquear filtro de unidades (m√∫ltiplos lotes)
                    bloquearFiltroUnidades();
                }
                
                // Fechar popup
                document.getElementById('lotes-popup').style.display = 'none';
                document.getElementById('lotes-overlay').style.display = 'none';
            });
            
            // Selecionar todos os lotes
            document.getElementById('btn-selecionar-todos-lotes').addEventListener('click', function() {
                document.querySelectorAll('.filtro-lote-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
                atualizarContagemLotes();
            });
            
            // Limpar todos os lotes
            document.getElementById('btn-limpar-lotes').addEventListener('click', function() {
                document.querySelectorAll('.filtro-lote-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                atualizarContagemLotes();
            });
            
            // Atualizar contagem ao clicar em checkbox
            document.querySelectorAll('.filtro-lote-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', atualizarContagemLotes);
            });
            
            // Fun√ß√£o para atualizar contagem
            function atualizarContagemLotes() {
                const count = document.querySelectorAll('.filtro-lote-checkbox:checked').length;
                document.getElementById('lotes-count').textContent = `${count} lote(s) selecionado(s)`;
            }
            
            // === EVENT LISTENERS PARA POPUP DE UNIDADES ===
            
            // Abrir popup de unidades (s√≥ funciona se habilitado)
            document.getElementById('unidades-display').addEventListener('click', function() {
                if (this.style.cursor === 'pointer') {
                    document.getElementById('unidades-popup').style.display = 'block';
                    document.getElementById('unidades-overlay').style.display = 'block';
                    atualizarContagemUnidades();
                }
            });
            
            // Fechar popup - Overlay
            document.getElementById('unidades-overlay').addEventListener('click', function() {
                document.getElementById('unidades-popup').style.display = 'none';
                document.getElementById('unidades-overlay').style.display = 'none';
            });
            
            // Fechar popup - Bot√£o Cancelar
            document.getElementById('btn-cancelar-unidades').addEventListener('click', function() {
                document.getElementById('unidades-popup').style.display = 'none';
                document.getElementById('unidades-overlay').style.display = 'none';
            });
            
            // Aplicar sele√ß√£o de unidades
            document.getElementById('btn-aplicar-unidades').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.filtro-unidade-checkbox:checked');
                const unidadesSelecionadas = Array.from(checkboxes);
                const count = unidadesSelecionadas.length;
                
                // Atualizar texto do display
                const unidadesText = document.getElementById('unidades-text');
                if (count === 0) {
                    unidadesText.textContent = 'Selecione as unidades';
                    unidadesText.style.color = 'var(--gray-600)';
                } else if (count === 1) {
                    unidadesText.textContent = unidadesSelecionadas[0].nextElementSibling.textContent.trim();
                    unidadesText.style.color = 'var(--gray-900)';
                } else {
                    unidadesText.textContent = `${count} unidades selecionadas`;
                    unidadesText.style.color = 'var(--gray-900)';
                }
                
                // Fechar popup
                document.getElementById('unidades-popup').style.display = 'none';
                document.getElementById('unidades-overlay').style.display = 'none';
                
                // Recarregar gr√°fico sempre que unidades s√£o alteradas (se houver 1 lote selecionado)
                const lotesCheckboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                if (lotesCheckboxes.length === 1) {
                    carregarGraficoRefeicoes();
                    carregarGraficoGastos();
                }
            });
            
            // Selecionar todas as unidades
            document.getElementById('btn-selecionar-todas-unidades').addEventListener('click', function() {
                document.querySelectorAll('.filtro-unidade-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
                atualizarContagemUnidades();
            });
            
            // Limpar todas as unidades
            document.getElementById('btn-limpar-unidades').addEventListener('click', function() {
                document.querySelectorAll('.filtro-unidade-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                atualizarContagemUnidades();
            });
            
            // Hover nos checkboxes de lotes
            document.querySelectorAll('.lote-checkbox-label').forEach(label => {
                label.addEventListener('mouseenter', function() {
                    this.style.background = 'var(--gray-100)';
                });
                label.addEventListener('mouseleave', function() {
                    this.style.background = 'transparent';
                });
            });
            
            // Hover nos bot√µes
            document.getElementById('btn-selecionar-todos-lotes').addEventListener('mouseenter', function() {
                this.style.background = '#2563eb';
            });
            document.getElementById('btn-selecionar-todos-lotes').addEventListener('mouseleave', function() {
                this.style.background = 'var(--primary-color)';
            });
            
            document.getElementById('btn-limpar-lotes').addEventListener('mouseenter', function() {
                this.style.background = '#d1d5db';
            });
            document.getElementById('btn-limpar-lotes').addEventListener('mouseleave', function() {
                this.style.background = 'var(--gray-200)';
            });
            
            // Controlar bot√µes de TIPO de visualiza√ß√£o (Normal vs Acumulada)
            document.querySelectorAll('.btn-tipo').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    
                    // Remover active de todos
                    document.querySelectorAll('.btn-tipo').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'transparent';
                        b.style.color = 'var(--gray-600)';
                        b.style.boxShadow = 'none';
                    });
                    
                    // Adicionar active ao clicado
                    this.classList.add('active');
                    this.style.background = 'var(--primary-color)';
                    this.style.color = 'white';
                    this.style.boxShadow = '0 2px 4px rgba(59,130,246,0.3)';
                    
                    tipoVisualizacao = this.dataset.tipo;
                    
                    // Recarregar gr√°fico se houver lotes selecionados
                    const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                    if (checkboxes.length > 0) {
                        carregarGraficoRefeicoes();
                        carregarGraficoGastos();
                    }
                });
            });
            
            // Controlar bot√µes de AGRUPAMENTO (Total vs Por Lote)
            document.querySelectorAll('.btn-agrupamento').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    
                    // Remover active de todos
                    document.querySelectorAll('.btn-agrupamento').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'transparent';
                        b.style.color = 'var(--gray-600)';
                        b.style.boxShadow = 'none';
                    });
                    
                    // Adicionar active ao clicado
                    this.classList.add('active');
                    this.style.background = 'var(--primary-color)';
                    this.style.color = 'white';
                    this.style.boxShadow = '0 2px 4px rgba(59,130,246,0.3)';
                    
                    tipoAgrupamento = this.dataset.agrupamento;
                    
                    // Recarregar gr√°fico se houver lotes selecionados
                    const checkboxes = document.querySelectorAll('.filtro-lote-checkbox:checked');
                    if (checkboxes.length > 0) {
                        carregarGraficoRefeicoes();
                        carregarGraficoGastos();
                    }
                });
            });

            // Anima√ß√µes
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            });

            document.querySelectorAll('.fade-in').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(30px)';
                el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(el);
            });
            
            // N√£o carregar gr√°fico automaticamente - aguardar sele√ß√£o de lote
            // Exibir placeholder inicial
            document.getElementById('placeholder-refeicoes').style.display = 'flex';
        });
    </script>
    
    <!-- Overlay e Popup de Lotes (fora do contexto de empilhamento) -->
    <div id="lotes-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9998;"></div>
    
    <div id="lotes-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 2px solid var(--gray-300); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); min-width: 400px; max-width: 500px; z-index: 9999;">
        <div style="padding: 1.25rem; border-bottom: 1px solid var(--gray-200);">
            <h4 style="margin: 0; color: var(--primary-color); font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">üì¶ Selecionar Lotes Ativos</h4>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.813rem; color: var(--gray-600);">Escolha um ou mais lotes para filtrar os dados</p>
        </div>
        
        <div style="padding: 1.25rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                <button id="btn-selecionar-todos-lotes" style="flex: 1; padding: 0.65rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">‚úÖ Selecionar Todos</button>
                <button id="btn-limpar-lotes" style="flex: 1; padding: 0.65rem; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">‚ùå Limpar Todos</button>
            </div>
            
            <div id="lotes-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                {% for lote in lotes %}
                <label class="lote-checkbox-label" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 6px; cursor: pointer; transition: background 0.2s; margin-bottom: 0.25rem;">
                    <input type="checkbox" class="filtro-lote-checkbox" value="{{ lote.id }}" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="color: var(--gray-700); font-size: 0.875rem; flex: 1;">{{ lote.nome }}{% if lote.empresa %} <span style="color: var(--gray-500);">- {{ lote.empresa }}</span>{% endif %}</span>
                </label>
                {% endfor %}
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                <span id="lotes-count" style="font-size: 0.875rem; color: var(--gray-600); font-weight: 500;">0 lote(s) selecionado(s)</span>
                <div style="display: flex; gap: 0.75rem;">
                    <button id="btn-cancelar-lotes" style="padding: 0.65rem 1.25rem; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Cancelar</button>
                    <button id="btn-aplicar-lotes" style="padding: 0.65rem 1.25rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Aplicar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Overlay e Popup de Unidades -->
    <div id="unidades-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9998;"></div>
    
    <div id="unidades-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 2px solid var(--gray-300); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); min-width: 400px; max-width: 500px; z-index: 9999;">
        <div style="padding: 1.25rem; border-bottom: 1px solid var(--gray-200);">
            <h4 style="margin: 0; color: var(--primary-color); font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">üè¢ Selecionar Unidades</h4>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.813rem; color: var(--gray-600);">Escolha uma ou mais unidades para filtrar os dados</p>
        </div>
        
        <div style="padding: 1.25rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                <button id="btn-selecionar-todas-unidades" style="flex: 1; padding: 0.65rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">‚úÖ Selecionar Todas</button>
                <button id="btn-limpar-unidades" style="flex: 1; padding: 0.65rem; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;">‚ùå Limpar Todas</button>
            </div>
            
            <div id="unidades-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                <!-- Unidades ser√£o carregadas dinamicamente -->
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                <span id="unidades-count" style="font-size: 0.875rem; color: var(--gray-600); font-weight: 500;">0 unidade(s) selecionada(s)</span>
                <div style="display: flex; gap: 0.75rem;">
                    <button id="btn-cancelar-unidades" style="padding: 0.65rem 1.25rem; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Cancelar</button>
                    <button id="btn-aplicar-unidades" style="padding: 0.65rem 1.25rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500;">Aplicar</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>