<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Lote - SGMRP</title>
    <meta name="description" content="Detalhes do lote contratual com mapas de refei√ß√µes e indicadores">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Notifica√ß√µes estilizadas */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideInRight 0.5s ease-out;
        }

        .notification-content {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            max-width: 450px;
            color: white;
        }

        .notification-success .notification-content {
            background: #16a34a;
        }

        .notification-warning .notification-content {
            background: #f59e0b;
        }

        .notification-error .notification-content {
            background: #dc2626;
        }

        .notification-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .notification-text {
            flex: 1;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            margin-left: 0.5rem;
            opacity: 0.8;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .notification.closing {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        /* Responsividade */
        @media (max-width: 480px) {
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
            }
            
            .notification-content {
                min-width: auto;
                max-width: none;
            }
        }

        /* Estilos para tabela edit√°vel estilo Excel */
        .tabela-manual {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.875rem;
            margin-top: 1.5rem;
            background: white;
            border: 2px solid var(--gray-300);
        }

        .tabela-manual th {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .tabela-manual td {
            border: 1px solid var(--gray-300);
            padding: 0;
            position: relative;
        }

        .tabela-manual td.data-column {
            background: var(--gray-50);
            text-align: center;
            font-weight: 500;
            color: var(--gray-700);
            padding: 0.5rem;
            width: 100px;
        }

        .tabela-manual input {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            padding: 0.5rem;
            font-size: 0.875rem;
            text-align: center;
            background: transparent;
            min-height: 40px;
        }

        .tabela-manual input:focus {
            background: #e3f2fd;
            box-shadow: inset 0 0 0 2px var(--primary-color);
        }

        .tabela-manual input:hover {
            background: var(--gray-50);
        }

        .tabela-manual tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .tabela-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
        }

        .tabela-manual tbody tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }

        .tabela-manual tbody tr:nth-child(even):hover {
            background: rgba(59, 130, 246, 0.05);
        }

        /* Estilos para c√©lulas selecionadas */
        .tabela-manual input.selected {
            background: #e3f2fd !important;
            box-shadow: inset 0 0 0 2px var(--primary-color) !important;
        }

        .tabela-manual input.paste-highlight {
            background: #d4edda !important;
            animation: pasteFlash 1s ease-out;
        }

        @keyframes pasteFlash {
            0% { background: #28a745 !important; }
            100% { background: #d4edda !important; }
        }

        /* Adicionar dica visual para paste */
        .paste-hint {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tabela-manual td:hover .paste-hint {
            opacity: 1;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('dashboard') }}" class="logo">SGMRP</a>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <li><a href="{{ url_for('lotes') }}">Lotes</a></li>
                        <li><a href="{{ url_for('relatorios') }}">Relat√≥rios</a></li>
                        <li><a href="#configuracoes">Configura√ß√µes</a></li>
                        <li><a href="#" id="logoutLink" style="color: #fed7d7;">Sair</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
            <!-- Bot√£o flutuante para troca de abas/tabelas -->
            <div style="position: fixed; bottom: 32px; right: 32px; z-index: 1200;">
                <button class="btn btn-primary" id="btn-troca-tabela" style="border-radius: 12px; padding: 12px 20px; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4); font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: all 0.3s ease; border: none; backdrop-filter: blur(10px);" title="Alternar entre tabelas">
                    <span id="icon-troca-tabela" style="font-size: 1.25rem;">‚áÑ</span>
                    <span style="letter-spacing: 0.5px;">Trocar Tabela</span>
                </button>
            </div>
        <div class="container">
            <!-- Breadcrumb -->
            <nav aria-label="Navega√ß√£o" style="margin-bottom: 2rem;">
                <div style="margin-bottom: 2.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 0.75rem 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                    <div style="display: flex; gap: 0.5rem; font-size: 0.95rem; color: var(--gray-500); align-items: center;">
                        <span><a href="{{ url_for('dashboard') }}" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">Dashboard</a></span>
                        <span aria-hidden="true" style="font-size: 1.1em; opacity: 0.7;">/</span>
                        <span><a href="{{ url_for('lotes') }}" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">Lotes</a></span>
                        <span aria-hidden="true" style="font-size: 1.1em; opacity: 0.7;">/</span>
                        <span aria-current="page" style="color: var(--primary-color); font-weight: 600;">{{ lote.nome }}</span>
                    </div>
                </div>
                    <!-- Apenas o breadcrumb completo -->
                </ol>
            </nav>

            <!-- Header do Lote -->
            <section class="card" style="margin-bottom: 2rem;">
                <div class="card-body" style="padding: 2rem;">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: start;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <h1 style="margin: 0; color: var(--primary-color);" id="titulo-lote">{{ lote.nome }}</h1>
                                {% if lote.ativo %}
                                <div class="badge" style="background-color: var(--success-color); color: white; padding: 0.5rem 1rem; border-radius: 1rem; font-size: 0.875rem;">
                                    ATIVO
                                </div>
                                {% else %}
                                <div class="badge" style="background-color: var(--gray-400); color: white; padding: 0.5rem 1rem; border-radius: 1rem; font-size: 0.875rem;">
                                    INATIVO
                                </div>
                                {% endif %}
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                <div>
                                    <strong>Empresa Respons√°vel:</strong><br>
                                    <span id="empresa-nome">{{ lote.empresa }}</span>
                                </div>
                                <div>
                                    <strong>Contrato:</strong><br>
                                    <span>{{ lote.contrato }}</span>
                                </div>
                                <div>
                                    <strong>In√≠cio do Contrato:</strong><br>
                                    {% if lote.data_inicio %}
                                        <span>{{ lote.data_inicio.split('-')[2] }}/{{ lote.data_inicio.split('-')[1] }}/{{ lote.data_inicio.split('-')[0] }}</span>
                                    {% else %}
                                        <span style="color: #aaa;">N√£o informado</span>
                                    {% endif %}
                                </div>
                                <div>
                                    <strong>Unidades Ativas:</strong><br>
                                    <span id="unidades-count">
                                        {{ unidades_lote | length }} unidades
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Tabela de Pre√ßos das Refei√ß√µes -->
                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
                                <h4 style="margin: 0 0 1rem 0; color: var(--gray-700); font-size: 1rem;">üí∞ Pre√ßos das Refei√ß√µes</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem;">
                                    {% if lote.precos %}
                                    <div style="background-color: var(--gray-50); padding: 0.75rem; border-radius: var(--border-radius); text-align: center;">
                                        <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 0.25rem;">‚òï Caf√©</div>
                                        <div style="font-size: 0.875rem;">
                                            <span style="color: var(--gray-600);">Interno:</span> <strong>R$ {{ "%.2f"|format(lote.precos.cafe.interno) }}</strong><br>
                                            <span style="color: var(--gray-600);">Func.:</span> <strong>R$ {{ "%.2f"|format(lote.precos.cafe.funcionario) }}</strong>
                                        </div>
                                    </div>
                                    <div style="background-color: var(--gray-50); padding: 0.75rem; border-radius: var(--border-radius); text-align: center;">
                                        <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 0.25rem;">üçΩÔ∏è Almo√ßo</div>
                                        <div style="font-size: 0.875rem;">
                                            <span style="color: var(--gray-600);">Interno:</span> <strong>R$ {{ "%.2f"|format(lote.precos.almoco.interno) }}</strong><br>
                                            <span style="color: var(--gray-600);">Func.:</span> <strong>R$ {{ "%.2f"|format(lote.precos.almoco.funcionario) }}</strong>
                                        </div>
                                    </div>
                                    <div style="background-color: var(--gray-50); padding: 0.75rem; border-radius: var(--border-radius); text-align: center;">
                                        <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 0.25rem;">ü•™ Lanche</div>
                                        <div style="font-size: 0.875rem;">
                                            <span style="color: var(--gray-600);">Interno:</span> <strong>R$ {{ "%.2f"|format(lote.precos.lanche.interno) }}</strong><br>
                                            <span style="color: var(--gray-600);">Func.:</span> <strong>R$ {{ "%.2f"|format(lote.precos.lanche.funcionario) }}</strong>
                                        </div>
                                    </div>
                                    <div style="background-color: var(--gray-50); padding: 0.75rem; border-radius: var(--border-radius); text-align: center;">
                                        <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 0.25rem;">üåô Jantar</div>
                                        <div style="font-size: 0.875rem;">
                                            <span style="color: var(--gray-600);">Interno:</span> <strong>R$ {{ "%.2f"|format(lote.precos.jantar.interno) }}</strong><br>
                                            <span style="color: var(--gray-600);">Func.:</span> <strong>R$ {{ "%.2f"|format(lote.precos.jantar.funcionario) }}</strong>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div style="grid-column: 1 / -1; text-align: center; color: var(--gray-500); font-style: italic; padding: 1rem;">
                                        Pre√ßos das refei√ß√µes n√£o dispon√≠veis para este lote
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üìä</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--primary-color);" id="conformidade-geral">
                                N/A
                            </div>
                            <div style="font-size: 0.875rem; color: var(--gray-600);">Conformidade Geral</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Filtros e Controles -->
            <section class="fade-in" style="margin-bottom: 2rem;">
                <!-- Filtros Compactos -->
                <div style="background: white; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.125rem;">üîç</span>
                            <span style="font-weight: 500; color: var(--gray-700); font-size: 0.875rem;">Filtros:</span>
                        </div>
                        
                        <div class="periodo-filter-container" style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Per√≠odo:</label>
                            <div class="periodo-display" id="periodo-display" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;">
                                <span class="periodo-text" id="periodo-text">Setembro/2025</span>
                                <span class="periodo-icon">üìÖ</span>
                            </div>
                            
                            <!-- Overlay para fechar calend√°rio -->
                            <div class="calendario-overlay" id="calendario-overlay"></div>
                            
                            <!-- Popup do calend√°rio -->
                            <div class="calendario-popup" id="calendario-popup">
                                <div class="calendario-header">
                                    <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem;">üìÖ Selecionar Per√≠odo</h4>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--gray-600);">Escolha as datas de in√≠cio e fim para filtrar os dados</p>
                                </div>
                                
                                <div class="calendario-body">
                                    <div class="periodo-inputs">
                                        <div class="date-input-group">
                                            <label class="date-input-label">ÔøΩ In√≠cio</label>
                                            <input type="date" class="date-input" id="data-inicio" value="2025-09-01">
                                        </div>
                                        <div class="date-input-group">
                                            <label class="date-input-label">ÔøΩ Fim</label>
                                            <input type="date" class="date-input" id="data-fim" value="2025-09-30">
                                        </div>
                                        <div class="date-input-group">
                                            <label class="date-input-label">üìÖ M√™s</label>
                                            <select class="date-input" id="mes-periodo">
                                                <option value="1">Janeiro</option>
                                                <option value="2">Fevereiro</option>
                                                <option value="3">Mar√ßo</option>
                                                <option value="4">Abril</option>
                                                <option value="5">Maio</option>
                                                <option value="6">Junho</option>
                                                <option value="7">Julho</option>
                                                <option value="8">Agosto</option>
                                                <option value="9">Setembro</option>
                                                <option value="10">Outubro</option>
                                                <option value="11">Novembro</option>
                                                <option value="12">Dezembro</option>
                                            </select>
                                        </div>
                                        <div class="date-input-group">
                                            <label class="date-input-label">üìÖ Ano</label>
                                            <input type="number" class="date-input" id="ano-periodo" min="2020" max="2030">
                                        </div>
                                    </div>
                                    
                                    <div class="calendario-actions">
                                        <div class="periodo-info">
                                            <span id="dias-periodo">30 dias selecionados</span>
                                        </div>
                                        <div class="action-buttons">
                                            <button class="btn-calendario" id="btn-cancelar-periodo">‚ùå Cancelar</button>
                                            <button class="btn-calendario primary" id="btn-aplicar-periodo">‚úÖ Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="unidades-filter-container" style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Unidades:</label>
                            <div class="unidades-display" id="unidades-display" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;">
                                <span class="unidades-text" id="unidades-text">Todas as unidades</span>
                                <span class="unidades-icon">üè¢</span>
                            </div>
                            
                            <!-- Overlay para fechar popup de unidades -->
                            <div class="unidades-overlay" id="unidades-overlay"></div>
                            
                            <!-- Popup de sele√ß√£o de unidades -->
                            <div class="unidades-popup" id="unidades-popup">
                                <div class="unidades-header">
                                    <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem;">üè¢ Selecionar Unidades</h4>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--gray-600);">Escolha as unidades para filtrar os dados</p>
                                </div>
                                
                                <div class="unidades-body">
                                    <div class="unidades-controls">
                                        <button class="control-btn" id="btn-selecionar-todas">‚úÖ Todas</button>
                                        <button class="control-btn" id="btn-limpar-todas">‚ùå Limpar</button>
                                    </div>
                                    
                                    <div class="unidades-list" id="unidades-list">
                                        {% for unidade in unidades_lote %}
                                        <div class="unidade-item" data-value="{{ unidade }}">
                                            <input type="checkbox" class="unidade-checkbox" id="checkbox-unidade{{ loop.index }}" value="{{ unidade }}">
                                            <label class="unidade-label" for="checkbox-unidade{{ loop.index }}">{{ unidade }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <div class="unidades-actions">
                                        <div class="unidades-info">
                                            <span id="unidades-selecionadas-count">
                                                {{ unidades_lote | length }} unidades selecionadas
                                            </span>
                                        </div>
                                        <div class="action-buttons">
                                            <button class="btn-calendario" id="btn-cancelar-unidades">‚ùå Cancelar</button>
                                            <button class="btn-calendario primary" id="btn-aplicar-unidades">‚úÖ Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bot√µes de A√ß√£o -->
                <div style="background: white; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center;">
                        <button class="btn btn-primary" id="btn-adicionar-dados" style="font-size: 0.875rem; padding: 0.625rem 1rem;">
                            üì§ Adicionar Dados
                        </button>
                        <button class="btn btn-secondary" id="btn-entrada-manual" style="font-size: 0.875rem; padding: 0.625rem 1rem;">
                            ‚úèÔ∏è Entrada Manual
                        </button>
                        <button class="btn btn-danger" id="btn-excluir-dados" style="font-size: 0.875rem; padding: 0.625rem 1rem;">
                            üóëÔ∏è Excluir Dados
                        </button>
                        <button class="btn btn-info" id="btn-adicionar-siisp" style="font-size: 0.875rem; padding: 0.625rem 1rem;">
                            ÔøΩ Adicionar n¬∫ SIISP
                        </button>
                    </div>
                </div>
            </section>

            <!-- Container de Resumos com Sub-abas -->
            <section class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3>üìä Resumos do Per√≠odo</h3>
                </div>
                
                <!-- Sub-abas de Resumos -->
                <div style="border-bottom: 2px solid var(--gray-200); background-color: var(--gray-50);">
                    <div style="display: flex; padding: 0 1rem;">
                        <button class="resumo-tab-button active" data-resumo-tab="resumo-refeicoes" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 500; color: var(--gray-600); border-bottom: 3px solid transparent; transition: all 0.3s ease;">
                            üçΩÔ∏è Resumo Refei√ß√µes
                        </button>
                        <button class="resumo-tab-button" data-resumo-tab="resumo-financeiro" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 500; color: var(--gray-600); border-bottom: 3px solid transparent; transition: all 0.3s ease;">
                            üí∞ Resumo Financeiro
                        </button>
                    </div>
                </div>

                <!-- Conte√∫do das Sub-abas -->
                <div class="card-body">
                    
                    <!-- Sub-aba 1: Resumo de Refei√ß√µes -->
                    <div id="resumo-tab-resumo-refeicoes" class="resumo-tab-content" style="display: block;">
                        <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 2rem; align-items: center;">
                            <!-- Total Geral - Esquerda -->
                            <div style="text-align: center; padding: 1.5rem; background-color: var(--gray-50); border-radius: var(--border-radius);">
                                <div style="font-size: 2rem; color: var(--primary-color); font-weight: 600;" id="total-refeicoes">28,450</div>
                                <div style="color: var(--gray-600); font-size: 0.875rem;">Total de Refei√ß√µes</div>
                            </div>

                            <!-- Indicadores por Tipo de Refei√ß√£o - Centro -->
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                                <!-- Linha Superior -->
                                <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                    <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-cafe-interno">0</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Caf√© Interno</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                    <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-cafe-funcionario">0</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Caf√© Funcion√°rio</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                    <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-almoco-interno">0</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Almo√ßo Interno</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                    <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-almoco-funcionario">0</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Almo√ßo Funcion√°rio</div>
                                </div>
                                
                                <!-- Linha Inferior -->
                                <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                    <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-lanche-interno">0</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Lanche Interno</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                    <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-lanche-funcionario">0</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Lanche Funcion√°rio</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                    <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-jantar-interno">0</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Jantar Interno</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                    <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-jantar-funcionario">0</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Jantar Funcion√°rio</div>
                                </div>
                            </div>

                            <!-- Indicadores de Conformidade - Direita -->
                            <div style="display: grid; grid-template-rows: 1fr 1fr; gap: 1rem;">
                                <div style="text-align: center; padding: 1.5rem; background-color: var(--gray-50); border-radius: var(--border-radius);">
                                    <div style="font-size: 1.8rem; color: var(--warning-color); font-weight: 600;" id="diferencas-pequenas">23</div>
                                    <div style="color: var(--gray-600); font-size: 0.875rem;">Diferen√ßas Pequenas</div>
                                </div>
                                <div style="text-align: center; padding: 1.5rem; background-color: var(--gray-50); border-radius: var(--border-radius);">
                                    <div style="font-size: 1.8rem; color: var(--danger-color); font-weight: 600;" id="discrepancias-criticas">8</div>
                                    <div style="color: var(--gray-600); font-size: 0.875rem;">Discrep√¢ncias Cr√≠ticas</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sub-aba 2: Resumo Financeiro -->
                    <div id="resumo-tab-resumo-financeiro" class="resumo-tab-content" style="display: none;">
                        <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 2fr) minmax(0, 1fr); gap: 2rem; align-items: start; overflow: hidden;">
                            <!-- Valor Total - Esquerda -->
                            <div style="text-align: center; padding: 1rem; background-color: #f0f9ff; border-radius: var(--border-radius); border: 2px solid var(--success-color); min-width: 0;">
                                <div style="font-size: 2rem; color: var(--success-color); font-weight: 600; word-break: break-word;" id="valor-total">R$ 0,00</div>
                                <div style="color: var(--gray-600); font-size: 0.875rem;">Valor Total</div>
                            </div>

                            <!-- Valores Parciais por Tipo de Refei√ß√£o - Centro -->
                            <div style="display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 1rem; min-width: 0;">
                                <!-- Linha Superior -->
                                <div style="text-align: center; padding: 0.4rem; background-color: #fef3c7; border-radius: var(--border-radius); min-width: 0;">
                                    <div style="font-size: 1rem; color: #d97706; font-weight: 600; word-break: break-word;" id="valor-cafe-interno">R$ 0,00</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Caf√© Interno</div>
                                </div>
                                <div style="text-align: center; padding: 0.4rem; background-color: #fef3c7; border-radius: var(--border-radius); min-width: 0;">
                                    <div style="font-size: 1rem; color: #d97706; font-weight: 600; word-break: break-word;" id="valor-cafe-funcionario">R$ 0,00</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Caf√© Funcion√°rio</div>
                                </div>
                                <div style="text-align: center; padding: 0.4rem; background-color: #fef3c7; border-radius: var(--border-radius); min-width: 0;">
                                    <div style="font-size: 1rem; color: #d97706; font-weight: 600; word-break: break-word;" id="valor-almoco-interno">R$ 0,00</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Almo√ßo Interno</div>
                                </div>
                                <div style="text-align: center; padding: 0.4rem; background-color: #fef3c7; border-radius: var(--border-radius); min-width: 0;">
                                    <div style="font-size: 1rem; color: #d97706; font-weight: 600; word-break: break-word;" id="valor-almoco-funcionario">R$ 0,00</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Almo√ßo Funcion√°rio</div>
                                </div>                            <!-- Linha Inferior -->
                                <div style="text-align: center; padding: 0.4rem; background-color: #fef3c7; border-radius: var(--border-radius); min-width: 0;">
                                    <div style="font-size: 1rem; color: #d97706; font-weight: 600; word-break: break-word;" id="valor-lanche-interno">R$ 0,00</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Lanche Interno</div>
                                </div>
                                <div style="text-align: center; padding: 0.4rem; background-color: #fef3c7; border-radius: var(--border-radius); min-width: 0;">
                                    <div style="font-size: 1rem; color: #d97706; font-weight: 600; word-break: break-word;" id="valor-lanche-funcionario">R$ 0,00</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Lanche Funcion√°rio</div>
                                </div>
                                <div style="text-align: center; padding: 0.4rem; background-color: #fef3c7; border-radius: var(--border-radius); min-width: 0;">
                                    <div style="font-size: 1rem; color: #d97706; font-weight: 600; word-break: break-word;" id="valor-jantar-interno">R$ 0,00</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Jantar Interno</div>
                                </div>
                                <div style="text-align: center; padding: 0.4rem; background-color: #fef3c7; border-radius: var(--border-radius); min-width: 0;">
                                    <div style="font-size: 1rem; color: #d97706; font-weight: 600; word-break: break-word;" id="valor-jantar-funcionario">R$ 0,00</div>
                                    <div style="color: var(--gray-600); font-size: 0.75rem;">Jantar Funcion√°rio</div>
                                </div>
                            </div>

                            <!-- Indicador de Desvio - Direita -->
                            <div style="text-align: center; padding: 1rem; background-color: #fef2f2; border-radius: var(--border-radius); border: 2px solid var(--danger-color); min-width: 0;">
                                <div style="font-size: 1.8rem; color: var(--danger-color); font-weight: 600; word-break: break-word;" id="valor-desvio">R$ 0,00</div>
                                <div style="color: var(--gray-600); font-size: 0.875rem;">Desvio</div>
                                <div style="color: var(--gray-500); font-size: 0.75rem; margin-top: 0.25rem;">Valores Excedentes</div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </section>

            <!-- Se√ß√µes Colaps√°veis -->
            <div style="display: grid; gap: 2rem;">
                <!-- Se√ß√£o de Adi√ß√£o de Dados -->
                <section class="card" id="secao-importacao" style="display: none;">
                    <div class="card-header">
                        <h3>Adicionar Dados via PDF</h3>
                    </div>
                    <div class="card-body">
                        <!-- Seletor de M√™s e Ano -->
                        <div class="mes-ano-selector">
                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                <label class="form-label" style="margin: 0; font-weight: 600; color: var(--primary-color);">üìÖ Per√≠odo de Refer√™ncia:</label>
                                <div class="mes-ano-display" id="mes-ano-display-import">
                                    <span class="mes-ano-text" id="mes-ano-text-import">Setembro/2025</span>
                                    <span class="mes-ano-icon">üìÖ</span>
                                </div>
                            </div>
                            <div class="mes-ano-inputs">
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">M√™s</label>
                                    <select id="mes-import" class="mes-ano-input">
                                        <option value="1">Jan</option>
                                        <option value="2">Fev</option>
                                        <option value="3">Mar</option>
                                        <option value="4">Abr</option>
                                        <option value="5">Mai</option>
                                        <option value="6">Jun</option>
                                        <option value="7">Jul</option>
                                        <option value="8">Ago</option>
                                        <option value="9" selected>Set</option>
                                        <option value="10">Out</option>
                                        <option value="11">Nov</option>
                                        <option value="12">Dez</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">Ano</label>
                                    <input type="number" id="ano-import" class="mes-ano-input" value="2025" min="2020" max="2030">
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <div class="form-group">
                                    <label for="select-presidio-import" class="form-label">Unidade</label>
                                    <select id="select-unidade-import" class="form-select" required>
                                        <option value="">Selecione a unidade</option>
                                        {% for unidade in unidades_lote %}
                                        <option value="{{ unidade }}">{{ unidade }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="texto-pdf" class="form-label">Texto extra√≠do do PDF ou Excel</label>
                                    <textarea 
                                        id="texto-pdf" 
                                        class="form-textarea" 
                                        rows="12" 
                                        placeholder="Cole aqui o texto extra√≠do do PDF ou Excel com os dados de refei√ß√µes..."
                                    ></textarea>
                                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">
                                        Formato esperado: Data, tipo de refei√ß√£o e quantidade por linha
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="form-group">
                                    <label for="dados-siisp" class="form-label">Dados do SIISP (opcional)</label>
                                    <textarea 
                                        id="dados-siisp" 
                                        class="form-textarea" 
                                        rows="4" 
                                        placeholder="Cole os dados de n√∫mero de detentos do SIISP para compara√ß√£o..."
                                    ></textarea>
                                </div>
                                
                                <div style="padding: 1.5rem; background-color: var(--light-blue); border-radius: var(--border-radius); margin-bottom: 1rem;">
                                    <h4 style="color: var(--primary-color); margin-bottom: 1rem;">üìã Formato dos Dados:</h4>
                                    <p style="font-size: 0.875rem; color: var(--gray-700); margin-bottom: 1rem;">
                                        Cole os dados separados por <strong>TAB</strong> ou <strong>ESPA√áOS</strong>. O sistema detecta automaticamente o separador.
                                    </p>
                                    
                                    <h5 style="color: var(--primary-color); margin-bottom: 0.5rem; font-size: 0.875rem;">‚úÖ Formato com TAB (recomendado):</h5>
                                    <pre style="font-family: 'Courier New', monospace; font-size: 0.75rem; color: var(--gray-700); margin: 0 0 1rem 0; background-color: #f8f9fa; padding: 0.75rem; border-radius: 4px; white-space: pre-wrap;">01/09/2025	915	12	915	70	915	58	915	12	909
02/09/2025	914	12	914	70	914	58	914	12	909
03/09/2025	901	12	901	70	901	58	904	12	896</pre>
                                    
                                    <h5 style="color: var(--primary-color); margin-bottom: 0.5rem; font-size: 0.875rem;">‚úÖ Formato com ESPA√áOS (tamb√©m aceito):</h5>
                                    <pre style="font-family: 'Courier New', monospace; font-size: 0.75rem; color: var(--gray-700); margin: 0; background-color: #f8f9fa; padding: 0.75rem; border-radius: 4px; white-space: pre-wrap;">01/09/2025 915 12 915 70 915 58 915 12 909
02/09/2025 914 12 914 70 914 58 914 12 909
03/09/2025 901 12 901 70 901 58 904 12 896</pre>
                                    
                                    <div style="margin-top: 1rem; padding: 0.75rem; background-color: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;">
                                        <p style="font-size: 0.75rem; margin: 0; color: #856404;">
                                            <strong>üí° Dica:</strong> Dados copiados do Excel usam TAB. Dados copiados de PDFs usam espa√ßos. Ambos funcionam!
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: end; margin-top: 1rem;">
                            <button class="btn btn-secondary" id="btn-cancelar-import">Cancelar</button>
                            <button class="btn btn-primary" id="btn-processar-import">Adicionar</button>
                        </div>
                    </div>
                </section>

                <!-- Se√ß√£o de Entrada Manual -->
                <section class="card" id="secao-manual" style="display: none;">
                    <div class="card-header">
                        <h3>Entrada Manual de Dados</h3>
                    </div>
                    <div class="card-body">
                        <!-- Seletor de M√™s e Ano -->
                        <div class="mes-ano-selector">
                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                <label class="form-label" style="margin: 0; font-weight: 600; color: var(--primary-color);">üìÖ Per√≠odo de Refer√™ncia:</label>
                                <div class="mes-ano-display" id="mes-ano-display-manual">
                                    <span class="mes-ano-text" id="mes-ano-text-manual">Setembro/2025</span>
                                    <span class="mes-ano-icon">üìÖ</span>
                                </div>
                            </div>
                            <div class="mes-ano-inputs">
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">M√™s</label>
                                    <select id="mes-manual" class="mes-ano-input">
                                        <option value="1">Jan</option>
                                        <option value="2">Fev</option>
                                        <option value="3">Mar</option>
                                        <option value="4">Abr</option>
                                        <option value="5">Mai</option>
                                        <option value="6">Jun</option>
                                        <option value="7">Jul</option>
                                        <option value="8">Ago</option>
                                        <option value="9" selected>Set</option>
                                        <option value="10">Out</option>
                                        <option value="11">Nov</option>
                                        <option value="12">Dez</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">Ano</label>
                                    <input type="number" id="ano-manual" class="mes-ano-input" value="2025" min="2020" max="2030">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="select-unidade-manual" class="form-label">Unidade</label>
                            <select id="select-unidade-manual" class="form-select" required>
                                <option value="">Selecione a unidade</option>
                                {% for unidade in unidades_lote %}
                                <option value="{{ unidade }}">{{ unidade }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Tabela de entrada manual -->
                        <div style="margin-top: 1rem; padding: 0.75rem; background-color: #e3f2fd; border-radius: 4px; border-left: 4px solid var(--primary-color);">
                            <p style="font-size: 0.75rem; margin: 0; color: var(--primary-color);">
                                <strong>üí° Dica:</strong> Voc√™ pode copiar dados do Excel e colar diretamente na tabela. Os dados se espalhar√£o automaticamente pelas c√©lulas corretas (incluindo datas)!
                            </p>
                        </div>
                        
                        <div class="tabela-container">
                            <table class="tabela-manual" id="tabela-entrada-manual">
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Data</th>
                                        <th style="width: 90px;">Caf√©<br>Interno</th>
                                        <th style="width: 90px;">Caf√©<br>Funcion√°rio</th>
                                        <th style="width: 90px;">Almo√ßo<br>Interno</th>
                                        <th style="width: 90px;">Almo√ßo<br>Funcion√°rio</th>
                                        <th style="width: 90px;">Lanche<br>Interno</th>
                                        <th style="width: 90px;">Lanche<br>Funcion√°rio</th>
                                        <th style="width: 90px;">Jantar<br>Interno</th>
                                        <th style="width: 90px;">Jantar<br>Funcion√°rio</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-entrada-manual">
                                    <!-- Linhas ser√£o geradas dinamicamente pelo JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: end; margin-top: 1rem;">
                            <button class="btn btn-secondary" id="btn-cancelar-manual">Cancelar</button>
                            <button class="btn btn-primary" id="btn-salvar-manual">Salvar Dados</button>
                        </div>
                    </div>
                </section>

                <!-- Se√ß√£o de Exclus√£o de Dados -->
                <section class="card" id="secao-exclusao" style="display: none;">
                    <div class="card-header">
                        <h3>Excluir Dados</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; align-items: end; margin-bottom: 2rem;">
                            <div class="form-group">
                                <label for="select-unidade-exclusao" class="form-label">Unidade</label>
                                <select id="select-unidade-exclusao" class="form-select" required>
                                    <option value="">Selecione a unidade</option>
                                    {% for unidade in unidades_lote %}
                                    <option value="{{ unidade }}">{{ unidade }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="mes-exclusao" class="form-label">M√™s</label>
                                <select id="mes-exclusao" class="form-select" required>
                                    <option value="">Selecione o m√™s</option>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Mar√ßo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="ano-exclusao" class="form-label">Ano</label>
                                <input type="number" id="ano-exclusao" class="form-input" min="2020" max="2030" value="2025" required>
                            </div>
                        </div>
                        
                        <div style="padding: 1rem; background-color: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107; margin-bottom: 1.5rem;">
                            <p style="font-size: 0.875rem; margin: 0; color: #856404;">
                                <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta a√ß√£o excluir√° permanentemente todos os dados de refei√ß√µes da unidade selecionada para o m√™s/ano especificado. Esta a√ß√£o n√£o pode ser desfeita.
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: end;">
                            <button class="btn btn-secondary" id="btn-cancelar-exclusao">Cancelar</button>
                            <button class="btn btn-danger" id="btn-confirmar-exclusao">Excluir Dados</button>
                        </div>
                    </div>
                </section>

                <!-- Se√ß√£o de Adi√ß√£o de N√∫meros SIISP -->
                <section class="card" id="secao-siisp" style="display: none;">
                    <div class="card-header">
                        <h3>Adicionar N√∫meros SIISP</h3>
                    </div>
                    <div class="card-body">
                        <!-- Seletor de M√™s e Ano -->
                        <div class="mes-ano-selector">
                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                <span class="form-label" style="margin: 0; min-width: 120px; font-weight: 500;">M√™s/Ano:</span>
                                <div id="mes-ano-display-siisp" class="mes-ano-display">
                                    <span id="mes-ano-text-siisp">Selecionar m√™s e ano</span>
                                    <i style="font-size: 1rem; color: var(--gray-500);">üìÖ</i>
                                </div>
                            </div>
                            <div class="mes-ano-inputs">
                                <div class="form-group" style="margin: 0;">
                                    <label for="mes-siisp" class="form-label">M√™s</label>
                                    <select id="mes-siisp" class="form-select" required>
                                        <option value="1">Janeiro</option>
                                        <option value="2">Fevereiro</option>
                                        <option value="3">Mar√ßo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Maio</option>
                                        <option value="6">Junho</option>
                                        <option value="7">Julho</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Setembro</option>
                                        <option value="10">Outubro</option>
                                        <option value="11">Novembro</option>
                                        <option value="12">Dezembro</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label for="ano-siisp" class="form-label">Ano</label>
                                    <input type="number" id="ano-siisp" class="form-input" placeholder="2025" min="2020" max="2030" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="select-unidade-siisp" class="form-label">Unidade</label>
                            <select id="select-unidade-siisp" class="form-select" required>
                                <option value="">Selecione a unidade...</option>
                                {% for unidade in unidades_lote %}
                                <option value="{{ unidade }}">{{ unidade }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="numeros-siisp" class="form-label">N√∫meros SIISP</label>
                            <textarea id="numeros-siisp" class="form-textarea" rows="15" placeholder="Cole os n√∫meros SIISP aqui (um por linha)&#10;&#10;Exemplo:&#10;1250&#10;1189&#10;1205&#10;1178&#10;1192&#10;..."></textarea>
                            <div class="form-help">
                                <p style="font-size: 0.875rem; color: var(--gray-600); margin: 0.5rem 0 0;">
                                    üí° <strong>Instru√ß√µes:</strong> Cole os n√∫meros SIISP, um por linha. Deve haver um n√∫mero para cada dia do m√™s selecionado.
                                </p>
                            </div>
                        </div>

                        <!-- Informa√ß√µes e Instru√ß√µes -->
                        <div style="margin-top: 1.5rem;">
                            <div style="padding: 1rem; background-color: #e3f2fd; border-radius: 4px; border-left: 4px solid var(--primary-color); margin-bottom: 1rem;">
                                <h4 style="color: var(--primary-color); margin-bottom: 0.75rem; font-size: 1rem;">‚ÑπÔ∏è Como funciona</h4>
                                <ul style="font-size: 0.875rem; margin: 0; color: var(--primary-color); padding-left: 1.25rem;">
                                    <li>Os n√∫meros SIISP s√£o usados para calcular as diferen√ßas com os dados de refei√ß√µes</li>
                                    <li>Deve haver exatamente um n√∫mero para cada dia do m√™s</li>
                                    <li>Os n√∫meros ser√£o aplicados aos registros existentes da unidade selecionada</li>
                                    <li>Se n√£o existirem dados de refei√ß√µes para a unidade/per√≠odo, nada ser√° alterado</li>
                                </ul>
                            </div>
                            
                            <div style="padding: 1rem; background-color: #fff3cd; border-radius: 4px; border-left: 4px solid #ffc107;">
                                <p style="font-size: 0.875rem; margin: 0; color: #856404;">
                                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta opera√ß√£o ir√° sobrescrever os n√∫meros SIISP existentes para a unidade e per√≠odo selecionados.
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: end; margin-top: 1.5rem;">
                            <button class="btn btn-secondary" id="btn-cancelar-siisp">Cancelar</button>
                            <button class="btn btn-primary" id="btn-processar-siisp">Adicionar SIISP</button>
                        </div>
                    </div>
                </section>

                <!-- Sistema de Abas para Dados -->
                <section class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 id="titulo-tabela">üìã Dados Detalhados</h3>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-secondary" id="btn-legenda">
                                üé® Legenda
                            </button>
                            <button class="btn btn-sm btn-secondary" id="btn-exportar-tabela">
                                üìã Exportar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Abas de Navega√ß√£o -->
                    <div style="border-bottom: 2px solid var(--gray-200); background-color: var(--gray-50);">
                        <div style="display: flex; padding: 0 1rem;">
                            <button class="tab-button active" data-tab="dados-refeicoes" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 500; color: var(--gray-600); border-bottom: 3px solid transparent; transition: all 0.3s ease;">
                                üìä Dados de Refei√ß√µes
                            </button>
                            <button class="tab-button" data-tab="comparacao-siisp" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 500; color: var(--gray-600); border-bottom: 3px solid transparent; transition: all 0.3s ease;">
                                üéØ Compara√ß√£o SIISP
                            </button>
                        </div>
                    </div>

                    <!-- Conte√∫do das Abas -->
                    <div class="card-body" style="padding: 0;">
                        
                        <!-- Aba 1: Dados de Refei√ß√µes -->
                        <div id="tab-dados-refeicoes" class="tab-content" style="display: block;">
                            <div style="padding: 1rem; background-color: var(--light-blue); border-bottom: 1px solid var(--gray-200);">
                                <p style="margin: 0; font-size: 0.875rem; color: var(--primary-color);">
                                    <strong>üìã Tabela de Entrada:</strong> Visualize apenas os dados de refei√ß√µes inseridos, 
                                    sem compara√ß√£o. Esta √© a tabela base com os n√∫meros originais reportados.
                                </p>
                            </div>
                            <div class="table-container">
                                <table class="table" id="tabela-dados-refeicoes">
                                    <thead>
                                        <tr>
                                            <th rowspan="2">Data</th>
                                            <th rowspan="2">Unidade</th>
                                            <th colspan="2">Caf√©</th>
                                            <th colspan="2">Almo√ßo</th>
                                            <th colspan="2">Lanche</th>
                                            <th colspan="2">Jantar</th>
                                            <th rowspan="2">Total Dia</th>
                                        </tr>
                                        <tr>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-dados-refeicoes">
                                        <!-- Dados ser√£o inseridos via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Aba 2: Compara√ß√£o SIISP -->
                        <div id="tab-comparacao-siisp" class="tab-content" style="display: none;">
                            <div style="padding: 1rem; background-color: #fff3cd; border-bottom: 1px solid var(--gray-200);">
                                <p style="margin: 0; font-size: 0.875rem; color: #856404;">
                                    <strong>üéØ Tabela de Compara√ß√£o:</strong> Dados comparados com o SIISP, com indicadores 
                                    coloridos. Verde (OK), Azul (diferen√ßa 1-5), Vermelho (diferen√ßa >5).
                                </p>
                            </div>
                            <div class="table-container">
                                <table class="table" id="tabela-comparacao-siisp">
                                    <thead>
                                        <tr>
                                            <th rowspan="2">Data</th>
                                            <th rowspan="2">Unidade</th>
                                            <th rowspan="2">SIISP</th>
                                            <th colspan="2">Caf√©</th>
                                            <th colspan="2">Almo√ßo</th>
                                            <th colspan="2">Lanche</th>
                                            <th colspan="2">Jantar</th>
                                        </tr>
                                        <tr>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-comparacao-siisp">
                                        <!-- Dados ser√£o inseridos via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Modal da Legenda -->
    <div id="modal-legenda" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: var(--border-radius-xl); padding: 2rem; max-width: 500px; width: 90%;">
            <h3 style="margin-bottom: 1.5rem;">Legenda dos Indicadores</h3>
            
            <div style="display: grid; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 30px; height: 30px; background-color: var(--success-color); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: bold;">OK</div>
                    <div>
                        <strong>Verde:</strong> Diferen√ßa ‚â§ 0 entre internos e SIISP (Conforme)
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 30px; height: 30px; background-color: var(--warning-color); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">+2</div>
                    <div>
                        <strong>Azul:</strong> Diferen√ßa de 1-5 refei√ß√µes para internos (Aten√ß√£o)
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 30px; height: 30px; background-color: var(--danger-color); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">+8</div>
                    <div>
                        <strong>Vermelho (Cr√≠tico):</strong> Diferen√ßa > 5 refei√ß√µes para internos
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 30px; height: 30px; background-color: var(--success-color); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: bold;">OK</div>
                    <div>
                        <strong>Verde (Funcion√°rios):</strong> Valores negativos SIISP funcion√°rios (normais)
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 30px; height: 30px; background-color: var(--danger-color); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">+5</div>
                    <div>
                        <strong>Vermelho (Funcion√°rios):</strong> Valores positivos SIISP funcion√°rios (an√¥malo)
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" id="btn-fechar-legenda">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div id="modal-confirmacao-exclusao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: var(--border-radius-xl); padding: 2rem; max-width: 600px; width: 90%;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: #dc2626; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">üóëÔ∏è</div>
                <h3 style="margin-bottom: 1rem; color: #dc2626;">Confirmar Exclus√£o</h3>
                <p id="mensagem-confirmacao" style="margin: 0; color: var(--gray-700); line-height: 1.5; font-size: 1rem;"></p>
            </div>
            
            <div style="padding: 1rem; background-color: #fef2f2; border-radius: 8px; border-left: 4px solid #dc2626; margin-bottom: 2rem;">
                <p style="font-size: 0.875rem; margin: 0; color: #991b1b;">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta a√ß√£o excluir√° permanentemente todos os dados de refei√ß√µes. Esta opera√ß√£o n√£o pode ser desfeita.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="btn-cancelar-confirmacao" style="min-width: 120px;">Cancelar</button>
                <button class="btn btn-danger" id="btn-confirmar-confirmacao" style="min-width: 120px;">Excluir Dados</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p style="margin: 0; color: var(--gray-400); font-size: 0.875rem;">
                ¬© 2025 SGMRP - Sistema de Gerenciamento de Mapas de Refei√ß√µes Penitenci√°rio
            </p>
        </div>
    </footer>

    <script>
        // Sistema de Notifica√ß√µes
        function showNotification(type, title, message, autoClose = true) {
            // Remover notifica√ß√£o existente se houver
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            let icon = 'üì¢';
            if (type === 'success') icon = '‚úÖ';
            else if (type === 'warning') icon = '‚ö†Ô∏è';
            else if (type === 'error') icon = '‚ùå';
            
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">${icon}</div>
                    <div class="notification-text">
                        <strong>${title}</strong>
                        ${message ? '<br>' + message : ''}
                    </div>
                    <button type="button" class="notification-close" onclick="closeNotification(this)">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-fechar ap√≥s tempo determinado
            if (autoClose) {
                const duration = 60000; // Todas notifica√ß√µes ficam 1 minuto
                setTimeout(() => {
                    closeNotification(notification.querySelector('.notification-close'));
                }, duration);
            }
        }

        function closeNotification(button) {
            const notification = button.closest('.notification');
            if (notification) {
                notification.classList.add('closing');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }
        }



    // Dados reais dos mapas do lote - carregados do Flask
    const mapasLote = JSON.parse(`{{ mapas_lote | tojson | safe }}`);
    // Dados dos pre√ßos do lote
    const precosLote = JSON.parse(`{{ lote.precos | tojson | safe }}`);
    // ID do lote atual
    const loteId = "{{ lote.id }}";
        
        // Vari√°veis globais para controle dos filtros
        let filtrosAtivos = {
            dataInicio: null,
            dataFim: null,
            // null => no unit filter (show all). Array => explicit selection (can be empty => show none)
            unidadesSelecionadas: null
        };
        
        // Converter dados dos mapas para formato da tabela
        const dadosRefeicoes = [];
        const dadosOriginais = []; // Manter c√≥pia dos dados originais
        
        mapasLote.forEach(mapa => {
            // Verificar qual campo de datas usar (compatibilidade)
            let datasArray = mapa.datas || mapa.data;
            let nomeUnidade = mapa.unidade || mapa.nome_unidade;
            
            // DEBUG: Verificar se campos SIISP de funcion√°rios existem
            console.log('DEBUG: Verificando mapa:', {
                unidade: nomeUnidade,
                temCafeFuncSiisp: !!mapa.cafe_funcionario_siisp,
                primeiroValorCafeFuncSiisp: mapa.cafe_funcionario_siisp ? mapa.cafe_funcionario_siisp[0] : 'UNDEFINED',
                primeiroValorCafeFunc: mapa.cafe_funcionario ? mapa.cafe_funcionario[0] : 'UNDEFINED'
            });
            
            if (!datasArray || !Array.isArray(datasArray)) {
                return; // Skip este mapa se n√£o tiver dados v√°lidos
            }
            
            // Para cada dia do m√™s
            for (let i = 0; i < datasArray.length; i++) {
                const registro = {
                    data: datasArray[i],
                    unidade: nomeUnidade,
                    cafeInt: (mapa.cafe_interno && mapa.cafe_interno[i]) || 0,
                    cafeFunc: (mapa.cafe_funcionario && mapa.cafe_funcionario[i]) || 0,
                    almocoInt: (mapa.almoco_interno && mapa.almoco_interno[i]) || 0,
                    almocoFunc: (mapa.almoco_funcionario && mapa.almoco_funcionario[i]) || 0,
                    lancheInt: (mapa.lanche_interno && mapa.lanche_interno[i]) || 0,
                    lancheFunc: (mapa.lanche_funcionario && mapa.lanche_funcionario[i]) || 0,
                    jantarInt: (mapa.jantar_interno && mapa.jantar_interno[i]) || 0,
                    jantarFunc: (mapa.jantar_funcionario && mapa.jantar_funcionario[i]) || 0,
                    // Dados SIISP - usar dados_siisp ou n_siisp se dispon√≠vel, sen√£o 0
                    siispInternos: (mapa.dados_siisp && mapa.dados_siisp.length > i) ? mapa.dados_siisp[i] : 
                                  (mapa.n_siisp && mapa.n_siisp.length > i) ? mapa.n_siisp[i] : 0,
                    temSiisp: (mapa.dados_siisp && mapa.dados_siisp.length > 0) || 
                              (mapa.n_siisp && mapa.n_siisp.length > 0) ||
                              (mapa.cafe_interno_siisp && mapa.cafe_interno_siisp.length > 0),
                    // Dados SIISP dos internos (colunas calculadas)
                    cafeIntSiisp: (mapa.cafe_interno_siisp && mapa.cafe_interno_siisp.length > i) ? mapa.cafe_interno_siisp[i] : null,
                    almocoIntSiisp: (mapa.almoco_interno_siisp && mapa.almoco_interno_siisp.length > i) ? mapa.almoco_interno_siisp[i] : null,
                    lancheIntSiisp: (mapa.lanche_interno_siisp && mapa.lanche_interno_siisp.length > i) ? mapa.lanche_interno_siisp[i] : null,
                    jantarIntSiisp: (mapa.jantar_interno_siisp && mapa.jantar_interno_siisp.length > i) ? mapa.jantar_interno_siisp[i] : null,
                    // Dados SIISP dos funcion√°rios
                    cafeFuncSiisp: (mapa.cafe_funcionario_siisp && mapa.cafe_funcionario_siisp.length > i) ? mapa.cafe_funcionario_siisp[i] : null,
                    almocoFuncSiisp: (mapa.almoco_funcionario_siisp && mapa.almoco_funcionario_siisp.length > i) ? mapa.almoco_funcionario_siisp[i] : null,
                    lancheFuncSiisp: (mapa.lanche_funcionario_siisp && mapa.lanche_funcionario_siisp.length > i) ? mapa.lanche_funcionario_siisp[i] : null,
                    jantarFuncSiisp: (mapa.jantar_funcionario_siisp && mapa.jantar_funcionario_siisp.length > i) ? mapa.jantar_funcionario_siisp[i] : null
                };
                dadosOriginais.push(registro);
                dadosRefeicoes.push({...registro}); // C√≥pia para manipula√ß√£o
            }
        });
        
        // Fun√ß√£o para aplicar filtros aos dados
        function aplicarFiltros() {
            // Limpar dados filtrados
            dadosRefeicoes.length = 0;
            
            console.log('=== APLICANDO FILTROS ===');
            console.log('Filtros ativos:', filtrosAtivos);
            console.log('Dados originais total:', dadosOriginais.length);
            
            // Se n√£o h√° filtros ativos (nenhum per√≠odo e sem filtro de unidades), mostrar todos os dados
            if (!filtrosAtivos.dataInicio && !filtrosAtivos.dataFim && filtrosAtivos.unidadesSelecionadas === null) {
                console.log('Nenhum filtro ativo - mostrando todos os dados');
                dadosOriginais.forEach(registro => {
                    dadosRefeicoes.push({...registro});
                });
            } else {
                console.log('Aplicando filtros espec√≠ficos...');
                // Aplicar filtros aos dados originais
                dadosOriginais.forEach(registro => {
                    let incluir = true;
                    
                    // Filtro por per√≠odo
                    if (filtrosAtivos.dataInicio && filtrosAtivos.dataFim) {
                        // Converter data brasileira (DD/MM/YYYY) para formato Date
                        let dataRegistro = null;
                        if (registro.data) {
                            const partesData = registro.data.split('/');
                            dataRegistro = new Date(partesData[2], partesData[1] - 1, partesData[0]);
                        }
                        
                        // Converter strings ISO para Date de forma consistente
                        let inicio = null, fim = null;
                        if (filtrosAtivos.dataInicio && filtrosAtivos.dataFim) {
                            const [anoInicio, mesInicio, diaInicio] = filtrosAtivos.dataInicio.split('-');
                            const [anoFim, mesFim, diaFim] = filtrosAtivos.dataFim.split('-');
                            inicio = new Date(parseInt(anoInicio), parseInt(mesInicio) - 1, parseInt(diaInicio));
                            fim = new Date(parseInt(anoFim), parseInt(mesFim) - 1, parseInt(diaFim));
                        }
                        

                        
                        if (dataRegistro < inicio || dataRegistro > fim) {
                            incluir = false;
                        }
                    }
                    
                    // Filtro por unidades - tr√™s estados:
                    // - filtrosAtivos.unidadesSelecionadas === null => sem filtro (aceita todas)
                    // - Array with length > 0 => filtrar apenas pelas selecionadas
                    // - Array with length === 0 => usu√°rio selecionou explicitamente nenhuma unidade -> n√£o incluir
                    if (Array.isArray(filtrosAtivos.unidadesSelecionadas)) {
                        if (filtrosAtivos.unidadesSelecionadas.length === 0) {
                            // Nenhuma unidade explicitamente selecionada -> excluir todos
                            incluir = false;
                        } else {
                            const unidadeIncluida = filtrosAtivos.unidadesSelecionadas.some(unidadeSelecionada => {
                                // Comparar nomes completos das unidades (exact match ou contains)
                                const nomeRegistro = registro.unidade.toLowerCase().trim();
                                const nomeSelecionado = unidadeSelecionada.toLowerCase().trim();

                                // Exact match ou contains
                                return nomeRegistro === nomeSelecionado || 
                                       nomeRegistro.includes(nomeSelecionado) ||
                                       nomeSelecionado.includes(nomeRegistro);
                            });

                            if (!unidadeIncluida) {
                                incluir = false;
                            }
                        }
                    }
                    
                    if (incluir) {
                        dadosRefeicoes.push({...registro});
                    }
                });
            }
            
            console.log('Dados ap√≥s filtros:', dadosRefeicoes.length);
            console.log('=== FIM FILTROS ===\n');
            
            // Atualizar tabelas
            carregarTabelaRefeicoes();
            atualizarResumoEstatisticas();
        }
        

        
        // Fun√ß√£o para limpar todos os filtros
        function limparTodosFiltros() {
            // Reset filtros ativos - limpar completamente para mostrar todos os dados
            filtrosAtivos.dataInicio = null;
            filtrosAtivos.dataFim = null;
            // null = sem filtro (mostrar todas). [] = explicitamente nenhuma selecionada
            filtrosAtivos.unidadesSelecionadas = null;
            
            // Reset inputs de data
            document.getElementById('data-inicio').value = '';
            document.getElementById('data-fim').value = '';
            document.getElementById('periodo-text').textContent = 'Selecionar per√≠odo';
            
            // Reset checkboxes de unidades - selecionar todas
            document.querySelectorAll('.unidade-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            atualizarDisplayUnidades();
            
            // Aplicar filtros (que agora mostrar√° todos os dados)
            aplicarFiltros();
        }

        // Verificar autentica√ß√£o
        window.addEventListener('load', function() {
            const usuarioSalvo = localStorage.getItem('sgmrp_usuario');
            if (!usuarioSalvo) {
                showNotification('warning', 'Sess√£o expirada', 'Redirecionando para a p√°gina de login...', false);
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            // Verificar par√¢metros da URL para a√ß√µes espec√≠ficas
            const urlParams = new URLSearchParams(window.location.search);
            const acao = urlParams.get('acao');
            const unidadeFiltro = urlParams.get('unidade');
            const mesFiltro = urlParams.get('mes');
            const anoFiltro = urlParams.get('ano');

            // Interface j√° inicializada pelo Flask com dados din√¢micos

            // Mostrar se√ß√£o espec√≠fica se houver a√ß√£o
            if (acao === 'importar') {
                mostrarSecaoImportacao();
            } else if (acao === 'manual') {
                mostrarSecaoManual();
            }

            // Se houver filtros na URL (ap√≥s adicionar dados), aplic√°-los
            if (unidadeFiltro && mesFiltro && anoFiltro) {
                console.log('üîç DEBUG URL Parameters:', 'unidade=', unidadeFiltro, 'mes=', mesFiltro, 'ano=', anoFiltro);
                
                // Calcular per√≠odo do m√™s/ano especificado
                const mesNum = parseInt(mesFiltro);
                const anoNum = parseInt(anoFiltro);
                
                console.log('üîç DEBUG Parsed:', 'mesNum=', mesNum, 'anoNum=', anoNum);
                
                // Calcular primeiro e √∫ltimo dia do m√™s corretamente
                // Usar Date.UTC para evitar problemas de timezone
                const primeiroDia = new Date(Date.UTC(anoNum, mesNum - 1, 1));
                // Calcular √∫ltimo dia: primeiro dia do pr√≥ximo m√™s - 1 dia
                const ultimoDia = new Date(Date.UTC(anoNum, mesNum, 0));
                
                console.log('üîç DEBUG Dates:', 
                    'primeiroDia=', primeiroDia.toISOString(), 
                    'ultimoDia=', ultimoDia.toISOString()
                );
                
                const dataInicioStr = primeiroDia.toISOString().split('T')[0];
                const dataFimStr = ultimoDia.toISOString().split('T')[0];
                
                console.log('üîç DEBUG Date Strings:', 'dataInicioStr=', dataInicioStr, 'dataFimStr=', dataFimStr);
                
                // Atualizar inputs de data
                const dataInicioInput = document.getElementById('data-inicio');
                const dataFimInput = document.getElementById('data-fim');
                if (dataInicioInput && dataFimInput) {
                    dataInicioInput.value = dataInicioStr;
                    dataFimInput.value = dataFimStr;
                    filtrosAtivos.dataInicio = dataInicioStr;
                    filtrosAtivos.dataFim = dataFimStr;
                    console.log('üîç DEBUG Input values set:', 
                        'dataInicioValue=', dataInicioInput.value, 
                        'dataFimValue=', dataFimInput.value
                    );
                }
                
                // Atualizar sele√ß√£o de unidades (ser√° aplicado depois em initUnidadesFilter)
                filtrosAtivos.unidadesSelecionadas = [unidadeFiltro];
            } else {
                // Definir m√™s anterior como padr√£o no filtro
                setDefaultPreviousMonth();
            }
            
            // Inicializar filtro de per√≠odo
            initPeriodoFilter(unidadeFiltro && mesFiltro && anoFiltro);
            
            // Se veio da URL com filtros, atualizar display do per√≠odo
            if (unidadeFiltro && mesFiltro && anoFiltro) {
                atualizarDisplayPeriodo();
                atualizarTituloPeriodo();
            }
            
            // Inicializar filtro de unidades
            initUnidadesFilter();
            
            // Inicializar seletor de m√™s/ano da importa√ß√£o
            initMesAnoImport();
            
            // Aplicar filtros iniciais e carregar dados da tabela
            aplicarFiltros();
            
            // Inicializar sistema de abas
            initTabs();
            
            // Inicializar sub-abas de resumos
            initResumoTabs();
        });

        // Fun√ß√£o removida - interface agora √© inicializada pelo Flask com dados din√¢micos

        // Fun√ß√£o para definir setembro/2025 como padr√£o (dados dispon√≠veis)
        function setDefaultPreviousMonth() {
            // Calcular m√™s anterior ao atual
            const now = new Date();
            let ano = now.getFullYear();
            let mes = now.getMonth(); // 0 = janeiro, 10 = novembro
            if (mes === 0) {
                mes = 11; // dezembro
                ano--;
            } else {
                mes--;
            }
            // Primeiro dia do m√™s anterior - usar Date.UTC para evitar problemas de timezone
            const dataInicio = new Date(Date.UTC(ano, mes, 1));
            // √öltimo dia do m√™s anterior - usar Date.UTC para evitar problemas de timezone
            const dataFim = new Date(Date.UTC(ano, mes + 1, 0));
            const dataInicioStr = dataInicio.toISOString().split('T')[0];
            const dataFimStr = dataFim.toISOString().split('T')[0];
            const dataInicioInput = document.getElementById('data-inicio');
            const dataFimInput = document.getElementById('data-fim');
            if (dataInicioInput && dataFimInput) {
                dataInicioInput.value = dataInicioStr;
                dataFimInput.value = dataFimStr;
                filtrosAtivos.dataInicio = dataInicioStr;
                filtrosAtivos.dataFim = dataFimStr;
                atualizarDisplayPeriodo();
                aplicarFiltros();
            }
        }

        function carregarTabelaRefeicoes() {
            carregarTabelaDados();
            carregarTabelaComparacao();
        }
        
        // Fun√ß√£o para atualizar resumo de estat√≠sticas
        function atualizarResumoEstatisticas() {
            let totalRefeicoes = 0;
            let totalCafeInterno = 0;
            let totalCafeFuncionario = 0;
            let totalAlmocoInterno = 0;
            let totalAlmocoFuncionario = 0;
            let totalLancheInterno = 0;
            let totalLancheFuncionario = 0;
            let totalJantarInterno = 0;
            let totalJantarFuncionario = 0;
            // Contar c√©lulas azuis (diferen√ßas pequenas) e vermelhas (discrep√¢ncias cr√≠ticas) na tabela de compara√ß√£o SIISP
            let diferencasPequenas = 0;
            let discrepanciasCriticas = 0;
            // Contar c√©lulas OK (verdes) e total de c√©lulas com dados SIISP para calcular conformidade geral
            let celulasOk = 0;
            let totalCelulasComSiisp = 0;
            // Vari√°veis para c√°lculo do desvio (valores monet√°rios dos excedentes)
            let totalExcedentesInternos = 0;
            let totalExcedentesFuncionarios = 0;
            
            dadosRefeicoes.forEach(row => {
                // Somar totais por tipo de refei√ß√£o
                totalCafeInterno += row.cafeInt;
                totalCafeFuncionario += row.cafeFunc;
                totalAlmocoInterno += row.almocoInt;
                totalAlmocoFuncionario += row.almocoFunc;
                totalLancheInterno += row.lancheInt;
                totalLancheFuncionario += row.lancheFunc;
                totalJantarInterno += row.jantarInt;
                totalJantarFuncionario += row.jantarFunc;
                
                // Calcular total geral
                const totalDia = row.cafeInt + row.cafeFunc + row.almocoInt + row.almocoFunc + 
                               row.lancheInt + row.lancheFunc + row.jantarInt + row.jantarFunc;
                totalRefeicoes += totalDia;
                
                // Contar c√©lulas azuis (cell-warning) e vermelhas (cell-danger) da tabela de compara√ß√£o SIISP
                // Usar detec√ß√£o de colunas _siisp calculadas em vez de siisp > 0
                const siisp = row.siispInternos || 0;
                const temColunasSiisp = row.cafeIntSiisp !== null && row.cafeIntSiisp !== undefined;
                
                if (temColunasSiisp) {
                    // USAR VALORES _SIISP J√Å CALCULADOS para estat√≠sticas
                    const tiposRefeicaoSiisp = [
                        { valorSiisp: row.cafeIntSiisp, tipo: 'cafe' },
                        { valorSiisp: row.almocoIntSiisp, tipo: 'almoco' },
                        { valorSiisp: row.lancheIntSiisp, tipo: 'lanche' },
                        { valorSiisp: row.jantarIntSiisp, tipo: 'jantar' }
                    ];
                    
                    tiposRefeicaoSiisp.forEach(refeicao => {
                        const classificacao = getClassificacaoSiisp(refeicao.valorSiisp);
                        totalCelulasComSiisp++; // Contar total de c√©lulas com dados SIISP
                        
                        if (classificacao.class === 'cell-warning') {
                            diferencasPequenas++; // Contar c√©lula azul (diferen√ßa pequena)
                            // Somar valor monet√°rio do excedente usando pre√ßo espec√≠fico da refei√ß√£o
                            if (precosLote && refeicao.valorSiisp > 0) {
                                totalExcedentesInternos += refeicao.valorSiisp * precosLote[refeicao.tipo].interno;
                            }
                        } else if (classificacao.class === 'cell-danger') {
                            discrepanciasCriticas++; // Contar c√©lula vermelha (discrep√¢ncia cr√≠tica)
                            // Somar valor monet√°rio do excedente usando pre√ßo espec√≠fico da refei√ß√£o
                            if (precosLote && refeicao.valorSiisp > 0) {
                                totalExcedentesInternos += refeicao.valorSiisp * precosLote[refeicao.tipo].interno;
                            }
                        } else if (classificacao.class === 'cell-ok') {
                            celulasOk++; // Contar c√©lula verde (OK)
                        }
                    });
                    
                    // Verificar c√©lulas de funcion√°rios SIISP usando colunas calculadas
                    const funcionariosSiispDetalhados = [
                        {valorSiisp: row.cafeFuncSiisp, tipo: 'cafe'},
                        {valorSiisp: row.almocoFuncSiisp, tipo: 'almoco'},
                        {valorSiisp: row.lancheFuncSiisp, tipo: 'lanche'},
                        {valorSiisp: row.jantarFuncSiisp, tipo: 'jantar'}
                    ];
                    
                    funcionariosSiispDetalhados.forEach(func => {
                        if (func.valorSiisp !== null && func.valorSiisp !== undefined) {
                            totalCelulasComSiisp++; // Contar c√©lula de funcion√°rio
                            
                            // Para funcion√°rios: valores <= 0 s√£o OK (verde), valores > 0 s√£o cr√≠ticos (vermelho)
                            if (func.valorSiisp <= 0) {
                                celulasOk++; // C√©lulas verdes (OK)
                            } else {
                                discrepanciasCriticas++; // C√©lulas vermelhas (cr√≠ticas)
                                // Somar valor monet√°rio do excedente usando pre√ßo espec√≠fico da refei√ß√£o
                                if (precosLote) {
                                    totalExcedentesFuncionarios += func.valorSiisp * precosLote[func.tipo].funcionario;
                                }
                            }
                        }
                    });
                }
            });
            
            // Atualizar elementos na p√°gina com os novos IDs
            const totalRefeicoes_elemento = document.getElementById('total-refeicoes');
            const totalCafeInterno_elemento = document.getElementById('total-cafe-interno');
            const totalCafeFuncionario_elemento = document.getElementById('total-cafe-funcionario');
            const totalAlmocoInterno_elemento = document.getElementById('total-almoco-interno');
            const totalAlmocoFuncionario_elemento = document.getElementById('total-almoco-funcionario');
            const totalLancheInterno_elemento = document.getElementById('total-lanche-interno');
            const totalLancheFuncionario_elemento = document.getElementById('total-lanche-funcionario');
            const totalJantarInterno_elemento = document.getElementById('total-jantar-interno');
            const totalJantarFuncionario_elemento = document.getElementById('total-jantar-funcionario');
            const diferencasPequenas_elemento = document.getElementById('diferencas-pequenas');
            const discrepanciasCriticas_elemento = document.getElementById('discrepancias-criticas');
            const conformidadeGeral_elemento = document.getElementById('conformidade-geral');
            const valorTotal_elemento = document.getElementById('valor-total');
            const valorDesvio_elemento = document.getElementById('valor-desvio');
            
            // Elementos dos valores parciais
            const valorCafeInterno_elemento = document.getElementById('valor-cafe-interno');
            const valorCafeFuncionario_elemento = document.getElementById('valor-cafe-funcionario');
            const valorAlmocoInterno_elemento = document.getElementById('valor-almoco-interno');
            const valorAlmocoFuncionario_elemento = document.getElementById('valor-almoco-funcionario');
            const valorLancheInterno_elemento = document.getElementById('valor-lanche-interno');
            const valorLancheFuncionario_elemento = document.getElementById('valor-lanche-funcionario');
            const valorJantarInterno_elemento = document.getElementById('valor-jantar-interno');
            const valorJantarFuncionario_elemento = document.getElementById('valor-jantar-funcionario');
            
            // Calcular valor total das refei√ß√µes e valores parciais
            let valorTotal = 0;
            let valorCafeInterno = 0;
            let valorCafeFuncionario = 0;
            let valorAlmocoInterno = 0;
            let valorAlmocoFuncionario = 0;
            let valorLancheInterno = 0;
            let valorLancheFuncionario = 0;
            let valorJantarInterno = 0;
            let valorJantarFuncionario = 0;
            let valorDesvio = 0;
            
            if (precosLote) {
                valorCafeInterno = totalCafeInterno * precosLote.cafe.interno;
                valorCafeFuncionario = totalCafeFuncionario * precosLote.cafe.funcionario;
                valorAlmocoInterno = totalAlmocoInterno * precosLote.almoco.interno;
                valorAlmocoFuncionario = totalAlmocoFuncionario * precosLote.almoco.funcionario;
                valorLancheInterno = totalLancheInterno * precosLote.lanche.interno;
                valorLancheFuncionario = totalLancheFuncionario * precosLote.lanche.funcionario;
                valorJantarInterno = totalJantarInterno * precosLote.jantar.interno;
                valorJantarFuncionario = totalJantarFuncionario * precosLote.jantar.funcionario;
                
                valorTotal = valorCafeInterno + valorCafeFuncionario + valorAlmocoInterno + valorAlmocoFuncionario + 
                           valorLancheInterno + valorLancheFuncionario + valorJantarInterno + valorJantarFuncionario;
                
                // Calcular valor total do desvio (j√° calculado com pre√ßos espec√≠ficos)
                valorDesvio = totalExcedentesInternos + totalExcedentesFuncionarios;
            }
            
            // Calcular conformidade geral: (valor geral - desvio) / valor geral * 100
            let conformidadeGeral = 0;
            if (precosLote && valorTotal > 0) {
                conformidadeGeral = ((valorTotal - valorDesvio) / valorTotal) * 100;
                // Garantir que n√£o seja negativo
                conformidadeGeral = Math.max(0, conformidadeGeral);
            }
            
            // Atualizar valores
            if (totalRefeicoes_elemento) totalRefeicoes_elemento.textContent = totalRefeicoes.toLocaleString('pt-BR');
            if (totalCafeInterno_elemento) totalCafeInterno_elemento.textContent = totalCafeInterno.toLocaleString('pt-BR');
            if (totalCafeFuncionario_elemento) totalCafeFuncionario_elemento.textContent = totalCafeFuncionario.toLocaleString('pt-BR');
            if (totalAlmocoInterno_elemento) totalAlmocoInterno_elemento.textContent = totalAlmocoInterno.toLocaleString('pt-BR');
            if (totalAlmocoFuncionario_elemento) totalAlmocoFuncionario_elemento.textContent = totalAlmocoFuncionario.toLocaleString('pt-BR');
            if (totalLancheInterno_elemento) totalLancheInterno_elemento.textContent = totalLancheInterno.toLocaleString('pt-BR');
            if (totalLancheFuncionario_elemento) totalLancheFuncionario_elemento.textContent = totalLancheFuncionario.toLocaleString('pt-BR');
            if (totalJantarInterno_elemento) totalJantarInterno_elemento.textContent = totalJantarInterno.toLocaleString('pt-BR');
            if (totalJantarFuncionario_elemento) totalJantarFuncionario_elemento.textContent = totalJantarFuncionario.toLocaleString('pt-BR');
            if (diferencasPequenas_elemento) diferencasPequenas_elemento.textContent = diferencasPequenas.toString();
            if (discrepanciasCriticas_elemento) discrepanciasCriticas_elemento.textContent = discrepanciasCriticas.toString();
            if (conformidadeGeral_elemento) {
                if (precosLote && valorTotal > 0) {
                    conformidadeGeral_elemento.textContent = conformidadeGeral.toFixed(1) + '%';
                } else {
                    conformidadeGeral_elemento.textContent = 'N/A';
                }
            }
            
            // Atualizar valor total formatado como moeda brasileira
            if (valorTotal_elemento) {
                if (precosLote) {
                    valorTotal_elemento.textContent = valorTotal.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                } else {
                    valorTotal_elemento.textContent = 'N/A';
                }
            }
            
            // Atualizar valor de desvio formatado como moeda brasileira
            if (valorDesvio_elemento) {
                if (precosLote) {
                    valorDesvio_elemento.textContent = valorDesvio.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                } else {
                    valorDesvio_elemento.textContent = 'N/A';
                }
            }
            
            // Atualizar valores parciais formatados como moeda brasileira
            if (precosLote) {
                if (valorCafeInterno_elemento) {
                    valorCafeInterno_elemento.textContent = valorCafeInterno.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                }
                if (valorCafeFuncionario_elemento) {
                    valorCafeFuncionario_elemento.textContent = valorCafeFuncionario.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                }
                if (valorAlmocoInterno_elemento) {
                    valorAlmocoInterno_elemento.textContent = valorAlmocoInterno.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                }
                if (valorAlmocoFuncionario_elemento) {
                    valorAlmocoFuncionario_elemento.textContent = valorAlmocoFuncionario.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                }
                if (valorLancheInterno_elemento) {
                    valorLancheInterno_elemento.textContent = valorLancheInterno.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                }
                if (valorLancheFuncionario_elemento) {
                    valorLancheFuncionario_elemento.textContent = valorLancheFuncionario.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                }
                if (valorJantarInterno_elemento) {
                    valorJantarInterno_elemento.textContent = valorJantarInterno.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                }
                if (valorJantarFuncionario_elemento) {
                    valorJantarFuncionario_elemento.textContent = valorJantarFuncionario.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                }
            } else {
                // Se n√£o h√° pre√ßos, mostrar N/A para todos os valores parciais e desvio
                [valorCafeInterno_elemento, valorCafeFuncionario_elemento, valorAlmocoInterno_elemento, 
                 valorAlmocoFuncionario_elemento, valorLancheInterno_elemento, valorLancheFuncionario_elemento,
                 valorJantarInterno_elemento, valorJantarFuncionario_elemento, valorDesvio_elemento].forEach(elemento => {
                    if (elemento) elemento.textContent = 'N/A';
                });
            }
        }

        function carregarTabelaDados() {
            const tbody = document.getElementById('tbody-dados-refeicoes');
            tbody.innerHTML = '';

            dadosRefeicoes.forEach(row => {
                const tr = document.createElement('tr');
                const totalDia = row.cafeInt + row.cafeFunc + row.almocoInt + row.almocoFunc + row.lancheInt + row.lancheFunc + row.jantarInt + row.jantarFunc;
                
                tr.innerHTML = `
                    <td>${row.data}</td>
                    <td>${row.unidade}</td>
                    <td style="text-align: center; background-color: var(--gray-50);">${row.cafeInt}</td>
                    <td style="text-align: center;">${row.cafeFunc}</td>
                    <td style="text-align: center; background-color: var(--gray-50);">${row.almocoInt}</td>
                    <td style="text-align: center;">${row.almocoFunc}</td>
                    <td style="text-align: center; background-color: var(--gray-50);">${row.lancheInt}</td>
                    <td style="text-align: center;">${row.lancheFunc}</td>
                    <td style="text-align: center; background-color: var(--gray-50);">${row.jantarInt}</td>
                    <td style="text-align: center;">${row.jantarFunc}</td>
                    <td style="text-align: center; font-weight: 600; background-color: var(--light-blue);">${totalDia}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function carregarTabelaComparacao() {
            const tbody = document.getElementById('tbody-comparacao-siisp');
            tbody.innerHTML = '';

            dadosRefeicoes.forEach(row => {
                const tr = document.createElement('tr');
                
                // Usar dados reais do SIISP ou 0 se n√£o dispon√≠vel
                const siisp = row.siispInternos || 0;
                
                // Verificar se h√° colunas SIISP calculadas
                const temColunasSiisp = row.cafeIntSiisp !== null && row.cafeIntSiisp !== undefined;
                const statusSiisp = temColunasSiisp ? 'Calculado' : 'N√£o dispon√≠vel';
                
                // Classifica√ß√µes para INTERNOS usando getClassificacaoSiisp
                const cafeIntClass = temColunasSiisp ? 
                    getClassificacaoSiisp(row.cafeIntSiisp) : 
                    { class: 'cell-na', display: 'N/A' };
                
                const almocoIntClass = temColunasSiisp ? 
                    getClassificacaoSiisp(row.almocoIntSiisp) : 
                    { class: 'cell-na', display: 'N/A' };
                
                const lancheIntClass = temColunasSiisp ? 
                    getClassificacaoSiisp(row.lancheIntSiisp) : 
                    { class: 'cell-na', display: 'N/A' };
                
                const jantarIntClass = temColunasSiisp ? 
                    getClassificacaoSiisp(row.jantarIntSiisp) : 
                    { class: 'cell-na', display: 'N/A' };

                // Classifica√ß√µes para FUNCION√ÅRIOS usando getClassificacaoSiisp
                const cafeFuncClass = temColunasSiisp ? 
                    getClassificacaoSiisp(row.cafeFuncSiisp) : 
                    { class: 'cell-na', display: 'N/A' };
                
                // DEBUG: Log dos primeiros 3 dias para caf√© funcion√°rio
                if (dadosRefeicoes.indexOf(row) < 3) {
                    console.log(`DEBUG Dia ${dadosRefeicoes.indexOf(row) + 1}:`);
                    console.log('  row.cafeFuncSiisp:', row.cafeFuncSiisp);
                    console.log('  cafeFuncClass:', cafeFuncClass);
                }
                
                const almocoFuncClass = temColunasSiisp ? 
                    getClassificacaoSiisp(row.almocoFuncSiisp) : 
                    { class: 'cell-na', display: 'N/A' };
                
                const lancheFuncClass = temColunasSiisp ? 
                    getClassificacaoSiisp(row.lancheFuncSiisp) : 
                    { class: 'cell-na', display: 'N/A' };
                
                const jantarFuncClass = temColunasSiisp ? 
                    getClassificacaoSiisp(row.jantarFuncSiisp) : 
                    { class: 'cell-na', display: 'N/A' };

                tr.innerHTML = `
                    <td>${row.data}</td>
                    <td>${row.unidade}</td>
                    <td style="text-align: center; font-weight: 600; background-color: var(--gray-100);">
                        ${siisp}
                    </td>
                    <td class="${cafeIntClass.class}" style="text-align: center;">
                        ${cafeIntClass.display}
                    </td>
                    <td class="${cafeFuncClass.class}" style="text-align: center;">
                        ${cafeFuncClass.display}
                    </td>
                    <td class="${almocoIntClass.class}" style="text-align: center;">
                        ${almocoIntClass.display}
                    </td>
                    <td class="${almocoFuncClass.class}" style="text-align: center;">
                        ${almocoFuncClass.display}
                    </td>
                    <td class="${lancheIntClass.class}" style="text-align: center;">
                        ${lancheIntClass.display}
                    </td>
                    <td class="${lancheFuncClass.class}" style="text-align: center;">
                        ${lancheFuncClass.display}
                    </td>
                    <td class="${jantarIntClass.class}" style="text-align: center;">
                        ${jantarIntClass.display}
                    </td>
                    <td class="${jantarFuncClass.class}" style="text-align: center;">
                        ${jantarFuncClass.display}
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function getClassificacao(refeicoes, siisp) {
            const diferenca = refeicoes - siisp;
            
            if (diferenca <= 0) {
                return { class: 'cell-ok', display: 'OK' };
            } else if (diferenca <= 5) {
                return { class: 'cell-warning', display: `+${diferenca}` };
            } else {
                return { class: 'cell-danger', display: `+${diferenca}` };
            }
        }

        // Nova fun√ß√£o para classificar baseada nos valores _siisp j√° calculados
        function getClassificacaoSiisp(valorSiisp) {
            // valorSiisp j√° √© a diferen√ßa (refeicoes - dados_siisp)
            if (valorSiisp <= 0) {
                return { class: 'cell-ok', display: 'OK' };
            } else if (valorSiisp <= 5) {
                return { class: 'cell-warning', display: `+${valorSiisp}` };
            } else {
                return { class: 'cell-danger', display: `+${valorSiisp}` };
            }
        }



        // Controle das Abas
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

                tabButtons.forEach(button => {/* ...existing code... */});

                // Ativar a primeira aba por padr√£o
                if (tabButtons.length > 0) {/* ...existing code... */}

                // Bot√£o flutuante de troca de tabela
                const btnTrocaTabela = document.getElementById('btn-troca-tabela');
                if (btnTrocaTabela) {
                    btnTrocaTabela.addEventListener('click', function() {
                        const tab1 = document.getElementById('tab-dados-refeicoes');
                        const tab2 = document.getElementById('tab-comparacao-siisp');
                        const tabButtons = document.querySelectorAll('.tab-button');
                        let tabelaContainer1 = tab1 ? tab1.querySelector('.table-container, .tabela-container') : null;
                        let tabelaContainer2 = tab2 ? tab2.querySelector('.table-container, .tabela-container') : null;
                        let scrollPos = 0;
                        // Alterna para a outra aba
                        if (tab1 && tab1.style.display !== 'none' && tabelaContainer1) {
                            scrollPos = tabelaContainer1.scrollTop;
                            tab1.style.display = 'none';
                            tab2.style.display = 'block';
                            if (tabelaContainer2) tabelaContainer2.scrollTop = scrollPos;
                            // Atualizar bot√µes de aba
                            tabButtons.forEach(btn => {
                                if (btn.dataset.tab === 'dados-refeicoes') {
                                    btn.classList.remove('active');
                                    btn.style.borderBottomColor = 'transparent';
                                    btn.style.color = 'var(--gray-600)';
                                    btn.style.backgroundColor = 'transparent';
                                    btn.style.marginBottom = '';
                                } else if (btn.dataset.tab === 'comparacao-siisp') {
                                    btn.classList.add('active');
                                    btn.style.borderBottomColor = 'var(--primary-color)';
                                    btn.style.color = 'var(--primary-color)';
                                    btn.style.backgroundColor = 'white';
                                    btn.style.marginBottom = '-2px';
                                }
                            });
                        } else if (tab2 && tab2.style.display !== 'none' && tabelaContainer2) {
                            scrollPos = tabelaContainer2.scrollTop;
                            tab2.style.display = 'none';
                            tab1.style.display = 'block';
                            if (tabelaContainer1) tabelaContainer1.scrollTop = scrollPos;
                            // Atualizar bot√µes de aba
                            tabButtons.forEach(btn => {
                                if (btn.dataset.tab === 'comparacao-siisp') {
                                    btn.classList.remove('active');
                                    btn.style.borderBottomColor = 'transparent';
                                    btn.style.color = 'var(--gray-600)';
                                    btn.style.backgroundColor = 'transparent';
                                    btn.style.marginBottom = '';
                                } else if (btn.dataset.tab === 'dados-refeicoes') {
                                    btn.classList.add('active');
                                    btn.style.borderBottomColor = 'var(--primary-color)';
                                    btn.style.color = 'var(--primary-color)';
                                    btn.style.backgroundColor = 'white';
                                    btn.style.marginBottom = '-2px';
                                }
                            });
                        }
                    });
                }

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    // Remover classe active de todos os bot√µes
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.style.borderBottomColor = 'transparent';
                        btn.style.color = 'var(--gray-600)';
                        btn.style.backgroundColor = 'transparent';
                    });
                    
                    // Adicionar classe active ao bot√£o clicado
                    this.classList.add('active');
                    this.style.borderBottomColor = 'var(--primary-color)';
                    this.style.color = 'var(--primary-color)';
                    this.style.backgroundColor = 'white';
                    this.style.marginBottom = '-2px';
                    
                    // Esconder todos os conte√∫dos
                    tabContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Mostrar o conte√∫do da aba selecionada
                    const targetContent = document.getElementById('tab-' + targetTab);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                    }
                });
            });

            // Ativar a primeira aba por padr√£o
            if (tabButtons.length > 0) {
                tabButtons[0].click();
            }
        }

        // Controle das Sub-abas de Resumos
        function initResumoTabs() {
            const resumoTabButtons = document.querySelectorAll('.resumo-tab-button');
            const resumoTabContents = document.querySelectorAll('.resumo-tab-content');

            resumoTabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.dataset.resumoTab;
                    
                    // Remover classe active de todos os bot√µes
                    resumoTabButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.style.borderBottomColor = 'transparent';
                        btn.style.color = 'var(--gray-600)';
                        btn.style.backgroundColor = 'transparent';
                    });
                    
                    // Adicionar classe active ao bot√£o clicado
                    this.classList.add('active');
                    this.style.borderBottomColor = 'var(--primary-color)';
                    this.style.color = 'var(--primary-color)';
                    this.style.backgroundColor = 'white';
                    this.style.marginBottom = '-2px';
                    
                    // Esconder todos os conte√∫dos
                    resumoTabContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Mostrar o conte√∫do da sub-aba selecionada
                    const targetContent = document.getElementById('resumo-tab-' + targetTab);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                    }
                });
            });

            // Ativar a primeira sub-aba por padr√£o
            if (resumoTabButtons.length > 0) {
                resumoTabButtons[0].click();
            }
        }

        // Controles das se√ß√µes
        document.getElementById('btn-adicionar-dados').addEventListener('click', mostrarSecaoImportacao);
        document.getElementById('btn-entrada-manual').addEventListener('click', mostrarSecaoManual);
        document.getElementById('btn-excluir-dados').addEventListener('click', mostrarSecaoExcluir);
        document.getElementById('btn-adicionar-siisp').addEventListener('click', mostrarSecaoSiisp);

        function mostrarSecaoImportacao() {
            document.getElementById('secao-importacao').style.display = 'block';
            document.getElementById('secao-manual').style.display = 'none';
            document.getElementById('secao-importacao').scrollIntoView({ behavior: 'smooth' });
        }

        function mostrarSecaoManual() {
            document.getElementById('secao-importacao').style.display = 'none';
            document.getElementById('secao-exclusao').style.display = 'none';
            document.getElementById('secao-manual').style.display = 'block';
            document.getElementById('secao-manual').scrollIntoView({ behavior: 'smooth' });
            
            // Inicializar seletor de m√™s/ano da entrada manual
            initMesAnoManual();
        }

        function mostrarSecaoExcluir() {
            document.getElementById('secao-importacao').style.display = 'none';
            document.getElementById('secao-manual').style.display = 'none';
            document.getElementById('secao-exclusao').style.display = 'block';
            document.getElementById('secao-exclusao').scrollIntoView({ behavior: 'smooth' });
            
            // Definir m√™s anterior como padr√£o
            const now = new Date();
            let mesAnterior = now.getMonth() + 1; // getMonth() retorna 0-11, queremos 1-12
            let anoAnterior = now.getFullYear();
            
            if (mesAnterior === 1) {
                mesAnterior = 12;
                anoAnterior--;
            } else {
                mesAnterior--;
            }
            
            document.getElementById('mes-exclusao').value = mesAnterior.toString();
            document.getElementById('ano-exclusao').value = anoAnterior.toString();
        }

        function mostrarSecaoSiisp() {
            document.getElementById('secao-importacao').style.display = 'none';
            document.getElementById('secao-manual').style.display = 'none';
            document.getElementById('secao-exclusao').style.display = 'none';
            document.getElementById('secao-siisp').style.display = 'block';
            document.getElementById('secao-siisp').scrollIntoView({ behavior: 'smooth' });
            
            // Inicializar seletor de m√™s/ano do SIISP
            initMesAnoSiisp();
        }

        // Bot√µes de cancelar
        document.getElementById('btn-cancelar-import').addEventListener('click', function() {
            document.getElementById('secao-importacao').style.display = 'none';
        });

        document.getElementById('btn-cancelar-manual').addEventListener('click', function() {
            document.getElementById('secao-manual').style.display = 'none';
        });

        document.getElementById('btn-cancelar-exclusao').addEventListener('click', function() {
            document.getElementById('secao-exclusao').style.display = 'none';
        });

        document.getElementById('btn-cancelar-siisp').addEventListener('click', function() {
            document.getElementById('secao-siisp').style.display = 'none';
        });

        // Processar adi√ß√£o de n√∫meros SIISP
        document.getElementById('btn-processar-siisp').addEventListener('click', function() {
            const unidade = document.getElementById('select-unidade-siisp').value;
            const mes = document.getElementById('mes-siisp').value;
            const ano = document.getElementById('ano-siisp').value;
            const numerosSiisp = document.getElementById('numeros-siisp').value;
            
            // Valida√ß√£o da unidade
            if (!unidade) {
                showNotification('warning', 'Campo obrigat√≥rio', 'Por favor, selecione a unidade.');
                return;
            }
            
            // Valida√ß√£o do m√™s e ano
            if (!mes || !ano) {
                showNotification('warning', 'Campos obrigat√≥rios', 'Por favor, selecione o m√™s e ano.');
                return;
            }
            
            // Valida√ß√£o dos n√∫meros SIISP
            if (!numerosSiisp || numerosSiisp.trim() === '') {
                showNotification('warning', 'Campo obrigat√≥rio', 'Por favor, cole os n√∫meros SIISP.');
                return;
            }
            
            console.log('Dados SIISP coletados:', {
                unidade: unidade,
                mes: mes,
                ano: ano,
                numerosSiisp: numerosSiisp.substring(0, 100) + '...' // Log truncado
            });
            
            // Preparar dados para enviar √† API
            const dadosParaApi = {
                lote_id: loteId,
                mes: parseInt(mes),
                ano: parseInt(ano),
                unidade: unidade,
                dados_siisp: numerosSiisp
            };
            
            console.log('Enviando dados SIISP para API:', dadosParaApi);
            
            // Chamar API para adicionar n√∫meros SIISP
            fetch('/api/adicionar-siisp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dadosParaApi)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Erro no servidor');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Mostrar notifica√ß√£o de sucesso
                    const validacao = data.validacao || {};
                    const siisp = validacao.siisp || {};
                    const registros = siisp.registros_processados || 0;
                    const mensagem = `${registros} n√∫meros SIISP adicionados para ${unidade} em ${mes}/${ano}.`;
                    
                    showNotification('success', 'Dados SIISP salvos com sucesso!', mensagem);
                    
                    // Fechar se√ß√£o e limpar formul√°rio
                    document.getElementById('secao-siisp').style.display = 'none';
                    document.getElementById('select-unidade-siisp').value = '';
                    document.getElementById('numeros-siisp').value = '';
                    
                    // Log de sucesso
                    console.log('‚úÖ N√∫meros SIISP adicionados:', data.registro);
                    
                    // Recarregar a p√°gina para mostrar os novos dados
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } else {
                    // Erro retornado pela API
                    showNotification('error', 'Erro ao adicionar SIISP', data.error || 'Erro desconhecido na API.');
                }
            })
            .catch(error => {
                console.error('‚ùå Erro ao adicionar n√∫meros SIISP:', error);
                
                // Mostrar notifica√ß√£o de erro
                if (error.message.includes('obrigat√≥rios')) {
                    showNotification('error', 'Dados inv√°lidos', error.message);
                } else if (error.message.includes('n√£o confere')) {
                    showNotification('error', 'Quantidade incorreta', error.message);
                } else if (error.message.includes('inv√°lido na linha')) {
                    showNotification('error', 'Formato inv√°lido', error.message);
                } else if (error.message.includes('N√£o foram encontrados dados')) {
                    showNotification('error', 'Dados n√£o encontrados', error.message);
                } else {
                    showNotification('error', 'Erro de conex√£o', 'Erro de conex√£o com o servidor. Verifique sua conex√£o e tente novamente.');
                }
            });
        });

        // Processar exclus√£o
        document.getElementById('btn-confirmar-exclusao').addEventListener('click', function() {
            const unidade = document.getElementById('select-unidade-exclusao').value;
            const mes = document.getElementById('mes-exclusao').value;
            const ano = document.getElementById('ano-exclusao').value;
            
            // Valida√ß√£o da unidade
            if (!unidade) {
                showNotification('warning', 'Unidade n√£o selecionada', 'Por favor, selecione a unidade para excluir os dados.');
                return;
            }
            
            // Valida√ß√£o do m√™s e ano
            if (!mes || !ano) {
                showNotification('warning', 'Campos obrigat√≥rios', 'Por favor, selecione o m√™s e ano para exclus√£o.');
                return;
            }
            
            // Preparar dados para enviar √† API
            const dadosExclusao = {
                lote_id: loteId,
                mes: parseInt(mes),
                ano: parseInt(ano),
                unidade: unidade
            };
            
            // Mostrar modal de confirma√ß√£o personalizado
            mostrarConfirmacaoExclusao(unidade, mes, ano, dadosExclusao);
        });

        // Inicializar seletor de m√™s/ano da importa√ß√£o
        function initMesAnoImport() {
            const mesSelect = document.getElementById('mes-import');
            const anoInput = document.getElementById('ano-import');
            const mesAnoDisplay = document.getElementById('mes-ano-display-import');
            const mesAnoText = document.getElementById('mes-ano-text-import');
            
            // Definir m√™s anterior como padr√£o
            const now = new Date();
            let mesAnterior = now.getMonth(); // getMonth() retorna 0-11
            let anoAnterior = now.getFullYear();
            
            if (mesAnterior === 0) {
                mesAnterior = 12;
                anoAnterior--;
            }
            
            mesSelect.value = mesAnterior.toString();
            anoInput.value = anoAnterior.toString();
            atualizarDisplayMesAno();
            
            // Eventos para atualizar display quando valores mudarem
            mesSelect.addEventListener('change', atualizarDisplayMesAno);
            anoInput.addEventListener('input', atualizarDisplayMesAno);
            
            // Clique no display para focar no primeiro input
            mesAnoDisplay.addEventListener('click', function() {
                mesSelect.focus();
            });
            
            function atualizarDisplayMesAno() {
                const meses = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                const mesIndex = parseInt(mesSelect.value) - 1;
                const mesNome = meses[mesIndex] || 'M√™s';
                const ano = anoInput.value || 'Ano';
                
                mesAnoText.textContent = `${mesNome}/${ano}`;
            }
        }
        
        // Inicializar seletor de m√™s/ano da entrada manual
        function initMesAnoManual() {
            const mesSelect = document.getElementById('mes-manual');
            const anoInput = document.getElementById('ano-manual');
            const mesAnoDisplay = document.getElementById('mes-ano-display-manual');
            const mesAnoText = document.getElementById('mes-ano-text-manual');
            
            // Definir m√™s anterior como padr√£o
            const now = new Date();
            let mesAnterior = now.getMonth(); // getMonth() retorna 0-11
            let anoAnterior = now.getFullYear();
            
            if (mesAnterior === 0) {
                mesAnterior = 12;
                anoAnterior--;
            }
            
            mesSelect.value = mesAnterior.toString();
            anoInput.value = anoAnterior.toString();
            atualizarDisplayMesAnoManual();
            gerarTabelaManual(); // Gerar tabela inicial
            
            // Eventos para atualizar display quando valores mudarem
            mesSelect.addEventListener('change', function() {
                atualizarDisplayMesAnoManual();
                gerarTabelaManual();
            });
            anoInput.addEventListener('input', function() {
                atualizarDisplayMesAnoManual();
                gerarTabelaManual();
            });
            
            // Clique no display para focar no primeiro input
            mesAnoDisplay.addEventListener('click', function() {
                mesSelect.focus();
            });
            
            function atualizarDisplayMesAnoManual() {
                const meses = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                const mesIndex = parseInt(mesSelect.value) - 1;
                const mesNome = meses[mesIndex] || 'M√™s';
                const ano = anoInput.value || 'Ano';
                
                mesAnoText.textContent = `${mesNome}/${ano}`;
            }
        }

        // Inicializar seletor de m√™s/ano do SIISP
        function initMesAnoSiisp() {
            const mesSelect = document.getElementById('mes-siisp');
            const anoInput = document.getElementById('ano-siisp');
            const mesAnoDisplay = document.getElementById('mes-ano-display-siisp');
            const mesAnoText = document.getElementById('mes-ano-text-siisp');
            
            // Definir m√™s anterior como padr√£o
            const now = new Date();
            let mesAnterior = now.getMonth(); // getMonth() retorna 0-11
            let anoAnterior = now.getFullYear();
            
            if (mesAnterior === 0) {
                mesAnterior = 12;
                anoAnterior--;
            }
            
            mesSelect.value = mesAnterior.toString();
            anoInput.value = anoAnterior.toString();
            atualizarDisplayMesAnoSiisp();
            
            // Eventos para atualizar display quando valores mudarem
            mesSelect.addEventListener('change', atualizarDisplayMesAnoSiisp);
            anoInput.addEventListener('input', atualizarDisplayMesAnoSiisp);
            
            // Clique no display para focar no primeiro input
            mesAnoDisplay.addEventListener('click', function() {
                mesSelect.focus();
            });
            
            function atualizarDisplayMesAnoSiisp() {
                const meses = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                const mesIndex = parseInt(mesSelect.value) - 1;
                const mesNome = meses[mesIndex] || 'M√™s';
                const ano = anoInput.value || 'Ano';
                
                mesAnoText.textContent = `${mesNome}/${ano}`;
            }
        }

        // Fun√ß√£o para gerar tabela manual baseada no m√™s/ano selecionado
        function gerarTabelaManual() {
            const mesSelect = document.getElementById('mes-manual');
            const anoInput = document.getElementById('ano-manual');
            const tbody = document.getElementById('tbody-entrada-manual');
            
            if (!mesSelect || !anoInput || !tbody) return;
            
            const mes = parseInt(mesSelect.value);
            const ano = parseInt(anoInput.value);
            
            // Calcular n√∫mero de dias no m√™s
            const diasNoMes = new Date(ano, mes, 0).getDate();
            
            // Limpar tabela
            tbody.innerHTML = '';
            
            // Gerar linhas para cada dia do m√™s
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const tr = document.createElement('tr');
                // Formatar data como DD/MM/AAAA
                const dataFormatada = `${dia.toString().padStart(2, '0')}/${mes.toString().padStart(2, '0')}/${ano}`;
                tr.innerHTML = `
                    <td class="data-column"><input type="text" class="input-data" value="${dataFormatada}" data-col="data" data-dia="${dia}" style="width: 100px; text-align: center;"></td>
                    <td><input type="number" min="0" placeholder="0" data-col="cafe-int" data-dia="${dia}"></td>
                    <td><input type="number" min="0" placeholder="0" data-col="cafe-func" data-dia="${dia}"></td>
                    <td><input type="number" min="0" placeholder="0" data-col="almoco-int" data-dia="${dia}"></td>
                    <td><input type="number" min="0" placeholder="0" data-col="almoco-func" data-dia="${dia}"></td>
                    <td><input type="number" min="0" placeholder="0" data-col="lanche-int" data-dia="${dia}"></td>
                    <td><input type="number" min="0" placeholder="0" data-col="lanche-func" data-dia="${dia}"></td>
                    <td><input type="number" min="0" placeholder="0" data-col="jantar-int" data-dia="${dia}"></td>
                    <td><input type="number" min="0" placeholder="0" data-col="jantar-func" data-dia="${dia}"></td>
                `;
                tbody.appendChild(tr);
            }
            
            // Adicionar evento de navega√ß√£o por teclado
            adicionarNavegacaoTeclado();
        }

        // Fun√ß√£o para adicionar navega√ß√£o por teclado na tabela (estilo Excel)
        function adicionarNavegacaoTeclado() {
            const inputs = document.querySelectorAll('#tabela-entrada-manual input');
            
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', function(e) {
                    let targetIndex = index;
                    
                    switch(e.key) {
                        case 'Tab':
                            // Tab j√° funciona naturalmente
                            break;
                        case 'Enter':
                        case 'ArrowDown':
                            e.preventDefault();
                            targetIndex = index + 8; // Pr√≥xima linha (8 colunas de dados)
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            targetIndex = index - 8; // Linha anterior
                            break;
                        case 'ArrowRight':
                            if (input.selectionStart === input.value.length) {
                                e.preventDefault();
                                targetIndex = index + 1;
                            }
                            break;
                        case 'ArrowLeft':
                            if (input.selectionStart === 0) {
                                e.preventDefault();
                                targetIndex = index - 1;
                            }
                            break;
                    }
                    
                    // Focar no input de destino se existir
                    if (inputs[targetIndex] && targetIndex !== index) {
                        inputs[targetIndex].focus();
                        inputs[targetIndex].select();
                    }
                });

                // Adicionar funcionalidade de paste especial (estilo Excel)
                input.addEventListener('paste', function(e) {
                    e.preventDefault();
                    
                    // Obter dados do clipboard
                    const pasteData = e.clipboardData.getData('text');
                    
                    if (!pasteData.trim()) return;
                    
                    // Detectar se s√£o dados tabulares (m√∫ltiplas linhas/colunas)
                    if (isTabularData(pasteData)) {
                        colarDadosTabulares(pasteData, input, index);
                    } else {
                        // Se for um valor simples, colar normalmente
                        input.value = pasteData.trim();
                    }
                });
            });
        }

        // Fun√ß√£o para detectar se os dados s√£o tabulares
        function isTabularData(data) {
            const lines = data.trim().split('\n');
            if (lines.length <= 1) return false;
            
            // Verificar se h√° tabs ou m√∫ltiplos espa√ßos (indicando colunas)
            const hasTabsOrSpaces = lines.some(line => 
                line.includes('\t') || line.match(/\s{2,}/) || line.split(/\s+/).length > 1
            );
            
            return hasTabsOrSpaces || lines.length > 1;
        }

        // Fun√ß√£o para colar dados tabulares nas c√©lulas
        function colarDadosTabulares(data, startInput, startIndex) {
            const lines = data.trim().split('\n');
            const inputs = document.querySelectorAll('#tabela-entrada-manual input');
            const inputsPerRow = 9; // Agora s√£o 9 colunas (incluindo data)
            const table = document.getElementById('tabela-entrada-manual');
            const rows = table.querySelectorAll('tbody tr');

            // Descobrir a linha e coluna inicial a partir do input clicado
            const startRowIndex = Math.floor(startIndex / inputsPerRow);
            const startColIndex = startIndex % inputsPerRow; // 0 = coluna de data

            lines.forEach((line, rowOffset) => {
                // Detectar separador (TAB tem prioridade sobre espa√ßos)
                let values;
                if (line.includes('\t')) {
                    values = line.split('\t');
                } else {
                    // Para espa√ßos, dividir por m√∫ltiplos espa√ßos ou espa√ßos simples
                    values = line.split(/\s+/).filter(v => v.trim() !== '');
                }

                // Calcular linha de destino baseada na posi√ß√£o inicial
                const targetRowIndex = startRowIndex + rowOffset;
                if (targetRowIndex >= rows.length) return; // N√£o ultrapassar o n√∫mero de linhas

                const targetRow = rows[targetRowIndex];
                const targetInputs = targetRow.querySelectorAll('input');

                // Colar valores a partir da coluna do input clicado
                values.forEach((value, colOffset) => {
                    const inputIndexInRow = startColIndex + colOffset;
                    if (inputIndexInRow < inputsPerRow) {
                        const targetInput = targetInputs[inputIndexInRow];
                        if (targetInput) {
                            // Se for a coluna de data (primeira), aceita texto, sen√£o s√≥ n√∫meros
                            if (inputIndexInRow === 0) {
                                targetInput.value = value.trim();
                            } else {
                                const numericValue = value.replace(/[^\d]/g, '');
                                if (numericValue) {
                                    targetInput.value = numericValue;
                                }
                            }
                            // Adicionar efeito visual para mostrar que foi colado
                            targetInput.style.backgroundColor = '#d4edda';
                            setTimeout(() => {
                                targetInput.style.backgroundColor = '';
                            }, 1000);
                        }
                    }
                });
            });

            // Mostrar notifica√ß√£o de sucesso
            const totalCells = lines.reduce((acc, line) => {
                const values = line.includes('\t') ? line.split('\t') : line.split(/\s+/).filter(v => v.trim() !== '');
                return acc + values.length;
            }, 0);

            if (totalCells > 0) {
                showNotification('success', 'Dados colados com sucesso!', `${totalCells} valores foram inseridos na tabela.`);
            }
        }
        
        // Processar importa√ß√£o
        document.getElementById('btn-processar-import').addEventListener('click', function() {
            const unidade = document.getElementById('select-unidade-import').value;
            
            // Debug: verificar se o elemento existe
            const textoElement = document.getElementById('texto-pdf');
            console.log('üîç Debug - Elemento texto-pdf encontrado:', textoElement);
            
            // Capturar texto SEM trim() para preservar espa√ßos e quebras de linha
            const textoPdf = textoElement ? textoElement.value : '';
            const mes = document.getElementById('mes-import').value;
            const ano = document.getElementById('ano-import').value;
            const dadosSiisp = document.getElementById('dados-siisp').value.trim();
            
            // Debug: verificar se o texto est√° sendo capturado (mostrar caracteres especiais)
            console.log('üîç Debug - Texto capturado (raw):', JSON.stringify(textoPdf));
            console.log('üîç Debug - Tamanho do texto:', textoPdf.length);
            console.log('üîç Debug - Primeiros 100 chars:', textoPdf.substring(0, 100));
            
            if (!unidade) {
                showNotification('warning', 'Campo obrigat√≥rio', 'Por favor, selecione a unidade.');
                return;
            }
            
            if (!mes || !ano) {
                showNotification('warning', 'Campos obrigat√≥rios', 'Por favor, defina o m√™s e ano de refer√™ncia.');
                return;
            }
            
            if (!textoPdf || textoPdf.trim() === '') {
                showNotification('warning', 'Campo obrigat√≥rio', 'Por favor, insira o texto extra√≠do do PDF ou Excel.');
                return;
            }
            
            // Preparar dados para enviar √† API
            const dadosParaApi = {
                lote_id: loteId,
                mes: parseInt(mes),
                ano: parseInt(ano),
                unidade: unidade,
                dados_siisp: dadosSiisp,  // Enviar dados SIISP como string original
                texto: textoPdf
            };
            
            console.log('Enviando dados para API:', dadosParaApi);
            
            // Chamar API para salvar dados
            fetch('/api/adicionar-dados', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dadosParaApi)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(JSON.stringify(errorData));
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const meses = [
                        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                    ];
                    const mesNome = meses[parseInt(mes) - 1];
                    
                    // Usar estat√≠sticas retornadas pelo backend
                    const stats = data.estatisticas || {};
                    const diasSalvos = stats.registros_processados || 0;
                    const totalRefeicoes = stats.total_refeicoes || 0;
                    
                    // Verificar se houve filtragem (linhas < dias do m√™s)
                    const mesNumero = parseInt(mes);
                    const anoNumero = parseInt(ano);
                    const diasNoMes = new Date(anoNumero, mesNumero, 0).getDate();
                    
                    let mensagem;
                    if (diasSalvos < diasNoMes) {
                        mensagem = `${diasSalvos} de ${diasNoMes} dias foram salvos para ${unidade} em ${mesNome}/${ano} (filtrados por per√≠odo de contrato). Total de refei√ß√µes: ${totalRefeicoes}.`;
                    } else {
                        mensagem = `${diasSalvos} registros salvos para ${unidade} em ${mesNome}/${ano}. Total de refei√ß√µes: ${totalRefeicoes}.`;
                    }
                    
                    showNotification('success', 'Dados salvos com sucesso!', mensagem);
                    
                    document.getElementById('secao-importacao').style.display = 'none';
                    
                    // Limpar formul√°rio
                    document.getElementById('texto-pdf').value = '';
                    document.getElementById('dados-siisp').value = '';
                    
                    // Recarregar p√°gina com filtros aplicados para a unidade e per√≠odo rec√©m-adicionados
                    setTimeout(() => {
                        window.location.href = `?unidade=${encodeURIComponent(unidade)}&mes=${mes}&ano=${ano}`;
                    }, 1000); // 1 segundo para garantir que a notifica√ß√£o fique vis√≠vel
                    
                    console.log('‚úÖ Dados salvos:', data.registro);
                } else {
                    showNotification('error', 'Erro ao salvar dados', data.error || 'Erro desconhecido ao processar os dados.');
                    console.error('‚ùå Erro da API:', data);
                }
            })
            .catch(error => {
                console.error('‚ùå Erro completo:', error);
                
                try {
                    // Tentar fazer parse do erro para ver se √© erro de valida√ß√£o
                    const errorData = JSON.parse(error.message);
                    
                    if (errorData.validacao && !errorData.validacao.valido) {
                        // Erro de valida√ß√£o - mostrar popup detalhado
                        const detalhesValidacao = `${errorData.validacao.detalhes}. ` +
                            `Registros encontrados: ${errorData.validacao.registros_processados}, ` +
                            `Dias esperados: ${errorData.validacao.dias_esperados}. ` +
                            `Os dados devem conter exatamente ${errorData.validacao.dias_esperados} linhas.`;
                        
                        showNotification('error', 'Dados rejeitados - Inconsist√™ncia detectada', detalhesValidacao);
                    } else {
                        // Outro tipo de erro
                        showNotification('error', 'Erro do servidor', errorData.error || 'Erro desconhecido do servidor.');
                    }
                } catch (parseError) {
                    // Erro de conex√£o ou outro tipo
                    showNotification('error', 'Erro de conex√£o', 'Erro de conex√£o com o servidor. Verifique sua conex√£o e tente novamente.');
                }
                
                console.error('‚ùå Erro de rede:', error);
            });
        });

        // Salvar entrada manual
        document.getElementById('btn-salvar-manual').addEventListener('click', function() {
            const unidade = document.getElementById('select-unidade-manual').value;
            const mes = document.getElementById('mes-manual').value;
            const ano = document.getElementById('ano-manual').value;
            
            // Valida√ß√£o da unidade
            if (!unidade) {
                showNotification('warning', 'Campo obrigat√≥rio', 'Por favor, selecione a unidade.');
                return;
            }
            
            // Valida√ß√£o do m√™s e ano
            if (!mes || !ano) {
                showNotification('warning', 'Campos obrigat√≥rios', 'Por favor, selecione o m√™s e ano.');
                return;
            }

            // Coletar dados da tabela
            const dadosTabela = coletarDadosTabela();
            
            // Verificar se h√° pelo menos um valor preenchido
            const temDados = dadosTabela.some(dia => 
                dia.cafe_interno > 0 || dia.cafe_funcionario > 0 || dia.almoco_interno > 0 || dia.almoco_funcionario > 0 ||
                dia.lanche_interno > 0 || dia.lanche_funcionario > 0 || dia.jantar_interno > 0 || dia.jantar_funcionario > 0
            );
            
            if (!temDados) {
                showNotification('warning', 'Tabela vazia', 'Por favor, preencha pelo menos um valor na tabela.');
                return;
            }
            
            console.log('Dados coletados da tabela:', dadosTabela);
            
            // Preparar dados para enviar √† API
            const dadosParaApi = {
                lote_id: loteId,
                mes: parseInt(mes),
                ano: parseInt(ano),
                unidade: unidade,
                dados_tabela: dadosTabela
            };
            
            console.log('Enviando dados para API de entrada manual:', dadosParaApi);
            
            // Chamar API para salvar dados
            fetch('/api/entrada-manual', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dadosParaApi)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Erro no servidor');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Mostrar notifica√ß√£o de sucesso
                    const stats = data.estatisticas || {};
                    const diasSalvos = stats.registros_processados || 0;
                    const totalRefeicoes = stats.total_refeicoes || 0;
                    
                    // Verificar se houve filtragem
                    const mesNumero = parseInt(mes);
                    const anoNumero = parseInt(ano);
                    const diasNoMes = new Date(anoNumero, mesNumero, 0).getDate();
                    
                    let mensagem;
                    if (diasSalvos < diasNoMes) {
                        mensagem = `${diasSalvos} de ${diasNoMes} dias foram salvos para ${unidade} em ${mes}/${ano} (filtrados por per√≠odo de contrato). Total de refei√ß√µes: ${totalRefeicoes}.`;
                    } else {
                        mensagem = `${diasSalvos} registros salvos para ${unidade} em ${mes}/${ano}. Total de refei√ß√µes: ${totalRefeicoes}.`;
                    }
                    
                    showNotification('success', 'Dados salvos com sucesso!', mensagem);
                    
                    // Fechar se√ß√£o e limpar formul√°rio
                    document.getElementById('secao-manual').style.display = 'none';
                    document.getElementById('select-unidade-manual').value = '';
                    gerarTabelaManual(); // Regenerar tabela vazia
                    
                    // Atualizar dados na tela (se aplic√°vel)
                    
                    // Recarregar a p√°gina com filtros aplicados para a unidade e per√≠odo rec√©m-adicionados
                    setTimeout(() => {
                        window.location.href = `?unidade=${encodeURIComponent(unidade)}&mes=${mes}&ano=${ano}`;
                    }, 2000);
                    
                } else {
                    // Erro retornado pela API
                    showNotification('error', 'Erro ao salvar', data.error || 'Erro desconhecido na API.');
                }
            })
            .catch(error => {
                console.error('‚ùå Erro ao salvar entrada manual:', error);
                
                // Mostrar notifica√ß√£o de erro
                if (error.message.includes('Lote ID') || error.message.includes('obrigat√≥rios')) {
                    showNotification('error', 'Dados inv√°lidos', error.message);
                } else if (error.message.includes('n√£o confere')) {
                    showNotification('error', 'Inconsist√™ncia de dados', error.message);
                } else if (error.message.includes('inv√°lidos encontrados')) {
                    showNotification('error', 'Valores inv√°lidos', error.message);
                } else {
                    showNotification('error', 'Erro de conex√£o', 'Erro de conex√£o com o servidor. Verifique sua conex√£o e tente novamente.');
                }
            });
        });

        // Fun√ß√£o para coletar dados da tabela manual
        function coletarDadosTabela() {
            const inputs = document.querySelectorAll('#tabela-entrada-manual input');
            const dados = [];
            const diasNoMes = new Date(parseInt(document.getElementById('ano-manual').value), parseInt(document.getElementById('mes-manual').value), 0).getDate();
            
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const cafeInterno = parseInt(document.querySelector(`input[data-col="cafe-int"][data-dia="${dia}"]`).value) || 0;
                const cafeFuncionario = parseInt(document.querySelector(`input[data-col="cafe-func"][data-dia="${dia}"]`).value) || 0;
                const almocoInterno = parseInt(document.querySelector(`input[data-col="almoco-int"][data-dia="${dia}"]`).value) || 0;
                const almocoFuncionario = parseInt(document.querySelector(`input[data-col="almoco-func"][data-dia="${dia}"]`).value) || 0;
                const lancheInterno = parseInt(document.querySelector(`input[data-col="lanche-int"][data-dia="${dia}"]`).value) || 0;
                const lancheFuncionario = parseInt(document.querySelector(`input[data-col="lanche-func"][data-dia="${dia}"]`).value) || 0;
                const jantarInterno = parseInt(document.querySelector(`input[data-col="jantar-int"][data-dia="${dia}"]`).value) || 0;
                const jantarFuncionario = parseInt(document.querySelector(`input[data-col="jantar-func"][data-dia="${dia}"]`).value) || 0;
                
                dados.push({
                    dia: dia,
                    cafe_interno: cafeInterno,
                    cafe_funcionario: cafeFuncionario,
                    almoco_interno: almocoInterno,
                    almoco_funcionario: almocoFuncionario,
                    lanche_interno: lancheInterno,
                    lanche_funcionario: lancheFuncionario,
                    jantar_interno: jantarInterno,
                    jantar_funcionario: jantarFuncionario
                });
            }
            
            return dados;
        }

        // Fun√ß√£o para mostrar confirma√ß√£o de exclus√£o
        function mostrarConfirmacaoExclusao(unidade, mes, ano, dadosExclusao) {
            const modal = document.getElementById('modal-confirmacao-exclusao');
            const mensagem = document.getElementById('mensagem-confirmacao');
            
            // Definir mensagem personalizada
            mensagem.textContent = `Tem certeza que deseja excluir TODOS os dados de ${unidade} para ${mes}/${ano}?`;
            
            // Mostrar modal
            modal.style.display = 'block';
            
            // Definir a√ß√£o do bot√£o de confirma√ß√£o
            document.getElementById('btn-confirmar-confirmacao').onclick = function() {
                modal.style.display = 'none';
                executarExclusao(dadosExclusao, unidade, mes, ano);
            };
        }
        
        // Fun√ß√£o para executar a exclus√£o (c√≥digo movido do evento original)
        function executarExclusao(dadosExclusao, unidade, mes, ano) {
            console.log('Excluindo dados:', dadosExclusao);
            
            // Chamar API para excluir dados
            fetch('/api/excluir-dados', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dadosExclusao)
            })
            .then(response => {
                // Sempre tentar fazer parse do JSON, mesmo para erros
                return response.json().then(data => {
                    return { data: data, status: response.status, ok: response.ok };
                });
            })
            .then(result => {
                console.log('üîç Debug - Resposta da API de exclus√£o:', result);
                const { data, status, ok } = result;
                
                if (ok && data.success) {
                    showNotification('success', 'Registro exclu√≠do', `Os dados de ${unidade} para ${mes}/${ano} foram exclu√≠dos com sucesso.`);
                    
                    // Fechar popup de exclus√£o
                    document.getElementById('secao-exclusao').style.display = 'none';
                    
                    // Limpar formul√°rio
                    document.getElementById('select-unidade-exclusao').value = '';
                    document.getElementById('mes-exclusao').value = '';
                    document.getElementById('ano-exclusao').value = '2025';
                    
                    // Recarregar dados da tabela
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else if (status === 404 || (data.error && (data.error.includes('n√£o encontrado') || data.error.includes('Registro n√£o encontrado')))) {
                    showNotification('warning', 'Registro n√£o existente', `N√£o foram encontrados dados de ${unidade} para ${mes}/${ano}.`);
                } else {
                    showNotification('error', 'Erro na exclus√£o', data.error || 'Erro desconhecido ao excluir os dados.');
                }
            })
            .catch(error => {
                console.error('‚ùå Erro ao excluir dados:', error);
                showNotification('error', 'Erro de conex√£o', 'Erro de conex√£o com o servidor. Verifique sua conex√£o e tente novamente.');
            });
        }

        // Modal da legenda
        document.getElementById('btn-legenda').addEventListener('click', function() {
            document.getElementById('modal-legenda').style.display = 'block';
        });

        document.getElementById('btn-fechar-legenda').addEventListener('click', function() {
            document.getElementById('modal-legenda').style.display = 'none';
        });

        // Modal de confirma√ß√£o de exclus√£o
        document.getElementById('btn-cancelar-confirmacao').addEventListener('click', function() {
            document.getElementById('modal-confirmacao-exclusao').style.display = 'none';
        });

        // Fechar modais clicando fora
        document.getElementById('modal-legenda').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
        
        document.getElementById('modal-confirmacao-exclusao').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });



        // Exportar tabela
        document.getElementById('btn-exportar-tabela').addEventListener('click', function() {
            // Obter filtros ativos
            const dataInicio = filtrosAtivos.dataInicio;
            const dataFim = filtrosAtivos.dataFim;
            const unidades = filtrosAtivos.unidadesSelecionadas;

            // Montar nome do arquivo
            let nomeArquivo = 'tabela_lote_' + loteId;
            if (dataInicio && dataFim) {
                nomeArquivo += `_${dataInicio}_a_${dataFim}`;
            }
            nomeArquivo += '.xlsx';

            // Montar URL da exporta√ß√£o
            const params = new URLSearchParams();
            if (dataInicio) params.append('data_inicio', dataInicio);
            if (dataFim) params.append('data_fim', dataFim);
            if (unidades && unidades.length > 0) params.append('unidades', unidades.join(','));
            params.append('lote_id', loteId);

            // Chamar rota Flask para exportar Excel
            fetch(`/exportar-tabela?${params.toString()}`)
                .then(response => {
                    if (!response.ok) throw new Error('Erro ao gerar arquivo');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = nomeArquivo;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    showNotification('success', 'Download conclu√≠do', 'Tabela exportada com sucesso!');
                })
                .catch(() => {
                    showNotification('error', 'Erro ao baixar tabela', 'N√£o foi poss√≠vel gerar o arquivo Excel.');
                });
        });
        


        // Logout
        document.getElementById('logoutLink').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                showNotification('success', 'Logout realizado', 'At√© logo!', false);
                localStorage.removeItem('sgmrp_usuario');
                localStorage.removeItem('sgmrp_remember');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
            }
        });

        // Controle do filtro de per√≠odo
        function initPeriodoFilter(skipAutoInit = false) {
            const periodoDisplay = document.getElementById('periodo-display');
            const calendarioPopup = document.getElementById('calendario-popup');
            const calendarioOverlay = document.getElementById('calendario-overlay');
            const dataInicio = document.getElementById('data-inicio');
            const dataFim = document.getElementById('data-fim');
            const btnAplicar = document.getElementById('btn-aplicar-periodo');
            const btnCancelar = document.getElementById('btn-cancelar-periodo');
            
            // Abrir calend√°rio
            periodoDisplay.addEventListener('click', function() {
                calendarioPopup.style.display = 'block';
                calendarioOverlay.style.display = 'block';
                periodoDisplay.classList.add('active');
                atualizarInfoDias();
            });
            
            // Fechar calend√°rio
            function fecharCalendario() {
                calendarioPopup.style.display = 'none';
                calendarioOverlay.style.display = 'none';
                periodoDisplay.classList.remove('active');
            }
            
            calendarioOverlay.addEventListener('click', fecharCalendario);
            btnCancelar.addEventListener('click', fecharCalendario);
            
            // Aplicar per√≠odo
            btnAplicar.addEventListener('click', function() {
                // Atualizar filtros ativos
                filtrosAtivos.dataInicio = dataInicio.value;
                filtrosAtivos.dataFim = dataFim.value;
                
                atualizarDisplayPeriodo();
                atualizarTituloPeriodo();
                fecharCalendario();
                
                // Aplicar filtros e atualizar tabela
                console.log('Aplicando filtro de per√≠odo:', dataInicio.value, 'at√©', dataFim.value);
                console.log('Dados originais:', dadosOriginais.length, 'registros');
                aplicarFiltros();
                console.log('Dados filtrados:', dadosRefeicoes.length, 'registros');
            });
            
            // Atualizar info de dias quando as datas mudarem
            dataInicio.addEventListener('change', atualizarInfoDias);
            dataFim.addEventListener('change', atualizarInfoDias);
            
            // Seletor de m√™s/ano
            const mesPeriodo = document.getElementById('mes-periodo');
            const anoPeriodo = document.getElementById('ano-periodo');
            
            // Definir m√™s anterior como padr√£o
            const hoje = new Date();
            let mesAnterior = hoje.getMonth(); // 0-11 (outubro = 9)
            let anoAnterior = hoje.getFullYear();
            
            if (mesAnterior === 0) {
                mesAnterior = 12;
                anoAnterior--;
            }
            
            mesPeriodo.value = mesAnterior.toString();
            anoPeriodo.value = anoAnterior.toString();
            
            // Fun√ß√£o para atualizar as datas quando m√™s/ano mudarem
            function atualizarDatasPorMesAno() {
                const mes = parseInt(mesPeriodo.value);
                const ano = parseInt(anoPeriodo.value);
                
                // Calcular primeiro e √∫ltimo dia do m√™s
                const primeiroDia = new Date(ano, mes - 1, 1);
                const ultimoDia = new Date(ano, mes, 0);
                
                // Definir valores nos inputs
                dataInicio.value = primeiroDia.toISOString().split('T')[0];
                dataFim.value = ultimoDia.toISOString().split('T')[0];
                
                // Atualizar display
                atualizarInfoDias();
            }
            
            // Event listeners para atualiza√ß√£o autom√°tica
            mesPeriodo.addEventListener('change', atualizarDatasPorMesAno);
            anoPeriodo.addEventListener('change', atualizarDatasPorMesAno);
            
            // Aplicar o m√™s anterior inicial APENAS se n√£o houver par√¢metros na URL
            if (!skipAutoInit) {
                atualizarDatasPorMesAno();
            }
        }
        
        function atualizarInfoDias() {
            const dataInicioValue = document.getElementById('data-inicio').value;
            const dataFimValue = document.getElementById('data-fim').value;
            const diasInfo = document.getElementById('dias-periodo');
            
            if (dataInicioValue && dataFimValue) {
                // Converter strings ISO para Date de forma consistente
                const [anoInicio, mesInicio, diaInicio] = dataInicioValue.split('-');
                const [anoFim, mesFim, diaFim] = dataFimValue.split('-');
                const dataInicio = new Date(parseInt(anoInicio), parseInt(mesInicio) - 1, parseInt(diaInicio));
                const dataFim = new Date(parseInt(anoFim), parseInt(mesFim) - 1, parseInt(diaFim));
                
                if (dataInicio <= dataFim) {
                    const diffTime = Math.abs(dataFim - dataInicio);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Contar quantos registros est√£o no per√≠odo - converter data brasileira
                    const registrosNoPeriodo = dadosOriginais.filter(registro => {
                        if (!registro.data) return false;
                        const partesData = registro.data.split('/');
                        const dataRegistro = new Date(partesData[2], partesData[1] - 1, partesData[0]);
                        return dataRegistro >= dataInicio && dataRegistro <= dataFim;
                    }).length;
                    
                    diasInfo.textContent = `${diffDays} dias selecionados (${registrosNoPeriodo} registros)`;
                } else {
                    diasInfo.textContent = 'Data de in√≠cio deve ser anterior √† data de fim';
                }
            } else {
                diasInfo.textContent = 'Selecione as datas de in√≠cio e fim';
            }
        }
        
        function atualizarDisplayPeriodo() {
            const dataInicio = document.getElementById('data-inicio').value;
            const dataFim = document.getElementById('data-fim').value;
            const periodoText = document.getElementById('periodo-text');
            
            console.log('üîç DEBUG atualizarDisplayPeriodo:', 'dataInicio=', dataInicio, 'dataFim=', dataFim);
            
            if (dataInicio && dataFim) {
                // Usar split para evitar problemas de timezone
                let anoInicio, mesInicio, diaInicio, anoFim, mesFim, diaFim;
                if (dataInicio) {
                    [anoInicio, mesInicio, diaInicio] = dataInicio.split('-');
                }
                if (dataFim) {
                    [anoFim, mesFim, diaFim] = dataFim.split('-');
                }
                
                console.log('üîç DEBUG Split dates:', 
                    'inicio:', diaInicio, '/', mesInicio, '/', anoInicio,
                    'fim:', diaFim, '/', mesFim, '/', anoFim
                );
                
                const inicioFormatado = `${diaInicio}/${mesInicio}/${anoInicio}`;
                const fimFormatado = `${diaFim}/${mesFim}/${anoFim}`;
                
                console.log('üîç DEBUG Formatted:', 'inicio=', inicioFormatado, 'fim=', fimFormatado);
                
                periodoText.textContent = `${inicioFormatado} - ${fimFormatado}`;
            }
        }
        
        function atualizarTituloPeriodo() {
            const dataInicio = document.getElementById('data-inicio').value;
            const dataFim = document.getElementById('data-fim').value;
            const titulo = document.querySelector('.card-header h3');
            
            if (dataInicio && dataFim && titulo) {
                // Usar split para evitar problemas de timezone
                const [anoInicio, mesInicio, diaInicio] = dataInicio.split('-');
                const [anoFim, mesFim, diaFim] = dataFim.split('-');
                
                const inicioFormatado = `${diaInicio}/${mesInicio}/${anoInicio}`;
                const fimFormatado = `${diaFim}/${mesFim}/${anoFim}`;
                
                titulo.textContent = `Mapas de Refei√ß√µes - ${inicioFormatado} a ${fimFormatado}`;
            }
        }

        // Controle do filtro de unidades multi-select
        function initUnidadesFilter() {
            const unidadesDisplay = document.getElementById('unidades-display');
            const unidadesPopup = document.getElementById('unidades-popup');
            const unidadesOverlay = document.getElementById('unidades-overlay');
            const btnAplicar = document.getElementById('btn-aplicar-unidades');
            const btnCancelar = document.getElementById('btn-cancelar-unidades');
            const btnSelecionarTodas = document.getElementById('btn-selecionar-todas');
            const btnLimparTodas = document.getElementById('btn-limpar-todas');

            // Depura√ß√£o: garantir que todos os elementos existem
            if (!unidadesDisplay || !unidadesPopup || !unidadesOverlay || !btnAplicar || !btnCancelar || !btnSelecionarTodas || !btnLimparTodas) {
                console.error('Filtro de unidades: elemento(s) n√£o encontrado(s)!', {
                    unidadesDisplay, unidadesPopup, unidadesOverlay, btnAplicar, btnCancelar, btnSelecionarTodas, btnLimparTodas
                });
                return;
            }

            let unidadesSelecionadasBackup = [];

            // Verificar se h√° unidades pr√©-selecionadas vindas da URL
            const unidadesPreSelecionadas = filtrosAtivos.unidadesSelecionadas;

            // Inicializar checkboxes
            const checkboxes = document.querySelectorAll('.unidade-checkbox');
            if (unidadesPreSelecionadas && unidadesPreSelecionadas.length > 0) {
                // Se veio da URL, selecionar apenas as especificadas
                checkboxes.forEach(checkbox => {
                    checkbox.checked = unidadesPreSelecionadas.includes(checkbox.value);
                });
            } else {
                // Caso contr√°rio, selecionar todas
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                // Definir como null (todas selecionadas = sem filtro)
                filtrosAtivos.unidadesSelecionadas = null;
            }

            atualizarDisplayUnidades();

            // Abrir popup de unidades
            unidadesDisplay.addEventListener('click', function() {
                console.log('DEBUG: Clique no filtro de unidades');
                // Fazer backup das sele√ß√µes atuais
                unidadesSelecionadasBackup = getUnidadesSelecionadas();
                unidadesPopup.style.display = 'block';
                unidadesOverlay.style.display = 'block';
                unidadesDisplay.classList.add('active');
                atualizarCountUnidades();
            });

            // Fechar popup de unidades
            function fecharUnidadesPopup() {
                unidadesPopup.style.display = 'none';
                unidadesOverlay.style.display = 'none';
                unidadesDisplay.classList.remove('active');
            }

            unidadesOverlay.addEventListener('click', function() {
                // Restaurar sele√ß√µes anteriores ao cancelar
                restaurarSelecoes(unidadesSelecionadasBackup);
                fecharUnidadesPopup();
            });

            btnCancelar.addEventListener('click', function() {
                // Restaurar sele√ß√µes anteriores ao cancelar
                restaurarSelecoes(unidadesSelecionadasBackup);
                fecharUnidadesPopup();
            });

            // Aplicar sele√ß√£o de unidades
            btnAplicar.addEventListener('click', function() {
                const unidadesSelecionadas = getUnidadesSelecionadas();
                const totalCheckboxes = document.querySelectorAll('.unidade-checkbox').length;
                // Se todas as unidades est√£o selecionadas, limpar filtro (mostrar todas) -> usar null como sentinel
                if (unidadesSelecionadas.length === totalCheckboxes) {
                    filtrosAtivos.unidadesSelecionadas = null;
                } else {
                    // Pode ser array com 0 elementos (nenhuma selecionada) ou >0 (algumas selecionadas)
                    filtrosAtivos.unidadesSelecionadas = unidadesSelecionadas;
                }
                atualizarDisplayUnidades();
                fecharUnidadesPopup();
                // Aplicar filtros e atualizar tabela
                console.log('Aplicando filtro de unidades:', filtrosAtivos.unidadesSelecionadas);
                console.log('Dados originais:', dadosOriginais.length, 'registros');
                aplicarFiltros();
                console.log('Dados filtrados:', dadosRefeicoes.length, 'registros');
            });

            // Selecionar todas as unidades
            btnSelecionarTodas.addEventListener('click', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                atualizarCountUnidades();
            });

            // Limpar todas as sele√ß√µes
            btnLimparTodas.addEventListener('click', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                atualizarCountUnidades();
            });

            // Atualizar contador quando checkboxes mudarem
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', atualizarCountUnidades);
            });

            // Permitir clicar no item todo para marcar/desmarcar
            document.querySelectorAll('.unidade-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox' && e.target.tagName !== 'LABEL') {
                        const checkbox = this.querySelector('.unidade-checkbox');
                        checkbox.checked = !checkbox.checked;
                        atualizarCountUnidades();
                    }
                });
            });
        }
        
        function getUnidadesSelecionadas() {
            const checkboxes = document.querySelectorAll('.unidade-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function restaurarSelecoes(unidades) {
            const checkboxes = document.querySelectorAll('.unidade-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = unidades.includes(checkbox.value);
            });
            atualizarCountUnidades();
        }
        
        function atualizarCountUnidades() {
            const selecionadas = getUnidadesSelecionadas();
            const countElement = document.getElementById('unidades-selecionadas-count');
            const total = document.querySelectorAll('.unidade-checkbox').length;
            
            if (selecionadas.length === 0) {
                countElement.textContent = 'Nenhuma unidade selecionada';
            } else if (selecionadas.length === total) {
                countElement.textContent = 'Todas as unidades selecionadas';
            } else if (selecionadas.length === 1) {
                countElement.textContent = '1 unidade selecionada';
            } else {
                countElement.textContent = `${selecionadas.length} unidades selecionadas`;
            }
        }
        
        function atualizarDisplayUnidades() {
            const selecionadas = getUnidadesSelecionadas();
            const unidadesText = document.getElementById('unidades-text');
            const total = document.querySelectorAll('.unidade-checkbox').length;
            
            if (selecionadas.length === 0) {
                unidadesText.textContent = 'Nenhuma unidade';
            } else if (selecionadas.length === total) {
                unidadesText.textContent = 'Todas as unidades';
            } else if (selecionadas.length === 1) {
                // Mostrar o nome da unidade selecionada
                const checkbox = document.querySelector(`input[value="${selecionadas[0]}"]`);
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                unidadesText.textContent = label.textContent;
            } else {
                unidadesText.textContent = `${selecionadas.length} unidades`;
            }
        }

        // Placeholder para links n√£o implementados
        document.addEventListener('click', function(e) {
            if (e.target.closest('a[href="#relatorios"]')) {
                e.preventDefault();
                showNotification('warning', 'M√≥dulo em desenvolvimento', 'O m√≥dulo de Relat√≥rios ser√° implementado na pr√≥xima vers√£o do SGMRP.');
            }
            
            if (e.target.closest('a[href="#configuracoes"]')) {
                e.preventDefault();
                showNotification('warning', 'M√≥dulo em desenvolvimento', 'O m√≥dulo de Configura√ß√µes ser√° implementado na pr√≥xima vers√£o do SGMRP.');
            }
        });
    </script>
    <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyAp2Xg1g5MwxuD3m6QlroJVmi6V6SEYeGo",
        authDomain: "sgmrp-sfa-seap.firebaseapp.com",
        projectId: "sgmrp-sfa-seap",
        storageBucket: "sgmrp-sfa-seap.firebasestorage.app",
        messagingSenderId: "890046403125",
        appId: "1:890046403125:web:36c3cb60d4e6960f1a977c",
        measurementId: "G-Z0KXSCHS4Q"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    </script>
</body>
</html>
