<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotes Contratuais - SGMRP</title>
    <meta name="description" content="Listagem completa dos lotes contratuais do sistema penitenci√°rio">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('dashboard') }}" class="logo">SGMRP</a>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <li><a href="{{ url_for('lotes') }}" class="active">Lotes</a></li>
                        <li><a href="{{ url_for('relatorios') }}">Relat√≥rios</a></li>
                        <li><a href="#configuracoes">Configura√ß√µes</a></li>
                        <li><a href="#" id="logoutLink" style="color: #fed7d7;">Sair</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Breadcrumb melhorado -->
            <nav aria-label="Navega√ß√£o" style="margin-bottom: 2.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 0.75rem 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="display: flex; gap: 0.5rem; font-size: 0.95rem; color: var(--gray-500); align-items: center;">
                    <span><a href="{{ url_for('dashboard') }}" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">Dashboard</a></span>
                    <span aria-hidden="true" style="font-size: 1.1em; opacity: 0.7;">/</span>
                    <span aria-current="page" style="color: var(--primary-color); font-weight: 600;">Lotes Contratuais</span>
                </div>
            </nav>

            <!-- Header da P√°gina melhorado -->
            <section style="margin-bottom: 2.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 2rem;">
                    <div>
                        <h1 style="margin-bottom: 0.5rem; color: var(--primary-color); font-size: 2.1rem; font-weight: 700; letter-spacing: -1px;">Lotes Contratuais</h1>
                        <p style="color: var(--gray-600); margin: 0; font-size: 1.05rem;">Gerenciamento completo dos lotes e unidades prisionais</p>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <button class="btn btn-primary" id="novoLote" style="font-size: 1.08rem; padding: 0.7rem 1.3rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(59,130,246,0.08);">‚ûï Novo Lote</button>
                        <button class="btn btn-secondary" id="editarLote" style="font-size: 1.08rem; padding: 0.7rem 1.3rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(108,117,125,0.08);">‚úèÔ∏è Editar Lote</button>
                        <button class="btn btn-danger" id="excluirLote" style="font-size: 1.08rem; padding: 0.7rem 1.3rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(220,53,69,0.08); background-color: #dc3545; color: white;">üóëÔ∏è Excluir Lote</button>
                    </div>
                </div>
            </section>

            <!-- Filtros Avan√ßados -->
            <section class="fade-in" style="margin-bottom: 2rem;">
                <div style="background: white; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.125rem;">üîç</span>
                            <span style="font-weight: 500; color: var(--gray-700); font-size: 0.875rem;">Filtros:</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="filtro-status" style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Status:</label>
                            <select id="filtro-status" class="form-select" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; border-radius: 6px;">
                                <option value="">Todos</option>
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="filtro-empresa" style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Empresa:</label>
                            <select id="filtro-empresa" class="form-select" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; border-radius: 6px;">
                                <option value="">Todas</option>
                                {% for empresa in empresas %}
                                    <option value="{{ empresa|lower }}">{{ empresa }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="filtro-percentual" style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Executado:</label>
                            <select id="filtro-percentual" class="form-select" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; border-radius: 6px;">
                                <option value="">Todos</option>
                                <option value="alta">Alto (&gt;80%)</option>
                                <option value="media">M√©dio (50-80%)</option>
                                <option value="baixa">Baixo (&lt;50%)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Resumo dos Resultados -->
            <section style="margin-bottom: 2rem;">
                <div class="card">
                    <div class="card-body" style="padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <span style="font-size: 0.875rem; color: var(--gray-600);">
                                    Exibindo <strong id="resultados-count">{{ lotes|length }}</strong> de <strong>{{ lotes|length }}</strong> lotes
                                </span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="font-size: 0.875rem; color: var(--gray-600);">Ordenar por:</span>
                                <select id="ordenacao" class="form-select" style="width: auto; min-width: 150px;">
                                    <option value="nome">Nome</option>
                                    <option value="conformidade">Conformidade</option>
                                    <option value="refeicoes">N¬∫ Refei√ß√µes</option>
                                    <option value="atualizacao">√öltima Atualiza√ß√£o</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Lista de Lotes -->
            <section id="lista-lotes">
                {% for lote in lotes %}
                <div class="card fade-in lote-item" data-lote="{{ loop.index }}" data-status="{{ 'ativo' if lote.ativo else 'inativo' }}" data-empresa="{{ lote.empresa|lower }}" data-percentual="{{ lote.percentual_executado }}">
                    <div class="card-body" style="padding: 2rem;">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: start;">
                            <!-- Informa√ß√µes principais -->
                            <div>
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <h3 style="margin: 0; color: var(--primary-color);">Lote {{ loop.index }}</h3>
                                    {% if lote.ativo %}
                                    <div class="badge" style="background-color: var(--success-color); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 500;">
                                        ATIVO
                                    </div>
                                    {% else %}
                                    <div class="badge" style="background-color: var(--danger-color); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 500;">
                                        INATIVO
                                    </div>
                                    {% endif %}
                                    {% set percentual = lote.percentual_executado %}
                                    {% if percentual < 50 %}
                                        {% set cor_fundo = 'var(--success-color)' %}
                                        {% set cor_texto = 'white' %}
                                    {% elif percentual < 80 %}
                                        {% set cor_fundo = 'var(--warning-color)' %}
                                        {% set cor_texto = 'white' %}
                                    {% elif percentual < 100 %}
                                        {% set cor_fundo = '#ff6b35' %}
                                        {% set cor_texto = 'white' %}
                                    {% else %}
                                        {% set cor_fundo = 'var(--danger-color)' %}
                                        {% set cor_texto = 'white' %}
                                    {% endif %}
                                    <div style="background-color: {{ cor_fundo }}; color: {{ cor_texto }}; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 500;">
                                        {{ "%.1f"|format(lote.percentual_executado) }}% Executado
                                    </div>
                                </div>

                                <div style="margin-bottom: 1.5rem;">
                                    <p style="margin: 0; color: var(--gray-600);">
                                        <strong>Empresa Respons√°vel:</strong> {{ lote.empresa }}
                                    </p>
                                    <p style="margin: 0; color: var(--gray-600);">
                                        <strong>Unidades:</strong> {{ lote.unidades|length }} unidades ativas
                                    </p>
                                    <p style="margin: 0; color: var(--gray-600);">
                                        <strong>√öltima Atividade:</strong> {{ lote.ultima_atualizacao }}{% if lote.ultima_atividade %} - <em style="color: var(--primary-color);">{{ lote.ultima_atividade }}</em>{% endif %}
                                    </p>
                                </div>

                                <!-- Estat√≠sticas do Lote (simuladas) -->
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                                    <div style="text-align: center; padding: 1rem; background-color: var(--gray-50); border-radius: var(--border-radius);">
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--primary-color);">
                                            {% set total = lote.refeicoes_por_mes.values()|sum %}
                                            {% set meses = lote.refeicoes_por_mes|length %}
                                            {{ '%.2f'|format(total / meses if meses > 0 else 0) }}
                                        </div>
                                        <div style="font-size: 0.75rem; color: var(--gray-600);">Refei√ß√µes/M√™s</div>
                                    </div>
                                    <div style="text-align: center; padding: 1rem; background-color: var(--gray-50); border-radius: var(--border-radius);">
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--success-color);">R$ {{ "{:,.2f}".format(lote.custo_mes).replace(',', 'X').replace('.', ',').replace('X', '.') }}</div>
                                        <div style="font-size: 0.75rem; color: var(--gray-600);">Custo/M√™s</div>
                                    </div>
                                    <div style="text-align: center; padding: 1rem; background-color: var(--gray-50); border-radius: var(--border-radius);">
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--warning-color);">R$ {{ "{:,.2f}".format(lote.desvio_mes).replace(',', 'X').replace('.', ',').replace('X', '.') }}</div>
                                        <div style="font-size: 0.75rem; color: var(--gray-600);">Desvio/M√™s</div>
                                    </div>
                                    <div style="text-align: center; padding: 1rem; background-color: var(--gray-50); border-radius: var(--border-radius);">
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--primary-color);">{{ lote.meses_cadastrados }}</div>
                                        <div style="font-size: 0.75rem; color: var(--gray-600);">Meses Cadastrados</div>
                                    </div>
                                </div>
                            </div>

                            <!-- A√ß√µes -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; align-items: start; min-width: 320px;">
                                    <a href="{{ url_for('lote_detalhes', lote_id=lote.id) }}" class="btn btn-primary btn-sm">
                                    üîç Ver Detalhes
                                </a>
                                <button class="btn btn-success btn-sm" onclick="adicionarUnidade({{ lote.id }})">
                                    ‚ûï Adicionar Unidade
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="ExportarDados({{ lote.id }})">
                                                üì§ Exportar Dados
                                          </button>
                                          <button class="btn btn-secondary btn-sm" onclick="editarUnidade({{ lote.id }})">
                                              ‚úèÔ∏è Editar Unidade
                                          </button>
                                          <button class="btn btn-secondary btn-sm" onclick="alert('Funcionalidade de relat√≥rio para Lote {{ loop.index }} ser√° implementada em vers√µes futuras.')">
                                              üìä Relat√≥rio
                                          </button>
                                          <button class="btn btn-danger btn-sm" onclick="excluirUnidade({{ lote.id }})">
                                              üóëÔ∏è Excluir Unidade
                                          </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </section>
        </div>
    </main>

    <footer>
        <div class="container text-center">
            <p style="margin: 0; color: var(--gray-400); font-size: 0.875rem;">
                ¬© 2025 SGMRP - Sistema de Gerenciamento de Mapas de Refei√ß√µes Penitenci√°rio
            </p>
        </div>
    </footer>

    <!-- Modal Novo Lote -->

    <div id="modal-novo-lote" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 1100px; width: 98%; box-shadow: 0 8px 32px rgba(0,0,0,0.18);">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">Novo Lote Contratual</h2>
            <form id="form-novo-lote" autocomplete="off">
                <div style="display: flex; flex-direction: row; gap: 2rem; margin-bottom: 2rem; flex-wrap: wrap;">
                    <!-- Coluna 1: dados principais -->
                    <div style="flex: 1 1 260px; min-width: 220px; display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label for="novo-lote-nome" class="form-label" style="font-weight: 500;">Nome do Lote</label>
                            <input type="text" id="novo-lote-nome" name="nome_lote" class="form-input" placeholder="Digite o nome do lote" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="novo-lote-empresa" class="form-label" style="font-weight: 500;">Nome da Empresa</label>
                            <input type="text" id="novo-lote-empresa" name="nome_empresa" class="form-input" placeholder="Digite o nome da empresa" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="novo-lote-contrato" class="form-label" style="font-weight: 500;">N√∫mero do Contrato</label>
                            <input type="text" id="novo-lote-contrato" name="numero_contrato" class="form-input" placeholder="Digite o n√∫mero do contrato" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="novo-lote-inicio" class="form-label" style="font-weight: 500;">Data de In√≠cio do Contrato</label>
                            <input type="date" id="novo-lote-inicio" name="data_inicio" class="form-input" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="novo-lote-fim" class="form-label" style="font-weight: 500;">Data de Fim do Contrato</label>
                            <input type="date" id="novo-lote-fim" name="data_fim" class="form-input" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="novo-lote-valor-contratual" class="form-label" style="font-weight: 500;">Valor Contratual (R$)</label>
                            <input type="text" id="novo-lote-valor-contratual" name="valor_contratual" class="form-input" placeholder="R$ 0,00" readonly style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300); background-color: #f5f5f5; cursor: not-allowed;">
                            <small style="color: var(--gray-500); font-size: 0.85em;">Calculado automaticamente: Pre√ßos √ó Quantidades</small>
                        </div>
                        <div>
                            <label for="novo-lote-predecessor" class="form-label" style="font-weight: 500;">üîó Lote Predecessor (Hist√≥rico)</label>
                            <select id="novo-lote-predecessor" name="lote_predecessor_id" class="form-input" style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                                <option value="">Nenhum (novo contrato)</option>
                            </select>
                            <small style="color: var(--gray-500); font-size: 0.85em;">Selecione se este lote substitui outro (reajuste de pre√ßos)</small>
                        </div>
                    </div>
                    <!-- Coluna 2: pre√ßos -->
                    <div style="flex: 1 1 320px; min-width: 220px; display: flex; flex-direction: column; gap: 1rem;">
                        <label class="form-label" style="font-weight: 500;">Pre√ßos das Refei√ß√µes (R$)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label for="preco-cafe-interno" style="font-size: 0.95em;">Caf√© Interno</label>
                                <input type="number" step="0.01" min="0" id="preco-cafe-interno" name="preco_cafe_interno" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="preco-cafe-funcionario" style="font-size: 0.95em;">Caf√© Funcion√°rio</label>
                                <input type="number" step="0.01" min="0" id="preco-cafe-funcionario" name="preco_cafe_funcionario" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="preco-almoco-interno" style="font-size: 0.95em;">Almo√ßo Interno</label>
                                <input type="number" step="0.01" min="0" id="preco-almoco-interno" name="preco_almoco_interno" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="preco-almoco-funcionario" style="font-size: 0.95em;">Almo√ßo Funcion√°rio</label>
                                <input type="number" step="0.01" min="0" id="preco-almoco-funcionario" name="preco_almoco_funcionario" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="preco-lanche-interno" style="font-size: 0.95em;">Lanche Interno</label>
                                <input type="number" step="0.01" min="0" id="preco-lanche-interno" name="preco_lanche_interno" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="preco-lanche-funcionario" style="font-size: 0.95em;">Lanche Funcion√°rio</label>
                                <input type="number" step="0.01" min="0" id="preco-lanche-funcionario" name="preco_lanche_funcionario" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="preco-jantar-interno" style="font-size: 0.95em;">Jantar Interno</label>
                                <input type="number" step="0.01" min="0" id="preco-jantar-interno" name="preco_jantar_interno" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="preco-jantar-funcionario" style="font-size: 0.95em;">Jantar Funcion√°rio</label>
                                <input type="number" step="0.01" min="0" id="preco-jantar-funcionario" name="preco_jantar_funcionario" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                        </div>
                    </div>
                    <!-- Coluna 3: quantitativos -->
                    <div style="flex: 1 1 320px; min-width: 220px; display: flex; flex-direction: column; gap: 1rem;">
                        <label class="form-label" style="font-weight: 500;">Quantitativo de Refei√ß√µes</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label for="qtd-cafe-interno" style="font-size: 0.95em;">Caf√© Interno</label>
                                <input type="number" step="1" min="0" id="qtd-cafe-interno" name="qtd_cafe_interno" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="qtd-cafe-funcionario" style="font-size: 0.95em;">Caf√© Funcion√°rio</label>
                                <input type="number" step="1" min="0" id="qtd-cafe-funcionario" name="qtd_cafe_funcionario" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="qtd-almoco-interno" style="font-size: 0.95em;">Almo√ßo Interno</label>
                                <input type="number" step="1" min="0" id="qtd-almoco-interno" name="qtd_almoco_interno" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="qtd-almoco-funcionario" style="font-size: 0.95em;">Almo√ßo Funcion√°rio</label>
                                <input type="number" step="1" min="0" id="qtd-almoco-funcionario" name="qtd_almoco_funcionario" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="qtd-lanche-interno" style="font-size: 0.95em;">Lanche Interno</label>
                                <input type="number" step="1" min="0" id="qtd-lanche-interno" name="qtd_lanche_interno" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="qtd-lanche-funcionario" style="font-size: 0.95em;">Lanche Funcion√°rio</label>
                                <input type="number" step="1" min="0" id="qtd-lanche-funcionario" name="qtd_lanche_funcionario" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="qtd-jantar-interno" style="font-size: 0.95em;">Jantar Interno</label>
                                <input type="number" step="1" min="0" id="qtd-jantar-interno" name="qtd_jantar_interno" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="qtd-jantar-funcionario" style="font-size: 0.95em;">Jantar Funcion√°rio</label>
                                <input type="number" step="1" min="0" id="qtd-jantar-funcionario" name="qtd_jantar_funcionario" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button type="button" id="btn-cancelar-novo-lote" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" id="btn-adicionar-novo-lote" class="btn btn-primary">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Lote -->
    <div id="modal-editar-lote" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 1100px; width: 98%; box-shadow: 0 8px 32px rgba(0,0,0,0.18);">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">Editar Lote Contratual</h2>
            <form id="form-editar-lote" autocomplete="off">
                <div style="display: flex; flex-direction: row; gap: 2rem; margin-bottom: 2rem; flex-wrap: wrap;">
                    <!-- Coluna 1: dados principais -->
                    <div style="flex: 1 1 260px; min-width: 220px; display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label for="editar-lote-selecao" class="form-label" style="font-weight: 500;">Selecione o Lote</label>
                            <select id="editar-lote-selecao" class="form-select" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                                <option value="">-- Selecione um lote --</option>
                                {% for lote in lotes %}
                                <option value="{{ lote.id }}">{{ lote.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="editar-lote-nome" class="form-label" style="font-weight: 500;">Nome do Lote</label>
                            <input type="text" id="editar-lote-nome" name="nome_lote" class="form-input" placeholder="Digite o nome do lote" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="editar-lote-empresa" class="form-label" style="font-weight: 500;">Nome da Empresa</label>
                            <input type="text" id="editar-lote-empresa" name="nome_empresa" class="form-input" placeholder="Digite o nome da empresa" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="editar-lote-contrato" class="form-label" style="font-weight: 500;">N√∫mero do Contrato</label>
                            <input type="text" id="editar-lote-contrato" name="numero_contrato" class="form-input" placeholder="Digite o n√∫mero do contrato" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="editar-lote-inicio" class="form-label" style="font-weight: 500;">Data de In√≠cio do Contrato</label>
                            <input type="date" id="editar-lote-inicio" name="data_inicio" class="form-input" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="editar-lote-fim" class="form-label" style="font-weight: 500;">Data de Fim do Contrato</label>
                            <input type="date" id="editar-lote-fim" name="data_fim" class="form-input" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="editar-lote-valor-contratual" class="form-label" style="font-weight: 500;">Valor Contratual (R$)</label>
                            <input type="text" id="editar-lote-valor-contratual" name="valor_contratual" class="form-input" placeholder="R$ 0,00" readonly style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300); background-color: #f5f5f5; cursor: not-allowed;">
                            <small style="color: var(--gray-500); font-size: 0.85em;">Calculado automaticamente: Pre√ßos √ó Quantidades</small>
                        </div>
                        <div>
                            <label class="form-label" style="font-weight: 500;">Status</label>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" id="editar-lote-ativo-sim" name="ativo" value="true" checked style="cursor: pointer;">
                                    <span>Ativo</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" id="editar-lote-ativo-nao" name="ativo" value="false" style="cursor: pointer;">
                                    <span>Inativo</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- Coluna 2: pre√ßos -->
                    <div style="flex: 1 1 320px; min-width: 220px; display: flex; flex-direction: column; gap: 1rem;">
                        <label class="form-label" style="font-weight: 500;">Pre√ßos das Refei√ß√µes (R$)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label for="editar-preco-cafe-interno" style="font-size: 0.95em;">Caf√© Interno</label>
                                <input type="number" step="0.01" min="0" id="editar-preco-cafe-interno" name="preco_cafe_interno" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-preco-cafe-funcionario" style="font-size: 0.95em;">Caf√© Funcion√°rio</label>
                                <input type="number" step="0.01" min="0" id="editar-preco-cafe-funcionario" name="preco_cafe_funcionario" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-preco-almoco-interno" style="font-size: 0.95em;">Almo√ßo Interno</label>
                                <input type="number" step="0.01" min="0" id="editar-preco-almoco-interno" name="preco_almoco_interno" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-preco-almoco-funcionario" style="font-size: 0.95em;">Almo√ßo Funcion√°rio</label>
                                <input type="number" step="0.01" min="0" id="editar-preco-almoco-funcionario" name="preco_almoco_funcionario" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-preco-lanche-interno" style="font-size: 0.95em;">Lanche Interno</label>
                                <input type="number" step="0.01" min="0" id="editar-preco-lanche-interno" name="preco_lanche_interno" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-preco-lanche-funcionario" style="font-size: 0.95em;">Lanche Funcion√°rio</label>
                                <input type="number" step="0.01" min="0" id="editar-preco-lanche-funcionario" name="preco_lanche_funcionario" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-preco-jantar-interno" style="font-size: 0.95em;">Jantar Interno</label>
                                <input type="number" step="0.01" min="0" id="editar-preco-jantar-interno" name="preco_jantar_interno" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-preco-jantar-funcionario" style="font-size: 0.95em;">Jantar Funcion√°rio</label>
                                <input type="number" step="0.01" min="0" id="editar-preco-jantar-funcionario" name="preco_jantar_funcionario" class="form-input" placeholder="0,00" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <label for="editar-lote-predecessor" style="font-size: 0.9em; font-weight: 500;">üîó Lote Predecessor</label>
                            <select id="editar-lote-predecessor" name="lote_predecessor_id" class="form-input" style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300); font-size: 0.9em;">
                                <option value="">Nenhum</option>
                            </select>
                            <small style="color: var(--gray-500); font-size: 0.8em; display: block; margin-top: 0.2rem;">Para reajustes de pre√ßos</small>
                        </div>
                    </div>
                    <!-- Coluna 3: quantitativos -->
                    <div style="flex: 1 1 320px; min-width: 220px; display: flex; flex-direction: column; gap: 1rem;">
                        <label class="form-label" style="font-weight: 500;">Quantitativo de Refei√ß√µes</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <div>
                                <label for="editar-qtd-cafe-interno" style="font-size: 0.95em;">Caf√© Interno</label>
                                <input type="number" step="1" min="0" id="editar-qtd-cafe-interno" name="qtd_cafe_interno" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-qtd-cafe-funcionario" style="font-size: 0.95em;">Caf√© Funcion√°rio</label>
                                <input type="number" step="1" min="0" id="editar-qtd-cafe-funcionario" name="qtd_cafe_funcionario" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-qtd-almoco-interno" style="font-size: 0.95em;">Almo√ßo Interno</label>
                                <input type="number" step="1" min="0" id="editar-qtd-almoco-interno" name="qtd_almoco_interno" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-qtd-almoco-funcionario" style="font-size: 0.95em;">Almo√ßo Funcion√°rio</label>
                                <input type="number" step="1" min="0" id="editar-qtd-almoco-funcionario" name="qtd_almoco_funcionario" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-qtd-lanche-interno" style="font-size: 0.95em;">Lanche Interno</label>
                                <input type="number" step="1" min="0" id="editar-qtd-lanche-interno" name="qtd_lanche_interno" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-qtd-lanche-funcionario" style="font-size: 0.95em;">Lanche Funcion√°rio</label>
                                <input type="number" step="1" min="0" id="editar-qtd-lanche-funcionario" name="qtd_lanche_funcionario" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-qtd-jantar-interno" style="font-size: 0.95em;">Jantar Interno</label>
                                <input type="number" step="1" min="0" id="editar-qtd-jantar-interno" name="qtd_jantar_interno" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                            <div>
                                <label for="editar-qtd-jantar-funcionario" style="font-size: 0.95em;">Jantar Funcion√°rio</label>
                                <input type="number" step="1" min="0" id="editar-qtd-jantar-funcionario" name="qtd_jantar_funcionario" class="form-input" placeholder="0" required style="width: 100%; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button type="button" id="btn-cancelar-editar-lote" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" id="btn-salvar-editar-lote" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Selecionar Lote para Excluir -->
    <div id="modal-excluir-lote" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 98%; box-shadow: 0 8px 32px rgba(0,0,0,0.18);">
            <h2 style="margin-bottom: 1.5rem; color: var(--danger-color);">Excluir Lote</h2>
            <form id="form-excluir-lote" autocomplete="off">
                <div style="margin-bottom: 1.5rem;">
                    <label for="excluir-lote-selecao" class="form-label" style="font-weight: 500;">Selecione o Lote para excluir</label>
                    <select id="excluir-lote-selecao" class="form-select" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        <option value="">Selecione...</option>
                        {% for lote in lotes %}
                            <option value="{{ lote.id }}" data-nome="{{ lote.nome }}">Lote {{ lote.id }} - {{ lote.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button type="button" id="btn-cancelar-excluir-lote" class="btn btn-secondary">Cancelar</button>
                    <button type="button" id="btn-prosseguir-excluir-lote" class="btn btn-danger">Prosseguir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o de Lote -->
    <div id="modal-confirmacao-exclusao-lote" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 2001;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: #dc2626; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">üóëÔ∏è</div>
                <h3 style="margin-bottom: 1rem; color: #dc2626;">Confirmar Exclus√£o do Lote</h3>
                <p id="mensagem-confirmacao-lote" style="margin: 0; color: var(--gray-700); line-height: 1.5; font-size: 1rem;"></p>
            </div>
            
            <div style="padding: 1rem; background-color: #fef2f2; border-radius: 8px; border-left: 4px solid #dc2626; margin-bottom: 2rem;">
                <p style="font-size: 0.875rem; margin: 0; color: #991b1b;">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta a√ß√£o excluir√° permanentemente o lote e todos os dados de refei√ß√µes associados. Esta opera√ß√£o n√£o pode ser desfeita.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="btn-cancelar-confirmacao-lote" style="min-width: 120px;">Cancelar</button>
                <button class="btn btn-danger" id="btn-confirmar-confirmacao-lote" style="min-width: 120px;">Excluir Lote</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Logout -->
    <div id="modal-confirmacao-logout" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 2002;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">üëã</div>
                <h3 style="margin-bottom: 1rem; color: #f59e0b;">Sair do Sistema</h3>
                <p style="margin: 0; color: var(--gray-700); line-height: 1.5; font-size: 1rem;">
                    Tem certeza que deseja sair do sistema?
                </p>
            </div>
            
            <div style="padding: 1rem; background-color: #fffbeb; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 2rem;">
                <p style="font-size: 0.875rem; margin: 0; color: #92400e;">
                    <strong>‚ÑπÔ∏è Informa√ß√£o:</strong> Voc√™ precisar√° fazer login novamente para acessar o sistema.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="btn-cancelar-logout" style="min-width: 120px;">Cancelar</button>
                <button class="btn" id="btn-confirmar-logout" style="min-width: 120px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;">Sair</button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Unidade -->
    <div id="modal-adicionar-unidade" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 700px; width: 95%; box-shadow: 0 8px 32px rgba(0,0,0,0.18); max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 1.5rem; color: var(--success-color);">‚ûï Adicionar Nova Unidade</h2>
            <form id="form-adicionar-unidade" autocomplete="off">
                <input type="hidden" id="add-unidade-lote-id" name="lote_id">
                
                <!-- Nome da Unidade -->
                <div style="margin-bottom: 1.5rem;">
                    <label for="add-unidade-nome" class="form-label" style="font-weight: 500;">Nome da Unidade</label>
                    <input type="text" id="add-unidade-nome" name="nome" class="form-input" placeholder="Ex: UPR S√£o Lu√≠s 1" required style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--gray-300); font-size: 1rem;">
                </div>

                <!-- Unidade Principal (opcional para subunidades) -->
                <div style="margin-bottom: 1.5rem;">
                    <label for="add-unidade-principal" class="form-label" style="font-weight: 500;">üîó Unidade Principal (opcional)</label>
                    <select id="add-unidade-principal" name="unidade_principal_id" class="form-select" style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--gray-300); font-size: 1rem;">
                        <option value="">Unidade Independente</option>
                    </select>
                    <small style="color: var(--gray-500); font-size: 0.85em;">‚ö†Ô∏è Se esta unidade for subunidade de outra, selecione a unidade principal. Os quantitativos ser√£o herdados.</small>
                </div>

                <!-- Quantitativos de Refei√ß√µes -->
                <div style="margin-bottom: 1.5rem;">
                    <label class="form-label" style="font-weight: 500; display: block; margin-bottom: 1rem;">Quantitativo de Refei√ß√µes (Anual)</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                        <div>
                            <label for="add-qtd-cafe-interno" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Caf√© Interno</label>
                            <input type="number" id="add-qtd-cafe-interno" name="qtd_cafe_interno" class="form-input qtd-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="add-qtd-cafe-funcionario" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Caf√© Funcion√°rio</label>
                            <input type="number" id="add-qtd-cafe-funcionario" name="qtd_cafe_funcionario" class="form-input qtd-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="add-qtd-almoco-interno" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Almo√ßo Interno</label>
                            <input type="number" id="add-qtd-almoco-interno" name="qtd_almoco_interno" class="form-input qtd-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="add-qtd-almoco-funcionario" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Almo√ßo Funcion√°rio</label>
                            <input type="number" id="add-qtd-almoco-funcionario" name="qtd_almoco_funcionario" class="form-input qtd-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="add-qtd-lanche-interno" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Lanche Interno</label>
                            <input type="number" id="add-qtd-lanche-interno" name="qtd_lanche_interno" class="form-input qtd-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="add-qtd-lanche-funcionario" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Lanche Funcion√°rio</label>
                            <input type="number" id="add-qtd-lanche-funcionario" name="qtd_lanche_funcionario" class="form-input qtd-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="add-qtd-jantar-interno" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Jantar Interno</label>
                            <input type="number" id="add-qtd-jantar-interno" name="qtd_jantar_interno" class="form-input qtd-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="add-qtd-jantar-funcionario" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Jantar Funcion√°rio</label>
                            <input type="number" id="add-qtd-jantar-funcionario" name="qtd_jantar_funcionario" class="form-input qtd-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                    </div>
                </div>

                <!-- Valor Contratual (calculado automaticamente) -->
                <div style="margin-bottom: 1.5rem;">
                    <label for="add-unidade-valor" class="form-label" style="font-weight: 500;">Valor Contratual da Unidade (R$)</label>
                    <input type="text" id="add-unidade-valor" name="valor_contratual" class="form-input" placeholder="R$ 0,00" readonly style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--gray-300); background-color: #f5f5f5; cursor: not-allowed; font-size: 1rem; font-weight: 600; color: var(--success-color);">
                    <small style="color: var(--gray-500); font-size: 0.85em;">Calculado automaticamente: Pre√ßos do Lote √ó Quantidades</small>
                </div>

                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button type="button" id="btn-cancelar-add-unidade" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" id="btn-salvar-add-unidade" class="btn btn-success">Adicionar Unidade</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Unidade -->
    <div id="modal-editar-unidade" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 700px; width: 95%; box-shadow: 0 8px 32px rgba(0,0,0,0.18); max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">‚úèÔ∏è Editar Unidade</h2>
            <form id="form-editar-unidade" autocomplete="off">
                <input type="hidden" id="edit-unidade-lote-id" name="lote_id">
                <input type="hidden" id="edit-unidade-id" name="unidade_id">
                
                <!-- Sele√ß√£o da Unidade -->
                <div style="margin-bottom: 1.5rem;">
                    <label for="edit-unidade-selecao" class="form-label" style="font-weight: 500;">Selecione a Unidade</label>
                    <select id="edit-unidade-selecao" name="unidade_selecao" class="form-select" required style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--gray-300); font-size: 1rem;">
                        <option value="">Selecione uma unidade...</option>
                    </select>
                </div>

                <!-- Nome da Unidade -->
                <div style="margin-bottom: 1.5rem;">
                    <label for="edit-unidade-nome" class="form-label" style="font-weight: 500;">Nome da Unidade</label>
                    <input type="text" id="edit-unidade-nome" name="nome" class="form-input" placeholder="Ex: UPR S√£o Lu√≠s 1" required style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--gray-300); font-size: 1rem;">
                </div>

                <!-- Unidade Principal (opcional para subunidades) -->
                <div style="margin-bottom: 1.5rem;">
                    <label for="edit-unidade-principal" class="form-label" style="font-weight: 500;">üîó Unidade Principal (opcional)</label>
                    <select id="edit-unidade-principal" name="unidade_principal_id" class="form-select" style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--gray-300); font-size: 1rem;">
                        <option value="">Unidade Independente</option>
                    </select>
                    <small style="color: var(--gray-500); font-size: 0.85em;">‚ö†Ô∏è Se esta unidade for subunidade de outra, selecione a unidade principal. Os quantitativos ser√£o herdados.</small>
                </div>

                <!-- Quantitativos de Refei√ß√µes -->
                <div style="margin-bottom: 1.5rem;">
                    <label class="form-label" style="font-weight: 500; display: block; margin-bottom: 1rem;">Quantitativo de Refei√ß√µes (Anual)</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                        <div>
                            <label for="edit-qtd-cafe-interno" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Caf√© Interno</label>
                            <input type="number" id="edit-qtd-cafe-interno" name="qtd_cafe_interno" class="form-input qtd-edit-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="edit-qtd-cafe-funcionario" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Caf√© Funcion√°rio</label>
                            <input type="number" id="edit-qtd-cafe-funcionario" name="qtd_cafe_funcionario" class="form-input qtd-edit-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="edit-qtd-almoco-interno" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Almo√ßo Interno</label>
                            <input type="number" id="edit-qtd-almoco-interno" name="qtd_almoco_interno" class="form-input qtd-edit-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="edit-qtd-almoco-funcionario" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Almo√ßo Funcion√°rio</label>
                            <input type="number" id="edit-qtd-almoco-funcionario" name="qtd_almoco_funcionario" class="form-input qtd-edit-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="edit-qtd-lanche-interno" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Lanche Interno</label>
                            <input type="number" id="edit-qtd-lanche-interno" name="qtd_lanche_interno" class="form-input qtd-edit-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="edit-qtd-lanche-funcionario" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Lanche Funcion√°rio</label>
                            <input type="number" id="edit-qtd-lanche-funcionario" name="qtd_lanche_funcionario" class="form-input qtd-edit-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="edit-qtd-jantar-interno" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Jantar Interno</label>
                            <input type="number" id="edit-qtd-jantar-interno" name="qtd_jantar_interno" class="form-input qtd-edit-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                        <div>
                            <label for="edit-qtd-jantar-funcionario" style="font-size: 0.875rem; color: var(--gray-600); display: block; margin-bottom: 0.25rem;">Jantar Funcion√°rio</label>
                            <input type="number" id="edit-qtd-jantar-funcionario" name="qtd_jantar_funcionario" class="form-input qtd-edit-unidade-input" placeholder="0" min="0" step="1" required style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--gray-300);">
                        </div>
                    </div>
                </div>

                <!-- Valor Contratual (calculado automaticamente) -->
                <div style="margin-bottom: 1.5rem;">
                    <label for="edit-unidade-valor" class="form-label" style="font-weight: 500;">Valor Contratual da Unidade (R$)</label>
                    <input type="text" id="edit-unidade-valor" name="valor_contratual" class="form-input" placeholder="R$ 0,00" readonly style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--gray-300); background-color: #f5f5f5; cursor: not-allowed; font-size: 1rem; font-weight: 600; color: var(--primary-color);">
                    <small style="color: var(--gray-500); font-size: 0.85em;">Calculado automaticamente: Pre√ßos do Lote √ó Quantidades</small>
                </div>

                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button type="button" id="btn-cancelar-edit-unidade" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" id="btn-salvar-edit-unidade" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Selecionar Unidade para Excluir -->
    <div id="modal-excluir-unidade" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 95%; box-shadow: 0 8px 32px rgba(0,0,0,0.18);">
            <h2 style="margin-bottom: 1.5rem; color: var(--danger-color);">Excluir Unidade</h2>
            <form id="form-excluir-unidade" autocomplete="off">
                <input type="hidden" id="del-unidade-lote-id" name="lote_id">
                
                <!-- Sele√ß√£o da Unidade -->
                <div style="margin-bottom: 1.5rem;">
                    <label for="del-unidade-selecao" class="form-label" style="font-weight: 500;">Selecione a Unidade para excluir</label>
                    <select id="del-unidade-selecao" name="unidade_selecao" class="form-select" required style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--gray-300); font-size: 1rem;">
                        <option value="">Selecione...</option>
                    </select>
                </div>

                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button type="button" id="btn-cancelar-del-unidade" class="btn btn-secondary">Cancelar</button>
                    <button type="button" id="btn-prosseguir-del-unidade" class="btn btn-danger">Prosseguir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o de Unidade -->
    <div id="modal-confirmacao-exclusao-unidade" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 2001;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: #dc2626; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">üóëÔ∏è</div>
                <h3 style="margin-bottom: 1rem; color: #dc2626;">Confirmar Exclus√£o da Unidade</h3>
                <p id="mensagem-confirmacao-unidade" style="margin: 0; color: var(--gray-700); line-height: 1.5; font-size: 1rem;"></p>
            </div>
            
            <div style="padding: 1rem; background-color: #fef2f2; border-radius: 8px; border-left: 4px solid #dc2626; margin-bottom: 2rem;">
                <p style="font-size: 0.875rem; margin: 0; color: #991b1b;">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta a√ß√£o excluir√° permanentemente a unidade e remover√° sua associa√ß√£o com o lote. Esta opera√ß√£o n√£o pode ser desfeita.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="btn-cancelar-confirmacao-unidade" style="min-width: 120px;">Cancelar</button>
                <button class="btn btn-danger" id="btn-confirmar-confirmacao-unidade" style="min-width: 120px;">Excluir Unidade</button>
            </div>
        </div>
    </div>

    <script>
        const lotesData = JSON.parse(`{{ lotes|tojson|safe }}`);

        // Fun√ß√µes de unidades removidas - gerenciamento agora √© separado do CRUD de lotes
        // function adicionarCampoUnidade() { ... }
        // function adicionarCampoUnidadeEditar() { ... }

        // Fun√ß√£o para calcular valor contratual no modal de cria√ß√£o
        function calcularValorContratualCriacao() {
            const refeicoes = ['cafe', 'almoco', 'lanche', 'jantar'];
            const tipos = ['interno', 'funcionario'];
            let total = 0;
            
            refeicoes.forEach(refeicao => {
                tipos.forEach(tipo => {
                    const preco = parseFloat(document.getElementById(`preco-${refeicao}-${tipo}`)?.value) || 0;
                    const qtd = parseInt(document.getElementById(`qtd-${refeicao}-${tipo}`)?.value) || 0;
                    total += preco * qtd;
                });
            });
            
            document.getElementById('novo-lote-valor-contratual').value = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // Fun√ß√£o para calcular valor contratual no modal de edi√ß√£o
        function calcularValorContratualEdicao() {
            const refeicoes = ['cafe', 'almoco', 'lanche', 'jantar'];
            const tipos = ['interno', 'funcionario'];
            let total = 0;
            
            refeicoes.forEach(refeicao => {
                tipos.forEach(tipo => {
                    const preco = parseFloat(document.getElementById(`editar-preco-${refeicao}-${tipo}`)?.value) || 0;
                    const qtd = parseInt(document.getElementById(`editar-qtd-${refeicao}-${tipo}`)?.value) || 0;
                    total += preco * qtd;
                });
            });
            
            document.getElementById('editar-lote-valor-contratual').value = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // Carregar dados do lote selecionado
        function carregarDadosLote(loteId) {
            const lote = lotesData.find(l => l.id === parseInt(loteId));
            if (!lote) {
                alert('Lote n√£o encontrado');
                return;
            }
            
            // Debug: verificar quantitativos
            console.log('Lote carregado:', lote);
            console.log('Quantitativos do lote:', lote.quantitativos);

            // Preencher campos b√°sicos
            document.getElementById('editar-lote-nome').value = lote.nome || '';
            document.getElementById('editar-lote-empresa').value = lote.empresa || '';
            document.getElementById('editar-lote-contrato').value = lote.numero_contrato || lote.contrato || '';
            document.getElementById('editar-lote-inicio').value = lote.data_inicio || lote.inicio_contrato || '';
            // Formatar data_fim para YYYY-MM-DD se necess√°rio
            let dataFim = lote.data_fim || lote.fim_contrato || '';
            if (dataFim && dataFim.length > 0) {
                // Tenta converter formatos comuns para YYYY-MM-DD
                const match = dataFim.match(/(\d{4})[-/](\d{2})[-/](\d{2})/);
                if (match) {
                    dataFim = `${match[1]}-${match[2]}-${match[3]}`;
                } else {
                    // Tenta converter DD/MM/YYYY para YYYY-MM-DD
                    const matchBr = dataFim.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                    if (matchBr) {
                        dataFim = `${matchBr[3]}-${matchBr[2]}-${matchBr[1]}`;
                    }
                }
            }
            document.getElementById('editar-lote-fim').value = dataFim;
            document.getElementById('editar-lote-valor-contratual').value = lote.valor_contratual || 0;
            
            // Status
            if (lote.ativo) {
                document.getElementById('editar-lote-ativo-sim').checked = true;
            } else {
                document.getElementById('editar-lote-ativo-nao').checked = true;
            }

            // Unidades n√£o s√£o mais editadas via modal de lote - gerenciamento separado

            // Preencher pre√ßos
            const precos = lote.precos || {};
            
            // Fun√ß√£o auxiliar para extrair valor
            const getPreco = (refeicao, tipo) => {
                if (typeof precos[refeicao] === 'object') {
                    return precos[refeicao][tipo] || 0;
                }
                const key = `${refeicao}_${tipo}`;
                return precos[key] || 0;
            };

            document.getElementById('editar-preco-cafe-interno').value = getPreco('cafe', 'interno');
            document.getElementById('editar-preco-cafe-funcionario').value = getPreco('cafe', 'funcionario');
            document.getElementById('editar-preco-almoco-interno').value = getPreco('almoco', 'interno');
            document.getElementById('editar-preco-almoco-funcionario').value = getPreco('almoco', 'funcionario');
            document.getElementById('editar-preco-lanche-interno').value = getPreco('lanche', 'interno');
            document.getElementById('editar-preco-lanche-funcionario').value = getPreco('lanche', 'funcionario');
            document.getElementById('editar-preco-jantar-interno').value = getPreco('jantar', 'interno');
            document.getElementById('editar-preco-jantar-funcionario').value = getPreco('jantar', 'funcionario');

            // Preencher quantitativos
            const quantitativos = lote.quantitativos || {};
            
            // Verificar se os quantitativos est√£o vazios (lote antigo)
            const quantitativosVazios = Object.keys(quantitativos).length === 0;
            
            // Fun√ß√£o auxiliar para extrair quantitativo
            const getQuantitativo = (refeicao, tipo) => {
                if (typeof quantitativos[refeicao] === 'object') {
                    return quantitativos[refeicao][tipo] || 0;
                }
                const key = `${refeicao}_${tipo}`;
                return quantitativos[key] || 0;
            };

            document.getElementById('editar-qtd-cafe-interno').value = getQuantitativo('cafe', 'interno');
            document.getElementById('editar-qtd-cafe-funcionario').value = getQuantitativo('cafe', 'funcionario');
            document.getElementById('editar-qtd-almoco-interno').value = getQuantitativo('almoco', 'interno');
            document.getElementById('editar-qtd-almoco-funcionario').value = getQuantitativo('almoco', 'funcionario');
            document.getElementById('editar-qtd-lanche-interno').value = getQuantitativo('lanche', 'interno');
            document.getElementById('editar-qtd-lanche-funcionario').value = getQuantitativo('lanche', 'funcionario');
            document.getElementById('editar-qtd-jantar-interno').value = getQuantitativo('jantar', 'interno');
            document.getElementById('editar-qtd-jantar-funcionario').value = getQuantitativo('jantar', 'funcionario');

            // Calcular valor contratual ap√≥s carregar todos os dados
            calcularValorContratualEdicao();
            
            // Carregar predecessores e definir valor selecionado
            carregarLotesPredecessores('editar-lote-predecessor', lote.id);
            
            // Definir predecessor selecionado
            if (lote.lote_predecessor_id) {
                setTimeout(() => {
                    document.getElementById('editar-lote-predecessor').value = lote.lote_predecessor_id;
                }, 100); // Aguardar o carregamento da lista
            }
            
            // Mostrar aviso se os quantitativos estiverem vazios
            if (quantitativosVazios) {
                showNotification('warning', 'Quantitativos n√£o preenchidos', 
                    'Este lote foi criado antes da funcionalidade de quantitativos. Por favor, preencha os valores de quantidade de refei√ß√µes.',
                    false);
            }
        }
        
        // Fun√ß√£o para carregar a lista de lotes predecessores (inativos)
        function carregarLotesPredecessores(selectId, excludeLoteId = null) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Limpar op√ß√µes existentes
            select.innerHTML = '<option value="">Nenhum (novo lote)</option>';
            
            try {
                // Filtrar apenas lotes inativos e excluir o lote atual (se fornecido)
                const lotesInativos = lotesData.filter(lote => 
                    !lote.ativo && lote.id !== excludeLoteId
                );
                
                // Ordenar por nome
                lotesInativos.sort((a, b) => a.nome.localeCompare(b.nome));
                
                // Adicionar op√ß√µes
                lotesInativos.forEach(lote => {
                    const option = document.createElement('option');
                    option.value = lote.id;
                    option.textContent = `${lote.nome} (Inativo)`;
                    select.appendChild(option);
                });
                
                console.log(`Carregados ${lotesInativos.length} lotes inativos para sele√ß√£o de predecessor`);
            } catch (error) {
                console.error('Erro ao carregar lotes predecessores:', error);
                showNotification('error', 'Erro', 'N√£o foi poss√≠vel carregar a lista de lotes predecessores.');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Campos de unidades removidos - gerenciamento separado
            
            // Observa√ß√£o: a verifica√ß√£o via localStorage foi removida para
            // evitar redirecionamentos indesejados quando a sess√£o Flask
            // j√° est√° ativa. A autentica√ß√£o deve ser verificada no servidor.

            // Logout - Modal customizado
            var logoutBtn = document.getElementById('logoutLink');
            var modalLogout = document.getElementById('modal-confirmacao-logout');
            var btnCancelarLogout = document.getElementById('btn-cancelar-logout');
            var btnConfirmarLogout = document.getElementById('btn-confirmar-logout');
            
            if (logoutBtn && modalLogout) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    modalLogout.style.display = 'block';
                });
            }
            
            if (btnCancelarLogout && modalLogout) {
                btnCancelarLogout.addEventListener('click', function() {
                    modalLogout.style.display = 'none';
                });
            }
            
            if (btnConfirmarLogout) {
                btnConfirmarLogout.addEventListener('click', function() {
                    localStorage.removeItem('sgmrp_usuario');
                    localStorage.removeItem('sgmrp_remember');
                    window.location.href = "{{ url_for('logout') }}";
                });
            }
            
            // Fechar modal ao clicar fora
            if (modalLogout) {
                modalLogout.addEventListener('click', function(e) {
                    if (e.target === modalLogout) {
                        modalLogout.style.display = 'none';
                    }
                });
            }

            // Busca em tempo real
            var buscaInput = document.getElementById('filtro-busca-lote');
            if (buscaInput) {
                buscaInput.addEventListener('input', function() {
                    applyFilters();
                });
            }

            // Ordena√ß√£o
            var ordenacaoSelect = document.getElementById('ordenacao');
            if (ordenacaoSelect) {
                ordenacaoSelect.addEventListener('change', function() {
                    sortLotes(this.value);
                });
            }

            // Aplicar filtros automaticamente ao mudar qualquer select
            var filtroStatus = document.getElementById('filtro-status');
            var filtroEmpresa = document.getElementById('filtro-empresa');
            var filtroPercentual = document.getElementById('filtro-percentual');
            
            if (filtroStatus) {
                filtroStatus.addEventListener('change', applyFilters);
            }
            if (filtroEmpresa) {
                filtroEmpresa.addEventListener('change', applyFilters);
            }
            if (filtroPercentual) {
                filtroPercentual.addEventListener('change', applyFilters);
            }

            // Modal Adicionar Unidade
            var modalAdicionarUnidade = document.getElementById('modal-adicionar-unidade');
            var btnCancelarAddUnidade = document.getElementById('btn-cancelar-add-unidade');
            var formAdicionarUnidade = document.getElementById('form-adicionar-unidade');
            
            if (btnCancelarAddUnidade && modalAdicionarUnidade) {
                btnCancelarAddUnidade.addEventListener('click', function() {
                    modalAdicionarUnidade.style.display = 'none';
                });
            }
            
            if (modalAdicionarUnidade) {
                modalAdicionarUnidade.addEventListener('click', function(e) {
                    if (e.target === modalAdicionarUnidade) {
                        modalAdicionarUnidade.style.display = 'none';
                    }
                });
            }
            
            if (formAdicionarUnidade) {
                formAdicionarUnidade.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const loteId = document.getElementById('add-unidade-lote-id').value;
                    const nome = document.getElementById('add-unidade-nome').value.trim();
                    
                    // Capturar unidade_principal_id (pode ser vazio)
                    const unidadePrincipalSelect = document.getElementById('add-unidade-principal');
                    const unidade_principal_id = unidadePrincipalSelect.value ? parseInt(unidadePrincipalSelect.value) : null;
                    
                    if (!nome) {
                        showNotification('warning', 'Aten√ß√£o', 'Digite o nome da unidade.');
                        return;
                    }
                    
                    // Coletar quantitativos
                    const quantitativos = {
                        cafe: {
                            interno: parseInt(document.getElementById('add-qtd-cafe-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('add-qtd-cafe-funcionario').value) || 0
                        },
                        almoco: {
                            interno: parseInt(document.getElementById('add-qtd-almoco-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('add-qtd-almoco-funcionario').value) || 0
                        },
                        lanche: {
                            interno: parseInt(document.getElementById('add-qtd-lanche-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('add-qtd-lanche-funcionario').value) || 0
                        },
                        jantar: {
                            interno: parseInt(document.getElementById('add-qtd-jantar-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('add-qtd-jantar-funcionario').value) || 0
                        }
                    };
                    
                    // Calcular valor_contratual_unidade
                    const lote = lotesData.find(l => l.id === parseInt(loteId));
                    if (!lote || !lote.precos) {
                        showNotification('error', 'Erro', 'N√£o foi poss√≠vel obter os pre√ßos do lote.');
                        return;
                    }
                    
                    const precos = lote.precos;
                    let valor_contratual_unidade = 0;
                    
                    for (const refeicao in quantitativos) {
                        for (const tipo in quantitativos[refeicao]) {
                            const qtd = quantitativos[refeicao][tipo];
                            let preco = 0;
                            
                            if (typeof precos[refeicao] === 'object') {
                                preco = parseFloat(precos[refeicao][tipo]) || 0;
                            } else {
                                const key = `${refeicao}_${tipo}`;
                                preco = parseFloat(precos[key]) || 0;
                            }
                            
                            valor_contratual_unidade += preco * qtd;
                        }
                    }
                    
                    // Enviar para backend
                    try {
                        const resp = await fetch('/api/adicionar-unidade', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                lote_id: parseInt(loteId),
                                nome: nome,
                                quantitativos_unidade: JSON.stringify(quantitativos),
                                valor_contratual_unidade: valor_contratual_unidade,
                                unidade_principal_id: unidade_principal_id
                            }),
                            credentials: 'same-origin'
                        });
                        
                        const data = await resp.json();
                        
                        if (resp.ok && data.success) {
                            showNotification('success', 'Sucesso!', `Unidade "${nome}" adicionada com sucesso!`);
                            modalAdicionarUnidade.style.display = 'none';
                            setTimeout(() => window.location.reload(), 1500);
                        } else {
                            showNotification('error', 'Erro', data.message || 'N√£o foi poss√≠vel adicionar a unidade.');
                        }
                    } catch (err) {
                        showNotification('error', 'Erro de conex√£o', 'N√£o foi poss√≠vel conectar ao servidor.');
                    }
                });
            }
            
            // Modal Editar Unidade
            var modalEditarUnidade = document.getElementById('modal-editar-unidade');
            var btnCancelarEditUnidade = document.getElementById('btn-cancelar-edit-unidade');
            var selectEditUnidade = document.getElementById('edit-unidade-selecao');
            var formEditarUnidade = document.getElementById('form-editar-unidade');
            
            if (btnCancelarEditUnidade && modalEditarUnidade) {
                btnCancelarEditUnidade.addEventListener('click', function() {
                    modalEditarUnidade.style.display = 'none';
                });
            }
            
            if (modalEditarUnidade) {
                modalEditarUnidade.addEventListener('click', function(e) {
                    if (e.target === modalEditarUnidade) {
                        modalEditarUnidade.style.display = 'none';
                    }
                });
            }
            
            // Event listener para carregar dados quando selecionar unidade
            if (selectEditUnidade) {
                selectEditUnidade.addEventListener('change', carregarDadosUnidade);
            }
            
            // Event listeners para recalcular valor ao mudar quantitativos
            const qtdEditInputs = document.querySelectorAll('.qtd-edit-unidade-input');
            qtdEditInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const loteId = document.getElementById('edit-unidade-lote-id').value;
                    if (loteId) {
                        calcularValorEditUnidade(loteId);
                    }
                });
            });
            
            // Submit do formul√°rio de editar unidade
            if (formEditarUnidade) {
                formEditarUnidade.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const unidadeId = document.getElementById('edit-unidade-id').value;
                    const loteId = document.getElementById('edit-unidade-lote-id').value;
                    const nome = document.getElementById('edit-unidade-nome').value.trim();
                    
                    // Capturar unidade_principal_id (pode ser vazio)
                    const unidadePrincipalSelect = document.getElementById('edit-unidade-principal');
                    const unidade_principal_id = unidadePrincipalSelect.value ? parseInt(unidadePrincipalSelect.value) : null;
                    
                    if (!unidadeId) {
                        showNotification('warning', 'Aten√ß√£o', 'Selecione uma unidade.');
                        return;
                    }
                    
                    if (!nome) {
                        showNotification('warning', 'Aten√ß√£o', 'Digite o nome da unidade.');
                        return;
                    }
                    
                    // Coletar quantitativos
                    const quantitativos = {
                        cafe: {
                            interno: parseInt(document.getElementById('edit-qtd-cafe-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('edit-qtd-cafe-funcionario').value) || 0
                        },
                        almoco: {
                            interno: parseInt(document.getElementById('edit-qtd-almoco-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('edit-qtd-almoco-funcionario').value) || 0
                        },
                        lanche: {
                            interno: parseInt(document.getElementById('edit-qtd-lanche-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('edit-qtd-lanche-funcionario').value) || 0
                        },
                        jantar: {
                            interno: parseInt(document.getElementById('edit-qtd-jantar-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('edit-qtd-jantar-funcionario').value) || 0
                        }
                    };
                    
                    // Calcular valor_contratual_unidade
                    const lote = lotesData.find(l => l.id === parseInt(loteId));
                    if (!lote || !lote.precos) {
                        showNotification('error', 'Erro', 'N√£o foi poss√≠vel obter os pre√ßos do lote.');
                        return;
                    }
                    
                    const precos = lote.precos;
                    let valor_contratual_unidade = 0;
                    
                    for (const refeicao in quantitativos) {
                        for (const tipo in quantitativos[refeicao]) {
                            const qtd = quantitativos[refeicao][tipo];
                            let preco = 0;
                            
                            if (typeof precos[refeicao] === 'object') {
                                preco = parseFloat(precos[refeicao][tipo]) || 0;
                            } else {
                                const key = `${refeicao}_${tipo}`;
                                preco = parseFloat(precos[key]) || 0;
                            }
                            
                            valor_contratual_unidade += preco * qtd;
                        }
                    }
                    
                    // Enviar para backend
                    try {
                        const resp = await fetch(`/api/editar-unidade/${unidadeId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                nome: nome,
                                quantitativos_unidade: JSON.stringify(quantitativos),
                                valor_contratual_unidade: valor_contratual_unidade,
                                unidade_principal_id: unidade_principal_id
                            }),
                            credentials: 'same-origin'
                        });
                        
                        const data = await resp.json();
                        
                        if (resp.ok && data.success) {
                            showNotification('success', 'Sucesso!', `Unidade "${nome}" atualizada com sucesso!`);
                            modalEditarUnidade.style.display = 'none';
                            setTimeout(() => window.location.reload(), 1500);
                        } else {
                            showNotification('error', 'Erro', data.message || 'N√£o foi poss√≠vel atualizar a unidade.');
                        }
                    } catch (err) {
                        showNotification('error', 'Erro de conex√£o', 'N√£o foi poss√≠vel conectar ao servidor.');
                    }
                });
            }
            
            // Modal Excluir Unidade
            var modalExcluirUnidade = document.getElementById('modal-excluir-unidade');
            var btnCancelarDelUnidade = document.getElementById('btn-cancelar-del-unidade');
            var btnProsseguirDelUnidade = document.getElementById('btn-prosseguir-del-unidade');
            var modalConfirmacaoUnidade = document.getElementById('modal-confirmacao-exclusao-unidade');
            var btnCancelarConfirmacaoUnidade = document.getElementById('btn-cancelar-confirmacao-unidade');
            var btnConfirmarConfirmacaoUnidade = document.getElementById('btn-confirmar-confirmacao-unidade');
            var unidadeIdParaExcluir = null;
            
            if (btnCancelarDelUnidade && modalExcluirUnidade) {
                btnCancelarDelUnidade.addEventListener('click', function() {
                    modalExcluirUnidade.style.display = 'none';
                });
            }
            
            if (modalExcluirUnidade) {
                modalExcluirUnidade.addEventListener('click', function(e) {
                    if (e.target === modalExcluirUnidade) {
                        modalExcluirUnidade.style.display = 'none';
                    }
                });
            }
            
            // Bot√£o prosseguir - abre modal de confirma√ß√£o
            if (btnProsseguirDelUnidade) {
                btnProsseguirDelUnidade.addEventListener('click', function() {
                    const selectUnidade = document.getElementById('del-unidade-selecao');
                    const unidadeId = selectUnidade.value;
                    
                    if (!unidadeId) {
                        showNotification('warning', 'Aten√ß√£o', 'Selecione uma unidade para excluir.');
                        return;
                    }
                    
                    // Pegar nome da unidade
                    const selectedOption = selectUnidade.options[selectUnidade.selectedIndex];
                    const nomeUnidade = selectedOption.dataset.nome || selectedOption.text;
                    
                    // Guardar ID da unidade
                    unidadeIdParaExcluir = unidadeId;
                    
                    // Atualizar mensagem de confirma√ß√£o
                    document.getElementById('mensagem-confirmacao-unidade').textContent = 
                        `Voc√™ est√° prestes a excluir a unidade "${nomeUnidade}". A unidade ser√° removida permanentemente do sistema.`;
                    
                    // Fechar modal de sele√ß√£o e abrir modal de confirma√ß√£o
                    modalExcluirUnidade.style.display = 'none';
                    modalConfirmacaoUnidade.style.display = 'block';
                });
            }
            
            // Cancelar confirma√ß√£o
            if (btnCancelarConfirmacaoUnidade) {
                btnCancelarConfirmacaoUnidade.addEventListener('click', function() {
                    modalConfirmacaoUnidade.style.display = 'none';
                    unidadeIdParaExcluir = null;
                });
            }
            
            // Confirmar exclus√£o
            if (btnConfirmarConfirmacaoUnidade) {
                btnConfirmarConfirmacaoUnidade.addEventListener('click', async function() {
                    if (!unidadeIdParaExcluir) return;
                    
                    // Desabilitar bot√£o durante a requisi√ß√£o
                    btnConfirmarConfirmacaoUnidade.disabled = true;
                    btnConfirmarConfirmacaoUnidade.textContent = 'Excluindo...';
                    
                    try {
                        const resp = await fetch(`/api/excluir-unidade/${unidadeIdParaExcluir}`, {
                            method: 'DELETE',
                            credentials: 'same-origin'
                        });
                        const data = await resp.json();
                        
                        if (resp.ok && data.success) {
                            showNotification('success', 'Sucesso!', data.message);
                            modalConfirmacaoUnidade.style.display = 'none';
                            setTimeout(() => window.location.reload(), 1200);
                        } else {
                            showNotification('error', 'Erro', data.message || 'N√£o foi poss√≠vel excluir a unidade.');
                            btnConfirmarConfirmacaoUnidade.disabled = false;
                            btnConfirmarConfirmacaoUnidade.textContent = 'Excluir Unidade';
                        }
                    } catch (err) {
                        showNotification('error', 'Erro de conex√£o', 'N√£o foi poss√≠vel conectar ao servidor.');
                        btnConfirmarConfirmacaoUnidade.disabled = false;
                        btnConfirmarConfirmacaoUnidade.textContent = 'Excluir Unidade';
                    }
                });
            }
            
            // Fechar modal ao clicar fora
            if (modalConfirmacaoUnidade) {
                modalConfirmacaoUnidade.addEventListener('click', function(e) {
                    if (e.target === modalConfirmacaoUnidade) {
                        modalConfirmacaoUnidade.style.display = 'none';
                        unidadeIdParaExcluir = null;
                    }
                });
            }

            // Bot√£o Novo Lote - abrir modal
            var novoLoteBtn = document.getElementById('novoLote');
            var modalNovoLote = document.getElementById('modal-novo-lote');
            var btnCancelarNovoLote = document.getElementById('btn-cancelar-novo-lote');
            var btnAdicionarNovoLote = document.getElementById('btn-adicionar-novo-lote');
            if (novoLoteBtn && modalNovoLote) {
                novoLoteBtn.addEventListener('click', function() {
                    modalNovoLote.style.display = 'block';
                    // Calcular valor inicial
                    calcularValorContratualCriacao();
                    // Carregar lotes inativos como op√ß√µes de predecessor
                    carregarLotesPredecessores('novo-lote-predecessor');
                });
            }
            if (btnCancelarNovoLote && modalNovoLote) {
                btnCancelarNovoLote.addEventListener('click', function() {
                    modalNovoLote.style.display = 'none';
                });
            }

            // Adicionar event listeners para recalcular valor no modal de cria√ß√£o
            const refeicoesCriacao = ['cafe', 'almoco', 'lanche', 'jantar'];
            const tiposCriacao = ['interno', 'funcionario'];
            refeicoesCriacao.forEach(refeicao => {
                tiposCriacao.forEach(tipo => {
                    const precoInput = document.getElementById(`preco-${refeicao}-${tipo}`);
                    const qtdInput = document.getElementById(`qtd-${refeicao}-${tipo}`);
                    if (precoInput) precoInput.addEventListener('input', calcularValorContratualCriacao);
                    if (qtdInput) qtdInput.addEventListener('input', calcularValorContratualCriacao);
                });
            });

            // Bot√£o Editar Lote - abrir modal
            var editarLoteBtn = document.getElementById('editarLote');
            var modalEditarLote = document.getElementById('modal-editar-lote');
            var btnCancelarEditarLote = document.getElementById('btn-cancelar-editar-lote');
            var btnSalvarEditarLote = document.getElementById('btn-salvar-editar-lote');
            
            if (editarLoteBtn && modalEditarLote) {
                editarLoteBtn.addEventListener('click', function() {
                    // Limpar sele√ß√£o e campos
                    document.getElementById('editar-lote-selecao').value = '';
                    modalEditarLote.style.display = 'block';
                });
            }
            
            if (btnCancelarEditarLote && modalEditarLote) {
                btnCancelarEditarLote.addEventListener('click', function() {
                    modalEditarLote.style.display = 'none';
                });
            }

            // Seletor de lote - carregar dados quando selecionado
            var seletorLote = document.getElementById('editar-lote-selecao');
            if (seletorLote) {
                seletorLote.addEventListener('change', function() {
                    const loteId = this.value;
                    if (loteId) {
                        carregarDadosLote(loteId);
                    }
                });
            }

            // Adicionar event listeners para recalcular valor no modal de edi√ß√£o
            const refeicoesEdicao = ['cafe', 'almoco', 'lanche', 'jantar'];
            const tiposEdicao = ['interno', 'funcionario'];
            refeicoesEdicao.forEach(refeicao => {
                tiposEdicao.forEach(tipo => {
                    const precoInput = document.getElementById(`editar-preco-${refeicao}-${tipo}`);
                    const qtdInput = document.getElementById(`editar-qtd-${refeicao}-${tipo}`);
                    if (precoInput) precoInput.addEventListener('input', calcularValorContratualEdicao);
                    if (qtdInput) qtdInput.addEventListener('input', calcularValorContratualEdicao);
                });
            });

            // Submit do formul√°rio de edi√ß√£o
            var formEditarLote = document.getElementById('form-editar-lote');
            if (formEditarLote) {
                formEditarLote.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const loteId = document.getElementById('editar-lote-selecao').value;
                    if (!loteId) {
                        alert('Selecione um lote para editar');
                        return;
                    }

                    // Coletar dados do formul√°rio
                    const nome_lote = document.getElementById('editar-lote-nome').value.trim();
                    const nome_empresa = document.getElementById('editar-lote-empresa').value.trim();
                    const numero_contrato = document.getElementById('editar-lote-contrato').value.trim();
                    const data_inicio = document.getElementById('editar-lote-inicio').value;
                    const data_fim = document.getElementById('editar-lote-fim').value;
                    const ativo = document.getElementById('editar-lote-ativo-sim').checked ? 'true' : 'false';
                    
                    // Unidades n√£o s√£o mais editadas via modal de lote
                    const novas_unidades = [];
                    
                    // Coletar pre√ßos
                    const precos = {
                        cafe: {
                            interno: document.getElementById('editar-preco-cafe-interno').value,
                            funcionario: document.getElementById('editar-preco-cafe-funcionario').value
                        },
                        almoco: {
                            interno: document.getElementById('editar-preco-almoco-interno').value,
                            funcionario: document.getElementById('editar-preco-almoco-funcionario').value
                        },
                        lanche: {
                            interno: document.getElementById('editar-preco-lanche-interno').value,
                            funcionario: document.getElementById('editar-preco-lanche-funcionario').value
                        },
                        jantar: {
                            interno: document.getElementById('editar-preco-jantar-interno').value,
                            funcionario: document.getElementById('editar-preco-jantar-funcionario').value
                        }
                    };
                    
                    // Coletar quantitativos
                    const quantitativos = {
                        cafe: {
                            interno: parseInt(document.getElementById('editar-qtd-cafe-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('editar-qtd-cafe-funcionario').value) || 0
                        },
                        almoco: {
                            interno: parseInt(document.getElementById('editar-qtd-almoco-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('editar-qtd-almoco-funcionario').value) || 0
                        },
                        lanche: {
                            interno: parseInt(document.getElementById('editar-qtd-lanche-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('editar-qtd-lanche-funcionario').value) || 0
                        },
                        jantar: {
                            interno: parseInt(document.getElementById('editar-qtd-jantar-interno').value) || 0,
                            funcionario: parseInt(document.getElementById('editar-qtd-jantar-funcionario').value) || 0
                        }
                    };
                    
                    // Calcular valor_contratual
                    let valor_contratual = 0;
                    for (const refeicao in precos) {
                        for (const tipo in precos[refeicao]) {
                            const preco = parseFloat(precos[refeicao][tipo]) || 0;
                            const qtd = quantitativos[refeicao][tipo] || 0;
                            valor_contratual += preco * qtd;
                        }
                    }
                    
                    // Valida√ß√£o b√°sica
                    if (!nome_lote || !nome_empresa || !numero_contrato || !data_inicio || !data_fim) {
                        alert('Preencha todos os campos obrigat√≥rios.');
                        return;
                    }
                    
                    // Capturar lote predecessor
                    const lote_predecessor_id = document.getElementById('editar-lote-predecessor').value || null;
                    
                    // Enviar para backend
                    try {
                        const resp = await fetch(`/api/editar-lote/${loteId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify({ 
                                nome: nome_lote,
                                nome_empresa, 
                                numero_contrato, 
                                data_inicio,
                                data_fim,
                                valor_contratual,
                                ativo,
                                precos,
                                quantitativos,
                                novas_unidades,
                                lote_predecessor_id
                            })
                        });
                        const data = await resp.json();
                        if (resp.ok && data.success) {
                            showNotification('success', 'Lote atualizado!', 'As altera√ß√µes foram salvas com sucesso.');
                            modalEditarLote.style.display = 'none';
                            setTimeout(() => window.location.reload(), 1200);
                        } else {
                            showNotification('error', 'Erro ao editar lote', data.error || 'Erro ao salvar altera√ß√µes.');
                        }
                    } catch (err) {
                        alert('Erro de conex√£o com o servidor.');
                    }
                });
            }

            if (btnAdicionarNovoLote && modalNovoLote) {
                // Substituir o submit padr√£o para n√£o recarregar a p√°gina
                var formNovoLote = document.getElementById('form-novo-lote');
                if (formNovoLote) {
                    formNovoLote.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        // Coletar dados do formul√°rio
                        const nome_lote = document.getElementById('novo-lote-nome').value.trim();
                        const nome_empresa = document.getElementById('novo-lote-empresa').value.trim();
                        const numero_contrato = document.getElementById('novo-lote-contrato').value.trim();
                        const data_inicio = document.getElementById('novo-lote-inicio').value;
                        const data_fim = document.getElementById('novo-lote-fim').value;
                        // Unidades sempre vazio - gerenciamento separado
                        const unidades = [];
                        // Pre√ßos
                        const precos = {
                            cafe: {
                                interno: document.getElementById('preco-cafe-interno').value,
                                funcionario: document.getElementById('preco-cafe-funcionario').value
                            },
                            almoco: {
                                interno: document.getElementById('preco-almoco-interno').value,
                                funcionario: document.getElementById('preco-almoco-funcionario').value
                            },
                            lanche: {
                                interno: document.getElementById('preco-lanche-interno')?.value || '',
                                funcionario: document.getElementById('preco-lanche-funcionario')?.value || ''
                            },
                            jantar: {
                                interno: document.getElementById('preco-jantar-interno')?.value || '',
                                funcionario: document.getElementById('preco-jantar-funcionario')?.value || ''
                            }
                        };
                        // Quantitativos
                        const quantitativos = {
                            cafe: {
                                interno: parseInt(document.getElementById('qtd-cafe-interno').value) || 0,
                                funcionario: parseInt(document.getElementById('qtd-cafe-funcionario').value) || 0
                            },
                            almoco: {
                                interno: parseInt(document.getElementById('qtd-almoco-interno').value) || 0,
                                funcionario: parseInt(document.getElementById('qtd-almoco-funcionario').value) || 0
                            },
                            lanche: {
                                interno: parseInt(document.getElementById('qtd-lanche-interno')?.value) || 0,
                                funcionario: parseInt(document.getElementById('qtd-lanche-funcionario')?.value) || 0
                            },
                            jantar: {
                                interno: parseInt(document.getElementById('qtd-jantar-interno')?.value) || 0,
                                funcionario: parseInt(document.getElementById('qtd-jantar-funcionario')?.value) || 0
                            }
                        };
                        
                        // Calcular valor_contratual
                        let valor_contratual = 0;
                        for (const refeicao in precos) {
                            for (const tipo in precos[refeicao]) {
                                const preco = parseFloat(precos[refeicao][tipo]) || 0;
                                const qtd = quantitativos[refeicao][tipo] || 0;
                                valor_contratual += preco * qtd;
                            }
                        }
                        
                        // Valida√ß√£o: nenhum campo pode estar vazio
                        let erro = '';
                        if (!nome_lote || !nome_empresa || !numero_contrato || !data_inicio || !data_fim) {
                            erro = 'Preencha todos os campos obrigat√≥rios.';
                        } else {
                            for (const grupo in precos) {
                                for (const tipo in precos[grupo]) {
                                    if (!precos[grupo][tipo] || isNaN(Number(precos[grupo][tipo]))) {
                                        erro = 'Preencha todos os campos de pre√ßo corretamente.';
                                        break;
                                    }
                                }
                                if (erro) break;
                            }
                        }
                        if (erro) {
                            alert(erro);
                            return;
                        }
                        // Capturar lote predecessor
                        const lote_predecessor_id = document.getElementById('novo-lote-predecessor').value || null;
                        
                        // Enviar para backend
                        try {
                            const resp = await fetch('/api/novo-lote', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'same-origin',
                                body: JSON.stringify({ nome_lote, nome_empresa, numero_contrato, data_inicio, data_fim, valor_contratual, precos, quantitativos, unidades, lote_predecessor_id })
                            });
                            const data = await resp.json();
                            if (resp.ok && data.success) {
                                showNotification('success', 'Lote cadastrado!', 'O novo lote foi adicionado com sucesso.');
                                modalNovoLote.style.display = 'none';
                                setTimeout(() => window.location.reload(), 1200);
                            } else {
                                showNotification('error', 'Erro ao cadastrar lote', data.error || 'Erro ao cadastrar lote.');
                            }
                        } catch (err) {
                            alert('Erro de conex√£o com o servidor.');
                        }
                    });
                }
            }
            // Fechar modal ao clicar fora do conte√∫do
            if (modalNovoLote) {
                modalNovoLote.addEventListener('click', function(e) {
                    if (e.target === modalNovoLote) {
                        modalNovoLote.style.display = 'none';
                    }
                });
            }

            // Fechar modal de edi√ß√£o ao clicar fora
            if (modalEditarLote) {
                modalEditarLote.addEventListener('click', function(e) {
                    if (e.target === modalEditarLote) {
                        modalEditarLote.style.display = 'none';
                    }
                });
            }

            // Modal Excluir Lote
            var excluirLoteBtn = document.getElementById('excluirLote');
            var modalExcluirLote = document.getElementById('modal-excluir-lote');
            var btnCancelarExcluirLote = document.getElementById('btn-cancelar-excluir-lote');
            var btnProsseguirExcluirLote = document.getElementById('btn-prosseguir-excluir-lote');
            var modalConfirmacaoLote = document.getElementById('modal-confirmacao-exclusao-lote');
            var btnCancelarConfirmacaoLote = document.getElementById('btn-cancelar-confirmacao-lote');
            var btnConfirmarConfirmacaoLote = document.getElementById('btn-confirmar-confirmacao-lote');
            var loteIdParaExcluir = null;
            
            if (excluirLoteBtn && modalExcluirLote) {
                excluirLoteBtn.addEventListener('click', function() {
                    document.getElementById('excluir-lote-selecao').value = '';
                    modalExcluirLote.style.display = 'block';
                });
            }
            
            if (btnCancelarExcluirLote && modalExcluirLote) {
                btnCancelarExcluirLote.addEventListener('click', function() {
                    modalExcluirLote.style.display = 'none';
                });
            }
            
            if (modalExcluirLote) {
                modalExcluirLote.addEventListener('click', function(e) {
                    if (e.target === modalExcluirLote) {
                        modalExcluirLote.style.display = 'none';
                    }
                });
            }
            
            // Bot√£o prosseguir - abre modal de confirma√ß√£o
            if (btnProsseguirExcluirLote) {
                btnProsseguirExcluirLote.addEventListener('click', function() {
                    const loteSelect = document.getElementById('excluir-lote-selecao');
                    const loteId = loteSelect.value;
                    
                    if (!loteId) {
                        showNotification('warning', 'Aten√ß√£o', 'Selecione um lote para excluir.');
                        return;
                    }
                    
                    // Pegar nome do lote
                    const selectedOption = loteSelect.options[loteSelect.selectedIndex];
                    const loteNome = selectedOption.getAttribute('data-nome') || selectedOption.text;
                    
                    // Guardar ID do lote
                    loteIdParaExcluir = loteId;
                    
                    // Atualizar mensagem de confirma√ß√£o
                    document.getElementById('mensagem-confirmacao-lote').textContent = 
                        `Voc√™ est√° prestes a excluir o lote "${loteNome}". Todos os dados de refei√ß√µes associados ser√£o permanentemente removidos.`;
                    
                    // Fechar modal de sele√ß√£o e abrir modal de confirma√ß√£o
                    modalExcluirLote.style.display = 'none';
                    modalConfirmacaoLote.style.display = 'block';
                });
            }
            
            // Cancelar confirma√ß√£o
            if (btnCancelarConfirmacaoLote) {
                btnCancelarConfirmacaoLote.addEventListener('click', function() {
                    modalConfirmacaoLote.style.display = 'none';
                    loteIdParaExcluir = null;
                });
            }
            
            // Confirmar exclus√£o
            if (btnConfirmarConfirmacaoLote) {
                btnConfirmarConfirmacaoLote.addEventListener('click', async function() {
                    if (!loteIdParaExcluir) return;
                    
                    // Desabilitar bot√£o durante a requisi√ß√£o
                    btnConfirmarConfirmacaoLote.disabled = true;
                    btnConfirmarConfirmacaoLote.textContent = 'Excluindo...';
                    
                    try {
                        const resp = await fetch(`/api/editar-lote/${loteIdParaExcluir}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin'
                        });
                        const data = await resp.json();
                        
                        if (resp.ok && data.success) {
                            showNotification('success', 'Lote exclu√≠do!', 'O lote foi exclu√≠do com sucesso.');
                            modalConfirmacaoLote.style.display = 'none';
                            setTimeout(() => window.location.reload(), 1200);
                        } else {
                            showNotification('error', 'Erro ao excluir lote', data.error || 'Erro ao excluir lote.');
                            btnConfirmarConfirmacaoLote.disabled = false;
                            btnConfirmarConfirmacaoLote.textContent = 'Excluir Lote';
                        }
                    } catch (err) {
                        showNotification('error', 'Erro de conex√£o', 'N√£o foi poss√≠vel conectar ao servidor.');
                        btnConfirmarConfirmacaoLote.disabled = false;
                        btnConfirmarConfirmacaoLote.textContent = 'Excluir Lote';
                    }
                });
            }
            
            // Fechar modal ao clicar fora
            if (modalConfirmacaoLote) {
                modalConfirmacaoLote.addEventListener('click', function(e) {
                    if (e.target === modalConfirmacaoLote) {
                        modalConfirmacaoLote.style.display = 'none';
                        loteIdParaExcluir = null;
                    }
                });
            }

            // Bot√£o Exportar Dados (se existir)
            var exportarDadosBtn = document.getElementById('exportarDados');
            if (exportarDadosBtn) {
                exportarDadosBtn.addEventListener('click', function() {
                    alert('Funcionalidade de exporta√ß√£o ser√° implementada em vers√µes futuras.\n\nFormatos dispon√≠veis: Excel, PDF, CSV');
                });
            }

            // Anima√ß√µes
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);
            document.querySelectorAll('.fade-in').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(30px)';
                el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(el);
            });

            // Placeholder para links de relat√≥rios e configura√ß√µes
            document.addEventListener('click', function(e) {
                if (e.target.closest('a[href="#relatorios"]')) {
                    e.preventDefault();
                    alert('M√≥dulo de Relat√≥rios ser√° implementado na pr√≥xima vers√£o do SGMRP.');
                }
                if (e.target.closest('a[href="#configuracoes"]')) {
                    e.preventDefault();
                    alert('M√≥dulo de Configura√ß√µes ser√° implementado na pr√≥xima vers√£o do SGMRP.');
                }
            });
        });

        function applyFilters() {
            const busca = document.getElementById('filtro-busca-lote')?.value.toLowerCase() || '';
            const status = document.getElementById('filtro-status')?.value || '';
            const empresa = document.getElementById('filtro-empresa')?.value || '';
            const percentual = document.getElementById('filtro-percentual')?.value || '';

            const lotes = document.querySelectorAll('.lote-item');
            let visibleCount = 0;

            lotes.forEach(lote => {
                let show = true;

                // Filtro de busca
                if (busca) {
                    const text = lote.textContent.toLowerCase();
                    show = show && text.includes(busca);
                }

                // Filtro de status
                if (status) {
                    show = show && lote.dataset.status === status;
                }

                // Filtro de empresa
                if (empresa) {
                    show = show && lote.dataset.empresa === empresa;
                }

                // Filtro de percentual executado
                if (percentual) {
                    const perc = parseFloat(lote.dataset.percentual);
                    switch(percentual) {
                        case 'alta':
                            show = show && perc > 80;
                            break;
                        case 'media':
                            show = show && perc >= 50 && perc <= 80;
                            break;
                        case 'baixa':
                            show = show && perc < 50;
                            break;
                    }
                }

                if (show) {
                    lote.style.display = 'block';
                    visibleCount++;
                } else {
                    lote.style.display = 'none';
                }
            });

            var resultadosCount = document.getElementById('resultados-count');
            if (resultadosCount) {
                resultadosCount.textContent = visibleCount;
            }
        }

        function clearFilters() {
            if (document.getElementById('filtro-busca-lote')) document.getElementById('filtro-busca-lote').value = '';
            if (document.getElementById('filtro-status')) document.getElementById('filtro-status').value = '';
            if (document.getElementById('filtro-empresa')) document.getElementById('filtro-empresa').value = '';
            if (document.getElementById('filtro-percentual')) document.getElementById('filtro-percentual').value = '';
            applyFilters();
        }

        function sortLotes(criteria) {
            const container = document.getElementById('lista-lotes');
            const lotes = Array.from(container.querySelectorAll('.lote-item'));

            lotes.sort((a, b) => {
                switch(criteria) {
                    case 'nome':
                        const nomeA = a.querySelector('h3').textContent;
                        const nomeB = b.querySelector('h3').textContent;
                        return nomeA.localeCompare(nomeB);
                    case 'percentual':
                        const percA = parseFloat(a.dataset.percentual);
                        const percB = parseFloat(b.dataset.percentual);
                        return percB - percA; // Decrescente
                    case 'refeicoes':
                        const refA = parseInt(a.querySelector('[data-refeicoes]')?.dataset.refeicoes || a.textContent.match(/(\d+,\d+)/)?.[1]?.replace(',', '') || '0');
                        const refB = parseInt(b.querySelector('[data-refeicoes]')?.dataset.refeicoes || b.textContent.match(/(\d+,\d+)/)?.[1]?.replace(',', '') || '0');
                        return refB - refA; // Decrescente
                    case 'atualizacao':
                        return Math.random() - 0.5;
                    default:
                        return 0;
                }
            });

            lotes.forEach(lote => container.removeChild(lote));
            lotes.forEach(lote => container.appendChild(lote));
        }

        function ExportarDados(loteId) {
            // Montar nome do arquivo
            const nomeArquivo = `lote_${loteId}_completo.xlsx`;
            
            // Montar URL da exporta√ß√£o sem filtros (exporta tudo)
            const params = new URLSearchParams();
            params.append('lote_id', loteId);
            // N√£o passar data_inicio, data_fim ou unidades = exporta tudo
            
            // Mostrar notifica√ß√£o de processamento
            showNotification('warning', 'Gerando arquivo...', 'Exportando todos os dados do lote. Aguarde...', false);
            
            // Chamar rota Flask para exportar Excel
            fetch(`/exportar-tabela?${params.toString()}`)
                .then(response => {
                    if (!response.ok) throw new Error('Erro ao gerar arquivo');
                    return response.blob();
                })
                .then(blob => {
                    // Criar link para download
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = nomeArquivo;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    
                    // Fechar notifica√ß√£o anterior e mostrar sucesso
                    const existingNotification = document.querySelector('.notification');
                    if (existingNotification) existingNotification.remove();
                    showNotification('success', 'Download conclu√≠do!', `Arquivo ${nomeArquivo} exportado com sucesso.`);
                })
                .catch(() => {
                    // Fechar notifica√ß√£o anterior e mostrar erro
                    const existingNotification = document.querySelector('.notification');
                    if (existingNotification) existingNotification.remove();
                    showNotification('error', 'Erro ao exportar', 'N√£o foi poss√≠vel gerar o arquivo Excel. Tente novamente.');
                });
        }

        function gerarRelatorio(loteId) {
            alert(`Funcionalidade de relat√≥rio para Lote ${loteId} ser√° implementada em vers√µes futuras.`);
        }

        // Sistema de Notifica√ß√µes (igual ao lote-detalhes.html)
function showNotification(type, title, message, autoClose = true) {
    // Remover notifica√ß√£o existente se houver
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    let icon = 'üì¢';
    if (type === 'success') icon = '‚úÖ';
    else if (type === 'warning') icon = '‚ö†Ô∏è';
    else if (type === 'error') icon = '‚ùå';
    notification.innerHTML = `
        <div class="notification-content">
            <div class="notification-icon">${icon}</div>
            <div class="notification-text">
                <strong>${title}</strong>
                ${message ? '<br>' + message : ''}
            </div>
            <button type="button" class="notification-close" onclick="closeNotification(this)">√ó</button>
        </div>
    `;
    document.body.appendChild(notification);
    if (autoClose) {
        const duration = type === 'error' ? 8000 : 5000;
        setTimeout(() => {
            closeNotification(notification.querySelector('.notification-close'));
        }, duration);
    }
}
function closeNotification(button) {
    const notification = button.closest('.notification');
    if (notification) {
        notification.classList.add('closing');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }
}

// Fun√ß√µes para gerenciamento de unidades
async function adicionarUnidade(loteId) {
    // Buscar dados do lote para obter os pre√ßos
    const lote = lotesData.find(l => l.id === parseInt(loteId));
    if (!lote) {
        showNotification('error', 'Erro', 'Lote n√£o encontrado.');
        return;
    }
    
    // Armazenar lote_id no campo hidden
    document.getElementById('add-unidade-lote-id').value = loteId;
    
    // Limpar formul√°rio
    document.getElementById('form-adicionar-unidade').reset();
    document.getElementById('add-unidade-lote-id').value = loteId;
    document.getElementById('add-unidade-valor').value = 'R$ 0,00';
    
    // Carregar unidades independentes para o select de unidade principal
    await carregarUnidadesPrincipaisParaAdicionar(loteId);
    
    // Configurar event listener para mudan√ßa na unidade principal
    const selectPrincipal = document.getElementById('add-unidade-principal');
    selectPrincipal.addEventListener('change', function() {
        toggleQuantitativosAdicionar(this.value);
    });
    
    // Habilitar campos por padr√£o (unidade independente)
    toggleQuantitativosAdicionar('');
    
    // Abrir modal
    document.getElementById('modal-adicionar-unidade').style.display = 'block';
    
    // Configurar event listeners para calcular valor automaticamente
    const qtdInputs = document.querySelectorAll('.qtd-unidade-input');
    qtdInputs.forEach(input => {
        input.addEventListener('input', () => calcularValorUnidade(loteId));
    });
}

// Fun√ß√£o para carregar unidades principais (apenas independentes) no select
async function carregarUnidadesPrincipaisParaAdicionar(loteId) {
    const selectPrincipal = document.getElementById('add-unidade-principal');
    selectPrincipal.innerHTML = '<option value="">Unidade Independente</option>';
    
    try {
        const resp = await fetch(`/api/listar-unidades/${loteId}`);
        const data = await resp.json();
        
        if (resp.ok && data.success && data.unidades) {
            // Filtrar apenas unidades independentes (sem unidade_principal_id)
            const unidadesIndependentes = data.unidades.filter(u => !u.unidade_principal_id);
            
            unidadesIndependentes.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = `${u.nome}`;
                selectPrincipal.appendChild(option);
            });
        }
    } catch (err) {
        console.error('Erro ao carregar unidades principais:', err);
    }
}

// Fun√ß√£o para bloquear/desbloquear campos de quantitativos no modal Adicionar
function toggleQuantitativosAdicionar(unidadePrincipalId) {
    const refeicoes = ['cafe', 'almoco', 'lanche', 'jantar'];
    const tipos = ['interno', 'funcionario'];
    const desabilitar = !!unidadePrincipalId;
    
    refeicoes.forEach(refeicao => {
        tipos.forEach(tipo => {
            const input = document.getElementById(`add-qtd-${refeicao}-${tipo}`);
            if (input) {
                input.disabled = desabilitar;
                input.style.backgroundColor = desabilitar ? '#f0f0f0' : 'white';
                input.style.cursor = desabilitar ? 'not-allowed' : 'text';
                if (desabilitar) {
                    input.value = 0;
                }
            }
        });
    });
    
    // Bloquear tamb√©m o campo de valor
    const inputValor = document.getElementById('add-unidade-valor');
    if (inputValor) {
        inputValor.style.backgroundColor = desabilitar ? '#f0f0f0' : '#f5f5f5';
        if (desabilitar) {
            inputValor.value = 'R$ 0,00';
        }
    }
}

function calcularValorUnidade(loteId) {
    // Buscar pre√ßos do lote
    const lote = lotesData.find(l => l.id === parseInt(loteId));
    if (!lote || !lote.precos) {
        return;
    }
    
    const precos = lote.precos;
    const refeicoes = ['cafe', 'almoco', 'lanche', 'jantar'];
    const tipos = ['interno', 'funcionario'];
    let total = 0;
    
    refeicoes.forEach(refeicao => {
        tipos.forEach(tipo => {
            const qtd = parseInt(document.getElementById(`add-qtd-${refeicao}-${tipo}`)?.value) || 0;
            let preco = 0;
            
            // Extrair pre√ßo do lote
            if (typeof precos[refeicao] === 'object') {
                preco = parseFloat(precos[refeicao][tipo]) || 0;
            } else {
                const key = `${refeicao}_${tipo}`;
                preco = parseFloat(precos[key]) || 0;
            }
            
            total += preco * qtd;
        });
    });
    
    document.getElementById('add-unidade-valor').value = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

async function editarUnidade(loteId) {
    // Buscar dados do lote
    const lote = lotesData.find(l => l.id === parseInt(loteId));
    if (!lote) {
        showNotification('error', 'Erro', 'Lote n√£o encontrado.');
        return;
    }
    
    // Armazenar lote_id
    document.getElementById('edit-unidade-lote-id').value = loteId;
    
    // Limpar formul√°rio
    document.getElementById('form-editar-unidade').reset();
    document.getElementById('edit-unidade-lote-id').value = loteId;
    document.getElementById('edit-unidade-valor').value = 'R$ 0,00';
    
    // Limpar select de unidades
    const selectUnidade = document.getElementById('edit-unidade-selecao');
    selectUnidade.innerHTML = '<option value="">Carregando unidades...</option>';
    
    // Buscar unidades do lote
    try {
        const resp = await fetch(`/api/listar-unidades/${loteId}`);
        const data = await resp.json();
        
        if (resp.ok && data.success && data.unidades && data.unidades.length > 0) {
            // Preencher select com unidades
            selectUnidade.innerHTML = '<option value="">Selecione uma unidade...</option>';
            data.unidades.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = `${u.nome} (ID: ${u.id})`;
                option.dataset.unidade = JSON.stringify(u);
                selectUnidade.appendChild(option);
            });
            
            // Configurar event listener para mudan√ßa na unidade principal
            const selectPrincipal = document.getElementById('edit-unidade-principal');
            selectPrincipal.addEventListener('change', function() {
                toggleQuantitativosEditar(this.value);
            });
            
            // Abrir modal
            document.getElementById('modal-editar-unidade').style.display = 'block';
        } else {
            showNotification('warning', 'Sem unidades', 'Este lote n√£o possui unidades cadastradas.');
        }
    } catch (err) {
        showNotification('error', 'Erro', 'N√£o foi poss√≠vel carregar as unidades.');
    }
}

async function carregarDadosUnidade() {
    const selectUnidade = document.getElementById('edit-unidade-selecao');
    const selectedOption = selectUnidade.options[selectUnidade.selectedIndex];
    
    if (!selectedOption || !selectedOption.value) {
        return;
    }
    
    try {
        const unidade = JSON.parse(selectedOption.dataset.unidade);
        const loteId = document.getElementById('edit-unidade-lote-id').value;
        
        // Armazenar ID da unidade
        document.getElementById('edit-unidade-id').value = unidade.id;
        
        // Preencher nome
        document.getElementById('edit-unidade-nome').value = unidade.nome || '';
        
        // Carregar unidades principais para o select (excluindo a pr√≥pria unidade)
        await carregarUnidadesPrincipaisParaEditar(loteId, unidade.id);
        
        // Preencher unidade principal se existir
        const selectPrincipal = document.getElementById('edit-unidade-principal');
        selectPrincipal.value = unidade.unidade_principal_id || '';
        
        // Preencher quantitativos
        const quantitativos = unidade.quantitativos_unidade || {};
        
        document.getElementById('edit-qtd-cafe-interno').value = quantitativos.cafe?.interno || 0;
        document.getElementById('edit-qtd-cafe-funcionario').value = quantitativos.cafe?.funcionario || 0;
        document.getElementById('edit-qtd-almoco-interno').value = quantitativos.almoco?.interno || 0;
        document.getElementById('edit-qtd-almoco-funcionario').value = quantitativos.almoco?.funcionario || 0;
        document.getElementById('edit-qtd-lanche-interno').value = quantitativos.lanche?.interno || 0;
        document.getElementById('edit-qtd-lanche-funcionario').value = quantitativos.lanche?.funcionario || 0;
        document.getElementById('edit-qtd-jantar-interno').value = quantitativos.jantar?.interno || 0;
        document.getElementById('edit-qtd-jantar-funcionario').value = quantitativos.jantar?.funcionario || 0;
        
        // Aplicar bloqueio/desbloqueio baseado na unidade principal
        toggleQuantitativosEditar(unidade.unidade_principal_id || '');
        
        // Calcular valor
        calcularValorEditUnidade(loteId);
    } catch (err) {
        console.error('Erro ao carregar dados da unidade:', err);
    }
}

// Fun√ß√£o para carregar unidades principais no modal Editar (excluindo a unidade atual)
async function carregarUnidadesPrincipaisParaEditar(loteId, unidadeAtualId) {
    const selectPrincipal = document.getElementById('edit-unidade-principal');
    selectPrincipal.innerHTML = '<option value="">Unidade Independente</option>';
    
    try {
        const resp = await fetch(`/api/listar-unidades/${loteId}`);
        const data = await resp.json();
        
        if (resp.ok && data.success && data.unidades) {
            // Filtrar: apenas independentes (sem unidade_principal_id) e diferente da unidade atual
            const unidadesDisponiveis = data.unidades.filter(u => 
                !u.unidade_principal_id && u.id !== unidadeAtualId
            );
            
            unidadesDisponiveis.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = `${u.nome}`;
                selectPrincipal.appendChild(option);
            });
        }
    } catch (err) {
        console.error('Erro ao carregar unidades principais:', err);
    }
}

// Fun√ß√£o para bloquear/desbloquear campos de quantitativos no modal Editar
function toggleQuantitativosEditar(unidadePrincipalId) {
    const refeicoes = ['cafe', 'almoco', 'lanche', 'jantar'];
    const tipos = ['interno', 'funcionario'];
    const desabilitar = !!unidadePrincipalId;
    
    refeicoes.forEach(refeicao => {
        tipos.forEach(tipo => {
            const input = document.getElementById(`edit-qtd-${refeicao}-${tipo}`);
            if (input) {
                input.disabled = desabilitar;
                input.style.backgroundColor = desabilitar ? '#f0f0f0' : 'white';
                input.style.cursor = desabilitar ? 'not-allowed' : 'text';
                if (desabilitar) {
                    input.value = 0;
                }
            }
        });
    });
    
    // Bloquear tamb√©m o campo de valor
    const inputValor = document.getElementById('edit-unidade-valor');
    if (inputValor) {
        inputValor.style.backgroundColor = desabilitar ? '#f0f0f0' : '#f5f5f5';
        if (desabilitar) {
            inputValor.value = 'R$ 0,00';
        }
    }
}

function calcularValorEditUnidade(loteId) {
    // Buscar pre√ßos do lote
    const lote = lotesData.find(l => l.id === parseInt(loteId));
    if (!lote || !lote.precos) {
        return;
    }
    
    const precos = lote.precos;
    const refeicoes = ['cafe', 'almoco', 'lanche', 'jantar'];
    const tipos = ['interno', 'funcionario'];
    let total = 0;
    
    refeicoes.forEach(refeicao => {
        tipos.forEach(tipo => {
            const qtd = parseInt(document.getElementById(`edit-qtd-${refeicao}-${tipo}`)?.value) || 0;
            let preco = 0;
            
            // Extrair pre√ßo do lote
            if (typeof precos[refeicao] === 'object') {
                preco = parseFloat(precos[refeicao][tipo]) || 0;
            } else {
                const key = `${refeicao}_${tipo}`;
                preco = parseFloat(precos[key]) || 0;
            }
            
            total += preco * qtd;
        });
    });
    
    document.getElementById('edit-unidade-valor').value = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

async function excluirUnidade(loteId) {
    // Buscar dados do lote
    const lote = lotesData.find(l => l.id === parseInt(loteId));
    if (!lote) {
        showNotification('error', 'Erro', 'Lote n√£o encontrado.');
        return;
    }
    
    // Armazenar lote_id
    document.getElementById('del-unidade-lote-id').value = loteId;
    
    // Limpar select de unidades
    const selectUnidade = document.getElementById('del-unidade-selecao');
    selectUnidade.innerHTML = '<option value="">Carregando unidades...</option>';
    
    // Buscar unidades do lote
    try {
        const resp = await fetch(`/api/listar-unidades/${loteId}`);
        const data = await resp.json();
        
        if (resp.ok && data.success && data.unidades && data.unidades.length > 0) {
            // Preencher select com unidades
            selectUnidade.innerHTML = '<option value="">Selecione uma unidade...</option>';
            data.unidades.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.textContent = `${u.nome} (ID: ${u.id})`;
                option.dataset.nome = u.nome;
                selectUnidade.appendChild(option);
            });
            
            // Abrir modal
            document.getElementById('modal-excluir-unidade').style.display = 'block';
        } else {
            showNotification('warning', 'Sem unidades', 'Este lote n√£o possui unidades cadastradas.');
        }
    } catch (err) {
        showNotification('error', 'Erro', 'N√£o foi poss√≠vel carregar as unidades.');
    }
}
    </script>

</body>
</html>