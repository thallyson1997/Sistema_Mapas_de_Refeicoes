<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios - SGMRP</title>
    <meta name="description" content="An√°lise gr√°fica e relat√≥rios de consumo de refei√ß√µes">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        .chart-placeholder {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,.1) 10px,
                rgba(255,255,255,.1) 20px
            );
        }
        
        .chart-content {
            position: relative;
            z-index: 1;
            text-align: center;
            padding: 2rem;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--gray-200);
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }
        
        .metric-subtitle {
            font-size: 0.75rem;
            color: var(--gray-500);
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .btn-projection {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-projection:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            margin: 3rem 0;
            opacity: 0.3;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-600);
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }
        
        .tab-btn:hover {
            color: var(--primary-color);
            background: var(--gray-50);
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .projection-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        /* Notifica√ß√µes customizadas */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            animation: slideInRight 0.4s ease-out;
            max-width: 400px;
        }

        .notification-content {
            background: white;
            color: #1f2937;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            border-left: 4px solid #3b82f6;
        }

        .notification-content.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .notification-content.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .notification-content.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .notification-content.info {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .notification-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        .notification-body {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            color: #111827;
        }

        .notification-message {
            font-size: 0.875rem;
            line-height: 1.5;
            color: #6b7280;
            white-space: pre-line;
        }

        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
            color: #6b7280;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .custom-notification.closing {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        @media (max-width: 480px) {
            .custom-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('dashboard') }}" class="logo">SGMRP</a>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <li><a href="{{ url_for('lotes') }}">Lotes</a></li>
                        <li><a href="{{ url_for('relatorios') }}" class="active">Relat√≥rios</a></li>
                        <li><a href="#configuracoes">Configura√ß√µes</a></li>
                        <li><a href="#" id="logoutLink" style="color: #fed7d7;">Sair</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Breadcrumb -->
            <nav aria-label="Navega√ß√£o" style="margin-bottom: 2.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 0.75rem 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="display: flex; gap: 0.5rem; font-size: 0.95rem; color: var(--gray-500); align-items: center;">
                    <span><a href="{{ url_for('dashboard') }}" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">Dashboard</a></span>
                    <span aria-hidden="true" style="font-size: 1.1em; opacity: 0.7;">/</span>
                    <span aria-current="page" style="color: var(--primary-color); font-weight: 600;">Relat√≥rios</span>
                </div>
            </nav>

            <!-- Header da P√°gina -->
            <section style="margin-bottom: 2.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 2rem;">
                    <div>
                        <h1 style="margin-bottom: 0.5rem; color: var(--primary-color); font-size: 2.1rem; font-weight: 700; letter-spacing: -1px;">
                            üìä Relat√≥rios e An√°lises
                        </h1>
                        <p style="color: var(--gray-600); margin: 0; font-size: 1.05rem;">Visualiza√ß√£o gr√°fica e estat√≠sticas de consumo de refei√ß√µes</p>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <button class="btn btn-secondary" id="btn-exportar-relatorio" style="font-size: 1rem; padding: 0.7rem 1.3rem; border-radius: 8px;">
                            üì• Exportar Relat√≥rio
                        </button>
                    </div>
                </div>
            </section>

            <!-- Filtros Avan√ßados -->
            <section class="fade-in" style="margin-bottom: 2rem; position: relative; z-index: 100;">
                <div style="background: white; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.125rem;">üîç</span>
                            <span style="font-weight: 500; color: var(--gray-700); font-size: 0.875rem;">Filtros:</span>
                        </div>
                        
                        <!-- Filtro Lotes (Multi-Select) -->
                        <div class="lotes-filter-container" style="display: flex; align-items: center; gap: 0.5rem; position: relative;">
                            <label style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Lotes:</label>
                            <div class="lotes-display" id="lotes-display" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; cursor: pointer; border: 1px solid var(--gray-300); border-radius: 6px; background: white; min-width: 180px; display: flex; justify-content: space-between; align-items: center;">
                                <span class="lotes-text" id="lotes-text">Todos os lotes</span>
                                <span class="lotes-icon">üì¶</span>
                            </div>
                            
                            <!-- Overlay para fechar popup de lotes -->
                            <div class="lotes-overlay" id="lotes-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 998;"></div>
                            
                            <!-- Popup de sele√ß√£o de lotes -->
                            <div class="lotes-popup" id="lotes-popup" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border: 1px solid var(--gray-300); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 350px; z-index: 999;">
                                <div class="lotes-header" style="padding: 1rem; border-bottom: 1px solid var(--gray-200);">
                                    <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem;">üì¶ Selecionar Lotes</h4>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--gray-600);">Escolha os lotes para filtrar os dados</p>
                                </div>
                                
                                <div class="lotes-body" style="padding: 1rem;">
                                    <div class="lotes-controls" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button class="control-btn" id="btn-selecionar-todos-lotes" style="flex: 1; padding: 0.5rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚úÖ Todos</button>
                                        <button class="control-btn" id="btn-limpar-todos-lotes" style="flex: 1; padding: 0.5rem; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚ùå Limpar</button>
                                    </div>
                                    
                                    <div class="lotes-list" id="lotes-list" style="max-height: 250px; overflow-y: auto;">
                                        {% for lote in lotes %}
                                        <div class="lote-item" data-value="{{ lote.id }}" style="padding: 0.5rem; display: flex; align-items: center; gap: 0.5rem; border-radius: 4px; transition: background 0.2s;">
                                            <input type="checkbox" class="lote-checkbox" id="checkbox-lote{{ lote.id }}" value="{{ lote.id }}" checked>
                                            <label class="lote-label" for="checkbox-lote{{ lote.id }}" style="cursor: pointer; flex: 1; font-size: 0.875rem;">{{ lote.nome }}{% if lote.empresa %} - {{ lote.empresa }}{% endif %}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <div class="lotes-actions" style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                                        <div class="lotes-info">
                                            <span id="lotes-selecionados-count" style="font-size: 0.875rem; color: var(--gray-600);">{{ lotes|length }} lote{{ 's' if lotes|length != 1 else '' }} selecionado{{ 's' if lotes|length != 1 else '' }}</span>
                                        </div>
                                        <div class="action-buttons" style="display: flex; gap: 0.5rem;">
                                            <button class="btn-calendario" id="btn-cancelar-lotes" style="padding: 0.5rem 1rem; background: var(--gray-200); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚ùå Cancelar</button>
                                            <button class="btn-calendario primary" id="btn-aplicar-lotes" style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚úÖ Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtro Unidades (Multi-Select) -->
                        <div class="unidades-filter-container" style="display: flex; align-items: center; gap: 0.5rem; position: relative;">
                            <label style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Unidades:</label>
                            <div class="unidades-display" id="unidades-display" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; cursor: pointer; border: 1px solid var(--gray-300); border-radius: 6px; background: white; min-width: 180px; display: flex; justify-content: space-between; align-items: center;">
                                <span class="unidades-text" id="unidades-text">Todas as unidades</span>
                                <span class="unidades-icon">üè¢</span>
                            </div>
                            
                            <!-- Overlay para fechar popup de unidades -->
                            <div class="unidades-overlay" id="unidades-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 998;"></div>
                            
                            <!-- Popup de sele√ß√£o de unidades -->
                            <div class="unidades-popup" id="unidades-popup" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border: 1px solid var(--gray-300); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 350px; z-index: 999;">
                                <div class="unidades-header" style="padding: 1rem; border-bottom: 1px solid var(--gray-200);">
                                    <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem;">üè¢ Selecionar Unidades</h4>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--gray-600);">Escolha as unidades para filtrar os dados</p>
                                </div>
                                
                                <div class="unidades-body" style="padding: 1rem;">
                                    <div class="unidades-controls" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button class="control-btn" id="btn-selecionar-todas-unidades" style="flex: 1; padding: 0.5rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚úÖ Todas</button>
                                        <button class="control-btn" id="btn-limpar-todas-unidades" style="flex: 1; padding: 0.5rem; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚ùå Limpar</button>
                                    </div>
                                    
                                    <div class="unidades-list" id="unidades-list" style="max-height: 250px; overflow-y: auto;">
                                        {% for unidade in unidades %}
                                        <div class="unidade-item" data-value="{{ unidade }}" style="padding: 0.5rem; display: flex; align-items: center; gap: 0.5rem; border-radius: 4px; transition: background 0.2s;">
                                            <input type="checkbox" class="unidade-checkbox" id="checkbox-unidade{{ loop.index }}" value="{{ unidade }}" checked>
                                            <label class="unidade-label" for="checkbox-unidade{{ loop.index }}" style="cursor: pointer; flex: 1; font-size: 0.875rem;">{{ unidade }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <div class="unidades-actions" style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                                        <div class="unidades-info">
                                            <span id="unidades-selecionadas-count" style="font-size: 0.875rem; color: var(--gray-600);">{{ unidades|length }} unidade{{ 's' if unidades|length != 1 else '' }} selecionada{{ 's' if unidades|length != 1 else '' }}</span>
                                        </div>
                                        <div class="action-buttons" style="display: flex; gap: 0.5rem;">
                                            <button class="btn-calendario" id="btn-cancelar-unidades" style="padding: 0.5rem 1rem; background: var(--gray-200); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚ùå Cancelar</button>
                                            <button class="btn-calendario primary" id="btn-aplicar-unidades" style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚úÖ Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtro Per√≠odo (Single Select) -->
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="filtro-periodo" style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Per√≠odo:</label>
                            <select id="filtro-periodo" class="form-input" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; border-radius: 6px;">
                                <option value="mes" selected>Mensal</option>
                                <option value="ano">Anual</option>
                            </select>
                        </div>
                        
                        <!-- Filtro Modo de Visualiza√ß√£o -->
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto;">
                            <label style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Visualiza√ß√£o:</label>
                            <div style="display: flex; gap: 0.25rem; background: var(--gray-100); padding: 0.25rem; border-radius: 8px;">
                                <button id="modo-acumulado" class="btn-modo active" data-modo="acumulado" style="padding: 0.5rem 1rem; font-size: 0.875rem; border: none; border-radius: 6px; cursor: pointer; background: var(--primary-color); color: white; font-weight: 500; transition: all 0.3s;">
                                    üìä Total Geral
                                </button>
                                <button id="modo-unidade" class="btn-modo" data-modo="unidade" style="padding: 0.5rem 1rem; font-size: 0.875rem; border: none; border-radius: 6px; cursor: pointer; background: transparent; color: var(--gray-700); font-weight: 500; transition: all 0.3s;">
                                    üè¢ Por Unidade
                                </button>
                                <button id="modo-lote" class="btn-modo" data-modo="lote" style="padding: 0.5rem 1rem; font-size: 0.875rem; border: none; border-radius: 6px; cursor: pointer; background: transparent; color: var(--gray-700); font-weight: 500; transition: all 0.3s;">
                                    üì¶ Por Lote
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Abas de Visualiza√ß√£o -->
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="refeicoes">üìà Evolu√ß√£o de Refei√ß√µes</button>
                <button class="tab-btn" data-tab="gastos">üí∞ Evolu√ß√£o de Gastos</button>
                <button class="tab-btn" data-tab="desvios">‚ö†Ô∏è Desvios e Conformidade</button>
                <button class="tab-btn" data-tab="comparativo">üìä Comparativo</button>
            </div>

            <!-- Conte√∫do Aba: Evolu√ß√£o de Refei√ß√µes -->
            <div class="tab-content active" id="tab-refeicoes">
            <!-- Gr√°fico Principal -->
            <section class="card fade-in" style="margin-bottom: 2rem;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;" id="chart-title">üìà Gr√°fico de Evolu√ß√£o - Refei√ß√µes por Per√≠odo</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span id="projecao-info" style="display: none; font-size: 0.875rem; color: var(--gray-600); margin-right: 1rem;">
                            <span class="projection-badge">PROJE√á√ÉO ATIVA</span>
                            Dados hist√≥ricos + Proje√ß√£o at√© <strong id="data-fim-contrato">Dez/2026</strong>
                        </span>
                        <button class="btn-projection" id="btn-toggle-projecao" title="Ativar proje√ß√£o de 6 meses baseada em dados hist√≥ricos">
                            üîÆ Ativar Proje√ß√£o
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Gr√°fico Real -->
                    <div id="chart-container" style="position: relative;">
                        <canvas id="grafico-principal" style="max-height: 400px;"></canvas>
                        <div id="chart-loading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è≥</div>
                            <div style="color: var(--gray-600);">Carregando dados...</div>
                        </div>
                        <div class="chart-placeholder" id="chart-placeholder" style="display: none;">
                            <div class="chart-content">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
                                <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Gr√°fico de S√©rie Temporal</h3>
                                <p style="color: var(--gray-600); max-width: 500px; margin: 0 auto;">
                                    Selecione os filtros acima para visualizar os dados do gr√°fico.
                                </p>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Legenda do Gr√°fico -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 30px; height: 3px; background: #3b82f6;"></div>
                            <span style="font-size: 0.875rem; color: var(--gray-700);">Dados Reais</span>
                        </div>
                        <div id="legenda-projecao" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 30px; height: 3px; background: #667eea; border-top: 2px dashed #764ba2;"></div>
                                <span style="font-size: 0.875rem; color: var(--gray-700);">üîÆ Proje√ß√£o at√© <strong id="projecao-data-fim-legenda">Dez/2026</strong></span>
                            </div>
                        </div>
                        <div id="legenda-linha-divisoria" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 30px; height: 2px; background: #f59e0b; opacity: 0.6;"></div>
                                <span style="font-size: 0.875rem; color: var(--gray-700);">√öltimo Dado Real</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Divisor -->
            <div class="section-divider"></div>

            <!-- M√©tricas de Proje√ß√£o (aparecem quando proje√ß√£o est√° ativa) -->
            <section id="metricas-projecao" class="card fade-in" style="display: none; margin-bottom: 2rem; border: 2px solid #667eea;">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        üéØ Indicadores da Proje√ß√£o
                        <span class="projection-badge" style="background: rgba(255,255,255,0.2);">IA</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem;">
                        <div class="metric-card" style="border: 2px solid #667eea;">
                            <div class="metric-label">üìÖ Previs√£o de Esgotamento</div>
                            <div class="metric-value" style="color: #667eea;">Mar√ßo/2026</div>
                            <div class="metric-subtitle">Baseado na tend√™ncia atual</div>
                        </div>
                        
                        <div class="metric-card" style="border: 2px solid #10b981;">
                            <div class="metric-label">üìà Tend√™ncia de Crescimento</div>
                            <div class="metric-value" style="color: #10b981;">+3.2%</div>
                            <div class="metric-subtitle">Crescimento mensal m√©dio</div>
                        </div>
                        
                        <div class="metric-card" style="border: 2px solid #f59e0b;">
                            <div class="metric-label">‚ö†Ô∏è N√≠vel de Alerta</div>
                            <div class="metric-value" style="color: #f59e0b;">M√©dio</div>
                            <div class="metric-subtitle">Monitoramento recomendado</div>
                        </div>
                        
                        <div class="metric-card" style="border: 2px solid #8b5cf6;">
                            <div class="metric-label">üí∞ Saldo Projetado</div>
                            <div class="metric-value" style="color: #8b5cf6;">R$ 45.000</div>
                            <div class="metric-subtitle">Em 31/12/2025</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
                        <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                            <strong>üí° Nota:</strong> A proje√ß√£o √© calculada com base nos dados hist√≥ricos e padr√µes de consumo identificados. 
                            Os valores s√£o estimativas e podem variar conforme mudan√ßas no cen√°rio real.
                        </p>
                    </div>
                </div>
            </section>

            <!-- Legenda e Estat√≠sticas -->
            <section style="margin-bottom: 2rem;">
                <h2 style="color: var(--primary-color); font-size: 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    üìã Estat√≠sticas Consolidadas
                    <span style="font-size: 0.875rem; color: var(--gray-500); font-weight: 400;">(Per√≠odo Selecionado)</span>
                </h2>
                
                <!-- Abas de Estat√≠sticas -->
                <div class="tab-buttons">
                    <button class="tab-btn active" data-stat-tab="refeicoes-stats">üçΩÔ∏è Refei√ß√µes</button>
                    <button class="tab-btn" data-stat-tab="gastos-stats">üíµ Gastos</button>
                    <button class="tab-btn" data-stat-tab="desvios-stats">üìâ Desvios</button>
                </div>

                <!-- Estat√≠sticas de Refei√ß√µes -->
                <div id="refeicoes-stats" class="stat-content">
                    <div class="legend-grid">
                        <!-- Caf√© da Manh√£ -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>‚òï</span>
                                <span>Caf√© da Manh√£</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA DI√ÅRIA</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">1.234</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">37.020</div>
                                </div>
                            </div>
                        </div>

                        <!-- Almo√ßo -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>üçΩÔ∏è</span>
                                <span>Almo√ßo</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA DI√ÅRIA</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">1.456</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">43.680</div>
                                </div>
                            </div>
                        </div>

                        <!-- Lanche -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>ü•™</span>
                                <span>Lanche</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA DI√ÅRIA</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">1.198</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">35.940</div>
                                </div>
                            </div>
                        </div>

                        <!-- Jantar -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>üåô</span>
                                <span>Jantar</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA DI√ÅRIA</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">1.387</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">41.610</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estat√≠sticas de Gastos (oculto inicialmente) -->
                <div id="gastos-stats" class="stat-content" style="display: none;">
                    <div class="legend-grid">
                        <!-- Caf√© da Manh√£ -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>‚òï</span>
                                <span>Caf√© da Manh√£</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA MENSAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">R$ 12.340</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">R$ 148.080</div>
                                </div>
                            </div>
                        </div>

                        <!-- Almo√ßo -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>üçΩÔ∏è</span>
                                <span>Almo√ßo</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA MENSAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">R$ 18.720</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">R$ 224.640</div>
                                </div>
                            </div>
                        </div>

                        <!-- Lanche -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>ü•™</span>
                                <span>Lanche</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA MENSAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">R$ 10.782</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">R$ 129.384</div>
                                </div>
                            </div>
                        </div>

                        <!-- Jantar -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>üåô</span>
                                <span>Jantar</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA MENSAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">R$ 16.644</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">R$ 199.728</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estat√≠sticas de Desvios (oculto inicialmente) -->
                <div id="desvios-stats" class="stat-content" style="display: none;">
                    <div class="legend-grid">
                        <!-- Caf√© da Manh√£ -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>‚òï</span>
                                <span>Caf√© da Manh√£</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA MENSAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem; color: #f59e0b;">R$ 234</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem; color: #f59e0b;">R$ 2.808</div>
                                </div>
                            </div>
                        </div>

                        <!-- Almo√ßo -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>üçΩÔ∏è</span>
                                <span>Almo√ßo</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA MENSAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem; color: #f59e0b;">R$ 456</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem; color: #f59e0b;">R$ 5.472</div>
                                </div>
                            </div>
                        </div>

                        <!-- Lanche -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>ü•™</span>
                                <span>Lanche</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA MENSAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem; color: #f59e0b;">R$ 198</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem; color: #f59e0b;">R$ 2.376</div>
                                </div>
                            </div>
                        </div>

                        <!-- Jantar -->
                        <div class="metric-card">
                            <div class="metric-label">
                                <span>üåô</span>
                                <span>Jantar</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div>
                                    <div class="metric-subtitle">M√âDIA MENSAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem; color: #f59e0b;">R$ 387</div>
                                </div>
                                <div>
                                    <div class="metric-subtitle">TOTAL</div>
                                    <div class="metric-value" style="font-size: 1.5rem; color: #f59e0b;">R$ 4.644</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            </div> <!-- Fim tab-refeicoes -->

            <!-- Conte√∫do Aba: An√°lise de Gastos -->
            <div class="tab-content" id="tab-gastos" style="display: none;">
            <!-- Gr√°fico de Gastos -->
            <section class="card fade-in" style="margin-bottom: 2rem;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: var(--primary-color); font-size: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.75rem;">üí∞</span>
                        Evolu√ß√£o de Gastos com Refei√ß√µes
                        <span id="projecao-badge-gastos" style="display: none;" class="projection-badge">üîÆ Com Proje√ß√£o</span>
                    </h2>
                    <button id="btn-toggle-projecao-gastos" class="btn-projection" title="Ativar proje√ß√£o de 6 meses" style="opacity: 1; cursor: pointer;">
                        üîÆ Ativar Proje√ß√£o
                    </button>
                </div>
                <div class="card-body">
                    <div id="container-grafico-gastos" style="position: relative; height: 500px; display: block;">
                        <canvas id="grafico-gastos"></canvas>
                    </div>
                    <div id="placeholder-grafico-gastos" class="chart-placeholder" style="display: none; height: 500px;">
                        <div class="chart-content">
                            <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">üìä</div>
                            <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Nenhum dado encontrado</h3>
                            <p style="color: var(--gray-500); max-width: 500px; margin: 0 auto;">
                                Selecione pelo menos um lote e uma unidade para visualizar os gastos.
                            </p>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; border: 1px dashed var(--gray-300); display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 1.25rem;">‚ÑπÔ∏è</div>
                        <div style="flex: 1;">
                            <strong style="color: var(--gray-700); display: block; margin-bottom: 0.25rem;">Legenda:</strong>
                            <span style="color: var(--gray-600); font-size: 0.875rem;">O gr√°fico exibe os gastos monet√°rios (R$) baseados no n√∫mero de refei√ß√µes fornecidas multiplicado pelos pre√ßos do contrato do lote.</span>
                            <span id="projecao-data-fim-legenda-gastos" style="display: none; margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: white; border-radius: 4px; font-weight: 600; color: #667eea;"></span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- M√©tricas de Proje√ß√£o Gastos -->
            <section id="metricas-projecao-gastos" class="card fade-in" style="display: none; margin-bottom: 2rem; border: 2px solid #667eea;">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h2 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üîÆ</span> M√©tricas de Proje√ß√£o de Gastos
                    </h2>
                </div>
                <div class="card-body">
                    <div class="legend-grid">
                        <div class="metric-card">
                            <div class="metric-label">üí∞ M√©dia Hist√≥rica</div>
                            <div class="metric-value">R$ <span id="media-periodo-gastos">0</span></div>
                            <div class="metric-subtitle">Gasto m√©dio por per√≠odo</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">üìà Tend√™ncia</div>
                            <div class="metric-value" id="tendencia-gastos">-</div>
                            <div class="metric-subtitle">Dire√ß√£o identificada</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">‚è∞ Per√≠odo Projetado</div>
                            <div class="metric-value" id="periodos-projetados-gastos">6</div>
                            <div class="metric-subtitle">meses √† frente</div>
                        </div>
                    </div>
                </div>
            </section>
            </div> <!-- Fim tab-gastos -->

            <!-- Conte√∫do Aba: Desvios e Conformidade -->
            <div class="tab-content" id="tab-desvios" style="display: none;">
                <section class="card fade-in">
                    <div class="card-header">
                        <h3 style="margin: 0;">‚ö†Ô∏è Desvios e Conformidade</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-placeholder">
                            <div class="chart-content">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                                <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Desvios e Conformidade</h3>
                                <p style="color: var(--gray-600); max-width: 500px; margin: 0 auto;">
                                    An√°lise de desvios entre valores planejados e executados em desenvolvimento.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Conte√∫do Aba: Comparativo -->
            <div class="tab-content" id="tab-comparativo" style="display: none;">
                <section class="card fade-in">
                    <div class="card-header">
                        <h3 style="margin: 0;">üìä Comparativo</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-placeholder">
                            <div class="chart-content">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
                                <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">An√°lise Comparativa</h3>
                                <p style="color: var(--gray-600); max-width: 500px; margin: 0 auto;">
                                    Compara√ß√£o entre diferentes unidades, lotes e per√≠odos em desenvolvimento.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

        </div>
    </main>

    <!-- Modal de Confirma√ß√£o de Logout -->
    <div id="modal-confirmacao-logout" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 11000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">üëã</div>
                <h3 style="margin-bottom: 1rem; color: #f59e0b;">Sair do Sistema</h3>
                <p style="margin: 0; color: var(--gray-700); line-height: 1.5; font-size: 1rem;">
                    Tem certeza que deseja sair do sistema?
                </p>
            </div>
            
            <div style="padding: 1rem; background-color: #fffbeb; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 2rem;">
                <p style="font-size: 0.875rem; margin: 0; color: #92400e;">
                    <strong>‚ÑπÔ∏è Informa√ß√£o:</strong> Voc√™ precisar√° fazer login novamente para acessar o sistema.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="btn-cancelar-logout" style="min-width: 120px;">Cancelar</button>
                <button class="btn" id="btn-confirmar-logout" style="min-width: 120px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;">Sair</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p style="margin: 0; color: var(--gray-400); font-size: 0.875rem;">
                ¬© 2025 SGMRP - Sistema de Gerenciamento de Mapas de Refei√ß√µes Penitenci√°rio
            </p>
        </div>
    </footer>

    <script>
        // Mapeamento de lotes para unidades (do backend)
        const lotesUnidadesMap = {{ lotes_unidades|tojson }};
        console.log('Mapeamento lotes -> unidades:', lotesUnidadesMap);
        
        // Vari√°vel global para o gr√°fico
        let chartInstance = null;
        let modoVisualizacao = 'acumulado'; // 'acumulado', 'unidade', 'lote'
        
        // Vari√°veis para gr√°fico de gastos
        let chartInstanceGastos = null;
        let projecaoAtivaGastos = false;
        
        // Fun√ß√£o para mostrar notifica√ß√£o customizada
        function mostrarNotificacao(titulo, mensagem, tipo = 'info', duracao = 5000) {
            // Criar elemento de notifica√ß√£o
            const notification = document.createElement('div');
            notification.className = 'custom-notification';
            
            // √çcones por tipo
            const icones = {
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå',
                'success': '‚úÖ',
                'info': '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div class="notification-content ${tipo}">
                    <div class="notification-icon">${icones[tipo] || icones['info']}</div>
                    <div class="notification-body">
                        <div class="notification-title">${titulo}</div>
                        <div class="notification-message">${mensagem}</div>
                    </div>
                    <button class="notification-close" onclick="this.closest('.custom-notification').remove()">‚úï</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remover ap√≥s dura√ß√£o
            setTimeout(() => {
                notification.classList.add('closing');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, duracao);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Controlar bot√µes de modo de visualiza√ß√£o
            document.querySelectorAll('.btn-modo').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remover active de todos
                    document.querySelectorAll('.btn-modo').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'transparent';
                        b.style.color = 'var(--gray-700)';
                    });
                    
                    // Adicionar active ao clicado
                    this.classList.add('active');
                    this.style.background = 'var(--primary-color)';
                    this.style.color = 'white';
                    
                    // Atualizar modo
                    modoVisualizacao = this.dataset.modo;
                    console.log('üîÑ Modo de visualiza√ß√£o alterado para:', modoVisualizacao);
                    
                    // Atualizar estado do bot√£o de proje√ß√£o
                    atualizarBotaoProjecao();
                    
                    // Se proje√ß√£o estava ativa e mudou para acumulado, desativar
                    if (projecaoAtiva && modoVisualizacao === 'acumulado') {
                        projecaoAtiva = false;
                        const btnProjecao = document.getElementById('btn-toggle-projecao');
                        btnProjecao.textContent = 'üîÆ Ativar Proje√ß√£o';
                        btnProjecao.style.background = '';
                        btnProjecao.style.color = '';
                        document.getElementById('projecao-info').style.display = 'none';
                        document.getElementById('metricas-projecao').style.display = 'none';
                        document.getElementById('legenda-projecao').style.display = 'none';
                        document.getElementById('legenda-linha-divisoria').style.display = 'none';
                    }
                    
                    // Se proje√ß√£o de gastos estava ativa e mudou para acumulado, desativar
                    if (projecaoAtivaGastos && modoVisualizacao === 'acumulado') {
                        projecaoAtivaGastos = false;
                        const btnProjecaoGastos = document.getElementById('btn-toggle-projecao-gastos');
                        if (btnProjecaoGastos) {
                            btnProjecaoGastos.textContent = 'üîÆ Ativar Proje√ß√£o';
                            btnProjecaoGastos.style.background = '';
                        }
                    }
                    
                    // Recarregar gr√°fico da aba ativa
                    const abaAtiva = document.querySelector('.tab-btn.active')?.dataset.tab;
                    if (abaAtiva === 'gastos') {
                        carregarGraficoGastos();
                    } else {
                        carregarGrafico();
                    }
                });
            });
            
            // Fun√ß√£o para atualizar estado do bot√£o de proje√ß√£o
            function atualizarBotaoProjecao() {
                const btnProjecao = document.getElementById('btn-toggle-projecao');
                if (modoVisualizacao === 'acumulado') {
                    btnProjecao.style.opacity = '0.5';
                    btnProjecao.style.cursor = 'not-allowed';
                    btnProjecao.title = 'Proje√ß√£o dispon√≠vel apenas nos modos: Por Unidade ou Por Lote';
                } else {
                    btnProjecao.style.opacity = '1';
                    btnProjecao.style.cursor = 'pointer';
                    btnProjecao.title = 'Ativar proje√ß√£o de 6 meses baseada em dados hist√≥ricos';
                }
                
                // Atualizar tamb√©m o bot√£o de proje√ß√£o de gastos
                const btnProjecaoGastos = document.getElementById('btn-toggle-projecao-gastos');
                if (btnProjecaoGastos) {
                    if (modoVisualizacao === 'acumulado') {
                        btnProjecaoGastos.style.opacity = '0.5';
                        btnProjecaoGastos.style.cursor = 'not-allowed';
                        btnProjecaoGastos.title = 'Proje√ß√£o dispon√≠vel apenas nos modos: Por Unidade ou Por Lote';
                    } else {
                        btnProjecaoGastos.style.opacity = '1';
                        btnProjecaoGastos.style.cursor = 'pointer';
                        btnProjecaoGastos.title = 'Ativar proje√ß√£o de 6 meses baseada em dados hist√≥ricos';
                    }
                }
            }
            

            
            // Controle das abas de gr√°ficos
            const tabButtons = document.querySelectorAll('.tab-btn[data-tab]');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remover active de todos os bot√µes
                    tabButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabName = this.dataset.tab;
                    console.log('üìë Aba selecionada:', tabName);
                    
                    // Ocultar todos os conte√∫dos
                    tabContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Mostrar conte√∫do da aba selecionada
                    const selectedTab = document.getElementById(`tab-${tabName}`);
                    if (selectedTab) {
                        selectedTab.style.display = 'block';
                    }
                    
                    // Carregar dados da aba selecionada
                    if (tabName === 'gastos') {
                        carregarGraficoGastos();
                    }
                });
            });

            // Controle das abas de estat√≠sticas
            const statTabButtons = document.querySelectorAll('.tab-btn[data-stat-tab]');
            statTabButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    statTabButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const statTab = this.dataset.statTab;
                    document.querySelectorAll('.stat-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    document.getElementById(statTab).style.display = 'block';
                });
            });

            // Aplicar filtros automaticamente ao mudar qualquer campo
            function aplicarFiltrosRelatorios() {
                console.log('Aplicando filtros e recarregando gr√°fico...');
                carregarGrafico();
            }
            
            // Garantir que filtros iniciais estejam atualizados antes de carregar o gr√°fico
            setTimeout(() => {
                atualizarCountLotes();
                atualizarDisplayLotes();
                atualizarCountUnidades();
                atualizarDisplayUnidades();
            }, 100);
            
            // Fun√ß√£o para carregar dados do gr√°fico
            async function carregarGrafico() {
                try {
                    // Coletar filtros
                    const lotesSelecionados = Array.from(document.querySelectorAll('.lote-checkbox:checked')).map(cb => cb.value);
                    const unidadesSelecionadas = Array.from(document.querySelectorAll('.unidade-checkbox')).filter(cb => {
                        return cb.checked && cb.closest('.unidade-item').style.display !== 'none';
                    }).map(cb => cb.value);
                    const periodo = document.getElementById('filtro-periodo').value;
                    
                    console.log('üìä Carregando gr√°fico:', { lotesSelecionados, unidadesSelecionadas, periodo });
                    
                    // Mostrar loading
                    document.getElementById('chart-loading').style.display = 'block';
                    document.getElementById('chart-placeholder').style.display = 'none';
                    
                    // Fazer requisi√ß√£o
                    const payload = {
                        lotes: lotesSelecionados,
                        unidades: unidadesSelecionadas,
                        periodo: periodo,
                        modo: modoVisualizacao,
                        projecao: projecaoAtiva
                    };
                    
                    console.log('üì§ Enviando requisi√ß√£o:', payload);
                    
                    const response = await fetch('/api/relatorios/dados-grafico', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    const resultado = await response.json();
                    console.log('üì• Resposta recebida:', resultado);
                    
                    document.getElementById('chart-loading').style.display = 'none';
                    
                    if (resultado.success) {
                        console.log('‚úÖ Dados recebidos:', resultado);
                        
                        // Verificar se h√° dados para exibir
                        const temDados = resultado.total_registros > 0 && 
                                        resultado.dados.labels && 
                                        resultado.dados.labels.length > 0;
                        
                        const temGrupos = resultado.dados.grupos && resultado.dados.grupos.length > 0;
                        
                        if (!temDados && !temGrupos) {
                            console.log('‚ö†Ô∏è Nenhum dado para exibir');
                            if (chartInstance) {
                                chartInstance.destroy();
                                chartInstance = null;
                            }
                            document.getElementById('chart-placeholder').style.display = 'flex';
                            document.getElementById('grafico-principal').style.display = 'none';
                        } else {
                            console.log('‚úÖ Exibindo gr√°fico - Dados v√°lidos encontrados');
                            document.getElementById('chart-placeholder').style.display = 'none';
                            document.getElementById('grafico-principal').style.display = 'block';
                            renderizarGrafico(resultado.dados);
                        }
                    } else {
                        console.error('‚ùå Erro ao buscar dados:', resultado.error);
                        alert('Erro ao carregar dados do gr√°fico: ' + resultado.error);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro na requisi√ß√£o:', error);
                    document.getElementById('chart-loading').style.display = 'none';
                    document.getElementById('chart-placeholder').style.display = 'block';
                }
            }
            
            // Fun√ß√£o para renderizar o gr√°fico com Chart.js
            function renderizarGrafico(dados) {
                const ctx = document.getElementById('grafico-principal').getContext('2d');
                
                console.log('üé® Renderizar gr√°fico - Dados recebidos:', dados);
                console.log('üìä Modo:', dados.modo);
                console.log('üîÆ Proje√ß√£o?', dados.projecao ? 'SIM' : 'N√ÉO');
                if (dados.projecao) {
                    console.log('üìà Dados de proje√ß√£o:', dados.projecao);
                }
                
                // Destruir gr√°fico anterior se existir
                if (chartInstance) {
                    chartInstance.destroy();
                }
                
                // Preparar datasets baseado no modo
                let datasets = [];
                const cores = [
                    { border: 'rgb(75, 192, 192)', bg: 'rgba(75, 192, 192, 0.1)' },
                    { border: 'rgb(255, 99, 132)', bg: 'rgba(255, 99, 132, 0.1)' },
                    { border: 'rgb(54, 162, 235)', bg: 'rgba(54, 162, 235, 0.1)' },
                    { border: 'rgb(255, 206, 86)', bg: 'rgba(255, 206, 86, 0.1)' },
                    { border: 'rgb(153, 102, 255)', bg: 'rgba(153, 102, 255, 0.1)' },
                    { border: 'rgb(255, 159, 64)', bg: 'rgba(255, 159, 64, 0.1)' },
                    { border: 'rgb(201, 203, 207)', bg: 'rgba(201, 203, 207, 0.1)' },
                    { border: 'rgb(83, 211, 87)', bg: 'rgba(83, 211, 87, 0.1)' },
                    { border: 'rgb(237, 100, 127)', bg: 'rgba(237, 100, 127, 0.1)' },
                    { border: 'rgb(155, 89, 182)', bg: 'rgba(155, 89, 182, 0.1)' }
                ];
                
                // Preparar labels combinando hist√≥rico + proje√ß√£o
                let allLabels = dados.labels_formatados || dados.labels;
                
                if (dados.projecao && dados.projecao.labels_formatados) {
                    allLabels = [...allLabels, ...dados.projecao.labels_formatados];
                }
                
                if (dados.modo === 'acumulado') {
                    // Modo acumulado - uma √∫nica linha com total
                    let dataHistorico = dados.datasets.total_refeicoes;
                    let dataProjecao = [];
                    
                    // Se tem proje√ß√£o, adicionar valores
                    if (dados.projecao && dados.projecao.valores) {
                        dataProjecao = dados.projecao.valores;
                    }
                    
                    // Dataset de dados hist√≥ricos
                    datasets.push({
                        label: 'Total de Refei√ß√µes (Real)',
                        data: [...dataHistorico, ...Array(dataProjecao.length).fill(null)],
                        borderColor: cores[0].border,
                        backgroundColor: cores[0].bg,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        segment: {
                            borderDash: ctx => ctx.p0DataIndex >= dataHistorico.length ? [5, 5] : undefined
                        }
                    });
                    
                    // Dataset de proje√ß√£o (se dispon√≠vel)
                    if (dataProjecao.length > 0) {
                        // Pegar √∫ltimo valor real para conectar com a proje√ß√£o
                        const ultimoValorReal = dataHistorico[dataHistorico.length - 1];
                        
                        // Criar array com ponto de conex√£o: √∫ltimo real + valores projetados
                        const dataProjecaoComConexao = [ultimoValorReal, ...dataProjecao];
                        
                        datasets.push({
                            label: 'Proje√ß√£o (IA)',
                            data: [...Array(dataHistorico.length - 1).fill(null), ...dataProjecaoComConexao],
                            borderColor: 'rgb(139, 92, 246)',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            fill: true,
                            tension: 0.4,
                            pointStyle: 'triangle',
                            pointRadius: 6
                        });
                        
                        // Atualizar m√©tricas de proje√ß√£o
                        if (dados.projecao.media_historica) {
                            const mediaPeriodo = document.getElementById('media-periodo');
                            if (mediaPeriodo) {
                                mediaPeriodo.textContent = dados.projecao.media_historica.toLocaleString('pt-BR');
                            }
                        }
                        if (dados.projecao.tendencia) {
                            const tendenciaTexto = dados.projecao.tendencia === 'crescimento' ? 'üìà Crescimento' : 
                                                   dados.projecao.tendencia === 'decrescimento' ? 'üìâ Decrescimento' : '‚û°Ô∏è Est√°vel';
                            const tendenciaDados = document.getElementById('tendencia-dados');
                            if (tendenciaDados) {
                                tendenciaDados.textContent = tendenciaTexto;
                            }
                        }
                        // Atualizar data fim da proje√ß√£o
                        if (dados.projecao.labels_formatados && dados.projecao.labels_formatados.length > 0) {
                            const ultimoMes = dados.projecao.labels_formatados[dados.projecao.labels_formatados.length - 1];
                            const dataFimContrato = document.getElementById('data-fim-contrato');
                            const projecaoDataFimLegenda = document.getElementById('projecao-data-fim-legenda');
                            if (dataFimContrato) {
                                dataFimContrato.textContent = ultimoMes;
                            }
                            if (projecaoDataFimLegenda) {
                                projecaoDataFimLegenda.textContent = ultimoMes;
                            }
                        }
                    }
                } else if (dados.modo === 'unidade' || dados.modo === 'lote') {
                    // Modo por unidade ou lote - m√∫ltiplas linhas
                    const grupos = dados.grupos || [];
                    
                    // Fun√ß√£o para escurecer cor
                    function escurecerCor(rgbString) {
                        const match = rgbString.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                        if (match) {
                            const r = Math.max(0, parseInt(match[1]) - 40);
                            const g = Math.max(0, parseInt(match[2]) - 40);
                            const b = Math.max(0, parseInt(match[3]) - 40);
                            return `rgb(${r}, ${g}, ${b})`;
                        }
                        return rgbString;
                    }
                    
                    // Determinar quantos per√≠odos de proje√ß√£o
                    const numPeriodosProjecao = dados.projecao && dados.projecao.labels ? dados.projecao.labels.length : 0;
                    
                    // Adicionar linhas dos grupos hist√≥ricos
                    grupos.forEach((grupo, index) => {
                        const corIndex = index % cores.length;
                        let valoresGrupo = grupo.valores;
                        
                        // Se tem proje√ß√£o, adicionar nulls para espa√ßo da proje√ß√£o
                        if (numPeriodosProjecao > 0) {
                            valoresGrupo = [...grupo.valores, ...Array(numPeriodosProjecao).fill(null)];
                        }
                        
                        datasets.push({
                            label: grupo.nome,
                            data: valoresGrupo,
                            borderColor: cores[corIndex].border,
                            backgroundColor: cores[corIndex].bg,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        });
                    });
                    
                    // Se tem proje√ß√£o por grupo, adicionar linha de proje√ß√£o para cada grupo
                    if (dados.projecao && dados.projecao.grupos_projetados && dados.projecao.grupos_projetados.length > 0) {
                        dados.projecao.grupos_projetados.forEach((grupoProj, index) => {
                            const corIndex = index % cores.length;
                            const corEscura = escurecerCor(cores[corIndex].border);
                            const numPeriodosHistoricos = grupos[0] ? grupos[0].valores.length : 0;
                            
                            // Pegar √∫ltimo valor real do grupo correspondente
                            const grupoHistorico = grupos[index];
                            const ultimoValorRealGrupo = grupoHistorico ? grupoHistorico.valores[grupoHistorico.valores.length - 1] : 0;
                            
                            // Criar array com ponto de conex√£o
                            const dataProjecaoGrupo = [ultimoValorRealGrupo, ...grupoProj.valores];
                            
                            datasets.push({
                                label: `${grupoProj.nome} (Proje√ß√£o)`,
                                data: [...Array(numPeriodosHistoricos - 1).fill(null), ...dataProjecaoGrupo],
                                borderColor: corEscura,
                                backgroundColor: cores[corIndex].bg,
                                borderWidth: 2,
                                borderDash: [10, 5],
                                fill: false,
                                tension: 0.4,
                                pointStyle: 'triangle',
                                pointRadius: 4
                            });
                        });
                    }
                    
                    // Atualizar m√©tricas de proje√ß√£o (se houver proje√ß√£o)
                    if (dados.projecao) {
                        if (dados.projecao.media_historica) {
                            const mediaPeriodo = document.getElementById('media-periodo');
                            if (mediaPeriodo) {
                                mediaPeriodo.textContent = dados.projecao.media_historica.toLocaleString('pt-BR');
                            }
                        }
                        if (dados.projecao.tendencia) {
                            const tendenciaTexto = dados.projecao.tendencia === 'crescimento' ? 'üìà Crescimento' : 
                                                   dados.projecao.tendencia === 'decrescimento' ? 'üìâ Decrescimento' : '‚û°Ô∏è Est√°vel';
                            const tendenciaDados = document.getElementById('tendencia-dados');
                            if (tendenciaDados) {
                                tendenciaDados.textContent = tendenciaTexto;
                            }
                        }
                        // Atualizar data fim da proje√ß√£o
                        if (dados.projecao.labels_formatados && dados.projecao.labels_formatados.length > 0) {
                            const ultimoMes = dados.projecao.labels_formatados[dados.projecao.labels_formatados.length - 1];
                            const dataFimContrato = document.getElementById('data-fim-contrato');
                            const projecaoDataFimLegenda = document.getElementById('projecao-data-fim-legenda');
                            if (dataFimContrato) {
                                dataFimContrato.textContent = ultimoMes;
                            }
                            if (projecaoDataFimLegenda) {
                                projecaoDataFimLegenda.textContent = ultimoMes;
                            }
                        }
                    }
                }
                
                // Criar novo gr√°fico
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            title: {
                                display: true,
                                text: 'Evolu√ß√£o de Refei√ß√µes ao Longo do Tempo',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y.toLocaleString('pt-BR');
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico renderizado com sucesso! Modo:', dados.modo);
            }
            
            // Adicionar listener para per√≠odo
            document.getElementById('filtro-periodo').addEventListener('change', carregarGrafico);
            
            // Controle do filtro de Lotes multi-select
            const lotesDisplay = document.getElementById('lotes-display');
            const lotesPopup = document.getElementById('lotes-popup');
            const lotesOverlay = document.getElementById('lotes-overlay');
            const btnSelecionarTodosLotes = document.getElementById('btn-selecionar-todos-lotes');
            const btnLimparTodosLotes = document.getElementById('btn-limpar-todos-lotes');
            const btnAplicarLotes = document.getElementById('btn-aplicar-lotes');
            const btnCancelarLotes = document.getElementById('btn-cancelar-lotes');
            
            console.log('Elementos de lotes:', { lotesDisplay, lotesPopup, lotesOverlay });
            
            // Abrir popup de lotes
            if (lotesDisplay) {
                lotesDisplay.addEventListener('click', function(e) {
                    console.log('Clique no filtro de lotes detectado!');
                    e.stopPropagation();
                    lotesPopup.style.display = 'block';
                    lotesOverlay.style.display = 'block';
                });
            } else {
                console.error('Elemento lotes-display n√£o encontrado!');
            }
            
            // Fechar popup de lotes
            function fecharPopupLotes() {
                lotesPopup.style.display = 'none';
                lotesOverlay.style.display = 'none';
            }
            
            lotesOverlay.addEventListener('click', fecharPopupLotes);
            btnCancelarLotes.addEventListener('click', fecharPopupLotes);
            
            // Selecionar todos os lotes
            btnSelecionarTodosLotes.addEventListener('click', function() {
                document.querySelectorAll('.lote-checkbox').forEach(cb => cb.checked = true);
                atualizarCountLotes();
            });
            
            // Limpar todos os lotes
            btnLimparTodosLotes.addEventListener('click', function() {
                document.querySelectorAll('.lote-checkbox').forEach(cb => cb.checked = false);
                atualizarCountLotes();
            });
            
            // Atualizar contagem de lotes
            function atualizarCountLotes() {
                const count = document.querySelectorAll('.lote-checkbox:checked').length;
                document.getElementById('lotes-selecionados-count').textContent = `${count} lote${count !== 1 ? 's' : ''} selecionado${count !== 1 ? 's' : ''}`;
            }
            
            // Atualizar display de lotes
            function atualizarDisplayLotes() {
                const checkboxes = document.querySelectorAll('.lote-checkbox');
                const selecionados = Array.from(checkboxes).filter(cb => cb.checked);
                const total = checkboxes.length;
                const lotesText = document.getElementById('lotes-text');
                
                if (selecionados.length === 0) {
                    lotesText.textContent = 'Nenhum lote';
                } else if (selecionados.length === total) {
                    lotesText.textContent = 'Todos os lotes';
                } else if (selecionados.length === 1) {
                    lotesText.textContent = selecionados[0].nextElementSibling.textContent;
                } else {
                    lotesText.textContent = `${selecionados.length} lotes`;
                }
            }
            
            // Aplicar filtro de lotes
            btnAplicarLotes.addEventListener('click', function() {
                atualizarDisplayLotes();
                atualizarUnidadesDisponiveis();
                fecharPopupLotes();
                carregarGrafico();
            });
            
            // Atualizar contagem ao mudar checkboxes
            document.querySelectorAll('.lote-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    atualizarCountLotes();
                    atualizarUnidadesDisponiveis();
                });
            });
            
            // Controle do filtro de Unidades multi-select
            const unidadesDisplay = document.getElementById('unidades-display');
            const unidadesPopup = document.getElementById('unidades-popup');
            const unidadesOverlay = document.getElementById('unidades-overlay');
            const btnSelecionarTodasUnidades = document.getElementById('btn-selecionar-todas-unidades');
            const btnLimparTodasUnidades = document.getElementById('btn-limpar-todas-unidades');
            const btnAplicarUnidades = document.getElementById('btn-aplicar-unidades');
            const btnCancelarUnidades = document.getElementById('btn-cancelar-unidades');
            
            console.log('Elementos de unidades:', { unidadesDisplay, unidadesPopup, unidadesOverlay });
            
            // Abrir popup de unidades
            if (unidadesDisplay) {
                unidadesDisplay.addEventListener('click', function(e) {
                    console.log('Clique no filtro de unidades detectado!');
                    e.stopPropagation();
                    atualizarUnidadesDisponiveis();
                    unidadesPopup.style.display = 'block';
                    unidadesOverlay.style.display = 'block';
                });
            } else {
                console.error('Elemento unidades-display n√£o encontrado!');
            }
            
            // Fechar popup de unidades
            function fecharPopupUnidades() {
                unidadesPopup.style.display = 'none';
                unidadesOverlay.style.display = 'none';
            }
            
            unidadesOverlay.addEventListener('click', fecharPopupUnidades);
            btnCancelarUnidades.addEventListener('click', fecharPopupUnidades);
            
            // Selecionar todas as unidades (apenas as vis√≠veis)
            btnSelecionarTodasUnidades.addEventListener('click', function() {
                document.querySelectorAll('.unidade-checkbox').forEach(cb => {
                    if (cb.closest('.unidade-item').style.display !== 'none') {
                        cb.checked = true;
                    }
                });
                atualizarCountUnidades();
            });
            
            // Limpar todas as unidades (apenas as vis√≠veis)
            btnLimparTodasUnidades.addEventListener('click', function() {
                document.querySelectorAll('.unidade-checkbox').forEach(cb => {
                    if (cb.closest('.unidade-item').style.display !== 'none') {
                        cb.checked = false;
                    }
                });
                atualizarCountUnidades();
            });
            
            // Atualizar contagem de unidades (apenas as vis√≠veis)
            function atualizarCountUnidades() {
                const checkboxes = document.querySelectorAll('.unidade-checkbox');
                let count = 0;
                checkboxes.forEach(cb => {
                    if (cb.closest('.unidade-item').style.display !== 'none' && cb.checked) {
                        count++;
                    }
                });
                document.getElementById('unidades-selecionadas-count').textContent = `${count} unidade${count !== 1 ? 's' : ''} selecionada${count !== 1 ? 's' : ''}`;
            }
            
            // Atualizar display de unidades (considera apenas as vis√≠veis)
            function atualizarDisplayUnidades() {
                const checkboxes = document.querySelectorAll('.unidade-checkbox');
                const unidadesText = document.getElementById('unidades-text');
                
                // Contar vis√≠veis
                let totalVisiveis = 0;
                let selecionados = [];
                
                checkboxes.forEach(cb => {
                    if (cb.closest('.unidade-item').style.display !== 'none') {
                        totalVisiveis++;
                        if (cb.checked) {
                            selecionados.push(cb);
                        }
                    }
                });
                
                if (totalVisiveis === 0) {
                    unidadesText.textContent = 'Nenhuma unidade dispon√≠vel';
                } else if (selecionados.length === 0) {
                    unidadesText.textContent = 'Nenhuma unidade';
                } else if (selecionados.length === totalVisiveis) {
                    unidadesText.textContent = 'Todas as unidades';
                } else if (selecionados.length === 1) {
                    unidadesText.textContent = selecionados[0].nextElementSibling.textContent;
                } else {
                    unidadesText.textContent = `${selecionados.length} unidades`;
                }
            }
            
            // Aplicar filtro de unidades
            btnAplicarUnidades.addEventListener('click', function() {
                atualizarDisplayUnidades();
                fecharPopupUnidades();
                carregarGrafico();
            });
            
            // Atualizar contagem ao mudar checkboxes
            document.querySelectorAll('.unidade-checkbox').forEach(cb => {
                cb.addEventListener('change', atualizarCountUnidades);
            });
            
            // Fun√ß√£o para atualizar unidades dispon√≠veis baseado nos lotes selecionados
            function atualizarUnidadesDisponiveis() {
                const lotesSelecionados = Array.from(document.querySelectorAll('.lote-checkbox:checked')).map(cb => cb.value);
                
                console.log('Lotes selecionados:', lotesSelecionados);
                
                // Coletar todas as unidades dos lotes selecionados
                let unidadesDisponiveis = new Set();
                
                if (lotesSelecionados.length === 0) {
                    // Nenhum lote selecionado = nenhuma unidade dispon√≠vel
                    unidadesDisponiveis = new Set();
                } else {
                    // Coletar unidades dos lotes selecionados
                    lotesSelecionados.forEach(loteId => {
                        const unidadesDoLote = lotesUnidadesMap[loteId] || [];
                        unidadesDoLote.forEach(unidade => unidadesDisponiveis.add(unidade));
                    });
                }
                
                console.log('Unidades dispon√≠veis:', Array.from(unidadesDisponiveis));
                
                // Atualizar checkboxes de unidades
                const unidadeItems = document.querySelectorAll('.unidade-item');
                let unidadesVisiveis = 0;
                
                unidadeItems.forEach(item => {
                    const checkbox = item.querySelector('.unidade-checkbox');
                    const unidadeNome = checkbox.value;
                    
                    if (unidadesDisponiveis.has(unidadeNome)) {
                        // Mostrar unidade
                        item.style.display = 'flex';
                        unidadesVisiveis++;
                    } else {
                        // Ocultar unidade e desmarcar
                        item.style.display = 'none';
                        checkbox.checked = false;
                    }
                });
                
                // Atualizar contagem
                atualizarCountUnidades();
                
                // Atualizar display no filtro principal
                atualizarDisplayUnidades();
                
                // Mensagem se nenhuma unidade dispon√≠vel
                const unidadesList = document.getElementById('unidades-list');
                let mensagemVazia = unidadesList.querySelector('.mensagem-vazia');
                
                if (unidadesVisiveis === 0) {
                    if (!mensagemVazia) {
                        mensagemVazia = document.createElement('div');
                        mensagemVazia.className = 'mensagem-vazia';
                        mensagemVazia.style.cssText = 'padding: 2rem; text-align: center; color: var(--gray-500); font-size: 0.875rem;';
                        mensagemVazia.innerHTML = 'üìã Nenhuma unidade dispon√≠vel<br><small style="font-size: 0.75rem;">Selecione pelo menos um lote</small>';
                        unidadesList.appendChild(mensagemVazia);
                    }
                } else {
                    if (mensagemVazia) {
                        mensagemVazia.remove();
                    }
                }
            }

            // Fun√ß√£o para carregar gr√°fico de GASTOS
            async function carregarGraficoGastos() {
                try {
                    const lotesSelecionados = Array.from(document.querySelectorAll('.lote-checkbox:checked')).map(cb => cb.value);
                    const unidadesSelecionadas = Array.from(document.querySelectorAll('.unidade-checkbox:checked')).map(cb => cb.value);
                    const periodo = document.getElementById('filtro-periodo').value;
                    
                    console.log('üí∞ Carregando gr√°fico gastos:', { lotesSelecionados, unidadesSelecionadas, periodo, modo: modoVisualizacao, projecao: projecaoAtivaGastos });
                    
                    const response = await fetch('/api/relatorios/dados-gastos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            lotes: lotesSelecionados,
                            unidades: unidadesSelecionadas,
                            periodo: periodo,
                            modo: modoVisualizacao,
                            projecao: projecaoAtivaGastos
                        })
                    });
                    
                    const resultado = await response.json();
                    
                    if (resultado.success) {
                        const dados = resultado.dados;
                        const temDados = resultado.total_registros > 0 && dados.labels && dados.labels.length > 0;
                        const temGrupos = dados.grupos && dados.grupos.length > 0;
                        
                        if (!temDados && !temGrupos) {
                            document.getElementById('container-grafico-gastos').style.display = 'none';
                            document.getElementById('placeholder-grafico-gastos').style.display = 'flex';
                        } else {
                            document.getElementById('container-grafico-gastos').style.display = 'block';
                            document.getElementById('placeholder-grafico-gastos').style.display = 'none';
                            renderizarGraficoGastos(dados);
                            
                            // Atualizar m√©tricas de proje√ß√£o se ativa
                            if (projecaoAtivaGastos && dados.projecao) {
                                document.getElementById('metricas-projecao-gastos').style.display = 'block';
                                document.getElementById('projecao-badge-gastos').style.display = 'inline-block';
                                
                                const mediaPeriodo = document.getElementById('media-periodo-gastos');
                                if (mediaPeriodo) mediaPeriodo.textContent = dados.projecao.media_historica.toLocaleString('pt-BR');
                                
                                const tendencia = document.getElementById('tendencia-gastos');
                                if (tendencia) {
                                    const tendenciaTexto = dados.projecao.tendencia === 'crescimento' ? 'üìà Crescimento' :
                                                          dados.projecao.tendencia === 'decrescimento' ? 'üìâ Decrescimento' : '‚û°Ô∏è Est√°vel';
                                    tendencia.textContent = tendenciaTexto;
                                    tendencia.style.color = dados.projecao.tendencia === 'crescimento' ? '#10b981' :
                                                           dados.projecao.tendencia === 'decrescimento' ? '#ef4444' : '#6b7280';
                                }
                                
                                const ultimoMes = dados.projecao.labels_formatados[dados.projecao.labels_formatados.length - 1];
                                const legendaDataFim = document.getElementById('projecao-data-fim-legenda-gastos');
                                if (legendaDataFim && ultimoMes) {
                                    legendaDataFim.textContent = `üîÆ Proje√ß√£o at√© ${ultimoMes}`;
                                    legendaDataFim.style.display = 'inline';
                                }
                            } else {
                                document.getElementById('metricas-projecao-gastos').style.display = 'none';
                                document.getElementById('projecao-badge-gastos').style.display = 'none';
                                const legendaDataFim = document.getElementById('projecao-data-fim-legenda-gastos');
                                if (legendaDataFim) legendaDataFim.style.display = 'none';
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar gr√°fico gastos:', error);
                    mostrarNotificacao('Erro', 'Falha ao carregar gr√°fico de gastos', 'error');
                }
            }
            
            // Fun√ß√£o para renderizar gr√°fico de GASTOS
            function renderizarGraficoGastos(dados) {
                const ctx = document.getElementById('grafico-gastos').getContext('2d');
                
                if (chartInstanceGastos) {
                    chartInstanceGastos.destroy();
                }
                
                let datasets = [];
                const cores = [
                    'rgb(59, 130, 246)', 'rgb(16, 185, 129)', 'rgb(245, 158, 11)', 
                    'rgb(239, 68, 68)', 'rgb(139, 92, 246)', 'rgb(236, 72, 153)',
                    'rgb(20, 184, 166)', 'rgb(251, 146, 60)', 'rgb(168, 85, 247)',
                    'rgb(34, 197, 94)'
                ];
                
                let allLabels = dados.labels_formatados || dados.labels;
                
                if (dados.projecao && dados.projecao.labels_formatados) {
                    allLabels = [...allLabels, ...dados.projecao.labels_formatados];
                }
                
                if (dados.modo === 'acumulado') {
                    const dataHistorico = dados.datasets.total_gastos || [];
                    
                    datasets.push({
                        label: 'Total de Gastos (R$)',
                        data: dataHistorico,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    });
                    
                    if (dados.projecao && dados.projecao.valores && dados.projecao.valores.length > 0) {
                        const dataProjecao = dados.projecao.valores;
                        const ultimoValorReal = dataHistorico[dataHistorico.length - 1];
                        const dataProjecaoComConexao = [ultimoValorReal, ...dataProjecao];
                        
                        datasets.push({
                            label: 'Proje√ß√£o de Gastos (R$)',
                            data: [...Array(dataHistorico.length - 1).fill(null), ...dataProjecaoComConexao],
                            borderColor: 'rgb(139, 92, 246)',
                            backgroundColor: 'rgba(139, 92, 246, 0.05)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointStyle: 'triangle'
                        });
                    }
                } else if (dados.modo === 'unidade' || dados.modo === 'lote') {
                    dados.grupos.forEach((grupo, index) => {
                        datasets.push({
                            label: grupo.nome,
                            data: grupo.valores,
                            borderColor: cores[index % cores.length],
                            backgroundColor: cores[index % cores.length].replace('rgb', 'rgba').replace(')', ', 0.1)'),
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        });
                        
                        if (dados.projecao && dados.projecao.grupos_projetados) {
                            const grupoProj = dados.projecao.grupos_projetados.find(g => g.nome === grupo.nome);
                            if (grupoProj && grupoProj.valores.length > 0) {
                                const grupoHistorico = grupo;
                                const ultimoValorRealGrupo = grupoHistorico.valores[grupoHistorico.valores.length - 1];
                                const dataProjecaoGrupo = [ultimoValorRealGrupo, ...grupoProj.valores];
                                
                                const corBase = cores[index % cores.length];
                                const corEscura = corBase.replace('rgb(', '').replace(')', '').split(',')
                                    .map(c => Math.max(0, parseInt(c.trim()) - 40))
                                    .join(',');
                                
                                datasets.push({
                                    label: `${grupoProj.nome} (Proje√ß√£o)`,
                                    data: [...Array(grupoHistorico.valores.length - 1).fill(null), ...dataProjecaoGrupo],
                                    borderColor: `rgb(${corEscura})`,
                                    backgroundColor: 'transparent',
                                    borderWidth: 2.5,
                                    borderDash: [10, 5],
                                    fill: false,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointHoverRadius: 6,
                                    pointStyle: 'triangle'
                                });
                            }
                        }
                    });
                }
                
                chartInstanceGastos = new Chart(ctx, {
                    type: 'line',
                    data: { labels: allLabels, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: { padding: 15, font: { size: 12 }, usePointStyle: true }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        label += 'R$ ' + (context.parsed.y || 0).toLocaleString('pt-BR', {
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2
                                        });
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR', {
                                            minimumFractionDigits: 0,
                                            maximumFractionDigits: 0
                                        });
                                    }
                                },
                                grid: { color: 'rgba(0, 0, 0, 0.05)' }
                            },
                            x: { grid: { display: false } }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico gastos renderizado! Modo:', dados.modo);
            }
            
            // Toggle de Proje√ß√£o GASTOS
            document.getElementById('btn-toggle-projecao-gastos').addEventListener('click', function() {
                // Verificar se o modo atual permite proje√ß√£o
                if (!projecaoAtivaGastos && modoVisualizacao === 'acumulado') {
                    mostrarNotificacao(
                        'Proje√ß√£o N√£o Dispon√≠vel',
                        'A proje√ß√£o est√° dispon√≠vel apenas nos modos:\n\nüè¢ Por Unidade\nüì¶ Por Lote\n\nPor favor, selecione um desses modos para ativar a proje√ß√£o.',
                        'warning',
                        6000
                    );
                    return;
                }
                
                projecaoAtivaGastos = !projecaoAtivaGastos;
                
                const btnProjecao = this;
                
                if (projecaoAtivaGastos) {
                    btnProjecao.textContent = '‚úñÔ∏è Desativar Proje√ß√£o';
                    btnProjecao.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                } else {
                    btnProjecao.textContent = 'üîÆ Ativar Proje√ß√£o';
                    btnProjecao.style.background = '';
                }
                
                carregarGraficoGastos();
            });

            // Toggle de Proje√ß√£o (integrado no gr√°fico)
            let projecaoAtiva = false;
            document.getElementById('btn-toggle-projecao').addEventListener('click', function() {
                // Verificar se o modo atual permite proje√ß√£o
                if (!projecaoAtiva && modoVisualizacao === 'acumulado') {
                    mostrarNotificacao(
                        'Proje√ß√£o N√£o Dispon√≠vel',
                        'A proje√ß√£o est√° dispon√≠vel apenas nos modos:\n\nüè¢ Por Unidade\nüì¶ Por Lote\n\nPor favor, selecione um desses modos para ativar a proje√ß√£o.',
                        'warning',
                        6000
                    );
                    return;
                }
                
                projecaoAtiva = !projecaoAtiva;
                
                const btnProjecao = this;
                const projecaoInfo = document.getElementById('projecao-info');
                const metricasProjecao = document.getElementById('metricas-projecao');
                const legendaProjecao = document.getElementById('legenda-projecao');
                const legendaLinhaDivisoria = document.getElementById('legenda-linha-divisoria');
                
                if (projecaoAtiva) {
                    // Ativar proje√ß√£o
                    btnProjecao.textContent = '‚úñÔ∏è Desativar Proje√ß√£o';
                    btnProjecao.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    btnProjecao.style.color = 'white';
                    projecaoInfo.style.display = 'flex';
                    metricasProjecao.style.display = 'block';
                    legendaProjecao.style.display = 'block';
                    legendaLinhaDivisoria.style.display = 'block';
                    
                    // Anima√ß√£o suave
                    metricasProjecao.style.opacity = '0';
                    metricasProjecao.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        metricasProjecao.style.transition = 'all 0.5s ease';
                        metricasProjecao.style.opacity = '1';
                        metricasProjecao.style.transform = 'translateY(0)';
                    }, 10);
                    
                    // Scroll suave at√© as m√©tricas
                    setTimeout(() => {
                        metricasProjecao.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 300);
                    
                    console.log('üîÆ Proje√ß√£o ativada - Recarregando gr√°fico com dados projetados');
                    carregarGrafico();
                } else {
                    // Desativar proje√ß√£o
                    btnProjecao.textContent = 'üîÆ Ativar Proje√ß√£o';
                    btnProjecao.style.background = '';
                    btnProjecao.style.color = '';
                    projecaoInfo.style.display = 'none';
                    metricasProjecao.style.display = 'none';
                    legendaProjecao.style.display = 'none';
                    legendaLinhaDivisoria.style.display = 'none';
                    
                    console.log('‚ùå Proje√ß√£o desativada - Recarregando apenas dados reais');
                    carregarGrafico();
                }
            });

            // Exportar relat√≥rio
            document.getElementById('btn-exportar-relatorio').addEventListener('click', function() {
                mostrarNotificacao(
                    'Em Desenvolvimento',
                    'A funcionalidade de exporta√ß√£o ser√° implementada na pr√≥xima fase.\n\nFormatos dispon√≠veis: PDF, Excel, CSV',
                    'info',
                    4000
                );
            });

            // Logout - Modal customizado
            var modalLogout = document.getElementById('modal-confirmacao-logout');
            var btnCancelarLogout = document.getElementById('btn-cancelar-logout');
            var btnConfirmarLogout = document.getElementById('btn-confirmar-logout');
            
            document.getElementById('logoutLink').addEventListener('click', function(e) {
                e.preventDefault();
                modalLogout.style.display = 'block';
            });
            
            if (btnCancelarLogout) {
                btnCancelarLogout.addEventListener('click', function() {
                    modalLogout.style.display = 'none';
                });
            }
            
            if (btnConfirmarLogout) {
                btnConfirmarLogout.addEventListener('click', function() {
                    fetch('/logout', {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.ok) {
                            window.location.href = '/login';
                        }
                    })
                    .catch(() => {
                        window.location.href = '/logout';
                    });
                });
            }
            
            // Fechar modal ao clicar fora
            if (modalLogout) {
                modalLogout.addEventListener('click', function(e) {
                    if (e.target === modalLogout) {
                        modalLogout.style.display = 'none';
                    }
                });
            }

            // Anima√ß√µes
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            });

            document.querySelectorAll('.fade-in').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(30px)';
                el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(el);
            });
            
            // Carregar gr√°fico inicial ap√≥s inicializa√ß√£o completa
            console.log('üöÄ Iniciando carregamento do gr√°fico inicial...');
            setTimeout(() => {
                const lotesSelecionados = Array.from(document.querySelectorAll('.lote-checkbox:checked')).map(cb => cb.value);
                const unidadesSelecionadas = Array.from(document.querySelectorAll('.unidade-checkbox:checked')).map(cb => cb.value);
                console.log('üìä Filtros iniciais - Lotes:', lotesSelecionados.length, 'Unidades:', unidadesSelecionadas.length);
                atualizarBotaoProjecao();
                carregarGrafico();
            }, 200);
        });
    </script>
    <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyAp2Xg1g5MwxuD3m6QlroJVmi6V6SEYeGo",
        authDomain: "sgmrp-sfa-seap.firebaseapp.com",
        projectId: "sgmrp-sfa-seap",
        storageBucket: "sgmrp-sfa-seap.firebasestorage.app",
        messagingSenderId: "890046403125",
        appId: "1:890046403125:web:36c3cb60d4e6960f1a977c",
        measurementId: "G-Z0KXSCHS4Q"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    </script>
</body>
</html>
