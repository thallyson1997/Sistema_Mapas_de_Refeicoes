<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios - SGMRP</title>
    <meta name="description" content="An√°lise gr√°fica e relat√≥rios de consumo de refei√ß√µes">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        .chart-placeholder {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,.1) 10px,
                rgba(255,255,255,.1) 20px
            );
        }
        
        .chart-content {
            position: relative;
            z-index: 1;
            text-align: center;
            padding: 2rem;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--gray-200);
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }
        
        .metric-subtitle {
            font-size: 0.75rem;
            color: var(--gray-500);
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .btn-projection {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-projection:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            margin: 3rem 0;
            opacity: 0.3;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 0;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-600);
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }
        
        .tab-btn:hover {
            color: var(--primary-color);
            background: var(--gray-50);
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .projection-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        /* Notifica√ß√µes customizadas */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            animation: slideInRight 0.4s ease-out;
            max-width: 400px;
        }

        .notification-content {
            background: white;
            color: #1f2937;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            border-left: 4px solid #3b82f6;
        }

        .notification-content.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .notification-content.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .notification-content.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .notification-content.info {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }

        .notification-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        .notification-body {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            color: #111827;
        }

        .notification-message {
            font-size: 0.875rem;
            line-height: 1.5;
            color: #6b7280;
            white-space: pre-line;
        }

        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
            color: #6b7280;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .custom-notification.closing {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        @media (max-width: 480px) {
            .custom-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Estilos do Modal de Exporta√ß√£o */
        .export-option:hover {
            background: #f1f5f9 !important;
            border-color: var(--primary-color) !important;
        }

        .export-option input:checked + span {
            color: var(--primary-color) !important;
            font-weight: 600;
        }

        input[type="radio"]:checked {
            accent-color: var(--primary-color);
        }

        label:has(input[type="radio"]:checked) {
            border-color: var(--primary-color) !important;
            background: #f5f3ff !important;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('dashboard') }}" class="logo">SGMRP</a>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <li><a href="{{ url_for('lotes') }}">Lotes</a></li>
                        <li><a href="{{ url_for('relatorios') }}" class="active">Relat√≥rios</a></li>
                        <li><a href="#configuracoes">Configura√ß√µes</a></li>
                        <li><a href="#" id="logoutLink" style="color: #fed7d7;">Sair</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Breadcrumb -->
            <nav aria-label="Navega√ß√£o" style="margin-bottom: 2.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 0.75rem 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.03);">
                <div style="display: flex; gap: 0.5rem; font-size: 0.95rem; color: var(--gray-500); align-items: center;">
                    <span><a href="{{ url_for('dashboard') }}" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">Dashboard</a></span>
                    <span aria-hidden="true" style="font-size: 1.1em; opacity: 0.7;">/</span>
                    <span aria-current="page" style="color: var(--primary-color); font-weight: 600;">Relat√≥rios</span>
                </div>
            </nav>

            <!-- Header da P√°gina -->
            <section style="margin-bottom: 2.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 2rem;">
                    <div>
                        <h1 style="margin-bottom: 0.5rem; color: var(--primary-color); font-size: 2.1rem; font-weight: 700; letter-spacing: -1px;">
                            üìä Relat√≥rios e An√°lises
                        </h1>
                        <p style="color: var(--gray-600); margin: 0; font-size: 1.05rem;">Visualiza√ß√£o gr√°fica e estat√≠sticas de consumo de refei√ß√µes</p>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <button class="btn btn-secondary" id="btn-exportar-relatorio" style="font-size: 1rem; padding: 0.7rem 1.3rem; border-radius: 8px;">
                            üì• Exportar Relat√≥rio
                        </button>
                    </div>
                </div>
            </section>

            <!-- Filtros Avan√ßados -->
            <section class="fade-in" style="margin-bottom: 2rem; position: relative; z-index: 100;">
                <div style="background: white; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.125rem;">üîç</span>
                            <span style="font-weight: 500; color: var(--gray-700); font-size: 0.875rem;">Filtros:</span>
                        </div>
                        
                        <!-- Filtro Lotes (Multi-Select) -->
                        <div class="lotes-filter-container" style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="filtro-lote" style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">üì¶ Lote:</label>
                            <select id="filtro-lote" class="form-select" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; border: 1px solid var(--gray-300); border-radius: 6px; background: white; min-width: 250px; cursor: pointer;">
                                <option value="">Selecione um lote</option>
                                {% for lote in lotes %}
                                <option value="{{ lote.id }}">{{ lote.nome }}{% if lote.empresa %} - {{ lote.empresa }}{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Filtro Unidades (Multi-Select) -->
                        <div class="unidades-filter-container" style="display: flex; align-items: center; gap: 0.5rem; position: relative;">
                            <label style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Unidades:</label>
                            <div class="unidades-display" id="unidades-display" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; cursor: pointer; border: 1px solid var(--gray-300); border-radius: 6px; background: white; min-width: 180px; display: flex; justify-content: space-between; align-items: center;">
                                <span class="unidades-text" id="unidades-text">Todas as unidades</span>
                                <span class="unidades-icon">üè¢</span>
                            </div>
                            
                            <!-- Overlay para fechar popup de unidades -->
                            <div class="unidades-overlay" id="unidades-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 998;"></div>
                            
                            <!-- Popup de sele√ß√£o de unidades -->
                            <div class="unidades-popup" id="unidades-popup" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border: 1px solid var(--gray-300); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 350px; z-index: 999;">
                                <div class="unidades-header" style="padding: 1rem; border-bottom: 1px solid var(--gray-200);">
                                    <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem;">üè¢ Selecionar Unidades</h4>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--gray-600);">Escolha as unidades para filtrar os dados</p>
                                </div>
                                
                                <div class="unidades-body" style="padding: 1rem;">
                                    <div class="unidades-controls" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button class="control-btn" id="btn-selecionar-todas-unidades" style="flex: 1; padding: 0.5rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚úÖ Todas</button>
                                        <button class="control-btn" id="btn-limpar-todas-unidades" style="flex: 1; padding: 0.5rem; background: var(--gray-200); color: var(--gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚ùå Limpar</button>
                                    </div>
                                    
                                    <div class="unidades-list" id="unidades-list" style="max-height: 250px; overflow-y: auto;">
                                        {% for unidade in unidades %}
                                        <div class="unidade-item" data-value="{{ unidade }}" style="padding: 0.5rem; display: flex; align-items: center; gap: 0.5rem; border-radius: 4px; transition: background 0.2s;">
                                            <input type="checkbox" class="unidade-checkbox" id="checkbox-unidade{{ loop.index }}" value="{{ unidade }}" checked>
                                            <label class="unidade-label" for="checkbox-unidade{{ loop.index }}" style="cursor: pointer; flex: 1; font-size: 0.875rem;">{{ unidade }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <div class="unidades-actions" style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                                        <div class="unidades-info">
                                            <span id="unidades-selecionadas-count" style="font-size: 0.875rem; color: var(--gray-600);">{{ unidades|length }} unidade{{ 's' if unidades|length != 1 else '' }} selecionada{{ 's' if unidades|length != 1 else '' }}</span>
                                        </div>
                                        <div class="action-buttons" style="display: flex; gap: 0.5rem;">
                                            <button class="btn-calendario" id="btn-cancelar-unidades" style="padding: 0.5rem 1rem; background: var(--gray-200); border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚ùå Cancelar</button>
                                            <button class="btn-calendario primary" id="btn-aplicar-unidades" style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">‚úÖ Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtro Per√≠odo (Single Select) -->
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="filtro-periodo" style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Per√≠odo:</label>
                            <select id="filtro-periodo" class="form-input" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; border-radius: 6px;">
                                <option value="mes" selected>Mensal</option>
                                <option value="ano">Anual</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Segunda linha: Tipo e Agrupamento -->
                    <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                        <!-- Filtro Modo de Visualiza√ß√£o -->
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Tipo:</label>
                            <div style="display: flex; gap: 0.25rem; background: var(--gray-100); padding: 0.25rem; border-radius: 8px;">
                                <button id="tipo-normal" class="btn-tipo active" data-tipo="normal" style="padding: 0.5rem 1rem; font-size: 0.875rem; border: none; border-radius: 6px; cursor: pointer; background: var(--primary-color); color: white; font-weight: 500; transition: all 0.3s;">
                                    üìä Normal
                                </button>
                                <button id="tipo-acumulada" class="btn-tipo" data-tipo="acumulada" style="padding: 0.5rem 1rem; font-size: 0.875rem; border: none; border-radius: 6px; cursor: pointer; background: transparent; color: var(--gray-700); font-weight: 500; transition: all 0.3s;">
                                    üìà Acumulada
                                </button>
                            </div>
                        </div>
                        
                        <!-- Agrupamento -->
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-weight: 500; color: var(--gray-600); font-size: 0.875rem;">Agrupamento:</label>
                            <div style="display: flex; gap: 0.25rem; background: var(--gray-100); padding: 0.25rem; border-radius: 8px;">
                                <button id="modo-acumulado" class="btn-modo active" data-modo="acumulado" style="padding: 0.5rem 1rem; font-size: 0.875rem; border: none; border-radius: 6px; cursor: pointer; background: var(--primary-color); color: white; font-weight: 500; transition: all 0.3s;">
                                    üìä Total Geral
                                </button>
                                <button id="modo-unidade" class="btn-modo" data-modo="unidade" style="padding: 0.5rem 1rem; font-size: 0.875rem; border: none; border-radius: 6px; cursor: pointer; background: transparent; color: var(--gray-700); font-weight: 500; transition: all 0.3s;">
                                    üè¢ Por Unidade
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gr√°ficos de Visualiza√ß√£o -->
            <!-- Evolu√ß√£o de Refei√ß√µes -->
            <!-- Gr√°fico Principal -->
            <section class="card fade-in" style="margin-bottom: 2rem;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;" id="chart-title">üìà Gr√°fico de Evolu√ß√£o - Refei√ß√µes por Per√≠odo</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span id="projecao-info" style="display: none; font-size: 0.875rem; color: var(--gray-600); margin-right: 1rem;">
                            <span class="projection-badge">PROJE√á√ÉO ATIVA</span>
                            Dados hist√≥ricos + Proje√ß√£o at√© <strong id="data-fim-contrato">Dez/2026</strong>
                        </span>
                        <button class="btn-projection" id="btn-toggle-projecao" title="Ativar proje√ß√£o de 6 meses baseada em dados hist√≥ricos">
                            üîÆ Ativar Proje√ß√£o
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Gr√°fico Real -->
                    <div id="chart-container" style="position: relative;">
                        <canvas id="grafico-principal" style="max-height: 400px;"></canvas>
                        <div id="chart-loading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è≥</div>
                            <div style="color: var(--gray-600);">Carregando dados...</div>
                        </div>
                        <div class="chart-placeholder" id="chart-placeholder" style="display: none;">
                            <div class="chart-content">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
                                <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Gr√°fico de S√©rie Temporal</h3>
                                <p style="color: var(--gray-600); max-width: 500px; margin: 0 auto;">
                                    Selecione os filtros acima para visualizar os dados do gr√°fico.
                                </p>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Legenda do Gr√°fico -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 30px; height: 3px; background: #3b82f6;"></div>
                            <span style="font-size: 0.875rem; color: var(--gray-700);">Dados Reais</span>
                        </div>
                        <div id="legenda-projecao" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 30px; height: 3px; background: #667eea; border-top: 2px dashed #764ba2;"></div>
                                <span style="font-size: 0.875rem; color: var(--gray-700);">üîÆ Proje√ß√£o at√© <strong id="projecao-data-fim-legenda">Dez/2026</strong></span>
                            </div>
                        </div>
                        <div id="legenda-linha-divisoria" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 30px; height: 2px; background: #f59e0b; opacity: 0.6;"></div>
                                <span style="font-size: 0.875rem; color: var(--gray-700);">√öltimo Dado Real</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Divisor -->
            <div class="section-divider"></div>

            <!-- M√©tricas de Proje√ß√£o (aparecem quando proje√ß√£o est√° ativa) -->
            <section id="metricas-projecao" class="card fade-in" style="display: none !important; margin-bottom: 2rem; border: 2px solid #667eea;">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        üéØ Indicadores da Proje√ß√£o
                        <span class="projection-badge" style="background: rgba(255,255,255,0.2);">IA</span>
                    </h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem;">
                        <div class="metric-card" style="border: 2px solid #667eea;">
                            <div class="metric-label">üìÖ Previs√£o de Esgotamento</div>
                            <div class="metric-value" style="color: #667eea;">Mar√ßo/2026</div>
                            <div class="metric-subtitle">Baseado na tend√™ncia atual</div>
                        </div>
                        
                        <div class="metric-card" style="border: 2px solid #10b981;">
                            <div class="metric-label">üìà Tend√™ncia de Crescimento</div>
                            <div class="metric-value" style="color: #10b981;">+3.2%</div>
                            <div class="metric-subtitle">Crescimento mensal m√©dio</div>
                        </div>
                        
                        <div class="metric-card" style="border: 2px solid #f59e0b;">
                            <div class="metric-label">‚ö†Ô∏è N√≠vel de Alerta</div>
                            <div class="metric-value" style="color: #f59e0b;">M√©dio</div>
                            <div class="metric-subtitle">Monitoramento recomendado</div>
                        </div>
                        
                        <div class="metric-card" style="border: 2px solid #8b5cf6;">
                            <div class="metric-label">üí∞ Saldo Projetado</div>
                            <div class="metric-value" style="color: #8b5cf6;">R$ 45.000</div>
                            <div class="metric-subtitle">Em 31/12/2025</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
                        <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                            <strong>üí° Nota:</strong> A proje√ß√£o √© calculada com base nos dados hist√≥ricos e padr√µes de consumo identificados. 
                            Os valores s√£o estimativas e podem variar conforme mudan√ßas no cen√°rio real.
                        </p>
                    </div>
                </div>
            </section>

            <!-- Evolu√ß√£o de Gastos -->
            <!-- Gr√°fico de Gastos -->
            <section class="card fade-in" style="margin-bottom: 2rem;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;" id="chart-title-gastos">üí∞ Gr√°fico de Evolu√ß√£o - Gastos por Per√≠odo</h3>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span id="projecao-info-gastos" style="display: none; font-size: 0.875rem; color: var(--gray-600); margin-right: 1rem;">
                            <span class="projection-badge">PROJE√á√ÉO ATIVA</span>
                            Dados hist√≥ricos + Proje√ß√£o at√© <strong id="data-fim-contrato-gastos">Dez/2026</strong>
                        </span>
                        <button class="btn-projection" id="btn-toggle-projecao-gastos" title="Ativar proje√ß√£o de 6 meses baseada em dados hist√≥ricos">
                            üîÆ Ativar Proje√ß√£o
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Gr√°fico Real -->
                    <div id="chart-container-gastos" style="position: relative;">
                        <canvas id="grafico-gastos" style="max-height: 400px;"></canvas>
                        <div id="chart-loading-gastos" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è≥</div>
                            <div style="color: var(--gray-600);">Carregando dados...</div>
                        </div>
                        <div class="chart-placeholder" id="placeholder-grafico-gastos" style="display: none;">
                            <div class="chart-content">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
                                <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Gr√°fico de S√©rie Temporal</h3>
                                <p style="color: var(--gray-600); max-width: 500px; margin: 0 auto;">
                                    Selecione os filtros acima para visualizar os dados do gr√°fico.
                                </p>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Legenda do Gr√°fico -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 30px; height: 3px; background: #10b981;"></div>
                            <span style="font-size: 0.875rem; color: var(--gray-700);">Dados Reais</span>
                        </div>
                        <div id="legenda-projecao-gastos" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 30px; height: 3px; background: #667eea; border-top: 2px dashed #764ba2;"></div>
                                <span style="font-size: 0.875rem; color: var(--gray-700);">üîÆ Proje√ß√£o at√© <strong id="projecao-data-fim-legenda-gastos">Dez/2026</strong></span>
                            </div>
                        </div>
                        <div id="legenda-linha-divisoria-gastos" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 30px; height: 2px; background: #f59e0b; opacity: 0.6;"></div>
                                <span style="font-size: 0.875rem; color: var(--gray-700);">√öltimo Dado Real</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- M√©tricas de Proje√ß√£o Gastos -->
            <section id="metricas-projecao-gastos" class="card fade-in" style="display: none !important; margin-bottom: 2rem; border: 2px solid #667eea;">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h2 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üîÆ</span> M√©tricas de Proje√ß√£o de Gastos
                    </h2>
                </div>
                <div class="card-body">
                    <div class="legend-grid">
                        <div class="metric-card">
                            <div class="metric-label">üí∞ M√©dia Hist√≥rica</div>
                            <div class="metric-value">R$ <span id="media-periodo-gastos">0</span></div>
                            <div class="metric-subtitle">Gasto m√©dio por per√≠odo</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">üìà Tend√™ncia</div>
                            <div class="metric-value" id="tendencia-gastos">-</div>
                            <div class="metric-subtitle">Dire√ß√£o identificada</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">‚è∞ Per√≠odo Projetado</div>
                            <div class="metric-value" id="periodos-projetados-gastos">6</div>
                            <div class="metric-subtitle">meses √† frente</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Desvios e Conformidade (oculto por enquanto) -->
            <div style="display: none;" id="tab-desvios">
                <section class="card fade-in">
                    <div class="card-header">
                        <h3 style="margin: 0;">‚ö†Ô∏è Desvios e Conformidade</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-placeholder">
                            <div class="chart-content">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                                <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">Desvios e Conformidade</h3>
                                <p style="color: var(--gray-600); max-width: 500px; margin: 0 auto;">
                                    An√°lise de desvios entre valores planejados e executados em desenvolvimento.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Conte√∫do Aba: Comparativo -->
            <div class="tab-content" id="tab-comparativo" style="display: none;">
                <section class="card fade-in">
                    <div class="card-header">
                        <h3 style="margin: 0;">üìä Comparativo</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-placeholder">
                            <div class="chart-content">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
                                <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">An√°lise Comparativa</h3>
                                <p style="color: var(--gray-600); max-width: 500px; margin: 0 auto;">
                                    Compara√ß√£o entre diferentes unidades, lotes e per√≠odos em desenvolvimento.
                                </p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

        </div>
    </main>

    <!-- Modal de Confirma√ß√£o de Logout -->
    <!-- Modal de Exporta√ß√£o -->
    <div id="modal-exportacao" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 11000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">üìä</div>
                <h3 style="margin-bottom: 0.5rem; color: var(--primary-color);">Exportar Relat√≥rios</h3>
                <p style="margin: 0; color: var(--gray-600); font-size: 0.95rem;">Selecione os gr√°ficos e o formato de exporta√ß√£o</p>
            </div>
            
            <!-- Sele√ß√£o de Gr√°ficos -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: var(--gray-700); font-size: 1rem; font-weight: 600;">üìà Gr√°ficos para Exportar</h4>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-refeicoes-total" value="refeicoes-total" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Refei√ß√µes - Total Geral</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-refeicoes-unidade" value="refeicoes-unidade" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Refei√ß√µes - Por Unidade</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-gastos-total" value="gastos-total" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Gastos - Total Geral</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="export-option">
                        <input type="checkbox" id="export-gastos-unidade" value="gastos-unidade" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; color: var(--gray-700); font-weight: 500;">Evolu√ß√£o de Gastos - Por Unidade</span>
                    </label>
                </div>
            </div>
            
            <!-- Tipo de Visualiza√ß√£o (Normal/Acumulada) -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem; color: var(--gray-700); font-size: 1rem; font-weight: 600;">üìä Tipo de Visualiza√ß√£o</h4>
                <div style="display: flex; gap: 0.75rem;">
                    <label style="flex: 1; display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="export-tipo" value="normal" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: var(--gray-700); font-weight: 500;">Normal</span>
                    </label>
                    
                    <label style="flex: 1; display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                        <input type="radio" name="export-tipo" value="acumulada" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: var(--gray-700); font-weight: 500;">Acumulada</span>
                    </label>
                </div>
            </div>
            
            <!-- Formato de Exporta√ß√£o -->
            <div style="margin-bottom: 2rem;">
                <h4 style="margin-bottom: 1rem; color: var(--gray-700); font-size: 1rem; font-weight: 600;">üíæ Formato de Exporta√ß√£o</h4>
                <div style="display: flex; gap: 0.75rem;">
                    <label style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1.25rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="export-formato" value="imagens" checked style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="font-size: 2rem;">üñºÔ∏è</div>
                        <span style="color: var(--gray-700); font-weight: 600; text-align: center;">Imagens PNG<br><small style="font-weight: 400; color: var(--gray-500);">(arquivo ZIP)</small></span>
                    </label>
                    
                    <label style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1.25rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="export-formato" value="pdf" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="font-size: 2rem;">üìÑ</div>
                        <span style="color: var(--gray-700); font-weight: 600; text-align: center;">PDF<br><small style="font-weight: 400; color: var(--gray-500);">(paisagem)</small></span>
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="btn-cancelar-exportacao" style="min-width: 120px;">Cancelar</button>
                <button class="btn" id="btn-confirmar-exportacao" style="min-width: 160px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none;">
                    üì• Exportar
                </button>
            </div>
        </div>
    </div>

    <div id="modal-confirmacao-logout" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 11000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">üëã</div>
                <h3 style="margin-bottom: 1rem; color: #f59e0b;">Sair do Sistema</h3>
                <p style="margin: 0; color: var(--gray-700); line-height: 1.5; font-size: 1rem;">
                    Tem certeza que deseja sair do sistema?
                </p>
            </div>
            
            <div style="padding: 1rem; background-color: #fffbeb; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 2rem;">
                <p style="font-size: 0.875rem; margin: 0; color: #92400e;">
                    <strong>‚ÑπÔ∏è Informa√ß√£o:</strong> Voc√™ precisar√° fazer login novamente para acessar o sistema.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-secondary" id="btn-cancelar-logout" style="min-width: 120px;">Cancelar</button>
                <button class="btn" id="btn-confirmar-logout" style="min-width: 120px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;">Sair</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p style="margin: 0; color: var(--gray-400); font-size: 0.875rem;">
                ¬© 2025 SGMRP - Sistema de Gerenciamento de Mapas de Refei√ß√µes Penitenci√°rio
            </p>
        </div>
    </footer>

    <script>
        // Mapeamento de lotes para unidades (do backend)
        const lotesUnidadesMap = {{ lotes_unidades|tojson }};
        console.log('Mapeamento lotes -> unidades:', lotesUnidadesMap);
        
        // Vari√°vel global para o gr√°fico
        let chartInstance = null;
        let modoVisualizacao = 'acumulado'; // 'acumulado', 'unidade', 'lote'
        let tipoVisualizacao = 'normal'; // 'normal', 'acumulada'
        
        // Vari√°veis para gr√°fico de gastos
        let chartInstanceGastos = null;
        let projecaoAtivaGastos = false;
        
        // Fun√ß√£o para mostrar notifica√ß√£o customizada
        function mostrarNotificacao(titulo, mensagem, tipo = 'info', duracao = 5000) {
            // Criar elemento de notifica√ß√£o
            const notification = document.createElement('div');
            notification.className = 'custom-notification';
            
            // √çcones por tipo
            const icones = {
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå',
                'success': '‚úÖ',
                'info': '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div class="notification-content ${tipo}">
                    <div class="notification-icon">${icones[tipo] || icones['info']}</div>
                    <div class="notification-body">
                        <div class="notification-title">${titulo}</div>
                        <div class="notification-message">${mensagem}</div>
                    </div>
                    <button class="notification-close" onclick="this.closest('.custom-notification').remove()">‚úï</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remover ap√≥s dura√ß√£o
            setTimeout(() => {
                notification.classList.add('closing');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, duracao);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Controlar bot√µes de TIPO de visualiza√ß√£o (Normal vs Acumulada)
            document.querySelectorAll('.btn-tipo').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    
                    document.querySelectorAll('.btn-tipo').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'transparent';
                        b.style.color = 'var(--gray-700)';
                    });
                    
                    this.classList.add('active');
                    this.style.background = 'var(--primary-color)';
                    this.style.color = 'white';
                    
                    tipoVisualizacao = this.dataset.tipo;
                    console.log('üìä Tipo de visualiza√ß√£o alterado para:', tipoVisualizacao);
                    
                    // Recarregar ambos os gr√°ficos
                    carregarGrafico();
                    carregarGraficoGastos();
                });
            });
            
            // Controlar bot√µes de MODO de visualiza√ß√£o (Total/Unidade/Lote)
            document.querySelectorAll('.btn-modo').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    
                    // Remover active de todos
                    document.querySelectorAll('.btn-modo').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'transparent';
                        b.style.color = 'var(--gray-700)';
                    });
                    
                    // Adicionar active ao clicado
                    this.classList.add('active');
                    this.style.background = 'var(--primary-color)';
                    this.style.color = 'white';
                    
                    // Atualizar modo
                    modoVisualizacao = this.dataset.modo;
                    console.log('üîÑ Modo de agrupamento alterado para:', modoVisualizacao);
                    
                    // Atualizar estado do bot√£o de proje√ß√£o
                    atualizarBotaoProjecao();
                    
                    // Recarregar ambos os gr√°ficos
                    carregarGrafico();
                    carregarGraficoGastos();
                });
            });
            
            // Fun√ß√£o para atualizar estado do bot√£o de proje√ß√£o
            function atualizarBotaoProjecao() {
                // Proje√ß√£o habilitada para todos os modos
                const btnProjecao = document.getElementById('btn-toggle-projecao');
                btnProjecao.style.opacity = '1';
                btnProjecao.style.cursor = 'pointer';
                btnProjecao.title = 'Ativar proje√ß√£o de 6 meses baseada em dados hist√≥ricos';
                
                // Atualizar tamb√©m o bot√£o de proje√ß√£o de gastos
                const btnProjecaoGastos = document.getElementById('btn-toggle-projecao-gastos');
                if (btnProjecaoGastos) {
                    btnProjecaoGastos.style.opacity = '1';
                    btnProjecaoGastos.style.cursor = 'pointer';
                    btnProjecaoGastos.title = 'Ativar proje√ß√£o de 6 meses baseada em dados hist√≥ricos';
                }
            }
            
            // Controlar estado dos controles baseado na sele√ß√£o de lote
            function atualizarEstadoControles() {
                const loteSelecionado = document.getElementById('filtro-lote').value;
                const temLote = loteSelecionado !== '';
                
                // Bot√µes de Tipo (Normal/Acumulada)
                document.querySelectorAll('.btn-tipo').forEach(btn => {
                    btn.disabled = !temLote;
                    btn.style.opacity = temLote ? '1' : '0.5';
                    btn.style.cursor = temLote ? 'pointer' : 'not-allowed';
                    btn.title = temLote ? '' : 'Selecione um lote primeiro';
                });
                
                // Bot√µes de Agrupamento (Total Geral/Por Unidade)
                document.querySelectorAll('.btn-modo').forEach(btn => {
                    btn.disabled = !temLote;
                    btn.style.opacity = temLote ? '1' : '0.5';
                    btn.style.cursor = temLote ? 'pointer' : 'not-allowed';
                    btn.title = temLote ? '' : 'Selecione um lote primeiro';
                });
                
                // Bot√µes de Proje√ß√£o
                const btnProjecao = document.getElementById('btn-toggle-projecao');
                if (btnProjecao) {
                    btnProjecao.disabled = !temLote;
                    btnProjecao.style.opacity = temLote ? '1' : '0.5';
                    btnProjecao.style.cursor = temLote ? 'pointer' : 'not-allowed';
                    btnProjecao.title = temLote ? 'Ativar proje√ß√£o de 6 meses baseada em dados hist√≥ricos' : 'Selecione um lote primeiro';
                }
                
                const btnProjecaoGastos = document.getElementById('btn-toggle-projecao-gastos');
                if (btnProjecaoGastos) {
                    btnProjecaoGastos.disabled = !temLote;
                    btnProjecaoGastos.style.opacity = temLote ? '1' : '0.5';
                    btnProjecaoGastos.style.cursor = temLote ? 'pointer' : 'not-allowed';
                    btnProjecaoGastos.title = temLote ? 'Ativar proje√ß√£o de 6 meses baseada em dados hist√≥ricos' : 'Selecione um lote primeiro';
                }
            }
            

            
            // Sistema de abas removido - gr√°ficos agora s√£o exibidos simultaneamente

            // Controle das abas de estat√≠sticas
            const statTabButtons = document.querySelectorAll('.tab-btn[data-stat-tab]');
            statTabButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    statTabButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const statTab = this.dataset.statTab;
                    document.querySelectorAll('.stat-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    document.getElementById(statTab).style.display = 'block';
                });
            });

            // Aplicar filtros automaticamente ao mudar qualquer campo
            function aplicarFiltrosRelatorios() {
                console.log('Aplicando filtros e recarregando gr√°fico...');
                carregarGrafico();
            }
            
            // Garantir que filtros iniciais estejam atualizados antes de carregar o gr√°fico
            setTimeout(() => {
                atualizarCountUnidades();
                atualizarDisplayUnidades();
                atualizarEstadoControles();
            }, 100);
            
            // Fun√ß√£o para carregar dados do gr√°fico
            async function carregarGrafico() {
                try {
                    // Coletar filtros
                    const loteSelecionado = document.getElementById('filtro-lote').value;
                    const lotesSelecionados = loteSelecionado ? [loteSelecionado] : [];
                    
                    const unidadesSelecionadas = Array.from(document.querySelectorAll('.unidade-checkbox')).filter(cb => {
                        return cb.checked && cb.closest('.unidade-item').style.display !== 'none';
                    }).map(cb => cb.value);
                    const periodo = document.getElementById('filtro-periodo').value;
                    
                    // Verificar se h√° lote selecionado
                    if (lotesSelecionados.length === 0) {
                        console.log('‚ö†Ô∏è Nenhum lote selecionado - exibindo placeholder');
                        document.getElementById('chart-placeholder').style.display = 'flex';
                        document.getElementById('chart-loading').style.display = 'none';
                        if (chartInstance) {
                            chartInstance.destroy();
                            chartInstance = null;
                        }
                        return;
                    }
                    
                    console.log('üìä Carregando gr√°fico:', { lotesSelecionados, unidadesSelecionadas, periodo });
                    
                    // Mostrar loading
                    document.getElementById('chart-loading').style.display = 'block';
                    document.getElementById('chart-placeholder').style.display = 'none';
                    
                    // Fazer requisi√ß√£o
                    const payload = {
                        lotes: lotesSelecionados,
                        unidades: unidadesSelecionadas,
                        periodo: periodo,
                        modo: modoVisualizacao,
                        projecao: projecaoAtiva
                    };
                    
                    console.log('üì§ Enviando requisi√ß√£o:', payload);
                    
                    const response = await fetch('/api/relatorios/dados-grafico', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    const resultado = await response.json();
                    console.log('üì• Resposta recebida:', resultado);
                    
                    document.getElementById('chart-loading').style.display = 'none';
                    
                    if (resultado.success) {
                        console.log('‚úÖ Dados recebidos:', resultado);
                        
                        // Verificar se h√° dados para exibir
                        const temDados = resultado.total_registros > 0 && 
                                        resultado.dados.labels && 
                                        resultado.dados.labels.length > 0;
                        
                        const temGrupos = resultado.dados.grupos && resultado.dados.grupos.length > 0;
                        
                        if (!temDados && !temGrupos) {
                            console.log('‚ö†Ô∏è Nenhum dado para exibir');
                            if (chartInstance) {
                                chartInstance.destroy();
                                chartInstance = null;
                            }
                            document.getElementById('chart-placeholder').style.display = 'flex';
                            document.getElementById('grafico-principal').style.display = 'none';
                        } else {
                            console.log('‚úÖ Exibindo gr√°fico - Dados v√°lidos encontrados');
                            document.getElementById('chart-placeholder').style.display = 'none';
                            document.getElementById('grafico-principal').style.display = 'block';
                            renderizarGrafico(resultado.dados);
                        }
                    } else {
                        console.error('‚ùå Erro ao buscar dados:', resultado.error);
                        alert('Erro ao carregar dados do gr√°fico: ' + resultado.error);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro na requisi√ß√£o:', error);
                    document.getElementById('chart-loading').style.display = 'none';
                    document.getElementById('chart-placeholder').style.display = 'block';
                }
            }
            
            // Fun√ß√£o para acumular valores
            function acumularDados(valores) {
                if (!valores || valores.length === 0) return [];
                
                const acumulados = [];
                let soma = 0;
                let iniciado = false; // Flag para saber se j√° encontrou primeiro valor n√£o-null
                
                for (let i = 0; i < valores.length; i++) {
                    if (valores[i] === null || valores[i] === undefined) {
                        // Se ainda n√£o iniciou, manter null
                        // Se j√° iniciou, manter o √∫ltimo valor acumulado
                        acumulados.push(iniciado ? soma : null);
                    } else {
                        iniciado = true;
                        soma += valores[i];
                        acumulados.push(soma);
                    }
                }
                return acumulados;
            }
            
            // Fun√ß√£o para renderizar o gr√°fico com Chart.js
            function renderizarGrafico(dados) {
                const ctx = document.getElementById('grafico-principal').getContext('2d');
                
                console.log('üé® Renderizar gr√°fico - Dados recebidos:', dados);
                console.log('üìä Modo:', dados.modo, '| Tipo:', tipoVisualizacao);
                console.log('üîÆ Proje√ß√£o?', dados.projecao ? 'SIM' : 'N√ÉO');
                if (dados.projecao) {
                    console.log('üìà Dados de proje√ß√£o:', dados.projecao);
                }
                
                // Destruir gr√°fico anterior se existir
                if (chartInstance) {
                    chartInstance.destroy();
                }
                
                // Preparar datasets baseado no modo
                let datasets = [];
                const cores = [
                    { border: 'rgb(75, 192, 192)', bg: 'rgba(75, 192, 192, 0.1)' },
                    { border: 'rgb(255, 99, 132)', bg: 'rgba(255, 99, 132, 0.1)' },
                    { border: 'rgb(54, 162, 235)', bg: 'rgba(54, 162, 235, 0.1)' },
                    { border: 'rgb(255, 206, 86)', bg: 'rgba(255, 206, 86, 0.1)' },
                    { border: 'rgb(153, 102, 255)', bg: 'rgba(153, 102, 255, 0.1)' },
                    { border: 'rgb(255, 159, 64)', bg: 'rgba(255, 159, 64, 0.1)' },
                    { border: 'rgb(201, 203, 207)', bg: 'rgba(201, 203, 207, 0.1)' },
                    { border: 'rgb(83, 211, 87)', bg: 'rgba(83, 211, 87, 0.1)' },
                    { border: 'rgb(237, 100, 127)', bg: 'rgba(237, 100, 127, 0.1)' },
                    { border: 'rgb(155, 89, 182)', bg: 'rgba(155, 89, 182, 0.1)' }
                ];
                
                // Preparar labels combinando hist√≥rico + proje√ß√£o
                let allLabels = dados.labels_formatados || dados.labels;
                
                if (dados.projecao && dados.projecao.labels_formatados) {
                    allLabels = [...allLabels, ...dados.projecao.labels_formatados];
                }
                
                if (dados.modo === 'acumulado') {
                    // Modo acumulado - uma √∫nica linha com total
                    let dataHistorico = dados.datasets.total_refeicoes;
                    console.log('üîç Dados hist√≥ricos originais:', dataHistorico);
                    let dataProjecao = [];
                    
                    // Aplicar acumula√ß√£o se tipo for 'acumulada'
                    if (tipoVisualizacao === 'acumulada') {
                        dataHistorico = acumularDados(dataHistorico);
                        console.log('üìä Dados hist√≥ricos ACUMULADOS:', dataHistorico);
                    }
                    
                    // Se tem proje√ß√£o, adicionar valores
                    if (dados.projecao && dados.projecao.valores) {
                        dataProjecao = dados.projecao.valores;
                        // Se acumulada, continuar acumulando na proje√ß√£o
                        if (tipoVisualizacao === 'acumulada' && dataHistorico.length > 0) {
                            let ultimoValorHistorico = dataHistorico[dataHistorico.length - 1];
                            dataProjecao = dataProjecao.map(v => {
                                ultimoValorHistorico += v;
                                return ultimoValorHistorico;
                            });
                        }
                    }
                    
                    // Dataset de dados hist√≥ricos
                    datasets.push({
                        label: 'Total de Refei√ß√µes (Real)',
                        data: [...dataHistorico, ...Array(dataProjecao.length).fill(null)],
                        borderColor: cores[0].border,
                        backgroundColor: cores[0].bg,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        segment: {
                            borderDash: ctx => ctx.p0DataIndex >= dataHistorico.length ? [5, 5] : undefined
                        }
                    });
                    
                    // Dataset de proje√ß√£o (se dispon√≠vel)
                    if (dataProjecao.length > 0) {
                        // Pegar √∫ltimo valor real para conectar com a proje√ß√£o
                        const ultimoValorReal = dataHistorico[dataHistorico.length - 1];
                        
                        // Criar array com ponto de conex√£o: √∫ltimo real + valores projetados
                        const dataProjecaoComConexao = [ultimoValorReal, ...dataProjecao];
                        
                        datasets.push({
                            label: 'Proje√ß√£o (IA)',
                            data: [...Array(dataHistorico.length - 1).fill(null), ...dataProjecaoComConexao],
                            borderColor: 'rgb(139, 92, 246)',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            fill: true,
                            tension: 0.4,
                            pointStyle: 'triangle',
                            pointRadius: 6
                        });
                        
                        // Atualizar m√©tricas de proje√ß√£o
                        if (dados.projecao.media_historica) {
                            const mediaPeriodo = document.getElementById('media-periodo');
                            if (mediaPeriodo) {
                                mediaPeriodo.textContent = dados.projecao.media_historica.toLocaleString('pt-BR');
                            }
                        }
                        if (dados.projecao.tendencia) {
                            const tendenciaTexto = dados.projecao.tendencia === 'crescimento' ? 'üìà Crescimento' : 
                                                   dados.projecao.tendencia === 'decrescimento' ? 'üìâ Decrescimento' : '‚û°Ô∏è Est√°vel';
                            const tendenciaDados = document.getElementById('tendencia-dados');
                            if (tendenciaDados) {
                                tendenciaDados.textContent = tendenciaTexto;
                            }
                        }
                        // Atualizar data fim da proje√ß√£o
                        if (dados.projecao.labels_formatados && dados.projecao.labels_formatados.length > 0) {
                            const ultimoMes = dados.projecao.labels_formatados[dados.projecao.labels_formatados.length - 1];
                            const dataFimContrato = document.getElementById('data-fim-contrato');
                            const projecaoDataFimLegenda = document.getElementById('projecao-data-fim-legenda');
                            if (dataFimContrato) {
                                dataFimContrato.textContent = ultimoMes;
                            }
                            if (projecaoDataFimLegenda) {
                                projecaoDataFimLegenda.textContent = ultimoMes;
                            }
                        }
                    }
                } else if (dados.modo === 'unidade' || dados.modo === 'lote') {
                    // Modo por unidade ou lote - m√∫ltiplas linhas
                    const grupos = dados.grupos || [];
                    
                    // Fun√ß√£o para escurecer cor
                    function escurecerCor(rgbString) {
                        const match = rgbString.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                        if (match) {
                            const r = Math.max(0, parseInt(match[1]) - 40);
                            const g = Math.max(0, parseInt(match[2]) - 40);
                            const b = Math.max(0, parseInt(match[3]) - 40);
                            return `rgb(${r}, ${g}, ${b})`;
                        }
                        return rgbString;
                    }
                    
                    // Determinar quantos per√≠odos de proje√ß√£o
                    const numPeriodosProjecao = dados.projecao && dados.projecao.labels ? dados.projecao.labels.length : 0;
                    
                    // Adicionar linhas dos grupos hist√≥ricos
                    grupos.forEach((grupo, index) => {
                        const corIndex = index % cores.length;
                        let valoresGrupo = grupo.valores;
                        
                        // Aplicar acumula√ß√£o se tipo for 'acumulada'
                        if (tipoVisualizacao === 'acumulada') {
                            valoresGrupo = acumularDados(valoresGrupo);
                        }
                        
                        datasets.push({
                            label: grupo.nome,
                            data: valoresGrupo,
                            borderColor: cores[corIndex].border,
                            backgroundColor: cores[corIndex].bg,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        });
                    });
                    
                    // Se tem proje√ß√£o por grupo, adicionar linha de proje√ß√£o para cada grupo
                    if (dados.projecao && dados.projecao.grupos_projetados && dados.projecao.grupos_projetados.length > 0) {
                        dados.projecao.grupos_projetados.forEach((grupoProj, index) => {
                            const corIndex = index % cores.length;
                            const corEscura = escurecerCor(cores[corIndex].border);
                            const numPeriodosHistoricos = grupos[0] ? grupos[0].valores.length : 0;
                            
                            // Pegar valores j√° processados (acumulados ou n√£o) do dataset correspondente
                            // O dataset foi criado no loop anterior com os valores corretos
                            const datasetHistorico = datasets.find(ds => ds.label === grupoProj.nome);
                            const valoresGrupoHistorico = datasetHistorico ? datasetHistorico.data : [];
                            
                            const ultimoValorRealGrupo = valoresGrupoHistorico.length > 0 ? valoresGrupoHistorico[valoresGrupoHistorico.length - 1] : 0;
                            
                            // Criar array de proje√ß√£o
                            let valoresProjecaoGrupo = grupoProj.valores;
                            
                            // Se acumulada, acumular tamb√©m a proje√ß√£o
                            if (tipoVisualizacao === 'acumulada' && ultimoValorRealGrupo > 0) {
                                let acumulado = ultimoValorRealGrupo;
                                valoresProjecaoGrupo = valoresProjecaoGrupo.map(v => {
                                    acumulado += v;
                                    return acumulado;
                                });
                            }
                            
                            // Criar array com ponto de conex√£o
                            const dataProjecaoGrupo = [ultimoValorRealGrupo, ...valoresProjecaoGrupo];
                            
                            datasets.push({
                                label: `${grupoProj.nome} (Proje√ß√£o)`,
                                data: [...Array(numPeriodosHistoricos - 1).fill(null), ...dataProjecaoGrupo],
                                borderColor: corEscura,
                                backgroundColor: cores[corIndex].bg,
                                borderWidth: 2,
                                borderDash: [10, 5],
                                fill: false,
                                tension: 0.4,
                                pointStyle: 'triangle',
                                pointRadius: 4
                            });
                        });
                    }
                    
                    // Atualizar m√©tricas de proje√ß√£o (se houver proje√ß√£o)
                    if (dados.projecao) {
                        if (dados.projecao.media_historica) {
                            const mediaPeriodo = document.getElementById('media-periodo');
                            if (mediaPeriodo) {
                                mediaPeriodo.textContent = dados.projecao.media_historica.toLocaleString('pt-BR');
                            }
                        }
                        if (dados.projecao.tendencia) {
                            const tendenciaTexto = dados.projecao.tendencia === 'crescimento' ? 'üìà Crescimento' : 
                                                   dados.projecao.tendencia === 'decrescimento' ? 'üìâ Decrescimento' : '‚û°Ô∏è Est√°vel';
                            const tendenciaDados = document.getElementById('tendencia-dados');
                            if (tendenciaDados) {
                                tendenciaDados.textContent = tendenciaTexto;
                            }
                        }
                        // Atualizar data fim da proje√ß√£o
                        if (dados.projecao.labels_formatados && dados.projecao.labels_formatados.length > 0) {
                            const ultimoMes = dados.projecao.labels_formatados[dados.projecao.labels_formatados.length - 1];
                            const dataFimContrato = document.getElementById('data-fim-contrato');
                            const projecaoDataFimLegenda = document.getElementById('projecao-data-fim-legenda');
                            if (dataFimContrato) {
                                dataFimContrato.textContent = ultimoMes;
                            }
                            if (projecaoDataFimLegenda) {
                                projecaoDataFimLegenda.textContent = ultimoMes;
                            }
                        }
                    }
                }
                
                // Criar novo gr√°fico
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            title: {
                                display: true,
                                text: 'Evolu√ß√£o de Refei√ß√µes ao Longo do Tempo',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y.toLocaleString('pt-BR');
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico renderizado com sucesso! Modo:', dados.modo);
            }
            
            // Adicionar listener para per√≠odo
            document.getElementById('filtro-periodo').addEventListener('change', function() {
                carregarGrafico();
                carregarGraficoGastos();
            });
            
            // Controle do filtro de Lotes (select dropdown)
            const filtroLote = document.getElementById('filtro-lote');
            
            // Atualizar quando lote for selecionado
            filtroLote.addEventListener('change', function() {
                atualizarUnidadesDisponiveis();
                atualizarEstadoControles();
                
                // Carregar ambos os gr√°ficos
                carregarGrafico();
                carregarGraficoGastos();
            });
            
            // Controle do filtro de Unidades multi-select
            const unidadesDisplay = document.getElementById('unidades-display');
            const unidadesPopup = document.getElementById('unidades-popup');
            const unidadesOverlay = document.getElementById('unidades-overlay');
            const btnSelecionarTodasUnidades = document.getElementById('btn-selecionar-todas-unidades');
            const btnLimparTodasUnidades = document.getElementById('btn-limpar-todas-unidades');
            const btnAplicarUnidades = document.getElementById('btn-aplicar-unidades');
            const btnCancelarUnidades = document.getElementById('btn-cancelar-unidades');
            
            console.log('Elementos de unidades:', { unidadesDisplay, unidadesPopup, unidadesOverlay });
            
            // Abrir popup de unidades
            if (unidadesDisplay) {
                unidadesDisplay.addEventListener('click', function(e) {
                    console.log('Clique no filtro de unidades detectado!');
                    e.stopPropagation();
                    atualizarUnidadesDisponiveis();
                    unidadesPopup.style.display = 'block';
                    unidadesOverlay.style.display = 'block';
                });
            } else {
                console.error('Elemento unidades-display n√£o encontrado!');
            }
            
            // Fechar popup de unidades
            function fecharPopupUnidades() {
                unidadesPopup.style.display = 'none';
                unidadesOverlay.style.display = 'none';
            }
            
            unidadesOverlay.addEventListener('click', fecharPopupUnidades);
            btnCancelarUnidades.addEventListener('click', fecharPopupUnidades);
            
            // Selecionar todas as unidades (apenas as vis√≠veis)
            btnSelecionarTodasUnidades.addEventListener('click', function() {
                document.querySelectorAll('.unidade-checkbox').forEach(cb => {
                    if (cb.closest('.unidade-item').style.display !== 'none') {
                        cb.checked = true;
                    }
                });
                atualizarCountUnidades();
            });
            
            // Limpar todas as unidades (apenas as vis√≠veis)
            btnLimparTodasUnidades.addEventListener('click', function() {
                document.querySelectorAll('.unidade-checkbox').forEach(cb => {
                    if (cb.closest('.unidade-item').style.display !== 'none') {
                        cb.checked = false;
                    }
                });
                atualizarCountUnidades();
            });
            
            // Atualizar contagem de unidades (apenas as vis√≠veis)
            function atualizarCountUnidades() {
                const checkboxes = document.querySelectorAll('.unidade-checkbox');
                let count = 0;
                checkboxes.forEach(cb => {
                    if (cb.closest('.unidade-item').style.display !== 'none' && cb.checked) {
                        count++;
                    }
                });
                document.getElementById('unidades-selecionadas-count').textContent = `${count} unidade${count !== 1 ? 's' : ''} selecionada${count !== 1 ? 's' : ''}`;
            }
            
            // Atualizar display de unidades (considera apenas as vis√≠veis)
            function atualizarDisplayUnidades() {
                const checkboxes = document.querySelectorAll('.unidade-checkbox');
                const unidadesText = document.getElementById('unidades-text');
                
                // Contar vis√≠veis
                let totalVisiveis = 0;
                let selecionados = [];
                
                checkboxes.forEach(cb => {
                    if (cb.closest('.unidade-item').style.display !== 'none') {
                        totalVisiveis++;
                        if (cb.checked) {
                            selecionados.push(cb);
                        }
                    }
                });
                
                if (totalVisiveis === 0) {
                    unidadesText.textContent = 'Nenhuma unidade dispon√≠vel';
                } else if (selecionados.length === 0) {
                    unidadesText.textContent = 'Nenhuma unidade';
                } else if (selecionados.length === totalVisiveis) {
                    unidadesText.textContent = 'Todas as unidades';
                } else if (selecionados.length === 1) {
                    unidadesText.textContent = selecionados[0].nextElementSibling.textContent;
                } else {
                    unidadesText.textContent = `${selecionados.length} unidades`;
                }
            }
            
            // Aplicar filtro de unidades
            btnAplicarUnidades.addEventListener('click', function() {
                atualizarDisplayUnidades();
                fecharPopupUnidades();
                carregarGrafico();
                carregarGraficoGastos();
            });
            
            // Atualizar contagem ao mudar checkboxes
            document.querySelectorAll('.unidade-checkbox').forEach(cb => {
                cb.addEventListener('change', atualizarCountUnidades);
            });
            
            // Fun√ß√£o para atualizar unidades dispon√≠veis baseado nos lotes selecionados
            function atualizarUnidadesDisponiveis() {
                const loteSelecionado = document.getElementById('filtro-lote').value;
                const lotesSelecionados = loteSelecionado ? [loteSelecionado] : [];
                
                console.log('Lotes selecionados:', lotesSelecionados);
                
                // Coletar todas as unidades dos lotes selecionados
                let unidadesDisponiveis = new Set();
                
                if (lotesSelecionados.length === 0) {
                    // Nenhum lote selecionado = nenhuma unidade dispon√≠vel
                    unidadesDisponiveis = new Set();
                } else {
                    // Coletar unidades dos lotes selecionados
                    lotesSelecionados.forEach(loteId => {
                        const unidadesDoLote = lotesUnidadesMap[loteId] || [];
                        unidadesDoLote.forEach(unidade => unidadesDisponiveis.add(unidade));
                    });
                }
                
                console.log('Unidades dispon√≠veis:', Array.from(unidadesDisponiveis));
                
                // Atualizar checkboxes de unidades
                const unidadeItems = document.querySelectorAll('.unidade-item');
                let unidadesVisiveis = 0;
                
                unidadeItems.forEach(item => {
                    const checkbox = item.querySelector('.unidade-checkbox');
                    const unidadeNome = checkbox.value;
                    
                    if (unidadesDisponiveis.has(unidadeNome)) {
                        // Mostrar unidade e marc√°-la automaticamente
                        item.style.display = 'flex';
                        checkbox.checked = true;
                        unidadesVisiveis++;
                    } else {
                        // Ocultar unidade e desmarcar
                        item.style.display = 'none';
                        checkbox.checked = false;
                    }
                });
                
                // Atualizar contagem
                atualizarCountUnidades();
                
                // Atualizar display no filtro principal
                atualizarDisplayUnidades();
                
                // Mensagem se nenhuma unidade dispon√≠vel
                const unidadesList = document.getElementById('unidades-list');
                let mensagemVazia = unidadesList.querySelector('.mensagem-vazia');
                
                if (unidadesVisiveis === 0) {
                    if (!mensagemVazia) {
                        mensagemVazia = document.createElement('div');
                        mensagemVazia.className = 'mensagem-vazia';
                        mensagemVazia.style.cssText = 'padding: 2rem; text-align: center; color: var(--gray-500); font-size: 0.875rem;';
                        mensagemVazia.innerHTML = 'üìã Nenhuma unidade dispon√≠vel<br><small style="font-size: 0.75rem;">Selecione pelo menos um lote</small>';
                        unidadesList.appendChild(mensagemVazia);
                    }
                } else {
                    if (mensagemVazia) {
                        mensagemVazia.remove();
                    }
                }
            }

            // Fun√ß√£o para carregar gr√°fico de GASTOS
            async function carregarGraficoGastos() {
                try {
                    const loteSelecionado = document.getElementById('filtro-lote').value;
                    const lotesSelecionados = loteSelecionado ? [loteSelecionado] : [];
                    
                    const unidadesSelecionadas = Array.from(document.querySelectorAll('.unidade-checkbox:checked')).map(cb => cb.value);
                    const periodo = document.getElementById('filtro-periodo').value;
                    
                    // Verificar se h√° lote selecionado
                    if (lotesSelecionados.length === 0) {
                        console.log('‚ö†Ô∏è Nenhum lote selecionado - exibindo placeholder de gastos');
                        document.getElementById('placeholder-grafico-gastos').style.display = 'flex';
                        document.getElementById('grafico-gastos').style.display = 'none';
                        if (chartInstanceGastos) {
                            chartInstanceGastos.destroy();
                            chartInstanceGastos = null;
                        }
                        return;
                    }
                    
                    console.log('üí∞ Carregando gr√°fico gastos:', { lotesSelecionados, unidadesSelecionadas, periodo, modo: modoVisualizacao, projecao: projecaoAtivaGastos });
                    
                    const response = await fetch('/api/relatorios/dados-gastos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            lotes: lotesSelecionados,
                            unidades: unidadesSelecionadas,
                            periodo: periodo,
                            modo: modoVisualizacao,
                            projecao: projecaoAtivaGastos
                        })
                    });
                    
                    const resultado = await response.json();
                    
                    if (resultado.success) {
                        const dados = resultado.dados;
                        const temDados = resultado.total_registros > 0 && dados.labels && dados.labels.length > 0;
                        const temGrupos = dados.grupos && dados.grupos.length > 0;
                        
                        if (!temDados && !temGrupos) {
                            document.getElementById('chart-container-gastos').style.display = 'none';
                            document.getElementById('placeholder-grafico-gastos').style.display = 'flex';
                        } else {
                            document.getElementById('chart-container-gastos').style.display = 'block';
                            document.getElementById('placeholder-grafico-gastos').style.display = 'none';
                            renderizarGraficoGastos(dados);
                            
                            // Atualizar informa√ß√µes de proje√ß√£o se ativa
                            if (projecaoAtivaGastos && dados.projecao) {
                                document.getElementById('projecao-info-gastos').style.display = 'block';
                                document.getElementById('legenda-projecao-gastos').style.display = 'block';
                                document.getElementById('legenda-linha-divisoria-gastos').style.display = 'block';
                                // document.getElementById('metricas-projecao-gastos').style.display = 'block'; // Se√ß√£o oculta permanentemente
                                
                                const ultimoMes = dados.projecao.labels_formatados[dados.projecao.labels_formatados.length - 1];
                                const dataFimContrato = document.getElementById('data-fim-contrato-gastos');
                                const dataFimLegenda = document.getElementById('projecao-data-fim-legenda-gastos');
                                if (dataFimContrato && ultimoMes) dataFimContrato.textContent = ultimoMes;
                                if (dataFimLegenda && ultimoMes) dataFimLegenda.textContent = ultimoMes;
                                
                                // M√©tricas
                                const mediaPeriodo = document.getElementById('media-periodo-gastos');
                                if (mediaPeriodo) mediaPeriodo.textContent = dados.projecao.media_historica.toLocaleString('pt-BR');
                                
                                const tendencia = document.getElementById('tendencia-gastos');
                                if (tendencia) {
                                    const tendenciaTexto = dados.projecao.tendencia === 'crescimento' ? 'üìà Crescimento' :
                                                          dados.projecao.tendencia === 'decrescimento' ? 'üìâ Decrescimento' : '‚û°Ô∏è Est√°vel';
                                    tendencia.textContent = tendenciaTexto;
                                    tendencia.style.color = dados.projecao.tendencia === 'crescimento' ? '#10b981' :
                                                           dados.projecao.tendencia === 'decrescimento' ? '#ef4444' : '#6b7280';
                                }
                            } else {
                                document.getElementById('projecao-info-gastos').style.display = 'none';
                                document.getElementById('legenda-projecao-gastos').style.display = 'none';
                                document.getElementById('legenda-linha-divisoria-gastos').style.display = 'none';
                                // document.getElementById('metricas-projecao-gastos').style.display = 'none'; // J√° est√° permanentemente oculta
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar gr√°fico gastos:', error);
                    mostrarNotificacao('Erro', 'Falha ao carregar gr√°fico de gastos', 'error');
                }
            }
            
            // Fun√ß√£o para renderizar gr√°fico de GASTOS
            function renderizarGraficoGastos(dados) {
                const ctx = document.getElementById('grafico-gastos').getContext('2d');
                
                if (chartInstanceGastos) {
                    chartInstanceGastos.destroy();
                }
                
                let datasets = [];
                const cores = [
                    'rgb(59, 130, 246)', 'rgb(16, 185, 129)', 'rgb(245, 158, 11)', 
                    'rgb(239, 68, 68)', 'rgb(139, 92, 246)', 'rgb(236, 72, 153)',
                    'rgb(20, 184, 166)', 'rgb(251, 146, 60)', 'rgb(168, 85, 247)',
                    'rgb(34, 197, 94)'
                ];
                
                let allLabels = dados.labels_formatados || dados.labels;
                
                if (dados.projecao && dados.projecao.labels_formatados) {
                    allLabels = [...allLabels, ...dados.projecao.labels_formatados];
                }
                
                if (dados.modo === 'acumulado') {
                    let dataHistorico = dados.datasets.total_gastos || [];
                    
                    // Aplicar acumula√ß√£o se tipo for 'acumulada'
                    if (tipoVisualizacao === 'acumulada') {
                        dataHistorico = acumularDados(dataHistorico);
                    }
                    
                    datasets.push({
                        label: 'Total de Gastos (R$)',
                        data: dataHistorico,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    });
                    
                    if (dados.projecao && dados.projecao.valores && dados.projecao.valores.length > 0) {
                        let dataProjecao = dados.projecao.valores;
                        
                        // Se acumulada, continuar acumulando na proje√ß√£o
                        if (tipoVisualizacao === 'acumulada' && dataHistorico.length > 0) {
                            let ultimoValorHistorico = dataHistorico[dataHistorico.length - 1];
                            dataProjecao = dataProjecao.map(v => {
                                ultimoValorHistorico += v;
                                return ultimoValorHistorico;
                            });
                        }
                        
                        const ultimoValorReal = dataHistorico[dataHistorico.length - 1];
                        const dataProjecaoComConexao = [ultimoValorReal, ...dataProjecao];
                        
                        datasets.push({
                            label: 'Proje√ß√£o de Gastos (R$)',
                            data: [...Array(dataHistorico.length - 1).fill(null), ...dataProjecaoComConexao],
                            borderColor: 'rgb(139, 92, 246)',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointStyle: 'triangle'
                        });
                    }
                } else if (dados.modo === 'unidade' || dados.modo === 'lote') {
                    dados.grupos.forEach((grupo, index) => {
                        let valoresGrupo = grupo.valores;
                        
                        // Aplicar acumula√ß√£o se tipo for 'acumulada'
                        if (tipoVisualizacao === 'acumulada') {
                            valoresGrupo = acumularDados(valoresGrupo);
                        }
                        
                        datasets.push({
                            label: grupo.nome,
                            data: valoresGrupo,
                            borderColor: cores[index % cores.length],
                            backgroundColor: cores[index % cores.length].replace('rgb', 'rgba').replace(')', ', 0.1)'),
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        });
                        
                        if (dados.projecao && dados.projecao.grupos_projetados) {
                            const grupoProj = dados.projecao.grupos_projetados.find(g => g.nome === grupo.nome);
                            if (grupoProj && grupoProj.valores.length > 0) {
                                // Buscar o dataset correspondente j√° com valores acumulados (se aplic√°vel)
                                const datasetHistorico = datasets.find(ds => ds.label === grupoProj.nome);
                                const valoresHistoricosGrupo = datasetHistorico ? datasetHistorico.data : [];
                                
                                const ultimoValorRealGrupo = valoresHistoricosGrupo[valoresHistoricosGrupo.length - 1];
                                
                                // Preparar valores de proje√ß√£o
                                let valoresProjecaoGrupo = grupoProj.valores;
                                
                                // Se acumulada, acumular tamb√©m a proje√ß√£o
                                if (tipoVisualizacao === 'acumulada' && ultimoValorRealGrupo > 0) {
                                    let acumulado = ultimoValorRealGrupo;
                                    valoresProjecaoGrupo = valoresProjecaoGrupo.map(v => {
                                        acumulado += v;
                                        return acumulado;
                                    });
                                }
                                
                                const dataProjecaoGrupo = [ultimoValorRealGrupo, ...valoresProjecaoGrupo];
                                
                                const corBase = cores[index % cores.length];
                                const corEscura = corBase.replace('rgb(', '').replace(')', '').split(',')
                                    .map(c => Math.max(0, parseInt(c.trim()) - 40))
                                    .join(',');
                                
                                datasets.push({
                                    label: `${grupoProj.nome} (Proje√ß√£o)`,
                                    data: [...Array(valoresHistoricosGrupo.length - 1).fill(null), ...dataProjecaoGrupo],
                                    borderColor: `rgb(${corEscura})`,
                                    backgroundColor: 'transparent',
                                    borderWidth: 2.5,
                                    borderDash: [10, 5],
                                    fill: false,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointHoverRadius: 6,
                                    pointStyle: 'triangle'
                                });
                            }
                        }
                    });
                }
                
                // Adicionar linhas de valor contratual APENAS em modo acumulada
                if (tipoVisualizacao === 'acumulada' && dados.valores_contratuais && dados.valores_contratuais.length > 0) {
                    const coresContratuais = [
                        'rgb(220, 38, 38)',   // vermelho
                        'rgb(234, 88, 12)',   // laranja
                        'rgb(202, 138, 4)',   // amarelo escuro
                        'rgb(22, 163, 74)',   // verde
                        'rgb(6, 182, 212)',   // ciano
                    ];
                    
                    dados.valores_contratuais.forEach((contrato, idx) => {
                        const linhaValorContratual = Array(allLabels.length).fill(contrato.valor_contratual);
                        const cor = coresContratuais[idx % coresContratuais.length];
                        
                        datasets.push({
                            label: `Valor Contratual - ${contrato.lote_nome}`,
                            data: linhaValorContratual,
                            borderColor: cor,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            borderDash: [8, 4],
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            tension: 0
                        });
                    });
                }
                
                chartInstanceGastos = new Chart(ctx, {
                    type: 'line',
                    data: { labels: allLabels, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            title: {
                                display: true,
                                text: 'Evolu√ß√£o de Gastos ao Longo do Tempo',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        label += 'R$ ' + (context.parsed.y || 0).toLocaleString('pt-BR', {
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2
                                        });
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR', {
                                            minimumFractionDigits: 0,
                                            maximumFractionDigits: 0
                                        });
                                    }
                                },
                                grid: { color: 'rgba(0, 0, 0, 0.05)' }
                            },
                            x: { grid: { display: false } }
                        }
                    }
                });
                
                console.log('‚úÖ Gr√°fico gastos renderizado! Modo:', dados.modo);
            }
            
            // Toggle de Proje√ß√£o GASTOS
            document.getElementById('btn-toggle-projecao-gastos').addEventListener('click', function() {
                if (this.disabled) return;
                
                projecaoAtivaGastos = !projecaoAtivaGastos;
                
                const btnProjecao = this;
                
                if (projecaoAtivaGastos) {
                    btnProjecao.textContent = '‚úñÔ∏è Desativar Proje√ß√£o';
                    btnProjecao.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                } else {
                    btnProjecao.textContent = 'üîÆ Ativar Proje√ß√£o';
                    btnProjecao.style.background = '';
                }
                
                carregarGraficoGastos();
            });

            // Toggle de Proje√ß√£o (integrado no gr√°fico)
            let projecaoAtiva = false;
            document.getElementById('btn-toggle-projecao').addEventListener('click', function() {
                if (this.disabled) return;
                
                projecaoAtiva = !projecaoAtiva;
                
                const btnProjecao = this;
                const projecaoInfo = document.getElementById('projecao-info');
                const metricasProjecao = document.getElementById('metricas-projecao');
                const legendaProjecao = document.getElementById('legenda-projecao');
                const legendaLinhaDivisoria = document.getElementById('legenda-linha-divisoria');
                
                if (projecaoAtiva) {
                    // Ativar proje√ß√£o
                    btnProjecao.textContent = '‚úñÔ∏è Desativar Proje√ß√£o';
                    btnProjecao.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    btnProjecao.style.color = 'white';
                    projecaoInfo.style.display = 'flex';
                    // metricasProjecao.style.display = 'block'; // Se√ß√£o oculta permanentemente
                    legendaProjecao.style.display = 'block';
                    legendaLinhaDivisoria.style.display = 'block';
                    
                    // Anima√ß√£o suave - comentada pois m√©tricas est√£o ocultas
                    // metricasProjecao.style.opacity = '0';
                    // metricasProjecao.style.transform = 'translateY(20px)';
                    // setTimeout(() => {
                    //     metricasProjecao.style.transition = 'all 0.5s ease';
                    //     metricasProjecao.style.opacity = '1';
                    //     metricasProjecao.style.transform = 'translateY(0)';
                    // }, 10);
                    
                    // Scroll suave at√© as m√©tricas - comentado pois m√©tricas est√£o ocultas
                    // setTimeout(() => {
                    //     metricasProjecao.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    // }, 300);
                    
                    console.log('üîÆ Proje√ß√£o ativada - Recarregando gr√°fico com dados projetados');
                    carregarGrafico();
                } else {
                    // Desativar proje√ß√£o
                    btnProjecao.textContent = 'üîÆ Ativar Proje√ß√£o';
                    btnProjecao.style.background = '';
                    btnProjecao.style.color = '';
                    projecaoInfo.style.display = 'none';
                    // metricasProjecao.style.display = 'none'; // J√° est√° permanentemente oculta
                    legendaProjecao.style.display = 'none';
                    legendaLinhaDivisoria.style.display = 'none';
                    
                    console.log('‚ùå Proje√ß√£o desativada - Recarregando apenas dados reais');
                    carregarGrafico();
                }
            });

            // Exportar relat√≥rio - Modal
            var modalExportacao = document.getElementById('modal-exportacao');
            var btnCancelarExportacao = document.getElementById('btn-cancelar-exportacao');
            var btnConfirmarExportacao = document.getElementById('btn-confirmar-exportacao');
            
            document.getElementById('btn-exportar-relatorio').addEventListener('click', function() {
                const loteId = document.getElementById('filtro-lote').value;
                
                if (!loteId) {
                    mostrarNotificacao(
                        'Aten√ß√£o',
                        'Selecione um lote antes de exportar relat√≥rios.',
                        'warning',
                        3000
                    );
                    return;
                }
                
                modalExportacao.style.display = 'block';
            });
            
            btnCancelarExportacao.addEventListener('click', function() {
                modalExportacao.style.display = 'none';
            });
            
            btnConfirmarExportacao.addEventListener('click', async function() {
                // Coletar checkboxes selecionados
                const graficos = [];
                if (document.getElementById('export-refeicoes-total').checked) graficos.push('refeicoes-total');
                if (document.getElementById('export-refeicoes-unidade').checked) graficos.push('refeicoes-unidade');
                if (document.getElementById('export-gastos-total').checked) graficos.push('gastos-total');
                if (document.getElementById('export-gastos-unidade').checked) graficos.push('gastos-unidade');
                
                if (graficos.length === 0) {
                    mostrarNotificacao(
                        'Aten√ß√£o',
                        'Selecione pelo menos um gr√°fico para exportar.',
                        'warning',
                        3000
                    );
                    return;
                }
                
                // Coletar tipo de visualiza√ß√£o
                const tipo = document.querySelector('input[name="export-tipo"]:checked').value;
                
                // Coletar formato
                const formato = document.querySelector('input[name="export-formato"]:checked').value;
                
                // Fechar modal
                modalExportacao.style.display = 'none';
                
                // Mostrar notifica√ß√£o de processamento
                mostrarNotificacao(
                    'Gerando Relat√≥rio',
                    `Exportando ${graficos.length} gr√°fico(s) em formato ${formato.toUpperCase()}...`,
                    'info',
                    2000
                );
                
                // Aguardar um pouco antes de gerar
                await new Promise(resolve => setTimeout(resolve, 500));
                
                try {
                    console.log('Iniciando exporta√ß√£o:', { formato, tipo, graficos });
                    
                    if (formato === 'imagens') {
                        await exportarComoImagens(graficos, tipo);
                    } else {
                        await exportarComoPDF(graficos, tipo);
                    }
                } catch (error) {
                    console.error('Erro detalhado ao exportar:', error);
                    console.error('Stack trace:', error.stack);
                    mostrarNotificacao(
                        'Erro',
                        `Erro ao gerar relat√≥rio: ${error.message}`,
                        'error',
                        4000
                    );
                }
            });
            
            // Fun√ß√£o para exportar como imagens (ZIP)
            async function exportarComoImagens(graficos, tipo) {
                console.log('üñºÔ∏è Iniciando exporta√ß√£o de imagens');
                
                const JSZip = window.JSZip;
                if (!JSZip) {
                    console.error('JSZip n√£o dispon√≠vel');
                    mostrarNotificacao('Erro', 'Biblioteca de ZIP n√£o carregada.', 'error', 3000);
                    return;
                }
                
                const zip = new JSZip();
                
                // Salvar estado atual dos bot√µes
                const btnTipo = document.getElementById('tipo-normal');
                const btnAcumulada = document.getElementById('tipo-acumulada');
                const btnTotal = document.getElementById('modo-acumulado');
                const btnSeparado = document.getElementById('modo-unidade');
                
                const estadoAtual = {
                    tipoNormal: btnTipo.classList.contains('active'),
                    agrupamentoTotal: btnTotal.classList.contains('active')
                };
                
                console.log('Estado atual salvo:', estadoAtual);
                
                for (const grafico of graficos) {
                    console.log(`Gerando gr√°fico: ${grafico}`);
                    
                    // Configurar estado para o gr√°fico
                    const [categoria, agrup] = grafico.split('-');
                    
                    // Simular cliques nos bot√µes corretos
                    if (tipo === 'normal') {
                        btnTipo.classList.add('active');
                        btnAcumulada.classList.remove('active');
                    } else {
                        btnTipo.classList.remove('active');
                        btnAcumulada.classList.add('active');
                    }
                    
                    if (agrup === 'total') {
                        btnTotal.classList.add('active');
                        btnSeparado.classList.remove('active');
                    } else {
                        btnTotal.classList.remove('active');
                        btnSeparado.classList.add('active');
                    }
                    
                    // Atualizar vari√°veis globais
                    tipoGrafico = tipo;
                    agrupamento = agrup === 'total' ? 'total' : 'separado';
                    
                    console.log(`Configurado: tipo=${tipoGrafico}, agrupamento=${agrupamento}`);
                    
                    // Recarregar o gr√°fico apropriado
                    if (categoria === 'refeicoes') {
                        await carregarGrafico();
                        
                        // Garantir que o placeholder est√° oculto e o canvas est√° vis√≠vel
                        const placeholder = document.getElementById('chart-placeholder');
                        if (placeholder) placeholder.style.display = 'none';
                        
                        // Aguardar renderiza√ß√£o
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        // Capturar imagem do gr√°fico
                        const canvas = document.getElementById('grafico-principal');
                        console.log('Canvas encontrado:', canvas);
                        console.log('Canvas width:', canvas?.width, 'height:', canvas?.height);
                        
                        if (canvas && canvas.width > 0 && canvas.height > 0) {
                            console.log('Canvas de refei√ß√µes encontrado, capturando...');
                            const imgData = canvas.toDataURL('image/png');
                            const base64Data = imgData.split(',')[1];
                            const nomeArquivo = `refeicoes_${tipo}_${agrup}.png`;
                            zip.file(nomeArquivo, base64Data, {base64: true});
                            console.log(`‚úÖ Imagem salva: ${nomeArquivo}`);
                        } else {
                            console.error('Canvas de refei√ß√µes n√£o encontrado ou vazio!', {canvas, width: canvas?.width, height: canvas?.height});
                        }
                    } else {
                        await carregarGraficoGastos();
                        
                        // Garantir que o placeholder est√° oculto e o canvas est√° vis√≠vel
                        const placeholderGastos = document.getElementById('chart-placeholder-gastos');
                        if (placeholderGastos) placeholderGastos.style.display = 'none';
                        
                        // Aguardar renderiza√ß√£o
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        // Capturar imagem do gr√°fico
                        const canvas = document.getElementById('grafico-gastos');
                        console.log('Canvas gastos encontrado:', canvas);
                        console.log('Canvas width:', canvas?.width, 'height:', canvas?.height);
                        
                        if (canvas && canvas.width > 0 && canvas.height > 0) {
                            console.log('Canvas de gastos encontrado, capturando...');
                            const imgData = canvas.toDataURL('image/png');
                            const base64Data = imgData.split(',')[1];
                            const nomeArquivo = `gastos_${tipo}_${agrup}.png`;
                            zip.file(nomeArquivo, base64Data, {base64: true});
                            console.log(`‚úÖ Imagem salva: ${nomeArquivo}`);
                        } else {
                            console.error('Canvas de gastos n√£o encontrado ou vazio!', {canvas, width: canvas?.width, height: canvas?.height});
                        }
                    }
                }
                
                console.log('Restaurando estado original...');
                
                // Restaurar estado original dos bot√µes
                if (estadoAtual.tipoNormal) {
                    btnTipo.classList.add('active');
                    btnAcumulada.classList.remove('active');
                    tipoGrafico = 'normal';
                } else {
                    btnTipo.classList.remove('active');
                    btnAcumulada.classList.add('active');
                    tipoGrafico = 'acumulada';
                }
                
                if (estadoAtual.agrupamentoTotal) {
                    btnTotal.classList.add('active');
                    btnSeparado.classList.remove('active');
                    agrupamento = 'total';
                } else {
                    btnTotal.classList.remove('active');
                    btnSeparado.classList.add('active');
                    agrupamento = 'separado';
                }
                
                await carregarGrafico();
                await carregarGraficoGastos();
                
                console.log('Gerando arquivo ZIP...');
                
                // Gerar e baixar ZIP
                const content = await zip.generateAsync({type: 'blob'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `relatorios_${new Date().toISOString().split('T')[0]}.zip`;
                link.click();
                
                mostrarNotificacao(
                    'Sucesso',
                    'Relat√≥rios exportados com sucesso!',
                    'success',
                    3000
                );
            }
            
            // Fun√ß√£o para exportar como PDF
            async function exportarComoPDF(graficos, tipo) {
                console.log('üìÑ Iniciando exporta√ß√£o de PDF');
                
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    console.error('jsPDF n√£o dispon√≠vel');
                    mostrarNotificacao('Erro', 'Biblioteca de PDF n√£o carregada.', 'error', 3000);
                    return;
                }
                
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Salvar estado atual dos bot√µes
                const btnTipo = document.getElementById('tipo-normal');
                const btnAcumulada = document.getElementById('tipo-acumulada');
                const btnTotal = document.getElementById('modo-acumulado');
                const btnSeparado = document.getElementById('modo-unidade');
                
                const estadoAtual = {
                    tipoNormal: btnTipo.classList.contains('active'),
                    agrupamentoTotal: btnTotal.classList.contains('active')
                };
                
                console.log('Estado atual salvo:', estadoAtual);
                
                let primeiraPagina = true;
                
                for (const grafico of graficos) {
                    console.log(`Gerando p√°gina PDF: ${grafico}`);
                    
                    if (!primeiraPagina) {
                        pdf.addPage();
                    }
                    primeiraPagina = false;
                    
                    // Configurar estado para o gr√°fico
                    const [categoria, agrup] = grafico.split('-');
                    
                    // Simular cliques nos bot√µes corretos
                    if (tipo === 'normal') {
                        btnTipo.classList.add('active');
                        btnAcumulada.classList.remove('active');
                    } else {
                        btnTipo.classList.remove('active');
                        btnAcumulada.classList.add('active');
                    }
                    
                    if (agrup === 'total') {
                        btnTotal.classList.add('active');
                        btnSeparado.classList.remove('active');
                    } else {
                        btnTotal.classList.remove('active');
                        btnSeparado.classList.add('active');
                    }
                    
                    // Atualizar vari√°veis globais
                    tipoGrafico = tipo;
                    agrupamento = agrup === 'total' ? 'total' : 'separado';
                    
                    console.log(`Configurado: tipo=${tipoGrafico}, agrupamento=${agrupamento}`);
                    
                    // Recarregar o gr√°fico apropriado
                    if (categoria === 'refeicoes') {
                        await carregarGrafico();
                        
                        // Garantir que o placeholder est√° oculto
                        const placeholder = document.getElementById('chart-placeholder');
                        if (placeholder) placeholder.style.display = 'none';
                        
                        // Aguardar renderiza√ß√£o
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        const canvas = document.getElementById('grafico-principal');
                        console.log('Canvas encontrado:', canvas);
                        console.log('Canvas width:', canvas?.width, 'height:', canvas?.height);
                        
                        if (canvas && canvas.width > 0 && canvas.height > 0) {
                            console.log('Canvas de refei√ß√µes encontrado, adicionando ao PDF...');
                            const imgData = canvas.toDataURL('image/png');
                            
                            // Adicionar t√≠tulo
                            pdf.setFontSize(16);
                            pdf.text(`Evolu√ß√£o de Refei√ß√µes - ${agrup === 'total' ? 'Total Geral' : 'Por Unidade'}`, 148, 15, { align: 'center' });
                            pdf.setFontSize(12);
                            pdf.text(`Tipo: ${tipo === 'normal' ? 'Normal' : 'Acumulada'}`, 148, 22, { align: 'center' });
                            
                            // Adicionar gr√°fico (paisagem A4: 297x210mm, margem 10mm)
                            pdf.addImage(imgData, 'PNG', 10, 30, 277, 155);
                            
                            // Adicionar rodap√©
                            pdf.setFontSize(8);
                            pdf.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 148, 200, { align: 'center' });
                            console.log('‚úÖ P√°gina de refei√ß√µes adicionada');
                        } else {
                            console.error('Canvas de refei√ß√µes n√£o encontrado!');
                        }
                    } else {
                        await carregarGraficoGastos();
                        
                        // Garantir que o placeholder est√° oculto
                        const placeholderGastos = document.getElementById('chart-placeholder-gastos');
                        if (placeholderGastos) placeholderGastos.style.display = 'none';
                        
                        // Aguardar renderiza√ß√£o
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        const canvas = document.getElementById('grafico-gastos');
                        console.log('Canvas gastos encontrado:', canvas);
                        console.log('Canvas width:', canvas?.width, 'height:', canvas?.height);
                        
                        if (canvas && canvas.width > 0 && canvas.height > 0) {
                            console.log('Canvas de gastos encontrado, adicionando ao PDF...');
                            const imgData = canvas.toDataURL('image/png');
                            
                            // Adicionar t√≠tulo
                            pdf.setFontSize(16);
                            pdf.text(`Evolu√ß√£o de Gastos - ${agrup === 'total' ? 'Total Geral' : 'Por Unidade'}`, 148, 15, { align: 'center' });
                            pdf.setFontSize(12);
                            pdf.text(`Tipo: ${tipo === 'normal' ? 'Normal' : 'Acumulada'}`, 148, 22, { align: 'center' });
                            
                            // Adicionar gr√°fico
                            pdf.addImage(imgData, 'PNG', 10, 30, 277, 155);
                            
                            // Adicionar rodap√©
                            pdf.setFontSize(8);
                            pdf.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 148, 200, { align: 'center' });
                            console.log('‚úÖ P√°gina de gastos adicionada');
                        } else {
                            console.error('Canvas de gastos n√£o encontrado!');
                        }
                    }
                }
                
                console.log('Restaurando estado original...');
                
                // Restaurar estado original dos bot√µes
                if (estadoAtual.tipoNormal) {
                    btnTipo.classList.add('active');
                    btnAcumulada.classList.remove('active');
                    tipoGrafico = 'normal';
                } else {
                    btnTipo.classList.remove('active');
                    btnAcumulada.classList.add('active');
                    tipoGrafico = 'acumulada';
                }
                
                if (estadoAtual.agrupamentoTotal) {
                    btnTotal.classList.add('active');
                    btnSeparado.classList.remove('active');
                    agrupamento = 'total';
                } else {
                    btnTotal.classList.remove('active');
                    btnSeparado.classList.add('active');
                    agrupamento = 'separado';
                }
                
                await carregarGrafico();
                await carregarGraficoGastos();
                
                console.log('Gerando arquivo PDF...');
                
                // Baixar PDF
                pdf.save(`relatorios_${new Date().toISOString().split('T')[0]}.pdf`);
                
                mostrarNotificacao(
                    'Sucesso',
                    'Relat√≥rios exportados com sucesso!',
                    'success',
                    3000
                );
            }

            // Fechar modais ao clicar fora
            modalExportacao.addEventListener('click', function(e) {
                if (e.target === modalExportacao) {
                    modalExportacao.style.display = 'none';
                }
            });

            // Logout - Modal customizado
            var modalLogout = document.getElementById('modal-confirmacao-logout');
            var btnCancelarLogout = document.getElementById('btn-cancelar-logout');
            var btnConfirmarLogout = document.getElementById('btn-confirmar-logout');
            
            document.getElementById('logoutLink').addEventListener('click', function(e) {
                e.preventDefault();
                modalLogout.style.display = 'block';
            });
            
            if (btnCancelarLogout) {
                btnCancelarLogout.addEventListener('click', function() {
                    modalLogout.style.display = 'none';
                });
            }
            
            if (btnConfirmarLogout) {
                btnConfirmarLogout.addEventListener('click', function() {
                    fetch('/logout', {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.ok) {
                            window.location.href = '/login';
                        }
                    })
                    .catch(() => {
                        window.location.href = '/logout';
                    });
                });
            }
            
            // Fechar modal ao clicar fora
            if (modalLogout) {
                modalLogout.addEventListener('click', function(e) {
                    if (e.target === modalLogout) {
                        modalLogout.style.display = 'none';
                    }
                });
            }

            // Anima√ß√µes
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            });

            document.querySelectorAll('.fade-in').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(30px)';
                el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(el);
            });
            
            // N√£o carregar gr√°fico automaticamente - aguardar sele√ß√£o de lote
            console.log('üöÄ P√°gina carregada - aguardando sele√ß√£o de lote...');
            // Exibir placeholder inicial
            document.getElementById('chart-placeholder').style.display = 'flex';
            document.getElementById('placeholder-grafico-gastos').style.display = 'flex';
        });
    </script>
    <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyAp2Xg1g5MwxuD3m6QlroJVmi6V6SEYeGo",
        authDomain: "sgmrp-sfa-seap.firebaseapp.com",
        projectId: "sgmrp-sfa-seap",
        storageBucket: "sgmrp-sfa-seap.firebasestorage.app",
        messagingSenderId: "890046403125",
        appId: "1:890046403125:web:36c3cb60d4e6960f1a977c",
        measurementId: "G-Z0KXSCHS4Q"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    </script>
</body>
</html>
